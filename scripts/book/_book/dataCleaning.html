<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Data Cleaning | A Mega-Analysis of Personality Predictions: Robustness and Boundary Conditions</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Data Cleaning | A Mega-Analysis of Personality Predictions: Robustness and Boundary Conditions" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Data Cleaning | A Mega-Analysis of Personality Predictions: Robustness and Boundary Conditions" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Emorie D. Beck" />


<meta name="date" content="2020-07-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="propensity-score-matching-psm.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Workspace</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#packages"><i class="fa fa-check"></i><b>1.1</b> Packages</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#directory-path"><i class="fa fa-check"></i><b>1.2</b> Directory Path</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#codebook"><i class="fa fa-check"></i><b>1.3</b> Codebook</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#other-supporting-documents"><i class="fa fa-check"></i><b>1.4</b> Other Supporting Documents</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="dataCleaning.html"><a href="dataCleaning.html"><i class="fa fa-check"></i><b>2</b> Data Cleaning</a><ul>
<li class="chapter" data-level="2.1" data-path="dataCleaning.html"><a href="dataCleaning.html#add-health"><i class="fa fa-check"></i><b>2.1</b> Add Health</a><ul>
<li class="chapter" data-level="2.1.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data"><i class="fa fa-check"></i><b>2.1.1</b> Load Data</a></li>
<li class="chapter" data-level="2.1.2" data-path="dataCleaning.html"><a href="dataCleaning.html#matching-variables"><i class="fa fa-check"></i><b>2.1.2</b> Matching Variables</a></li>
<li class="chapter" data-level="2.1.3" data-path="dataCleaning.html"><a href="dataCleaning.html#personality-variables"><i class="fa fa-check"></i><b>2.1.3</b> Personality Variables</a></li>
<li class="chapter" data-level="2.1.4" data-path="dataCleaning.html"><a href="dataCleaning.html#outcome-variables"><i class="fa fa-check"></i><b>2.1.4</b> Outcome Variables</a></li>
<li class="chapter" data-level="2.1.5" data-path="dataCleaning.html"><a href="dataCleaning.html#covariates"><i class="fa fa-check"></i><b>2.1.5</b> Covariates</a></li>
<li class="chapter" data-level="2.1.6" data-path="dataCleaning.html"><a href="dataCleaning.html#imputation"><i class="fa fa-check"></i><b>2.1.6</b> Imputation</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="dataCleaning.html"><a href="dataCleaning.html#us"><i class="fa fa-check"></i><b>2.2</b> US</a><ul>
<li class="chapter" data-level="2.2.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data-1"><i class="fa fa-check"></i><b>2.2.1</b> Load Data</a></li>
<li class="chapter" data-level="2.2.2" data-path="dataCleaning.html"><a href="dataCleaning.html#outcome-variables-1"><i class="fa fa-check"></i><b>2.2.2</b> Outcome Variables</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="dataCleaning.html"><a href="dataCleaning.html#bhps"><i class="fa fa-check"></i><b>2.3</b> BHPS</a><ul>
<li class="chapter" data-level="2.3.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data-2"><i class="fa fa-check"></i><b>2.3.1</b> Load Data</a></li>
<li class="chapter" data-level="2.3.2" data-path="dataCleaning.html"><a href="dataCleaning.html#matching-variables-1"><i class="fa fa-check"></i><b>2.3.2</b> Matching Variables</a></li>
<li class="chapter" data-level="2.3.3" data-path="dataCleaning.html"><a href="dataCleaning.html#personality-variables-1"><i class="fa fa-check"></i><b>2.3.3</b> Personality Variables</a></li>
<li class="chapter" data-level="2.3.4" data-path="dataCleaning.html"><a href="dataCleaning.html#outcome-variables-2"><i class="fa fa-check"></i><b>2.3.4</b> Outcome Variables</a></li>
<li class="chapter" data-level="2.3.5" data-path="dataCleaning.html"><a href="dataCleaning.html#covariates-1"><i class="fa fa-check"></i><b>2.3.5</b> Covariates</a></li>
<li class="chapter" data-level="2.3.6" data-path="dataCleaning.html"><a href="dataCleaning.html#imputation-1"><i class="fa fa-check"></i><b>2.3.6</b> Imputation</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="dataCleaning.html"><a href="dataCleaning.html#gsoep"><i class="fa fa-check"></i><b>2.4</b> GSOEP</a><ul>
<li class="chapter" data-level="2.4.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data-3"><i class="fa fa-check"></i><b>2.4.1</b> Load Data</a></li>
<li class="chapter" data-level="2.4.2" data-path="dataCleaning.html"><a href="dataCleaning.html#matching-variables-2"><i class="fa fa-check"></i><b>2.4.2</b> Matching Variables</a></li>
<li class="chapter" data-level="2.4.3" data-path="dataCleaning.html"><a href="dataCleaning.html#personality-variables-2"><i class="fa fa-check"></i><b>2.4.3</b> Personality Variables</a></li>
<li class="chapter" data-level="2.4.4" data-path="dataCleaning.html"><a href="dataCleaning.html#outcome-variables-3"><i class="fa fa-check"></i><b>2.4.4</b> Outcome Variables</a></li>
<li class="chapter" data-level="2.4.5" data-path="dataCleaning.html"><a href="dataCleaning.html#covariates-2"><i class="fa fa-check"></i><b>2.4.5</b> Covariates</a></li>
<li class="chapter" data-level="2.4.6" data-path="dataCleaning.html"><a href="dataCleaning.html#imputation-2"><i class="fa fa-check"></i><b>2.4.6</b> Imputation</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="dataCleaning.html"><a href="dataCleaning.html#hilda"><i class="fa fa-check"></i><b>2.5</b> HILDA</a><ul>
<li class="chapter" data-level="2.5.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data-4"><i class="fa fa-check"></i><b>2.5.1</b> Load Data</a></li>
<li class="chapter" data-level="2.5.2" data-path="dataCleaning.html"><a href="dataCleaning.html#matching-variables-3"><i class="fa fa-check"></i><b>2.5.2</b> Matching Variables</a></li>
<li class="chapter" data-level="2.5.3" data-path="dataCleaning.html"><a href="dataCleaning.html#personality-variables-3"><i class="fa fa-check"></i><b>2.5.3</b> Personality Variables</a></li>
<li class="chapter" data-level="2.5.4" data-path="dataCleaning.html"><a href="dataCleaning.html#outcome-variables-4"><i class="fa fa-check"></i><b>2.5.4</b> Outcome Variables</a></li>
<li class="chapter" data-level="2.5.5" data-path="dataCleaning.html"><a href="dataCleaning.html#covariates-3"><i class="fa fa-check"></i><b>2.5.5</b> Covariates</a></li>
<li class="chapter" data-level="2.5.6" data-path="dataCleaning.html"><a href="dataCleaning.html#imputation-3"><i class="fa fa-check"></i><b>2.5.6</b> Imputation</a></li>
</ul></li>
<li class="chapter" data-level="2.6" data-path="dataCleaning.html"><a href="dataCleaning.html#hrs"><i class="fa fa-check"></i><b>2.6</b> HRS</a><ul>
<li class="chapter" data-level="2.6.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data-5"><i class="fa fa-check"></i><b>2.6.1</b> Load Data</a></li>
<li class="chapter" data-level="2.6.2" data-path="dataCleaning.html"><a href="dataCleaning.html#matching-variables-4"><i class="fa fa-check"></i><b>2.6.2</b> Matching Variables</a></li>
<li class="chapter" data-level="2.6.3" data-path="dataCleaning.html"><a href="dataCleaning.html#personality-variables-4"><i class="fa fa-check"></i><b>2.6.3</b> Personality Variables</a></li>
<li class="chapter" data-level="2.6.4" data-path="dataCleaning.html"><a href="dataCleaning.html#outcome-variables-5"><i class="fa fa-check"></i><b>2.6.4</b> Outcome Variables</a></li>
<li class="chapter" data-level="2.6.5" data-path="dataCleaning.html"><a href="dataCleaning.html#covariates-4"><i class="fa fa-check"></i><b>2.6.5</b> Covariates</a></li>
<li class="chapter" data-level="2.6.6" data-path="dataCleaning.html"><a href="dataCleaning.html#imputation-4"><i class="fa fa-check"></i><b>2.6.6</b> Imputation</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="dataCleaning.html"><a href="dataCleaning.html#liss"><i class="fa fa-check"></i><b>2.7</b> LISS</a><ul>
<li class="chapter" data-level="2.7.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data-6"><i class="fa fa-check"></i><b>2.7.1</b> Load Data</a></li>
<li class="chapter" data-level="2.7.2" data-path="dataCleaning.html"><a href="dataCleaning.html#matching-variables-5"><i class="fa fa-check"></i><b>2.7.2</b> Matching Variables</a></li>
<li class="chapter" data-level="2.7.3" data-path="dataCleaning.html"><a href="dataCleaning.html#personality-variables-5"><i class="fa fa-check"></i><b>2.7.3</b> Personality Variables</a></li>
<li class="chapter" data-level="2.7.4" data-path="dataCleaning.html"><a href="dataCleaning.html#outcome-variables-6"><i class="fa fa-check"></i><b>2.7.4</b> Outcome Variables</a></li>
<li class="chapter" data-level="2.7.5" data-path="dataCleaning.html"><a href="dataCleaning.html#covariates-5"><i class="fa fa-check"></i><b>2.7.5</b> Covariates</a></li>
<li class="chapter" data-level="2.7.6" data-path="dataCleaning.html"><a href="dataCleaning.html#imputation-5"><i class="fa fa-check"></i><b>2.7.6</b> Imputation</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="dataCleaning.html"><a href="dataCleaning.html#midus"><i class="fa fa-check"></i><b>2.8</b> MIDUS</a><ul>
<li class="chapter" data-level="2.8.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data-7"><i class="fa fa-check"></i><b>2.8.1</b> Load Data</a></li>
<li class="chapter" data-level="2.8.2" data-path="dataCleaning.html"><a href="dataCleaning.html#matching-variables-6"><i class="fa fa-check"></i><b>2.8.2</b> Matching Variables</a></li>
<li class="chapter" data-level="2.8.3" data-path="dataCleaning.html"><a href="dataCleaning.html#personality-variables-6"><i class="fa fa-check"></i><b>2.8.3</b> Personality Variables</a></li>
<li class="chapter" data-level="2.8.4" data-path="dataCleaning.html"><a href="dataCleaning.html#outcome-variables-7"><i class="fa fa-check"></i><b>2.8.4</b> Outcome Variables</a></li>
<li class="chapter" data-level="2.8.5" data-path="dataCleaning.html"><a href="dataCleaning.html#covariates-6"><i class="fa fa-check"></i><b>2.8.5</b> Covariates</a></li>
<li class="chapter" data-level="2.8.6" data-path="dataCleaning.html"><a href="dataCleaning.html#imputation-6"><i class="fa fa-check"></i><b>2.8.6</b> Imputation</a></li>
</ul></li>
<li class="chapter" data-level="2.9" data-path="dataCleaning.html"><a href="dataCleaning.html#nlsy"><i class="fa fa-check"></i><b>2.9</b> NLSY</a><ul>
<li class="chapter" data-level="2.9.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data-8"><i class="fa fa-check"></i><b>2.9.1</b> Load Data</a></li>
<li class="chapter" data-level="2.9.2" data-path="dataCleaning.html"><a href="dataCleaning.html#matching-variables-7"><i class="fa fa-check"></i><b>2.9.2</b> Matching Variables</a></li>
<li class="chapter" data-level="2.9.3" data-path="dataCleaning.html"><a href="dataCleaning.html#personality-variables-7"><i class="fa fa-check"></i><b>2.9.3</b> Personality Variables</a></li>
<li class="chapter" data-level="2.9.4" data-path="dataCleaning.html"><a href="dataCleaning.html#outcome-variables-8"><i class="fa fa-check"></i><b>2.9.4</b> Outcome Variables</a></li>
<li class="chapter" data-level="2.9.5" data-path="dataCleaning.html"><a href="dataCleaning.html#covariates-7"><i class="fa fa-check"></i><b>2.9.5</b> Covariates</a></li>
<li class="chapter" data-level="2.9.6" data-path="dataCleaning.html"><a href="dataCleaning.html#imputation-7"><i class="fa fa-check"></i><b>2.9.6</b> Imputation</a></li>
</ul></li>
<li class="chapter" data-level="2.10" data-path="dataCleaning.html"><a href="dataCleaning.html#shp"><i class="fa fa-check"></i><b>2.10</b> SHP</a><ul>
<li class="chapter" data-level="2.10.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data-9"><i class="fa fa-check"></i><b>2.10.1</b> Load Data</a></li>
<li class="chapter" data-level="2.10.2" data-path="dataCleaning.html"><a href="dataCleaning.html#matching-variables-8"><i class="fa fa-check"></i><b>2.10.2</b> Matching Variables</a></li>
<li class="chapter" data-level="2.10.3" data-path="dataCleaning.html"><a href="dataCleaning.html#personality-variables-8"><i class="fa fa-check"></i><b>2.10.3</b> Personality Variables</a></li>
<li class="chapter" data-level="2.10.4" data-path="dataCleaning.html"><a href="dataCleaning.html#outcome-variables-9"><i class="fa fa-check"></i><b>2.10.4</b> Outcome Variables</a></li>
<li class="chapter" data-level="2.10.5" data-path="dataCleaning.html"><a href="dataCleaning.html#covariates-8"><i class="fa fa-check"></i><b>2.10.5</b> Covariates</a></li>
<li class="chapter" data-level="2.10.6" data-path="dataCleaning.html"><a href="dataCleaning.html#imputation-8"><i class="fa fa-check"></i><b>2.10.6</b> Imputation</a></li>
</ul></li>
<li class="chapter" data-level="2.11" data-path="dataCleaning.html"><a href="dataCleaning.html#wls"><i class="fa fa-check"></i><b>2.11</b> WLS</a><ul>
<li class="chapter" data-level="2.11.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data-10"><i class="fa fa-check"></i><b>2.11.1</b> Load Data</a></li>
<li class="chapter" data-level="2.11.2" data-path="dataCleaning.html"><a href="dataCleaning.html#matching-variables-9"><i class="fa fa-check"></i><b>2.11.2</b> Matching Variables</a></li>
<li class="chapter" data-level="2.11.3" data-path="dataCleaning.html"><a href="dataCleaning.html#personality-variables-9"><i class="fa fa-check"></i><b>2.11.3</b> Personality Variables</a></li>
<li class="chapter" data-level="2.11.4" data-path="dataCleaning.html"><a href="dataCleaning.html#outcome-variables-10"><i class="fa fa-check"></i><b>2.11.4</b> Outcome Variables</a></li>
<li class="chapter" data-level="2.11.5" data-path="dataCleaning.html"><a href="dataCleaning.html#covariates-9"><i class="fa fa-check"></i><b>2.11.5</b> Covariates</a></li>
<li class="chapter" data-level="2.11.6" data-path="dataCleaning.html"><a href="dataCleaning.html#imputation-9"><i class="fa fa-check"></i><b>2.11.6</b> Imputation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="propensity-score-matching-psm.html"><a href="propensity-score-matching-psm.html"><i class="fa fa-check"></i><b>3</b> Propensity Score Matching {PSM}</a><ul>
<li class="chapter" data-level="3.1" data-path="propensity-score-matching-psm.html"><a href="propensity-score-matching-psm.html#part-1-data"><i class="fa fa-check"></i><b>3.1</b> Part 1: Data</a><ul>
<li class="chapter" data-level="3.1.1" data-path="propensity-score-matching-psm.html"><a href="propensity-score-matching-psm.html#outcomes-and-personality"><i class="fa fa-check"></i><b>3.1.1</b> Outcomes and Personality</a></li>
<li class="chapter" data-level="3.1.2" data-path="propensity-score-matching-psm.html"><a href="propensity-score-matching-psm.html#combine-matching-and-outcome-variables"><i class="fa fa-check"></i><b>3.1.2</b> Combine Matching and Outcome Variables</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="propensity-score-matching-psm.html"><a href="propensity-score-matching-psm.html#part-2-run-matching"><i class="fa fa-check"></i><b>3.2</b> Part 2: Run Matching</a><ul>
<li class="chapter" data-level="3.2.1" data-path="propensity-score-matching-psm.html"><a href="propensity-score-matching-psm.html#run-models"><i class="fa fa-check"></i><b>3.2.1</b> Run Models</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="propensity-score-matching-psm.html"><a href="propensity-score-matching-psm.html#part-3-balance"><i class="fa fa-check"></i><b>3.3</b> Part 3: Balance</a><ul>
<li class="chapter" data-level="3.3.1" data-path="propensity-score-matching-psm.html"><a href="propensity-score-matching-psm.html#run"><i class="fa fa-check"></i><b>3.3.1</b> Run</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="propensity-score-matching-psm.html"><a href="propensity-score-matching-psm.html#part-4-descriptives"><i class="fa fa-check"></i><b>3.4</b> Part 4: Descriptives</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html"><i class="fa fa-check"></i><b>4</b> PSM Models {PSM Mods}</a><ul>
<li class="chapter" data-level="4.1" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#part-5-data-setup"><i class="fa fa-check"></i><b>4.1</b> Part 5: Data Setup</a><ul>
<li class="chapter" data-level="4.1.1" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#personality"><i class="fa fa-check"></i><b>4.1.1</b> Personality</a></li>
<li class="chapter" data-level="4.1.2" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#moderators"><i class="fa fa-check"></i><b>4.1.2</b> Moderators</a></li>
<li class="chapter" data-level="4.1.3" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#outcomes"><i class="fa fa-check"></i><b>4.1.3</b> Outcomes</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#part-6-models"><i class="fa fa-check"></i><b>4.2</b> Part 6: Models</a><ul>
<li class="chapter" data-level="4.2.1" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#matched-model-function"><i class="fa fa-check"></i><b>4.2.1</b> Matched Model Function</a></li>
<li class="chapter" data-level="4.2.2" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#setup-cluster-jobs"><i class="fa fa-check"></i><b>4.2.2</b> Setup Cluster Jobs</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#part-7-compile-cluster-jobs"><i class="fa fa-check"></i><b>4.3</b> Part 7: Compile Cluster Jobs</a><ul>
<li class="chapter" data-level="4.3.1" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#moderator-predicted-values"><i class="fa fa-check"></i><b>4.3.1</b> Moderator Predicted Values</a></li>
<li class="chapter" data-level="4.3.2" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#compilation-and-summary-function"><i class="fa fa-check"></i><b>4.3.2</b> Compilation and Summary Function</a></li>
<li class="chapter" data-level="4.3.3" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#run-compilation"><i class="fa fa-check"></i><b>4.3.3</b> Run Compilation</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#part-8-tables-and-plots"><i class="fa fa-check"></i><b>4.4</b> Part 8: Tables and Plots</a><ul>
<li class="chapter" data-level="4.4.1" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#summaries"><i class="fa fa-check"></i><b>4.4.1</b> Summaries</a></li>
<li class="chapter" data-level="4.4.2" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#variance-covariance-matrices"><i class="fa fa-check"></i><b>4.4.2</b> Variance-Covariance Matrices</a></li>
<li class="chapter" data-level="4.4.3" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#simple-effects"><i class="fa fa-check"></i><b>4.4.3</b> Simple Effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html"><i class="fa fa-check"></i><b>5</b> Specification Curve Analysis</a><ul>
<li class="chapter" data-level="5.1" data-path="dataCleaning.html"><a href="dataCleaning.html#load-data"><i class="fa fa-check"></i><b>5.1</b> Load Data</a><ul>
<li class="chapter" data-level="5.1.1" data-path="dataCleaning.html"><a href="dataCleaning.html#covariates"><i class="fa fa-check"></i><b>5.1.1</b> Covariates</a></li>
<li class="chapter" data-level="5.1.2" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#outcomes"><i class="fa fa-check"></i><b>5.1.2</b> Outcomes</a></li>
<li class="chapter" data-level="5.1.3" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#personality"><i class="fa fa-check"></i><b>5.1.3</b> Personality</a></li>
<li class="chapter" data-level="5.1.4" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#moderators"><i class="fa fa-check"></i><b>5.1.4</b> Moderators</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#sca-data-setup"><i class="fa fa-check"></i><b>5.2</b> SCA Data Setup</a></li>
<li class="chapter" data-level="5.3" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#functions"><i class="fa fa-check"></i><b>5.3</b> Functions</a><ul>
<li class="chapter" data-level="5.3.1" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#permutation-samples"><i class="fa fa-check"></i><b>5.3.1</b> Permutation Samples</a></li>
<li class="chapter" data-level="5.3.2" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#permutation-models"><i class="fa fa-check"></i><b>5.3.2</b> Permutation Models</a></li>
<li class="chapter" data-level="5.3.3" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#terms-and-formulas"><i class="fa fa-check"></i><b>5.3.3</b> Terms and Formulas</a></li>
<li class="chapter" data-level="5.3.4" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#full-models-and-workspace-setup"><i class="fa fa-check"></i><b>5.3.4</b> Full Models and Workspace Setup</a></li>
<li class="chapter" data-level="5.3.5" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#specifications-and-permutations-for-cluster"><i class="fa fa-check"></i><b>5.3.5</b> Specifications and Permutations for Cluster</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#setup"><i class="fa fa-check"></i><b>5.4</b> Setup</a><ul>
<li class="chapter" data-level="5.4.1" data-path="index.html"><a href="index.html#workspace"><i class="fa fa-check"></i><b>5.4.1</b> Workspace</a></li>
<li class="chapter" data-level="5.4.2" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#job-arrays-for-the-cluster"><i class="fa fa-check"></i><b>5.4.2</b> Job Arrays for the Cluster</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#re-compiling"><i class="fa fa-check"></i><b>5.5</b> Re-Compiling</a><ul>
<li class="chapter" data-level="5.5.1" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#raw-data-functions"><i class="fa fa-check"></i><b>5.5.1</b> Raw Data Functions</a></li>
<li class="chapter" data-level="5.5.2" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#perm-data-functions"><i class="fa fa-check"></i><b>5.5.2</b> Perm Data Functions</a></li>
<li class="chapter" data-level="5.5.3" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#inferential-based-tests"><i class="fa fa-check"></i><b>5.5.3</b> Inferential-Based Tests</a></li>
<li class="chapter" data-level="5.5.4" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#plotting-function"><i class="fa fa-check"></i><b>5.5.4</b> Plotting Function</a></li>
<li class="chapter" data-level="5.5.5" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#compiling-function"><i class="fa fa-check"></i><b>5.5.5</b> Compiling Function</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="specification-curve-analysis.html"><a href="specification-curve-analysis.html#results"><i class="fa fa-check"></i><b>5.6</b> Results</a><ul>
<li class="chapter" data-level="5.6.1" data-path="psm-models-psm-mods.html"><a href="psm-models-psm-mods.html#tables"><i class="fa fa-check"></i><b>5.6.1</b> Tables</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">A Mega-Analysis of Personality Predictions: Robustness and Boundary Conditions</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="dataCleaning" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Data Cleaning</h1>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">Mode &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  ux &lt;-<span class="st"> </span><span class="kw">unique</span>(x)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  ux &lt;-<span class="st"> </span>ux[<span class="op">!</span><span class="kw">is.na</span>(ux)]</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  ux[<span class="kw">which.max</span>(<span class="kw">tabulate</span>(<span class="kw">match</span>(x, ux)))]</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">}</a></code></pre></div>
<div id="add-health" class="section level2">
<h2><span class="header-section-number">2.1</span> Add Health</h2>
<p>The National Study of Adolescent to Adult Health (Ad Health; Harris &amp; Udry, 2018) is an ongoing longitudinal study of adolescents in the United States that began as a response to a federal mandate to better understand adolescent health. The data are available online at <a href="https://www.icpsr.umich.edu/icpsrweb/DSDR/studies/21600" class="uri">https://www.icpsr.umich.edu/icpsrweb/DSDR/studies/21600</a>.</p>
<p>The initial sample of participants included approximately 20,000 students who completed at home administrations the study. Four waves of data collection (1994-1995, 1996, 2001-2002, and 2008) have been completed. The latest release contains data through 2008. Another wave of collection began in 2016 but has not yet been released. More documentation of the data are available at <a href="https://www.icpsr.umich.edu/icpsrweb/content/DSDR/add-health-data-guide.html#intro" class="uri">https://www.icpsr.umich.edu/icpsrweb/content/DSDR/add-health-data-guide.html#intro</a>.</p>
<p>Sample sizes vary by year, from 14,738 (1996) to 20,745 (1994-1995). This provides 99% power to detect a correlation effect size of ~.03.</p>
<div id="load-data" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Load Data</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">addhealth_read_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/addhealth/%s&quot;</span>, wd, x) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.) </a>
<a class="sourceLine" id="cb6-3" data-line-number="3">}</a></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">addhealth_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;Add Health&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">orig_itemname =</span> <span class="kw">str_to_upper</span>(orig_itemname))</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">addhealth_codebook</a></code></pre></div>
<pre><code>## # A tibble: 533 x 16
##    study dataset category name  itemname wave   year new_itemname orig_itemname description
##    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;         &lt;chr&gt;      
##  1 addh… SCH     match    adop… adopted  SCH    1994 addhealth__… S25           Adopted    
##  2 addh… SCH     match    age   age      SCH    1994 addhealth__… S1            Age        
##  3 addh… SCH     match    alco… alc12mo  SCH    1994 &lt;NA&gt;         S59B          Drank Alco…
##  4 addh… SCH     match    alco… alcohol  SCH    1994 &lt;NA&gt;         S49           Have Had A…
##  5 addh… SCH     match    alco… drunk12… SCH    1994 &lt;NA&gt;         S59C          Got Drunk …
##  6 addh… SCH     match    bioP… livingB… SCH    1994 &lt;NA&gt;         S26           Live with …
##  7 addh… SCH     match    birt… birthpl… SCH    1994 &lt;NA&gt;         S8            Born in Un…
##  8 addh… Parent  match    birt… borninUS Pare…  1995 &lt;NA&gt;         PC64          Child was …
##  9 addh… Parent  match    birt… bornUS   Pare…  1995 &lt;NA&gt;         PA3           Born in Un…
## 10 addh… Parent  match    brth… birthwe… Pare…  1995 &lt;NA&gt;         PC19A_P       Child&#39;s bi…
## # … with 523 more rows, and 6 more variables: scale &lt;chr&gt;, reverse_code &lt;chr&gt;, recode &lt;chr&gt;,
## #   mini &lt;dbl&gt;, maxi &lt;dbl&gt;, comp_rule &lt;chr&gt;</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">old.names &lt;-<span class="st"> </span><span class="kw">unique</span>(addhealth_codebook<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">datasets &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/addhealth&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">list.files</span>(., <span class="dt">pattern =</span> <span class="st">&quot;.sav&quot;</span>)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">addhealth &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">datasets =</span> datasets) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(datasets, addhealth_read_fun),</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">         <span class="dt">ncol =</span> <span class="kw">map</span>(data, ncol)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="st">  </span><span class="kw">unnest</span>(ncol) </a>
<a class="sourceLine" id="cb9-7" data-line-number="7"></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">addhealth_long &lt;-<span class="st"> </span>addhealth <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="st">  </span><span class="kw">filter</span>(ncol <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>AID))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ncol, <span class="op">-</span>datasets) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">SID =</span> AID)</a>
<a class="sourceLine" id="cb9-14" data-line-number="14"></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="kw">save</span>(addhealth, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/addhealth_raw.RData&quot;</span>, wd))</a></code></pre></div>
</div>
<div id="matching-variables" class="section level3">
<h3><span class="header-section-number">2.1.2</span> Matching Variables</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># rename variables   </span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co"># rename variables   </span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">addhealth_match &lt;-<span class="st"> </span>addhealth_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(name, itemname, wave, year, orig_itemname, reverse_code<span class="op">:</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(addhealth_long))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="st">  </span><span class="kw">unnest</span>()</a>
<a class="sourceLine" id="cb10-11" data-line-number="11"></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">yrBrth &lt;-<span class="st"> </span>addhealth_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">yearBrth =</span> value <span class="op">+</span><span class="st"> </span><span class="dv">1900</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="st">  </span><span class="kw">select</span>(SID, yearBrth)</a>
<a class="sourceLine" id="cb10-16" data-line-number="16"></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, year){</a>
<a class="sourceLine" id="cb10-19" data-line-number="19">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb10-20" data-line-number="20">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb10-21" data-line-number="21">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb10-22" data-line-number="22">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb10-23" data-line-number="23">}</a>
<a class="sourceLine" id="cb10-24" data-line-number="24"></a>
<a class="sourceLine" id="cb10-25" data-line-number="25">addhealth_match &lt;-<span class="st"> </span>addhealth_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-26" data-line-number="26"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;age&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-27" data-line-number="27"><span class="st">  </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-28" data-line-number="28"><span class="st">  </span><span class="kw">group_by</span>(recode, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-29" data-line-number="29"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-30" data-line-number="30"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-31" data-line-number="31"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-32" data-line-number="32"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb10-33" data-line-number="33"></a>
<a class="sourceLine" id="cb10-34" data-line-number="34"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb10-35" data-line-number="35">addhealth_match &lt;-<span class="st"> </span>addhealth_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-36" data-line-number="36"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, </a>
<a class="sourceLine" id="cb10-37" data-line-number="37">                        <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb10-38" data-line-number="38"></a>
<a class="sourceLine" id="cb10-39" data-line-number="39">fun_call &lt;-<span class="st"> </span><span class="cf">function</span>(x, rule){</a>
<a class="sourceLine" id="cb10-40" data-line-number="40">    <span class="cf">switch</span>(rule,</a>
<a class="sourceLine" id="cb10-41" data-line-number="41">           <span class="dt">average =</span> <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb10-42" data-line-number="42">           <span class="dt">mode =</span> <span class="kw">Mode</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb10-43" data-line-number="43">           <span class="dt">sum =</span> <span class="kw">sum</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb10-44" data-line-number="44">           <span class="dt">skip =</span> <span class="kw">unique</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb10-45" data-line-number="45">           <span class="dt">max =</span> <span class="kw">max</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb10-46" data-line-number="46">           <span class="dt">min =</span> <span class="kw">min</span>(x, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb10-47" data-line-number="47">  }</a>
<a class="sourceLine" id="cb10-48" data-line-number="48"></a>
<a class="sourceLine" id="cb10-49" data-line-number="49"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb10-50" data-line-number="50">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb10-51" data-line-number="51">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-52" data-line-number="52"><span class="st">    </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb10-53" data-line-number="53"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-54" data-line-number="54"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-55" data-line-number="55"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-56" data-line-number="56"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb10-57" data-line-number="57">}</a>
<a class="sourceLine" id="cb10-58" data-line-number="58"></a>
<a class="sourceLine" id="cb10-59" data-line-number="59">addhealth_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;Add Health&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb10-60" data-line-number="60"></a>
<a class="sourceLine" id="cb10-61" data-line-number="61">addhealth_match &lt;-<span class="st"> </span>addhealth_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-62" data-line-number="62"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="kw">max</span>(addhealth_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-63" data-line-number="63"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;skip&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb10-64" data-line-number="64">         <span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(comp_rule <span class="op">==</span><span class="st"> &quot;mx&quot;</span>, <span class="st">&quot;max&quot;</span>, comp_rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-65" data-line-number="65"><span class="st">  </span><span class="kw">group_by</span>(comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-66" data-line-number="66"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-67" data-line-number="67"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-68" data-line-number="68"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-69" data-line-number="69"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb10-70" data-line-number="70"></a>
<a class="sourceLine" id="cb10-71" data-line-number="71">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, p_year){</a>
<a class="sourceLine" id="cb10-72" data-line-number="72">  addhealth_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-73" data-line-number="73"><span class="st">    </span><span class="kw">filter</span>((year <span class="op">&lt;=</span><span class="st"> </span><span class="dv">1996</span> <span class="op">|</span><span class="st"> </span>year <span class="op">&lt;=</span><span class="st"> </span>p_year) <span class="op">&amp;</span><span class="st"> </span>comp_rule <span class="op">==</span><span class="st"> </span>rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-74" data-line-number="74"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-75" data-line-number="75"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-76" data-line-number="76"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-77" data-line-number="77"><span class="st">    </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb10-78" data-line-number="78">}</a>
<a class="sourceLine" id="cb10-79" data-line-number="79"></a>
<a class="sourceLine" id="cb10-80" data-line-number="80">addhealth_match &lt;-<span class="st"> </span><span class="kw">crossing</span>(</a>
<a class="sourceLine" id="cb10-81" data-line-number="81">  <span class="dt">p_year =</span> addhealth_waves<span class="op">$</span>Used, </a>
<a class="sourceLine" id="cb10-82" data-line-number="82">  <span class="dt">comp_rule =</span> <span class="kw">unique</span>(addhealth_match<span class="op">$</span>comp_rule)</a>
<a class="sourceLine" id="cb10-83" data-line-number="83">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-84" data-line-number="84"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(comp_rule, p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-85" data-line-number="85"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-86" data-line-number="86"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-87" data-line-number="87"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-88" data-line-number="88"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-89" data-line-number="89"><span class="st">  </span><span class="kw">spread</span>(name, value) </a>
<a class="sourceLine" id="cb10-90" data-line-number="90">addhealth_match</a></code></pre></div>
<pre><code>## # A tibble: 19,515 x 120
##    p_year SID   physhlthevnt     A     C     DEP     E    IQ   LOC     N  `NA`    PA    SE
##     &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1   1995 5710…            0   3.5  3.5   0.5       NA  28     2      NA   0.5     0  5   
##  2   1996 5710…            0  NA   NA    NA         NA  NA    NA      NA  NA      NA NA   
##  3   2001 5710…           NA  NA   NA     1.75      NA  NA    NA      NA   2      NA  4.75
##  4   1995 5710…            0   3    2.75  0.611     NA  59.5   2      NA   0.5     0  3.83
##  5   1996 5710…            0  NA   NA     0.167      4  NA     3.5     3   0       0  5   
##  6   2001 5710…           NA  NA   NA     1.25      NA  NA    NA      NA   1      NA  3.5 
##  7   1995 5710…            0   4.5  3     0.0556    NA  79     3      NA   0       0  4.83
##  8   1996 5710…            0  NA   NA    NA         NA  NA    NA      NA  NA      NA NA   
##  9   2001 5710…            0  NA   NA    NA         NA  NA    NA      NA  NA      NA NA   
## 10   1995 5710…            0   4.5  2     1.17      NA  57     5      NA   0.5     1  4.67
## # … with 19,505 more rows, and 107 more variables: SWL &lt;dbl&gt;, adopted &lt;dbl&gt;,
## #   ageMarried &lt;dbl&gt;, alcohol &lt;dbl&gt;, bioParinHH &lt;dbl&gt;, birthplace &lt;dbl&gt;, brthweight &lt;dbl&gt;,
## #   childFrnd &lt;dbl&gt;, childHlthProb &lt;dbl&gt;, childTemper &lt;dbl&gt;, childTrustwrthy &lt;dbl&gt;,
## #   chldAgeHlthProb &lt;dbl&gt;, chldHlthIns &lt;dbl&gt;, chldHlthProb &lt;dbl&gt;, clubs &lt;dbl&gt;, dadAlc &lt;dbl&gt;,
## #   dadBornUS &lt;dbl&gt;, dadCare &lt;dbl&gt;, dadEdu &lt;dbl&gt;, dadEmployed &lt;dbl&gt;, dadHealthProb &lt;dbl&gt;,
## #   dadInHH &lt;dbl&gt;, date &lt;dbl&gt;, dentist &lt;dbl&gt;, disability &lt;dbl&gt;, drugs &lt;dbl&gt;, drVisits &lt;dbl&gt;,
## #   durBreastFeed &lt;dbl&gt;, employed &lt;dbl&gt;, everLiveBioDad &lt;dbl&gt;, everLiveBioMom &lt;dbl&gt;,
## #   exercise &lt;dbl&gt;, expAIDS &lt;dbl&gt;, expDie25 &lt;dbl&gt;, expGradCollege &lt;dbl&gt;, expInc &lt;dbl&gt;,
## #   expLive35 &lt;dbl&gt;, expMarried25 &lt;dbl&gt;, extracurricular &lt;dbl&gt;, friendship &lt;dbl&gt;,
## #   frndsGoodInf &lt;dbl&gt;, gender &lt;dbl&gt;, grade &lt;dbl&gt;, grades &lt;dbl&gt;, grsWages &lt;dbl&gt;,
## #   height &lt;dbl&gt;, HHsize &lt;dbl&gt;, hlthProb &lt;dbl&gt;, hlthSymp &lt;dbl&gt;, involvedSchWrk &lt;dbl&gt;,
## #   liveMom &lt;dbl&gt;, momAlc &lt;dbl&gt;, momAlive &lt;dbl&gt;, momBornUS &lt;dbl&gt;, momCare &lt;dbl&gt;,
## #   momEdu &lt;dbl&gt;, momEmployed &lt;dbl&gt;, momHealthProb &lt;dbl&gt;, momInHH &lt;dbl&gt;,
## #   moneyForBills &lt;dbl&gt;, nbhdQual &lt;dbl&gt;, numMarriages &lt;dbl&gt;, numSiblng &lt;dbl&gt;,
## #   ParDisabled &lt;dbl&gt;, parDivorce &lt;dbl&gt;, parExpGrad &lt;dbl&gt;, parMarriedAge &lt;dbl&gt;,
## #   parReligFreq &lt;dbl&gt;, parReligImp &lt;dbl&gt;, parReligion &lt;dbl&gt;, parReligScript &lt;dbl&gt;,
## #   parRelSat &lt;dbl&gt;, parRepHlth &lt;dbl&gt;, parSmokes &lt;dbl&gt;, parTalkSex &lt;dbl&gt;, ParTalkSex &lt;dbl&gt;,
## #   parUnemployBen &lt;dbl&gt;, physFunc &lt;dbl&gt;, PhysFunc &lt;fct&gt;, prntAlcohol &lt;dbl&gt;,
## #   prntWelfare &lt;dbl&gt;, race &lt;dbl&gt;, recoverFast &lt;dbl&gt;, relChld &lt;dbl&gt;, religFreq &lt;dbl&gt;,
## #   religImp &lt;dbl&gt;, religion &lt;dbl&gt;, religScript &lt;dbl&gt;, sameHouse &lt;dbl&gt;, satHH &lt;dbl&gt;,
## #   satSchl &lt;dbl&gt;, school &lt;dbl&gt;, skipClass &lt;dbl&gt;, smokes &lt;dbl&gt;, sports &lt;dbl&gt;,
## #   SRhealth &lt;dbl&gt;, twin &lt;dbl&gt;, Understandchild &lt;dbl&gt;, weapon &lt;dbl&gt;, weed &lt;dbl&gt;, …</code></pre>
</div>
<div id="personality-variables" class="section level3">
<h3><span class="header-section-number">2.1.3</span> Personality Variables</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">addhealth_pers &lt;-<span class="st"> </span>addhealth_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;pers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(name, itemname, wave, year, orig_itemname, reverse_code<span class="op">:</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(addhealth_long))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(addhealth_waves<span class="op">$</span>Used))</a>
<a class="sourceLine" id="cb12-11" data-line-number="11"></a>
<a class="sourceLine" id="cb12-12" data-line-number="12">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb12-13" data-line-number="13">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb12-14" data-line-number="14">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb12-15" data-line-number="15">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb12-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb12-17" data-line-number="17"></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19">addhealth_pers &lt;-<span class="st"> </span>addhealth_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb12-25" data-line-number="25"></a>
<a class="sourceLine" id="cb12-26" data-line-number="26"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb12-27" data-line-number="27">addhealth_pers &lt;-<span class="st"> </span>addhealth_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-28" data-line-number="28"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">tolower</span>(reverse_code) <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, </a>
<a class="sourceLine" id="cb12-29" data-line-number="29">                        <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb12-30" data-line-number="30"></a>
<a class="sourceLine" id="cb12-31" data-line-number="31"><span class="co"># alpha&#39;s</span></a>
<a class="sourceLine" id="cb12-32" data-line-number="32">addhealth_alpha &lt;-<span class="st"> </span>addhealth_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, SID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34"><span class="st">  </span><span class="kw">group_by</span>(name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-35" data-line-number="35"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-36" data-line-number="36"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> itemname, <span class="dt">values_from =</span> value, <span class="dt">values_fn =</span> <span class="kw">list</span>(<span class="dt">value =</span> mean))),</a>
<a class="sourceLine" id="cb12-37" data-line-number="37">         <span class="dt">alpha =</span> <span class="kw">map</span>(data, <span class="kw">possibly</span>(<span class="op">~</span>psych<span class="op">::</span><span class="kw">alpha</span>((.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>SID)), <span class="ot">NA_real_</span>)))</a>
<a class="sourceLine" id="cb12-38" data-line-number="38"></a>
<a class="sourceLine" id="cb12-39" data-line-number="39"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb12-40" data-line-number="40">addhealth_pers &lt;-<span class="st"> </span>addhealth_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-41" data-line-number="41"><span class="st">  </span><span class="kw">group_by</span>(SID, name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-42" data-line-number="42"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-43" data-line-number="43"><span class="st">  </span><span class="kw">ungroup</span>() </a></code></pre></div>
<pre><code>## # A tibble: 105,398 x 4
##    SID      name   year value
##    &lt;chr&gt;    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 57100270 A      1995  3.5 
##  2 57100270 C      1995  3.5 
##  3 57100270 DEP    1995  0.5 
##  4 57100270 DEP    2001  1.75
##  5 57100270 IQ     1995 28   
##  6 57100270 LOC    1995  2   
##  7 57100270 NA     1995  0.5 
##  8 57100270 NA     2001  2   
##  9 57100270 PA     1995  0   
## 10 57100270 SE     1995  5   
## # … with 105,388 more rows</code></pre>
</div>
<div id="outcome-variables" class="section level3">
<h3><span class="header-section-number">2.1.4</span> Outcome Variables</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># missing all edu 2008 variables</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">addhealth_out &lt;-<span class="st"> </span>addhealth_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(name, itemname, wave, year, orig_itemname, reverse_code<span class="op">:</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="st">  </span><span class="kw">left_join</span>(addhealth_long) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> addhealth_waves<span class="op">$</span>Used, <span class="dt">name =</span> <span class="kw">unique</span>((.)<span class="op">$</span>name))) </a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="co"># recode</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year, year){</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb14-12" data-line-number="12">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb14-15" data-line-number="15"></a>
<a class="sourceLine" id="cb14-16" data-line-number="16">addhealth_out &lt;-<span class="st"> </span>addhealth_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-17" data-line-number="17"><span class="st">  </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-18" data-line-number="18"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>orig_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19"><span class="st">  </span><span class="kw">group_by</span>(recode, year, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-20" data-line-number="20"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-21" data-line-number="21"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-22" data-line-number="22"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">as.numeric</span>(year),</a>
<a class="sourceLine" id="cb14-23" data-line-number="23">         <span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-24" data-line-number="24"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-25" data-line-number="25"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb14-26" data-line-number="26"></a>
<a class="sourceLine" id="cb14-27" data-line-number="27"><span class="co"># composite within years </span></a>
<a class="sourceLine" id="cb14-28" data-line-number="28"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb14-29" data-line-number="29">addhealth_out &lt;-<span class="st"> </span>addhealth_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-30" data-line-number="30"><span class="st">  </span><span class="kw">group_by</span>(SID, name, year, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-31" data-line-number="31"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-32" data-line-number="32"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-33" data-line-number="33"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb14-34" data-line-number="34"></a>
<a class="sourceLine" id="cb14-35" data-line-number="35">addhealth_out &lt;-<span class="st"> </span>addhealth_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-36" data-line-number="36"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>p_year, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;past&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-37" data-line-number="37"><span class="st">    </span><span class="kw">group_by</span>(SID, name, group, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-38" data-line-number="38"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-39" data-line-number="39"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-40" data-line-number="40"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-41" data-line-number="41"><span class="st">    </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> group, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-42" data-line-number="42"><span class="st">    </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-43" data-line-number="43"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(past) <span class="op">|</span><span class="st"> </span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(future)), future,</a>
<a class="sourceLine" id="cb14-44" data-line-number="44">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(future), past, </a>
<a class="sourceLine" id="cb14-45" data-line-number="45">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-46" data-line-number="46"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-47" data-line-number="47"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(name <span class="op">==</span><span class="st"> &quot;crim&quot;</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(value), <span class="dv">0</span>, value))</a></code></pre></div>
<pre><code>## # A tibble: 198,117 x 4
##    SID      name     p_year value
##    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;
##  1 57100270 chldbrth   1995     0
##  2 57100270 chldbrth   1996     0
##  3 57100270 chldbrth   2001     0
##  4 57100270 crim       1995     0
##  5 57100270 crim       1996     0
##  6 57100270 crim       2001     0
##  7 57100270 divorced   1995     0
##  8 57100270 divorced   1996     0
##  9 57100270 divorced   2001     0
## 10 57100270 edu        1995     0
## # … with 198,107 more rows</code></pre>
</div>
<div id="covariates" class="section level3">
<h3><span class="header-section-number">2.1.5</span> Covariates</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">addhealth_match &lt;-<span class="st"> </span>addhealth_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">p_year =</span> year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="st">  </span><span class="kw">full_join</span>(addhealth_match)</a>
<a class="sourceLine" id="cb16-5" data-line-number="5"></a>
<a class="sourceLine" id="cb16-6" data-line-number="6">addhealth_match &lt;-<span class="st"> </span>addhealth_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> p_year <span class="op">-</span><span class="st"> </span>yearBrth,</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">         <span class="dt">height =</span> height<span class="op">*</span><span class="fl">2.54</span><span class="op">/</span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">         <span class="dt">weight =</span> weight<span class="op">/</span><span class="fl">2.2</span><span class="op">/</span><span class="fl">2.2</span>,</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">         <span class="dt">BMI =</span> weight <span class="op">/</span><span class="st"> </span>(height)<span class="op">^</span><span class="dv">2</span>, </a>
<a class="sourceLine" id="cb16-11" data-line-number="11">         <span class="dt">BMI =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(BMI), <span class="ot">NA</span>, BMI))</a>
<a class="sourceLine" id="cb16-12" data-line-number="12"></a>
<a class="sourceLine" id="cb16-13" data-line-number="13">addhealth_match &lt;-<span class="st"> </span>addhealth_out <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-14" data-line-number="14"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;physhlthevnt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="st">  </span><span class="kw">select</span>(p_year, SID, <span class="dt">physhlthevnt =</span> past) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-16" data-line-number="16"><span class="st">  </span><span class="kw">full_join</span>(addhealth_match) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-17" data-line-number="17"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(drugs, weed), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(.), <span class="dv">0</span>, .))</a>
<a class="sourceLine" id="cb16-18" data-line-number="18">  <span class="co"># select(-yearBrth, -contains(&quot;dad&quot;), -contains(&quot;mom&quot;), -religion, </span></a>
<a class="sourceLine" id="cb16-19" data-line-number="19">  <span class="co">#        -gender, -parDivorce, -numSiblng, -religion, -race, -SRhealth) %&gt;%</span></a>
<a class="sourceLine" id="cb16-20" data-line-number="20">  <span class="co"># full_join(addhealth_dem)</span></a>
<a class="sourceLine" id="cb16-21" data-line-number="21"></a>
<a class="sourceLine" id="cb16-22" data-line-number="22">addhealth_out &lt;-<span class="st"> </span>addhealth_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-23" data-line-number="23"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>past, <span class="op">-</span>future) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-24" data-line-number="24"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb16-25" data-line-number="25"></a>
<a class="sourceLine" id="cb16-26" data-line-number="26"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(addhealth_match2)]</a>
<a class="sourceLine" id="cb16-27" data-line-number="27"></a>
<a class="sourceLine" id="cb16-28" data-line-number="28">addhealth_SCA &lt;-<span class="st"> </span>addhealth_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-29" data-line-number="29"><span class="st">  </span><span class="kw">select</span>(SID, p_year, <span class="kw">one_of</span>(<span class="kw">c</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name), <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;dadEdu&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-30" data-line-number="30"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-31" data-line-number="31"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-32" data-line-number="32"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(parEdu), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-33" data-line-number="33"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb16-34" data-line-number="34"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu)</a></code></pre></div>
<pre><code>## # A tibble: 19,515 x 16
##    SID   p_year   age gender grsWages  race physhlthevnt SRhealth smokes alcohol exercise
##    &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
##  1 5710…   1995    18      1    55000     2            0        4      1       1        2
##  2 5710…   1996    19      1    55000     2            0        4      1       1        2
##  3 5710…   2001    24      1    55000     2           NA        4      1       1        2
##  4 5710…   1995    19      1       NA     2            0       NA      1       1        1
##  5 5710…   1996    20      1       NA     2            0       NA      1       1        1
##  6 5710…   2001    25      1       NA     2           NA       NA      1       1        1
##  7 5710…   1995    16      0    45000     0            0        3      0       0        2
##  8 5710…   1996    17      0    45000     0            0        3      0       0        2
##  9 5710…   2001    22      0    45000     0            0        3      0       0        2
## 10 5710…   1995    18      0     9000    NA            0        1     NA       0       NA
## # … with 19,505 more rows, and 5 more variables: BMI &lt;dbl&gt;, parDivorce &lt;dbl&gt;,
## #   PhysFunc &lt;int&gt;, religion &lt;dbl&gt;, parEdu &lt;dbl&gt;</code></pre>
</div>
<div id="imputation" class="section level3">
<h3><span class="header-section-number">2.1.6</span> Imputation</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co"># short helper functions to (1) identify and create factors, save col names of factors, remove columns with all missing values, and setup amelia</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2">factor_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){<span class="cf">if</span>(<span class="kw">is.numeric</span>(x)){<span class="kw">diff</span>(<span class="kw">range</span>(x, <span class="dt">na.rm =</span> T)) <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span>} <span class="cf">else</span>{F}}</a>
<a class="sourceLine" id="cb18-3" data-line-number="3">not_all_na &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">any</span>(<span class="op">!</span><span class="kw">is.na</span>(x))</a>
<a class="sourceLine" id="cb18-4" data-line-number="4">mice_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">  df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>bioParinHH, <span class="op">-</span>ageMarried, <span class="op">-</span>chldAgeHlthProb, <span class="op">-</span>childHlthProb, <span class="op">-</span>dadInHH,<span class="op">-</span>momInHH, <span class="op">-</span>parReligion, <span class="op">-</span>liveMom, <span class="op">-</span>yearsNoMom, <span class="op">-</span>yearsNoDad, <span class="op">-</span>yearMoveUS)</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">  <span class="kw">mice</span>(df, <span class="dt">m =</span> <span class="dv">5</span>, <span class="dt">maxit=</span><span class="dv">5</span>, <span class="dt">printFlag=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb18-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb18-8" data-line-number="8">start &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">addhealth_match_imp &lt;-<span class="st"> </span>addhealth_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">NegAff =</span> <span class="st">`</span><span class="dt">NA</span><span class="st">`</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate_if</span>(factor_fun, as.factor) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="st">  </span><span class="kw">group_by</span>(p_year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-13" data-line-number="13"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-14" data-line-number="14"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-15" data-line-number="15"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_na)),</a>
<a class="sourceLine" id="cb18-16" data-line-number="16">         <span class="dt">imp =</span> <span class="kw">map</span>(data, mice_fun))</a>
<a class="sourceLine" id="cb18-17" data-line-number="17">beepr<span class="op">::</span><span class="kw">beep</span>(<span class="dt">sound =</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb18-18" data-line-number="18"><span class="kw">print</span>(<span class="kw">Sys.time</span>() <span class="op">-</span><span class="st"> </span>start)</a>
<a class="sourceLine" id="cb18-19" data-line-number="19"></a>
<a class="sourceLine" id="cb18-20" data-line-number="20">addhealth_match_imp &lt;-<span class="st"> </span>addhealth_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp, <span class="op">~</span>mice<span class="op">::</span><span class="kw">complete</span>(., <span class="st">&quot;long&quot;</span>)),</a>
<a class="sourceLine" id="cb18-22" data-line-number="22">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>PhysFunc)  <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">PhysFunc =</span> <span class="kw">ifelse</span>(physFunc <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>))),</a>
<a class="sourceLine" id="cb18-23" data-line-number="23">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-24" data-line-number="24"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-25" data-line-number="25"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-26" data-line-number="26"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu)),</a>
<a class="sourceLine" id="cb18-27" data-line-number="27">         <span class="dt">imp_sca =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(.imp <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID,  <span class="kw">one_of</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name)))))</a>
<a class="sourceLine" id="cb18-28" data-line-number="28"></a>
<a class="sourceLine" id="cb18-29" data-line-number="29">addhealth_match_imp_long &lt;-<span class="st"> </span>addhealth_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-30" data-line-number="30"><span class="st">  </span><span class="kw">select</span>(p_year, imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-31" data-line-number="31"><span class="st">  </span><span class="kw">unnest</span>(imp_df)</a>
<a class="sourceLine" id="cb18-32" data-line-number="32"></a>
<a class="sourceLine" id="cb18-33" data-line-number="33">addhealth_SCA_imp &lt;-<span class="st"> </span>addhealth_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-34" data-line-number="34"><span class="st">  </span><span class="kw">select</span>(p_year, imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-35" data-line-number="35"><span class="st">  </span><span class="kw">unnest</span>(imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-36" data-line-number="36"><span class="st">  </span><span class="kw">left_join</span>(addhealth_SCA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(p_year, SID,</a>
<a class="sourceLine" id="cb18-37" data-line-number="37">        <span class="kw">colnames</span>(addhealth_SCA)[<span class="op">!</span><span class="kw">colnames</span>(addhealth_SCA) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(.)])) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-38" data-line-number="38"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">education =</span> <span class="kw">factor</span>(<span class="dv">0</span>), <span class="dt">married =</span> <span class="kw">factor</span>(<span class="dv">0</span>), <span class="dt">numKids =</span> <span class="dv">0</span>, <span class="dt">PhysFunc =</span> <span class="kw">factor</span>(PhysFunc))</a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw">save</span>(addhealth_match_imp_long, addhealth_SCA_imp, </a>
<a class="sourceLine" id="cb19-2" data-line-number="2">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/addhealth_imputed_small.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb19-3" data-line-number="3"><span class="kw">save</span>(addhealth_match_imp, </a>
<a class="sourceLine" id="cb19-4" data-line-number="4">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/addhealth_imputed.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="kw">save</span>(addhealth_alpha, addhealth_pers, addhealth_out, addhealth_match, addhealth_SCA,</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/addhealth_cleaned.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb19-7" data-line-number="7"><span class="kw">save</span>(addhealth_long, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/addhealth_raw_long.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb19-8" data-line-number="8"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;addhealth&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;addhealth&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
</div>
</div>
<div id="us" class="section level2">
<h2><span class="header-section-number">2.2</span> US</h2>
<div id="load-data-1" class="section level3">
<h3><span class="header-section-number">2.2.1</span> Load Data</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">us_read_fun &lt;-<span class="st"> </span><span class="cf">function</span>(Year, WL){</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">  old.names &lt;-<span class="st"> </span>(us_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>Year <span class="op">|</span><span class="st"> </span>year <span class="op">==</span><span class="st"> </span><span class="dv">0</span>))<span class="op">$</span>orig_itemname</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">  keep &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;pidp&quot;</span>, <span class="kw">sprintf</span>(<span class="st">&quot;%s_hidp&quot;</span>, WL))</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">  <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/us/%s_indresp.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="st">    </span><span class="kw">select</span>(<span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="st">    </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span><span class="kw">one_of</span>(keep), <span class="dt">na.rm =</span> T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-8" data-line-number="8"><span class="st">    </span><span class="kw">set_names</span>(<span class="kw">c</span>(<span class="st">&quot;HHID&quot;</span>, <span class="st">&quot;PID&quot;</span>, <span class="st">&quot;orig_itemname&quot;</span>, <span class="st">&quot;value&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-9" data-line-number="9"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">as.numeric</span>(value))</a>
<a class="sourceLine" id="cb21-10" data-line-number="10">}</a></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">us_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;US&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">orig_itemname =</span> <span class="kw">str_to_lower</span>(orig_itemname))</a>
<a class="sourceLine" id="cb22-3" data-line-number="3">us_codebook</a></code></pre></div>
<pre><code>## # A tibble: 235 x 17
##    study dataset category name  itemname  wave waveletter  year new_itemname orig_itemname
##    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;        
##  1 US    xwaved… out      chld… chldbrth     0 &lt;NA&gt;           0 US__out_chl… ch1by_dv     
##  2 US    a_INDR… out      chld… chldbrth     1 a           2009 US__out_chl… a_ch1by4     
##  3 US    b_INDR… out      chld… chldbrth     2 b           2010 US__out_chl… b_ch1by4     
##  4 US    c_INDR… out      chld… chldbrth     3 c           2011 US__out_chl… c_ch1by4     
##  5 US    d_INDR… out      chld… chldbrth     4 d           2012 US__out_chl… d_ch1by4     
##  6 US    e_INDR… out      chld… chldbrth     5 e           2013 US__out_chl… e_ch1by4     
##  7 US    f_INDR… out      chld… chldbrth     6 f           2014 US__out_chl… f_ch1by4     
##  8 US    g_INDR… out      chld… chldbrth     7 g           2015 US__out_chl… g_ch1by4     
##  9 US    h_INDR… out      chld… chldbrth     8 h           2016 US__out_chl… h_ch1by4     
## 10 US    i_INDR… out      chld… chldbrth     9 i           2017 US__out_chl… i_ch1by4     
## # … with 225 more rows, and 7 more variables: description &lt;chr&gt;, scale &lt;chr&gt;,
## #   reverse_code &lt;lgl&gt;, recode &lt;chr&gt;, mini &lt;lgl&gt;, maxi &lt;lgl&gt;, comp_rule &lt;chr&gt;</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">us_xwaveid &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/us/xwaveid.sav&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">read_sav</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(hhorig <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span><span class="op">:</span><span class="dv">6</span>))</a>
<a class="sourceLine" id="cb24-3" data-line-number="3"></a>
<a class="sourceLine" id="cb24-4" data-line-number="4">us &lt;-<span class="st"> </span>us_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(wave, waveletter, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-6" data-line-number="6"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(year, waveletter, us_read_fun)) </a>
<a class="sourceLine" id="cb24-9" data-line-number="9"></a>
<a class="sourceLine" id="cb24-10" data-line-number="10">us_long &lt;-<span class="st"> </span>us <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-11" data-line-number="11"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb24-12" data-line-number="12"></a>
<a class="sourceLine" id="cb24-13" data-line-number="13"><span class="kw">save</span>(us, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/us_raw.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb24-14" data-line-number="14"><span class="kw">rm</span>(us)</a></code></pre></div>
</div>
<div id="outcome-variables-1" class="section level3">
<h3><span class="header-section-number">2.2.2</span> Outcome Variables</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">bhps_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;BHPS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"></a>
<a class="sourceLine" id="cb25-3" data-line-number="3">us_out &lt;-<span class="st"> </span>us_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-6" data-line-number="6"><span class="st">  </span><span class="co"># full_join(crossing(name = unique((.)$name), p_year = bhps_waves$Used)) %&gt;%</span></a>
<a class="sourceLine" id="cb25-7" data-line-number="7"><span class="st">  </span><span class="kw">left_join</span>(us_long) </a>
<a class="sourceLine" id="cb25-8" data-line-number="8"></a>
<a class="sourceLine" id="cb25-9" data-line-number="9"><span class="co"># recode</span></a>
<a class="sourceLine" id="cb25-10" data-line-number="10">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb25-11" data-line-number="11">  <span class="kw">print</span>(rule)</a>
<a class="sourceLine" id="cb25-12" data-line-number="12">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb25-13" data-line-number="13">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb25-14" data-line-number="14">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb25-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb25-16" data-line-number="16"></a>
<a class="sourceLine" id="cb25-17" data-line-number="17">us_out &lt;-<span class="st"> </span>us_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-18" data-line-number="18"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, reverse_code<span class="op">:</span>comp_rule, PID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-19" data-line-number="19"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-20" data-line-number="20"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-21" data-line-number="21"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-22" data-line-number="22"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb25-23" data-line-number="23"><span class="st">  </span><span class="kw">unnest</span>(data) </a></code></pre></div>
<pre><code>## # A tibble: 9,282,789 x 10
##    recode               name   itemname  year reverse_code mini  maxi  comp_rule    PID value
##    &lt;chr&gt;                &lt;chr&gt;  &lt;chr&gt;    &lt;dbl&gt; &lt;lgl&gt;        &lt;lgl&gt; &lt;lgl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;
##  1 ifelse(x &lt; 0 &amp; !is.… chldb… chldbrth  2009 NA           NA    NA    max       6.80e7     0
##  2 ifelse(x &lt; 0 &amp; !is.… chldb… chldbrth  2009 NA           NA    NA    max       6.80e7     0
##  3 ifelse(x &lt; 0 &amp; !is.… chldb… chldbrth  2009 NA           NA    NA    max       6.80e7     0
##  4 ifelse(x &lt; 0 &amp; !is.… chldb… chldbrth  2009 NA           NA    NA    max       6.80e7     0
##  5 ifelse(x &lt; 0 &amp; !is.… chldb… chldbrth  2009 NA           NA    NA    max       6.80e7     0
##  6 ifelse(x &lt; 0 &amp; !is.… chldb… chldbrth  2009 NA           NA    NA    max       6.80e7     0
##  7 ifelse(x &lt; 0 &amp; !is.… chldb… chldbrth  2009 NA           NA    NA    max       6.80e7     0
##  8 ifelse(x &lt; 0 &amp; !is.… chldb… chldbrth  2009 NA           NA    NA    max       6.80e7     0
##  9 ifelse(x &lt; 0 &amp; !is.… chldb… chldbrth  2009 NA           NA    NA    max       6.80e7     0
## 10 ifelse(x &lt; 0 &amp; !is.… chldb… chldbrth  2009 NA           NA    NA    max       6.80e7     0
## # … with 9,282,779 more rows</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">save</span>(us_out, </a>
<a class="sourceLine" id="cb27-2" data-line-number="2">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/us_cleaned.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="kw">save</span>(us_long, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/us_raw_long.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="kw">rm</span>(us_long)</a></code></pre></div>
</div>
</div>
<div id="bhps" class="section level2">
<h2><span class="header-section-number">2.3</span> BHPS</h2>
<p>The British Household Panel Study (BHPS; University of Essex, 2018) is a longitudinal study of households in the United Kingdom. These data are available online, through application, from <a href="https://www.iser.essex.ac.uk/bhps/about/latest-release-of-bhps-data" class="uri">https://www.iser.essex.ac.uk/bhps/about/latest-release-of-bhps-data</a>.</p>
<p>Participants were recruited from more than 15,000 individuals from approximately 8,000 households in the United Kingdom. Data have been collected annually since 1991 from approximately 10,000 individuals (5,500 households) in Great Britain but expanded to include Scotland and Wales in 1999 and Northern Ireland in 2001. In 2010, the BHPS stopped data collection, but 6,700 of the current 8,000 participants were solicited to become part of the broader Understanding Society study (University of Essex, 2019). Participants can be matched across studies, so I will use additional data on the original BHPS participants from the Understanding Society study for additional waves of outcome data.</p>
<p>Sample sizes vary by year, ranging from 10,264 (1991) to 14419 (2008). This provides 99% power to detect a zero-order correlation effect size of ~.05, two-tailed at alpha .05.</p>
<div id="load-data-2" class="section level3">
<h3><span class="header-section-number">2.3.1</span> Load Data</h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">bhps_read_fun &lt;-<span class="st"> </span><span class="cf">function</span>(Year, WL){</a>
<a class="sourceLine" id="cb28-2" data-line-number="2">  old.names &lt;-<span class="st"> </span>(bhps_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>Year <span class="op">|</span><span class="st"> </span>year <span class="op">==</span><span class="st"> </span><span class="dv">0</span>))<span class="op">$</span>orig_itemname</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">  keep &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;pidp&quot;</span>, <span class="kw">sprintf</span>(<span class="st">&quot;%shid&quot;</span>, WL))</a>
<a class="sourceLine" id="cb28-4" data-line-number="4">  <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/bhps/%sindresp.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-5" data-line-number="5"><span class="st">    </span><span class="kw">full_join</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/data/bhps/%segoalt.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-6" data-line-number="6"><span class="st">    </span><span class="kw">full_join</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/data/bhps/%shhresp.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-7" data-line-number="7"><span class="st">    </span><span class="kw">full_join</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/data/bhps/%sincome.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-8" data-line-number="8"><span class="st">    </span><span class="kw">full_join</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/data/bhps/%sjobhist.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-9" data-line-number="9"><span class="st">    </span><span class="kw">select</span>(<span class="kw">one_of</span>(keep), <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-10" data-line-number="10"><span class="st">    </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-11" data-line-number="11"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span><span class="kw">one_of</span>(keep), <span class="dt">na.rm =</span> T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-12" data-line-number="12"><span class="st">    </span><span class="kw">set_names</span>(<span class="kw">c</span>(<span class="st">&quot;PID&quot;</span>, <span class="st">&quot;HHID&quot;</span>, <span class="st">&quot;orig_itemname&quot;</span>, <span class="st">&quot;value&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb28-13" data-line-number="13"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">as.numeric</span>(value))</a>
<a class="sourceLine" id="cb28-14" data-line-number="14">}</a></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">bhps_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;BHPS&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">orig_itemname =</span> <span class="kw">str_to_lower</span>(orig_itemname))</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">bhps_codebook</a></code></pre></div>
<pre><code>## # A tibble: 1,878 x 23
##    study dataset category name  itemname  wave waveletter  year new_itemname orig_itemname
##    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;        
##  1 bhps  aINDRE… match    acci… numAcci…     1 a           1991 bhps__match… anxdts       
##  2 bhps  bINDRE… match    acci… numAcci…     2 b           1992 bhps__match… bnxdts       
##  3 bhps  cINDRE… match    acci… numAcci…     3 c           1993 bhps__match… cnxdts       
##  4 bhps  dINDRE… match    acci… numAcci…     4 d           1994 bhps__match… dnxdts       
##  5 bhps  eINDRE… match    acci… numAcci…     5 e           1995 bhps__match… enxdts       
##  6 bhps  fINDRE… match    acci… numAcci…     6 f           1996 bhps__match… fnxdts       
##  7 bhps  gINDRE… match    acci… numAcci…     7 g           1997 bhps__match… gnxdts       
##  8 bhps  hINDRE… match    acci… numAcci…     8 h           1998 bhps__match… hnxdts       
##  9 bhps  iINDRE… match    acci… numAcci…     9 i           1999 bhps__match… inxdts       
## 10 bhps  jINDRE… match    acci… numAcci…    10 j           2000 bhps__match… jnxdts       
## # … with 1,868 more rows, and 13 more variables: description &lt;chr&gt;, scale &lt;chr&gt;,
## #   reverse_code &lt;chr&gt;, recode &lt;chr&gt;, mini &lt;dbl&gt;, maxi &lt;dbl&gt;, comp_rule &lt;chr&gt;, ...18 &lt;chr&gt;,
## #   ...19 &lt;chr&gt;, ...20 &lt;chr&gt;, ...21 &lt;chr&gt;, ...22 &lt;chr&gt;, ...23 &lt;chr&gt;</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">bhps_xwaveid &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/bhps/xwaveid.sav&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">read_sav</span>()</a>
<a class="sourceLine" id="cb31-2" data-line-number="2"></a>
<a class="sourceLine" id="cb31-3" data-line-number="3">bhps &lt;-<span class="st"> </span>bhps_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(wave, waveletter, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-5" data-line-number="5"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb31-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(year, waveletter, bhps_read_fun)) </a>
<a class="sourceLine" id="cb31-8" data-line-number="8"></a>
<a class="sourceLine" id="cb31-9" data-line-number="9">bhps_long &lt;-<span class="st"> </span>bhps <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-10" data-line-number="10"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-11" data-line-number="11"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">SID =</span> PID) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-12" data-line-number="12"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb31-13" data-line-number="13"></a>
<a class="sourceLine" id="cb31-14" data-line-number="14"><span class="kw">save</span>(bhps, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/bhps_raw.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb31-15" data-line-number="15"><span class="kw">rm</span>(bhps)</a></code></pre></div>
</div>
<div id="matching-variables-1" class="section level3">
<h3><span class="header-section-number">2.3.2</span> Matching Variables</h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, year){</a>
<a class="sourceLine" id="cb32-2" data-line-number="2">  <span class="kw">print</span>(rule)</a>
<a class="sourceLine" id="cb32-3" data-line-number="3">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb32-4" data-line-number="4">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb32-5" data-line-number="5">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb32-6" data-line-number="6">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb32-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb32-8" data-line-number="8"></a>
<a class="sourceLine" id="cb32-9" data-line-number="9"><span class="co"># rename variables   </span></a>
<a class="sourceLine" id="cb32-10" data-line-number="10">bhps_match &lt;-<span class="st"> </span>bhps_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-12" data-line-number="12"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>wave, <span class="op">-</span>waveletter) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-13" data-line-number="13"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-14" data-line-number="14"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-15" data-line-number="15"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(bhps_long))) </a>
<a class="sourceLine" id="cb32-17" data-line-number="17"></a>
<a class="sourceLine" id="cb32-18" data-line-number="18">yrBrth  &lt;-<span class="st"> </span>bhps_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-19" data-line-number="19"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-20" data-line-number="20"><span class="st">  </span><span class="kw">left_join</span>(bhps_long) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-21" data-line-number="21"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-22" data-line-number="22"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-23" data-line-number="23"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">yearBrth =</span> <span class="kw">Mode</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-24" data-line-number="24"><span class="st">  </span><span class="kw">ungroup</span>() </a>
<a class="sourceLine" id="cb32-25" data-line-number="25"></a>
<a class="sourceLine" id="cb32-26" data-line-number="26">bhps_match &lt;-<span class="st"> </span>bhps_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-27" data-line-number="27"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-28" data-line-number="28"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">full_join</span>(yrBrth)))</a>
<a class="sourceLine" id="cb32-29" data-line-number="29"></a>
<a class="sourceLine" id="cb32-30" data-line-number="30"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb32-31" data-line-number="31">bhps_match &lt;-<span class="st"> </span>bhps_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-32" data-line-number="32"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-33" data-line-number="33"><span class="st">    </span><span class="kw">select</span>(SID, year, recode, itemname, value, yearBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-34" data-line-number="34"><span class="st">    </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-35" data-line-number="35"><span class="st">    </span><span class="kw">group_by</span>(recode, year, itemname) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-36" data-line-number="36"><span class="st">    </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-37" data-line-number="37"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-38" data-line-number="38"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-39" data-line-number="39"><span class="st">    </span><span class="kw">unnest</span>(data)))</a>
<a class="sourceLine" id="cb32-40" data-line-number="40"></a>
<a class="sourceLine" id="cb32-41" data-line-number="41">bhps_htwt &lt;-<span class="st"> </span>bhps_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-42" data-line-number="42"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;height&quot;</span>, <span class="st">&quot;weight&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-43" data-line-number="43"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-44" data-line-number="44"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-45" data-line-number="45"><span class="st">  </span><span class="kw">select</span>(year, name, itemname, value, SID) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-46" data-line-number="46"><span class="st">  </span><span class="kw">group_by</span>(SID, itemname, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-47" data-line-number="47"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st">  </span></a>
<a class="sourceLine" id="cb32-48" data-line-number="48"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-49" data-line-number="49"><span class="st">  </span><span class="kw">spread</span>(itemname, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-50" data-line-number="50"><span class="st">  </span><span class="co"># filter(weightStn != 0) %&gt;%</span></a>
<a class="sourceLine" id="cb32-51" data-line-number="51"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">height =</span> <span class="kw">rowSums</span>(<span class="kw">cbind</span>(heightft, heightin), <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb32-52" data-line-number="52">         <span class="dt">weight =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(weightStn), weightkg, <span class="kw">rowSums</span>(<span class="kw">cbind</span>(weightlbs, weightStn), <span class="dt">na.rm =</span> T)),</a>
<a class="sourceLine" id="cb32-53" data-line-number="53">         <span class="dt">height =</span> height<span class="op">/</span><span class="dv">100</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-54" data-line-number="54"><span class="st">  </span><span class="kw">filter</span>(height <span class="op">&gt;</span><span class="st"> </span><span class="fl">.5</span> <span class="op">&amp;</span><span class="st"> </span>height <span class="op">&lt;</span><span class="st"> </span><span class="fl">2.5</span> <span class="op">&amp;</span><span class="st"> </span>weight <span class="op">&gt;</span><span class="st"> </span><span class="dv">20</span> <span class="op">&amp;</span><span class="st"> </span>weight <span class="op">&lt;</span><span class="st"> </span><span class="dv">150</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-55" data-line-number="55"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">BMI =</span> weight <span class="op">/</span><span class="st"> </span>(height)<span class="op">^</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb32-56" data-line-number="56">         <span class="dt">BMI =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(BMI), <span class="ot">NA</span>, BMI)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-57" data-line-number="57"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>heightft, <span class="op">-</span>heightin, <span class="op">-</span>weightlbs, <span class="op">-</span>weightStn, <span class="op">-</span>weightkg, <span class="op">-</span>year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-58" data-line-number="58"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> name, <span class="dt">value =</span> value, height, weight, BMI) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-59" data-line-number="59"><span class="st">  </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-60" data-line-number="60"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-61" data-line-number="61"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-62" data-line-number="62"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-63" data-line-number="63"><span class="st">  </span><span class="kw">mutate_all</span>(<span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(.), <span class="ot">NA</span>, .))</a>
<a class="sourceLine" id="cb32-64" data-line-number="64"></a>
<a class="sourceLine" id="cb32-65" data-line-number="65">bhps_relig &lt;-<span class="st"> </span>bhps_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-66" data-line-number="66"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;religion&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-67" data-line-number="67"><span class="st">  </span><span class="kw">left_join</span>(bhps_long) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-68" data-line-number="68"><span class="st">  </span><span class="kw">group_by</span>(year, recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-69" data-line-number="69"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-70" data-line-number="70"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-71" data-line-number="71"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-72" data-line-number="72"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-73" data-line-number="73"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-74" data-line-number="74"><span class="st">  </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-75" data-line-number="75"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">Mode</span>(value))</a>
<a class="sourceLine" id="cb32-76" data-line-number="76">  </a>
<a class="sourceLine" id="cb32-77" data-line-number="77"></a>
<a class="sourceLine" id="cb32-78" data-line-number="78"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb32-79" data-line-number="79">bhps_match &lt;-<span class="st"> </span>bhps_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-80" data-line-number="80"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-81" data-line-number="81"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-82" data-line-number="82"><span class="st">    </span><span class="kw">left_join</span>(bhps_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(year, itemname, reverse_code, mini<span class="op">:</span>comp_rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-83" data-line-number="83"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))))</a>
<a class="sourceLine" id="cb32-84" data-line-number="84"></a>
<a class="sourceLine" id="cb32-85" data-line-number="85">parIDs &lt;-<span class="st"> </span>bhps_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-86" data-line-number="86"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;momID&quot;</span>, <span class="st">&quot;dadID&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-87" data-line-number="87"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-88" data-line-number="88"><span class="st">  </span><span class="kw">select</span>(SID, year, <span class="dt">parID =</span> name, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-89" data-line-number="89"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-90" data-line-number="90"><span class="st">  </span><span class="kw">filter</span>(value <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-91" data-line-number="91"><span class="st">  </span><span class="kw">group_by</span>(SID, parID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-92" data-line-number="92"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-93" data-line-number="93"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-94" data-line-number="94"><span class="st">  </span><span class="kw">spread</span>(parID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-95" data-line-number="95"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(momID, dadID),</a>
<a class="sourceLine" id="cb32-96" data-line-number="96">     <span class="op">~</span><span class="kw">mapvalues</span>(., bhps_xwaveid<span class="op">$</span>pid, bhps_xwaveid<span class="op">$</span>pidp, <span class="dt">warn_missing =</span> F))</a>
<a class="sourceLine" id="cb32-97" data-line-number="97"></a>
<a class="sourceLine" id="cb32-98" data-line-number="98">parWages &lt;-<span class="st"> </span>bhps_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-99" data-line-number="99"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;grsWages&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-100" data-line-number="100"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-101" data-line-number="101"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">momID =</span> SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-102" data-line-number="102"><span class="st">  </span><span class="kw">right_join</span>(parIDs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(momID, SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-103" data-line-number="103"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-104" data-line-number="104"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">itemname =</span> <span class="st">&quot;momGrsWages&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-105" data-line-number="105"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>(reverse_code<span class="op">:</span>maxi), <span class="op">-</span>momID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-106" data-line-number="106"><span class="st">  </span><span class="kw">full_join</span>(</a>
<a class="sourceLine" id="cb32-107" data-line-number="107">bhps_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-108" data-line-number="108"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;grsWages&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-109" data-line-number="109"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-110" data-line-number="110"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">dadID =</span> SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-111" data-line-number="111"><span class="st">  </span><span class="kw">right_join</span>(parIDs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(dadID, SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-112" data-line-number="112"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-113" data-line-number="113"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">itemname =</span> <span class="st">&quot;dadGrsWages&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-114" data-line-number="114"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>(reverse_code<span class="op">:</span>maxi), <span class="op">-</span>dadID)</a>
<a class="sourceLine" id="cb32-115" data-line-number="115">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-116" data-line-number="116"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;parGrsWages&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-117" data-line-number="117"><span class="st">  </span><span class="kw">group_by</span>(year, name,  SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-118" data-line-number="118"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-119" data-line-number="119"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-120" data-line-number="120"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">parGrsWages =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-121" data-line-number="121"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb32-122" data-line-number="122"></a>
<a class="sourceLine" id="cb32-123" data-line-number="123">fun_call &lt;-<span class="st"> </span><span class="cf">function</span>(x, rule){</a>
<a class="sourceLine" id="cb32-124" data-line-number="124">    <span class="cf">switch</span>(rule,</a>
<a class="sourceLine" id="cb32-125" data-line-number="125">           <span class="dt">average =</span> <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb32-126" data-line-number="126">           <span class="dt">mode =</span> <span class="kw">Mode</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb32-127" data-line-number="127">           <span class="dt">sum =</span> <span class="kw">sum</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb32-128" data-line-number="128">           <span class="dt">skip =</span> <span class="kw">unique</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb32-129" data-line-number="129">           <span class="dt">max =</span> <span class="kw">max</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb32-130" data-line-number="130">           <span class="dt">min =</span> <span class="kw">min</span>(x, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb32-131" data-line-number="131">  }</a>
<a class="sourceLine" id="cb32-132" data-line-number="132"></a>
<a class="sourceLine" id="cb32-133" data-line-number="133"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb32-134" data-line-number="134">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb32-135" data-line-number="135">  rule &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(rule), <span class="st">&quot;skip&quot;</span>, rule)</a>
<a class="sourceLine" id="cb32-136" data-line-number="136">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-137" data-line-number="137"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb32-138" data-line-number="138"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-139" data-line-number="139"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-140" data-line-number="140"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value)) </a>
<a class="sourceLine" id="cb32-141" data-line-number="141">}</a>
<a class="sourceLine" id="cb32-142" data-line-number="142"></a>
<a class="sourceLine" id="cb32-143" data-line-number="143">bhps_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;BHPS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb32-144" data-line-number="144"></a>
<a class="sourceLine" id="cb32-145" data-line-number="145">bhps_match &lt;-<span class="st"> </span>bhps_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-146" data-line-number="146"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-147" data-line-number="147"><span class="st">    </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-148" data-line-number="148"><span class="st">    </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="kw">max</span>(bhps_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-149" data-line-number="149"><span class="st">    </span><span class="kw">group_by</span>(comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-150" data-line-number="150"><span class="st">    </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-151" data-line-number="151"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-152" data-line-number="152"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-153" data-line-number="153"><span class="st">    </span><span class="kw">unnest</span>(data))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-154" data-line-number="154"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb32-155" data-line-number="155"></a>
<a class="sourceLine" id="cb32-156" data-line-number="156">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, p_year){</a>
<a class="sourceLine" id="cb32-157" data-line-number="157">  rule &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(rule), <span class="st">&quot;skip&quot;</span>, rule)</a>
<a class="sourceLine" id="cb32-158" data-line-number="158">  bhps_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-159" data-line-number="159"><span class="st">    </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span>p_year  <span class="op">&amp;</span><span class="st"> </span>comp_rule <span class="op">==</span><span class="st"> </span>rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-160" data-line-number="160"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-161" data-line-number="161"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-162" data-line-number="162"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-163" data-line-number="163"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb32-164" data-line-number="164">}</a>
<a class="sourceLine" id="cb32-165" data-line-number="165"></a>
<a class="sourceLine" id="cb32-166" data-line-number="166">bhps_match &lt;-<span class="st"> </span><span class="kw">crossing</span>(</a>
<a class="sourceLine" id="cb32-167" data-line-number="167">  <span class="dt">p_year =</span> bhps_waves<span class="op">$</span>Used, </a>
<a class="sourceLine" id="cb32-168" data-line-number="168">  <span class="dt">comp_rule =</span> <span class="kw">unique</span>(bhps_match<span class="op">$</span>comp_rule)</a>
<a class="sourceLine" id="cb32-169" data-line-number="169">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-170" data-line-number="170"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(comp_rule, p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-171" data-line-number="171"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-172" data-line-number="172"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-173" data-line-number="173"><span class="st">  </span><span class="kw">filter</span>(name  <span class="op">!=</span><span class="st"> &quot;HHID&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-174" data-line-number="174"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> name, <span class="dt">values_from =</span> value, <span class="dt">values_fn =</span> <span class="kw">list</span>(<span class="dt">value =</span> <span class="op">~</span><span class="kw">max</span>(., <span class="dt">na.rm =</span> T))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-175" data-line-number="175"><span class="st">  </span><span class="kw">mutate_all</span>(<span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-176" data-line-number="176"><span class="st">  </span><span class="kw">full_join</span>(bhps_htwt) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-177" data-line-number="177"><span class="st">  </span><span class="kw">full_join</span>(parWages) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-178" data-line-number="178"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(p_year))</a></code></pre></div>
<pre><code>## # A tibble: 95,699 x 67
##      SID p_year     A     C   DEP     E   LOC     N     O    OP    SE    SS   SWB   SWL
##    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  9527   1996    NA    NA  1.83    NA    NA    NA    NA    NA     1    NA    10     4
##  2 12251   1996    NA    NA  1.83    NA    NA    NA    NA    NA     1    NA    10     5
##  3 12935   1996    NA    NA  1       NA    NA    NA    NA    NA     1    NA     0     4
##  4 14287   1996    NA    NA  1.92    NA    NA    NA    NA    NA     2    NA    11     5
##  5 14971   1996    NA    NA  2.75    NA    NA    NA    NA    NA     3    NA    21     2
##  6 15645   1996    NA    NA  2.5     NA    NA    NA    NA    NA     3    NA    18     2
##  7 16339   1996    NA    NA NA       NA    NA    NA    NA    NA    NA    NA    NA    NA
##  8 17687   1996    NA    NA  1.75    NA    NA    NA    NA    NA     1    NA     9     6
##  9 21087   1996    NA    NA  1.92    NA    NA    NA    NA    NA     1    NA    11     3
## 10 21767   1996    NA    NA  2.08    NA    NA    NA    NA    NA     1    NA    13     3
## # … with 95,689 more rows, and 53 more variables: yearBrth &lt;dbl&gt;, drVisits &lt;dbl&gt;,
## #   genderRoles &lt;dbl&gt;, grsWages &lt;dbl&gt;, nbhdQual &lt;dbl&gt;, SRhealth &lt;dbl&gt;, religiosity &lt;dbl&gt;,
## #   exercise &lt;dbl&gt;, satFam &lt;dbl&gt;, satHH &lt;dbl&gt;, accidents &lt;dbl&gt;, disability &lt;dbl&gt;,
## #   education &lt;dbl&gt;, employed &lt;dbl&gt;, homeHelp &lt;dbl&gt;, married &lt;dbl&gt;, smokes &lt;dbl&gt;,
## #   unempBen &lt;dbl&gt;, welfare &lt;dbl&gt;, mvdBigSlry &lt;dbl&gt;, mvdForWork &lt;dbl&gt;, numKids &lt;dbl&gt;,
## #   debt &lt;dbl&gt;, investments &lt;dbl&gt;, savings &lt;dbl&gt;, PhysFunc &lt;dbl&gt;, dadID &lt;dbl&gt;,
## #   dentalIns &lt;dbl&gt;, dentist &lt;dbl&gt;, domesticDuties &lt;dbl&gt;, eyeDr &lt;dbl&gt;, eyeDrIns &lt;dbl&gt;,
## #   gender &lt;dbl&gt;, momID &lt;dbl&gt;, prvntvHlthChcks &lt;dbl&gt;, neighbors &lt;dbl&gt;, satSchl &lt;dbl&gt;,
## #   ageMarried &lt;dbl&gt;, weight &lt;dbl&gt;, height &lt;dbl&gt;, momAgeAtBrth &lt;dbl&gt;, numSiblng &lt;dbl&gt;,
## #   BMI &lt;dbl&gt;, parGrsWages &lt;dbl&gt;, physhlthevnt &lt;dbl&gt;, age &lt;dbl&gt;, dadEdu &lt;dbl&gt;,
## #   dadOccPrstg &lt;dbl&gt;, momEdu &lt;dbl&gt;, momOccPrstg &lt;dbl&gt;, parDivorce &lt;dbl&gt;, race &lt;dbl&gt;,
## #   religion &lt;dbl&gt;</code></pre>
</div>
<div id="personality-variables-1" class="section level3">
<h3><span class="header-section-number">2.3.3</span> Personality Variables</h3>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="co"># keep correct personality waves</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2">bhps_pers &lt;-<span class="st"> </span>bhps_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">reverse_code =</span> <span class="kw">tolower</span>(reverse_code)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;pers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-5" data-line-number="5"><span class="st">  </span><span class="kw">left_join</span>(bhps_long) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-6" data-line-number="6"><span class="st">  </span><span class="kw">left_join</span>(p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;BHPS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">name =</span> p_item, Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span>bhps_waves<span class="op">$</span>Used) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-8" data-line-number="8"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb34-9" data-line-number="9"></a>
<a class="sourceLine" id="cb34-10" data-line-number="10">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb34-11" data-line-number="11">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb34-12" data-line-number="12">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb34-13" data-line-number="13">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb34-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb34-15" data-line-number="15"></a>
<a class="sourceLine" id="cb34-16" data-line-number="16"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb34-17" data-line-number="17">bhps_pers &lt;-<span class="st"> </span>bhps_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-18" data-line-number="18"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, reverse_code<span class="op">:</span>comp_rule, SID<span class="op">:</span>value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-19" data-line-number="19"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-20" data-line-number="20"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-21" data-line-number="21"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-22" data-line-number="22"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-23" data-line-number="23"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb34-24" data-line-number="24"></a>
<a class="sourceLine" id="cb34-25" data-line-number="25"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb34-26" data-line-number="26">bhps_pers &lt;-<span class="st"> </span>bhps_pers <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-27" data-line-number="27"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb34-28" data-line-number="28"></a>
<a class="sourceLine" id="cb34-29" data-line-number="29"></a>
<a class="sourceLine" id="cb34-30" data-line-number="30"><span class="co"># alpha&#39;s</span></a>
<a class="sourceLine" id="cb34-31" data-line-number="31">bhps_alpha &lt;-<span class="st"> </span>bhps_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-32" data-line-number="32"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, SID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-33" data-line-number="33"><span class="st">  </span><span class="kw">group_by</span>(name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-34" data-line-number="34"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-35" data-line-number="35"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> itemname, <span class="dt">values_from =</span> value)),</a>
<a class="sourceLine" id="cb34-36" data-line-number="36">         <span class="dt">alpha =</span> <span class="kw">map</span>(data, <span class="kw">possibly</span>(<span class="op">~</span>psych<span class="op">::</span><span class="kw">alpha</span>((.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>SID)), <span class="ot">NA_real_</span>)))</a>
<a class="sourceLine" id="cb34-37" data-line-number="37"></a>
<a class="sourceLine" id="cb34-38" data-line-number="38">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb34-39" data-line-number="39">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-40" data-line-number="40"><span class="st">    </span><span class="kw">group_by</span>(SID, HHID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-41" data-line-number="41"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-42" data-line-number="42"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-43" data-line-number="43"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb34-44" data-line-number="44">}</a>
<a class="sourceLine" id="cb34-45" data-line-number="45"></a>
<a class="sourceLine" id="cb34-46" data-line-number="46"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb34-47" data-line-number="47">bhps_pers &lt;-<span class="st"> </span>bhps_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-48" data-line-number="48"><span class="st">  </span><span class="kw">group_by</span>(name, comp_rule, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-49" data-line-number="49"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-50" data-line-number="50"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-51" data-line-number="51"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-52" data-line-number="52"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb34-53" data-line-number="53"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule, <span class="op">-</span>HHID)</a></code></pre></div>
<pre><code>## # A tibble: 291,507 x 4
##    name   year   SID value
##    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 A      2005 14971  4   
##  2 A      2005 15645  6   
##  3 A      2005 16339 NA   
##  4 A      2005 17015  5.67
##  5 A      2005 22445  5.33
##  6 A      2005 23807  5.33
##  7 A      2005 27284  4   
##  8 A      2005 28575  3.67
##  9 A      2005 30615  5.67
## 10 A      2005 46927  4.67
## # … with 291,497 more rows</code></pre>
</div>
<div id="outcome-variables-2" class="section level3">
<h3><span class="header-section-number">2.3.4</span> Outcome Variables</h3>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1">bhps_subs &lt;-<span class="st"> </span><span class="kw">unique</span>(bhps_pers<span class="op">$</span>SID)</a>
<a class="sourceLine" id="cb36-2" data-line-number="2"></a>
<a class="sourceLine" id="cb36-3" data-line-number="3">us_out &lt;-<span class="st"> </span>us_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(PID <span class="op">%in%</span><span class="st"> </span>bhps_subs) </a>
<a class="sourceLine" id="cb36-4" data-line-number="4"></a>
<a class="sourceLine" id="cb36-5" data-line-number="5">exit &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/bhps/xwlsten.sav&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-6" data-line-number="6"><span class="st">  </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(<span class="dt">SID =</span> pidp, lrio, lewave) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lrio =</span> <span class="kw">ifelse</span>(lrio <span class="op">==</span><span class="st"> </span><span class="dv">99</span>, <span class="dv">1990</span> <span class="op">+</span><span class="st"> </span>lewave, <span class="ot">NA</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-9" data-line-number="9"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">SID =</span> <span class="kw">unique</span>((.)<span class="op">$</span>SID), <span class="dt">p_year =</span> bhps_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-10" data-line-number="10"><span class="st">  </span><span class="co"># filter(!value &lt; 0)</span></a>
<a class="sourceLine" id="cb36-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(lrio) <span class="op">|</span><span class="st"> </span>lrio <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="ot">NA</span>, lrio),</a>
<a class="sourceLine" id="cb36-12" data-line-number="12">         <span class="dt">value =</span> <span class="kw">ifelse</span>(year <span class="op">&lt;=</span><span class="st"> </span>p_year, <span class="ot">NA</span>, <span class="kw">ifelse</span>(<span class="kw">is.na</span>(year),  <span class="dv">0</span>, <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>p_year, <span class="dv">1</span>, <span class="ot">NA</span>)))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-13" data-line-number="13"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>year, <span class="op">-</span>lrio, <span class="op">-</span>lewave) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;mortality&quot;</span>)</a>
<a class="sourceLine" id="cb36-14" data-line-number="14"></a>
<a class="sourceLine" id="cb36-15" data-line-number="15">bhps_out &lt;-<span class="st"> </span>bhps_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb36-16" data-line-number="16"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-17" data-line-number="17"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-18" data-line-number="18"><span class="st">  </span><span class="kw">left_join</span>(bhps_long) </a>
<a class="sourceLine" id="cb36-19" data-line-number="19"></a>
<a class="sourceLine" id="cb36-20" data-line-number="20">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year){</a>
<a class="sourceLine" id="cb36-21" data-line-number="21">  <span class="kw">print</span>(rule)</a>
<a class="sourceLine" id="cb36-22" data-line-number="22">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb36-23" data-line-number="23">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb36-24" data-line-number="24">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb36-25" data-line-number="25">}</a>
<a class="sourceLine" id="cb36-26" data-line-number="26"></a>
<a class="sourceLine" id="cb36-27" data-line-number="27"><span class="co"># recode</span></a>
<a class="sourceLine" id="cb36-28" data-line-number="28">bhps_out &lt;-<span class="st"> </span>bhps_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-29" data-line-number="29"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, reverse_code<span class="op">:</span>comp_rule, SID<span class="op">:</span>value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-30" data-line-number="30"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">name =</span> <span class="kw">unique</span>((.)<span class="op">$</span>name), <span class="dt">p_year =</span> bhps_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-31" data-line-number="31"><span class="st">  </span><span class="kw">group_by</span>(recode, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-32" data-line-number="32"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-33" data-line-number="33"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-34" data-line-number="34"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-35" data-line-number="35"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb36-36" data-line-number="36"></a>
<a class="sourceLine" id="cb36-37" data-line-number="37"><span class="co"># composite within years </span></a>
<a class="sourceLine" id="cb36-38" data-line-number="38"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb36-39" data-line-number="39">bhps_out &lt;-<span class="st"> </span>bhps_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-40" data-line-number="40"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>(reverse_code<span class="op">:</span>maxi), <span class="op">-</span>HHID, <span class="op">-</span>recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-41" data-line-number="41"><span class="st">  </span><span class="kw">full_join</span>(us_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(p_year<span class="op">:</span>year, comp_rule, <span class="dt">SID =</span> PID, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-42" data-line-number="42"><span class="st">  </span><span class="kw">group_by</span>(SID, name, year, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-43" data-line-number="43"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-44" data-line-number="44"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-45" data-line-number="45"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb36-46" data-line-number="46"></a>
<a class="sourceLine" id="cb36-47" data-line-number="47"><span class="co"># composite across years</span></a>
<a class="sourceLine" id="cb36-48" data-line-number="48">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(p_year){</a>
<a class="sourceLine" id="cb36-49" data-line-number="49">  bhps_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-50" data-line-number="50"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>p_year, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;past&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-51" data-line-number="51"><span class="st">    </span><span class="kw">group_by</span>(SID, name, group,) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-52" data-line-number="52"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-53" data-line-number="53"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-54" data-line-number="54"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-55" data-line-number="55"><span class="st">    </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> group, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-56" data-line-number="56"><span class="st">    </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-57" data-line-number="57"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(past) <span class="op">|</span><span class="st"> </span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(future)), future,</a>
<a class="sourceLine" id="cb36-58" data-line-number="58">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(future), past, </a>
<a class="sourceLine" id="cb36-59" data-line-number="59">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)))) </a>
<a class="sourceLine" id="cb36-60" data-line-number="60">}</a>
<a class="sourceLine" id="cb36-61" data-line-number="61"></a>
<a class="sourceLine" id="cb36-62" data-line-number="62">bhps_out &lt;-<span class="st"> </span>bhps_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-63" data-line-number="63"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>p_year, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;past&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-64" data-line-number="64"><span class="st">  </span><span class="kw">group_by</span>(SID, name, group, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-65" data-line-number="65"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-66" data-line-number="66"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-67" data-line-number="67"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-68" data-line-number="68"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> group, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-69" data-line-number="69"><span class="st">  </span><span class="kw">group_by</span>(SID, name, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-70" data-line-number="70"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(past) <span class="op">|</span><span class="st"> </span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(future)), future,</a>
<a class="sourceLine" id="cb36-71" data-line-number="71">                 <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(future), past, </a>
<a class="sourceLine" id="cb36-72" data-line-number="72">                 <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-73" data-line-number="73"><span class="st">  </span><span class="kw">ungroup</span>() </a>
<a class="sourceLine" id="cb36-74" data-line-number="74"></a>
<a class="sourceLine" id="cb36-75" data-line-number="75">bhps_out &lt;-<span class="st"> </span>bhps_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-76" data-line-number="76"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;mortality&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-77" data-line-number="77"><span class="st">  </span><span class="kw">full_join</span>(</a>
<a class="sourceLine" id="cb36-78" data-line-number="78">    bhps_out <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb36-79" data-line-number="79"><span class="st">      </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;mortality&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-80" data-line-number="80"><span class="st">      </span><span class="kw">full_join</span>(exit) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb36-81" data-line-number="81"><span class="st">      </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-82" data-line-number="82"><span class="st">      </span><span class="kw">group_by</span>(SID, name, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-83" data-line-number="83"><span class="st">      </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-84" data-line-number="84"><span class="st">      </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb36-85" data-line-number="85"><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) </a>
<a class="sourceLine" id="cb36-86" data-line-number="86">  )</a></code></pre></div>
<pre><code>## # A tibble: 1,154,787 x 6
##      SID name         p_year  past future value
##    &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
##  1   687 divorced       1996     0     NA     0
##  2   687 divorced       2001     0     NA     0
##  3   687 divorced       2005     0     NA     0
##  4   687 edu            1996     0     NA     0
##  5   687 edu            2001     0     NA     0
##  6   687 edu            2005     0     NA     0
##  7   687 frstjob        1996     1     NA    NA
##  8   687 frstjob        2001     1     NA    NA
##  9   687 frstjob        2005     1     NA    NA
## 10   687 mntlhlthevnt   1996     0     NA     0
## # … with 1,154,777 more rows</code></pre>
</div>
<div id="covariates-1" class="section level3">
<h3><span class="header-section-number">2.3.5</span> Covariates</h3>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1">bhps_match &lt;-<span class="st"> </span>bhps_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-2" data-line-number="2"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb38-3" data-line-number="3"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">p_year =</span> year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-4" data-line-number="4"><span class="st">  </span><span class="kw">full_join</span>(bhps_match) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-5" data-line-number="5"><span class="st">  </span><span class="co"># physical health event</span></a>
<a class="sourceLine" id="cb38-6" data-line-number="6"><span class="st">  </span><span class="kw">left_join</span>(bhps_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;physhlthevnt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(p_year, SID, <span class="dt">physhlthevnt =</span> past) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(SID, p_year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">physhlthevnt =</span> <span class="kw">max</span>(physhlthevnt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-7" data-line-number="7"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb38-8" data-line-number="8"></a>
<a class="sourceLine" id="cb38-9" data-line-number="9"><span class="co"># parental divorce </span></a>
<a class="sourceLine" id="cb38-10" data-line-number="10">bhps_match &lt;-<span class="st"> </span>bhps_out <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb38-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;divorced&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-12" data-line-number="12"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">momID =</span> SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-13" data-line-number="13"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-14" data-line-number="14"><span class="st">  </span><span class="kw">right_join</span>(parIDs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(momID, SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-15" data-line-number="15"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(past)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">itemname =</span> <span class="st">&quot;momDivorced&quot;</span>, <span class="dt">name =</span> <span class="st">&quot;parDivorce&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-17" data-line-number="17"><span class="st">  </span><span class="kw">select</span>(p_year, SID, name, <span class="dt">value =</span> past, itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-18" data-line-number="18"><span class="st">  </span><span class="kw">full_join</span>(</a>
<a class="sourceLine" id="cb38-19" data-line-number="19">bhps_out <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb38-20" data-line-number="20"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;divorced&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-21" data-line-number="21"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">dadID =</span> SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-22" data-line-number="22"><span class="st">  </span><span class="kw">right_join</span>(parIDs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(dadID, SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-23" data-line-number="23"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(past)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">itemname =</span> <span class="st">&quot;dadDivorced&quot;</span>, <span class="dt">name =</span> <span class="st">&quot;parDivorce&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-25" data-line-number="25"><span class="st">  </span><span class="kw">select</span>(p_year, SID, name, <span class="dt">value =</span> past, itemname)</a>
<a class="sourceLine" id="cb38-26" data-line-number="26">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-27" data-line-number="27"><span class="st">  </span><span class="kw">group_by</span>(p_year, SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-28" data-line-number="28"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">parDivorce =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb38-29" data-line-number="29"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-30" data-line-number="30"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-31" data-line-number="31"><span class="st">  </span><span class="kw">right_join</span>(bhps_match)</a>
<a class="sourceLine" id="cb38-32" data-line-number="32"></a>
<a class="sourceLine" id="cb38-33" data-line-number="33">bhps_match &lt;-<span class="st"> </span>bhps_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-34" data-line-number="34"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;OccPrstg&quot;</span>, name)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-35" data-line-number="35"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb38-36" data-line-number="36"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-37" data-line-number="37"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-38" data-line-number="38"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(bhps_long))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-39" data-line-number="39"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-40" data-line-number="40"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(value <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-41" data-line-number="41"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-42" data-line-number="42"><span class="st">  </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-43" data-line-number="43"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="kw">min</span>(year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-44" data-line-number="44"><span class="st">  </span><span class="kw">select</span>(name, SID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-45" data-line-number="45"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-46" data-line-number="46"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-47" data-line-number="47"><span class="st">  </span><span class="kw">right_join</span>(bhps_match) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-48" data-line-number="48"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-49" data-line-number="49"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(p_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-50" data-line-number="50"><span class="st">  </span><span class="co"># select(-comp_rule, -HHID) %&gt;%</span></a>
<a class="sourceLine" id="cb38-51" data-line-number="51"><span class="st">  </span><span class="kw">mutate_all</span>(<span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .))</a>
<a class="sourceLine" id="cb38-52" data-line-number="52"></a>
<a class="sourceLine" id="cb38-53" data-line-number="53">bhps_out &lt;-<span class="st"> </span>bhps_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-54" data-line-number="54"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>past, <span class="op">-</span>future) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-55" data-line-number="55"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb38-56" data-line-number="56"></a>
<a class="sourceLine" id="cb38-57" data-line-number="57">bhps_dem &lt;-<span class="st"> </span>bhps_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb38-58" data-line-number="58"><span class="st">  </span><span class="kw">select</span>(SID, dadOccPrstg, momOccPrstg, parDivorce, </a>
<a class="sourceLine" id="cb38-59" data-line-number="59">         <span class="dt">race =</span> ethnicity, momEdu, dadEdu)<span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-60" data-line-number="60"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> item, <span class="dt">value =</span> value, <span class="op">-</span>SID, <span class="dt">na.rm =</span> T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-61" data-line-number="61"><span class="st">  </span><span class="kw">group_by</span>(SID, item) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-62" data-line-number="62"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-63" data-line-number="63"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-64" data-line-number="64"><span class="st">  </span><span class="kw">spread</span>(item,value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-65" data-line-number="65"><span class="st">  </span><span class="kw">full_join</span>(bhps_relig <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">spread</span>(name, value))</a>
<a class="sourceLine" id="cb38-66" data-line-number="66"></a>
<a class="sourceLine" id="cb38-67" data-line-number="67"><span class="co"># age</span></a>
<a class="sourceLine" id="cb38-68" data-line-number="68">bhps_match &lt;-<span class="st"> </span>bhps_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-69" data-line-number="69"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> p_year <span class="op">-</span><span class="st"> </span>yearBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-70" data-line-number="70"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>dadOccPrstg, <span class="op">-</span>momOccPrstg, <span class="op">-</span>parDivorce, </a>
<a class="sourceLine" id="cb38-71" data-line-number="71">         <span class="op">-</span>ethnicity, <span class="op">-</span>momEdu, <span class="op">-</span>dadEdu, <span class="op">-</span>religion) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-72" data-line-number="72"><span class="st">  </span><span class="kw">full_join</span>(bhps_dem)</a>
<a class="sourceLine" id="cb38-73" data-line-number="73"></a>
<a class="sourceLine" id="cb38-74" data-line-number="74"></a>
<a class="sourceLine" id="cb38-75" data-line-number="75">bhps_SCA &lt;-<span class="st"> </span>bhps_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb38-76" data-line-number="76"><span class="st">  </span><span class="kw">select</span>(SID, p_year, <span class="kw">one_of</span>(<span class="kw">c</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name), <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;dadEdu&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-77" data-line-number="77"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-78" data-line-number="78"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb38-79" data-line-number="79">         <span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-80" data-line-number="80"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(parEdu, parOccPrstg), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb38-81" data-line-number="81"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb38-82" data-line-number="82"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu, <span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg)</a></code></pre></div>
<pre><code>## # A tibble: 95,699 x 19
##      SID p_year   age education gender grsWages  race physhlthevnt SRhealth smokes exercise
##    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
##  1  9527   1996    35         0      1   13186.     0            1     3.17      1      3.5
##  2 12251   1996    25         0      1   10485.     2            1     3.17      0      1  
##  3 12935   1996    23         0      1   13109.     1            0     4.8       1      3  
##  4 14287   1996    35         0      0   10948.     0            1     2.5       1      1  
##  5 14971   1996    34         0      1   10948.     1            1     3.17      1      2  
##  6 15645   1996    40         1      1   14686.     0            1     4         0      3  
##  7 16339   1996    24         0      1   15111.     0            0     4.83      0     NA  
##  8 17687   1996    27         0      1   11266.     0            0     4.17      1      3  
##  9 21087   1996    32         0      1   28184.     1            1     4.17      1      3.5
## 10 21767   1996    51         2      1   29317.     0            0     3.33      0      5  
## # … with 95,689 more rows, and 8 more variables: BMI &lt;dbl&gt;, married &lt;dbl&gt;, numKids &lt;dbl&gt;,
## #   parDivorce &lt;dbl&gt;, PhysFunc &lt;dbl&gt;, religion &lt;dbl&gt;, parEdu &lt;dbl&gt;, parOccPrstg &lt;dbl&gt;</code></pre>
</div>
<div id="imputation-1" class="section level3">
<h3><span class="header-section-number">2.3.6</span> Imputation</h3>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="co"># short helper functions to (1) identify and create factors, save col names of factors, remove columns with all missing values, and setup amelia</span></a>
<a class="sourceLine" id="cb40-2" data-line-number="2">factor_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){<span class="cf">if</span>(<span class="kw">is.numeric</span>(x)){<span class="kw">diff</span>(<span class="kw">range</span>(x, <span class="dt">na.rm =</span> T)) <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span>} <span class="cf">else</span>{F}}</a>
<a class="sourceLine" id="cb40-3" data-line-number="3">not_all_na &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">any</span>(<span class="op">!</span><span class="kw">is.na</span>(x))</a>
<a class="sourceLine" id="cb40-4" data-line-number="4">not_all_id &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="cf">if</span>(<span class="kw">is.numeric</span>(x)) <span class="kw">sd</span>(x, <span class="dt">na.rm =</span> T) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb40-5" data-line-number="5">mice_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb40-6" data-line-number="6">  df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>homeHelp, <span class="op">-</span>dentalIns, <span class="op">-</span>eyeDrIns)</a>
<a class="sourceLine" id="cb40-7" data-line-number="7">  <span class="kw">mice</span>(df, <span class="dt">m =</span> <span class="dv">5</span>, <span class="dt">maxit=</span><span class="dv">5</span>, <span class="dt">printFlag=</span><span class="ot">TRUE</span>, <span class="dt">method =</span> <span class="st">&quot;cart&quot;</span>)</a>
<a class="sourceLine" id="cb40-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb40-9" data-line-number="9">start &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()</a>
<a class="sourceLine" id="cb40-10" data-line-number="10">bhps_match_imp &lt;-<span class="st"> </span>bhps_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-11" data-line-number="11"><span class="st">  </span><span class="kw">group_by</span>(SID, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-13" data-line-number="13"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-14" data-line-number="14"><span class="st">  </span><span class="co"># filter(p_year==2001) %&gt;%</span></a>
<a class="sourceLine" id="cb40-15" data-line-number="15"><span class="st">  </span><span class="kw">select</span>(<span class="kw">everything</span>(), <span class="op">-</span>dadID, <span class="op">-</span>momID, <span class="op">-</span>momOccPrstg,<span class="op">-</span>dadOccPrstg) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-16" data-line-number="16"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(p_year) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(SID) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(yearBrth)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-17" data-line-number="17"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parOccPrstg =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(parOccPrstg), <span class="ot">NA</span>, parOccPrstg)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-18" data-line-number="18"><span class="st">  </span><span class="kw">group_by</span>(p_year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb40-19" data-line-number="19"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-20" data-line-number="20"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_na) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_id)),</a>
<a class="sourceLine" id="cb40-22" data-line-number="22">         <span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(factor_fun, as.factor)),</a>
<a class="sourceLine" id="cb40-23" data-line-number="23">         <span class="dt">imp =</span> <span class="kw">map</span>(data, mice_fun))</a>
<a class="sourceLine" id="cb40-24" data-line-number="24">beepr<span class="op">::</span><span class="kw">beep</span>(<span class="dt">sound =</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb40-25" data-line-number="25"><span class="kw">print</span>(<span class="kw">Sys.time</span>() <span class="op">-</span><span class="st"> </span>start)</a>
<a class="sourceLine" id="cb40-26" data-line-number="26"></a>
<a class="sourceLine" id="cb40-27" data-line-number="27">bhps_match_imp &lt;-<span class="st"> </span>bhps_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-28" data-line-number="28"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">!=</span><span class="st"> </span><span class="dv">1991</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-29" data-line-number="29"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp, <span class="op">~</span>mice<span class="op">::</span><span class="kw">complete</span>(., <span class="st">&quot;long&quot;</span>)),</a>
<a class="sourceLine" id="cb40-30" data-line-number="30">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb40-31" data-line-number="31"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-32" data-line-number="32"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-33" data-line-number="33"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-34" data-line-number="34"><span class="st">    </span><span class="kw">ungroup</span>()),</a>
<a class="sourceLine" id="cb40-35" data-line-number="35">         <span class="dt">imp_sca =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(.imp <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID,  <span class="kw">one_of</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name)))))</a>
<a class="sourceLine" id="cb40-36" data-line-number="36"></a>
<a class="sourceLine" id="cb40-37" data-line-number="37">bhps_match_imp_long &lt;-<span class="st"> </span>bhps_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-38" data-line-number="38"><span class="st">  </span><span class="kw">select</span>(p_year, imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-39" data-line-number="39"><span class="st">  </span><span class="kw">unnest</span>(imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-40" data-line-number="40"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>SWB)</a>
<a class="sourceLine" id="cb40-41" data-line-number="41"></a>
<a class="sourceLine" id="cb40-42" data-line-number="42">bhps_SCA_imp &lt;-<span class="st"> </span>bhps_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-43" data-line-number="43"><span class="st">  </span><span class="kw">select</span>(p_year, imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-44" data-line-number="44"><span class="st">  </span><span class="kw">unnest</span>(imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb40-45" data-line-number="45"><span class="st">  </span><span class="kw">full_join</span>(bhps_SCA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, SID, BMI))</a>
<a class="sourceLine" id="cb40-46" data-line-number="46"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(bhps_SCA_imp)]</a></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="kw">save</span>(bhps_match_imp_long, bhps_SCA_imp, </a>
<a class="sourceLine" id="cb41-2" data-line-number="2">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/bhps_imputed_small.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb41-3" data-line-number="3"><span class="kw">save</span>(bhps_match_imp, </a>
<a class="sourceLine" id="cb41-4" data-line-number="4">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/bhps_imputed.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb41-5" data-line-number="5"><span class="kw">save</span>(bhps_alpha, bhps_pers, bhps_out, bhps_match, bhps_SCA,</a>
<a class="sourceLine" id="cb41-6" data-line-number="6">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/bhps_cleaned.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb41-7" data-line-number="7"><span class="kw">save</span>(bhps_long, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/bhps_raw_long.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb41-8" data-line-number="8"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;bhps&quot;</span>, <span class="kw">ls</span>())])</a>
<a class="sourceLine" id="cb41-9" data-line-number="9"><span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;us&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
</div>
</div>
<div id="gsoep" class="section level2">
<h2><span class="header-section-number">2.4</span> GSOEP</h2>
<p>The German Socioeconomic Panel Study (GSOEP; Socio-Economic Panel, 2017) is an ongoing longitudinal study of German collected by the German Institute of Economic Research (DIW Berlin). The data are freely available at <a href="https://www.diw.de/soep" class="uri">https://www.diw.de/soep</a> by application.</p>
<p>Data have been collected annually since 1984 (the latest data release includes data up to 2017). Participants have been recruited from more than 11,000 households, which are nationally representative of private German households. 20,000 individuals are sampled each year, on average. It is critical to note that the GSOEP samples households, not individuals, and the households consist of individuals living in both the “old” and “new” federal states (the former West and East Germany), foreigners, and recent immigrants to Germany.</p>
<p>Sample size varies by year, ranging from approximately 10,000 (1989) to 31,000 (2013). This provides 99% power to detect a zero-order correlation effect size of ~.06, two-tailed at alpha &lt; .05.</p>
<div id="load-data-3" class="section level3">
<h3><span class="header-section-number">2.4.1</span> Load Data</h3>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">gsoep_read_fun &lt;-<span class="st"> </span><span class="cf">function</span>(Year, WL){</a>
<a class="sourceLine" id="cb42-2" data-line-number="2">  old.names &lt;-<span class="st"> </span>(gsoep_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>Year <span class="op">|</span><span class="st"> </span>category <span class="op">==</span><span class="st"> &quot;proc&quot;</span>))<span class="op">$</span>orig_itemname </a>
<a class="sourceLine" id="cb42-3" data-line-number="3">  p &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/gsoep/%sp.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-4" data-line-number="4"><span class="st">    </span><span class="kw">full_join</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/data/gsoep/%skind.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-5" data-line-number="5"><span class="st">    </span><span class="kw">full_join</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/data/gsoep/%spequiv.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-6" data-line-number="6"><span class="st">    </span><span class="kw">full_join</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/data/gsoep/%spgen.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-7" data-line-number="7"><span class="st">    </span><span class="kw">full_join</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/data/gsoep/%spkal.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-8" data-line-number="8"><span class="st">    </span><span class="kw">select</span>(<span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-9" data-line-number="9"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>persnr, <span class="op">-</span>hhnr, <span class="dt">na.rm =</span> T)</a>
<a class="sourceLine" id="cb42-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb42-11" data-line-number="11"> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/gsoep/%shbrutto.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-12" data-line-number="12"><span class="st">    </span><span class="kw">full_join</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/data/gsoep/%sh.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-13" data-line-number="13"><span class="st">    </span><span class="kw">select</span>(<span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-14" data-line-number="14"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>hhnr, <span class="dt">na.rm =</span> T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-15" data-line-number="15"><span class="st">    </span><span class="kw">full_join</span>(p <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(persnr, hhnr) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb42-16" data-line-number="16"><span class="st">    </span><span class="kw">full_join</span>(p) </a>
<a class="sourceLine" id="cb42-17" data-line-number="17">}</a></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1">gsoep_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;GSOEP&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb43-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">orig_itemname =</span> <span class="kw">str_to_lower</span>(orig_itemname))</a>
<a class="sourceLine" id="cb43-3" data-line-number="3">gsoep_codebook</a></code></pre></div>
<pre><code>## # A tibble: 1,843 x 20
##    study dataset category name  itemname  wave waveletter  year new_itemname orig_itemname
##    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;        
##  1 gsoep apequiv match    age   age          1 a           1984 gsoep__matc… d1110184     
##  2 gsoep bpequiv match    age   age          2 b           1985 gsoep__matc… d1110185     
##  3 gsoep cpequiv match    age   age          3 c           1986 gsoep__matc… d1110186     
##  4 gsoep dpequiv match    age   age          4 d           1987 gsoep__matc… d1110187     
##  5 gsoep epequiv match    age   age          5 e           1988 gsoep__matc… d1110188     
##  6 gsoep fpequiv match    age   age          6 f           1989 gsoep__matc… d1110189     
##  7 gsoep gpequiv match    age   age          7 g           1990 gsoep__matc… d1110190     
##  8 gsoep hpequiv match    age   age          8 h           1991 gsoep__matc… d1110191     
##  9 gsoep ipequiv match    age   age          9 i           1992 gsoep__matc… d1110192     
## 10 gsoep jpequiv match    age   age         10 j           1993 gsoep__matc… d1110193     
## # … with 1,833 more rows, and 10 more variables: description &lt;chr&gt;, scale &lt;chr&gt;,
## #   reverse_code &lt;chr&gt;, recode &lt;chr&gt;, mini &lt;dbl&gt;, maxi &lt;dbl&gt;, comp_rule &lt;chr&gt;, ...18 &lt;dbl&gt;,
## #   ...19 &lt;lgl&gt;, ...20 &lt;lgl&gt;</code></pre>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" data-line-number="1">gsoep &lt;-<span class="st"> </span>gsoep_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(wave, waveletter, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">complete.cases</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-4" data-line-number="4"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-5" data-line-number="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(year, waveletter, gsoep_read_fun)) </a>
<a class="sourceLine" id="cb45-6" data-line-number="6"></a>
<a class="sourceLine" id="cb45-7" data-line-number="7">old.names &lt;-<span class="st"> </span><span class="kw">unique</span>(gsoep_codebook<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb45-8" data-line-number="8">gsoep_post &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/gsoep/gpost.sav&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-9" data-line-number="9"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/data/gsoep/hpost.sav&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(persnr, hhnr, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-11" data-line-number="11"><span class="st">  </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-12" data-line-number="12"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>hhnr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-13" data-line-number="13"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>persnr, <span class="dt">na.rm =</span> T)</a>
<a class="sourceLine" id="cb45-14" data-line-number="14"></a>
<a class="sourceLine" id="cb45-15" data-line-number="15">gsoep_long &lt;-<span class="st"> </span>gsoep <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-16" data-line-number="16"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>hhnr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb45-17" data-line-number="17"><span class="st">  </span><span class="kw">full_join</span>(gsoep_post)</a>
<a class="sourceLine" id="cb45-18" data-line-number="18"></a>
<a class="sourceLine" id="cb45-19" data-line-number="19"><span class="kw">save</span>(gsoep, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/gsoep_raw.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb45-20" data-line-number="20"><span class="kw">rm</span>(gsoep)</a></code></pre></div>
</div>
<div id="matching-variables-2" class="section level3">
<h3><span class="header-section-number">2.4.2</span> Matching Variables</h3>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, year){</a>
<a class="sourceLine" id="cb46-2" data-line-number="2">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb46-3" data-line-number="3">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb46-4" data-line-number="4">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb46-5" data-line-number="5">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb46-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb46-7" data-line-number="7"></a>
<a class="sourceLine" id="cb46-8" data-line-number="8"><span class="co"># rename variables   </span></a>
<a class="sourceLine" id="cb46-9" data-line-number="9">gsoep_match &lt;-<span class="st"> </span>gsoep_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-10" data-line-number="10"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-12" data-line-number="12"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb46-13" data-line-number="13"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-14" data-line-number="14"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-15" data-line-number="15"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(gsoep_long))) </a>
<a class="sourceLine" id="cb46-16" data-line-number="16"></a>
<a class="sourceLine" id="cb46-17" data-line-number="17">yrBrth &lt;-<span class="st"> </span>gsoep_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb46-18" data-line-number="18"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb46-19" data-line-number="19"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-20" data-line-number="20"><span class="st">  </span><span class="kw">group_by</span>(persnr) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb46-21" data-line-number="21"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">yearBrth =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-22" data-line-number="22"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">yearBrth =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(yearBrth), <span class="ot">NA</span>, yearBrth)) </a>
<a class="sourceLine" id="cb46-24" data-line-number="24"></a>
<a class="sourceLine" id="cb46-25" data-line-number="25"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb46-26" data-line-number="26">gsoep_match &lt;-<span class="st"> </span>gsoep_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb46-27" data-line-number="27"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-28" data-line-number="28"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-29" data-line-number="29"><span class="st">    </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-30" data-line-number="30"><span class="st">    </span><span class="kw">group_by</span>(recode, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb46-31" data-line-number="31"><span class="st">    </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-32" data-line-number="32"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-33" data-line-number="33"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-34" data-line-number="34"><span class="st">    </span><span class="kw">unnest</span>(data)))</a>
<a class="sourceLine" id="cb46-35" data-line-number="35"></a>
<a class="sourceLine" id="cb46-36" data-line-number="36"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb46-37" data-line-number="37">gsoep_match &lt;-<span class="st"> </span>gsoep_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-38" data-line-number="38"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-39" data-line-number="39"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value,</a>
<a class="sourceLine" id="cb46-40" data-line-number="40">                          <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))))</a>
<a class="sourceLine" id="cb46-41" data-line-number="41"></a>
<a class="sourceLine" id="cb46-42" data-line-number="42">fun_call &lt;-<span class="st"> </span><span class="cf">function</span>(x, rule){</a>
<a class="sourceLine" id="cb46-43" data-line-number="43">    <span class="cf">switch</span>(rule,</a>
<a class="sourceLine" id="cb46-44" data-line-number="44">           <span class="dt">average =</span> <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb46-45" data-line-number="45">           <span class="dt">mode =</span> <span class="kw">Mode</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb46-46" data-line-number="46">           <span class="dt">sum =</span> <span class="kw">sum</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb46-47" data-line-number="47">           <span class="dt">skip =</span> <span class="kw">unique</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb46-48" data-line-number="48">           <span class="dt">max =</span> <span class="kw">max</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb46-49" data-line-number="49">           <span class="dt">min =</span> <span class="kw">min</span>(x, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb46-50" data-line-number="50">  }</a>
<a class="sourceLine" id="cb46-51" data-line-number="51"></a>
<a class="sourceLine" id="cb46-52" data-line-number="52"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb46-53" data-line-number="53">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb46-54" data-line-number="54">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-55" data-line-number="55"><span class="st">    </span><span class="kw">group_by</span>(persnr, yearBrth, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb46-56" data-line-number="56"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-57" data-line-number="57"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb46-58" data-line-number="58">}</a>
<a class="sourceLine" id="cb46-59" data-line-number="59"></a>
<a class="sourceLine" id="cb46-60" data-line-number="60">gsoep_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;GSOEP&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb46-61" data-line-number="61"></a>
<a class="sourceLine" id="cb46-62" data-line-number="62">gsoep_match &lt;-<span class="st"> </span>gsoep_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-63" data-line-number="63"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-64" data-line-number="64"><span class="st">    </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="kw">max</span>(gsoep_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-65" data-line-number="65"><span class="st">    </span><span class="kw">group_by</span>(comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-66" data-line-number="66"><span class="st">    </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-67" data-line-number="67"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-68" data-line-number="68"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;skip&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb46-69" data-line-number="69">           <span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-70" data-line-number="70"><span class="st">    </span><span class="kw">unnest</span>(data))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-71" data-line-number="71"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb46-72" data-line-number="72"></a>
<a class="sourceLine" id="cb46-73" data-line-number="73">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, p_year){</a>
<a class="sourceLine" id="cb46-74" data-line-number="74">  gsoep_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-75" data-line-number="75"><span class="st">    </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span>p_year  <span class="op">&amp;</span><span class="st"> </span>comp_rule <span class="op">==</span><span class="st"> </span>rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-76" data-line-number="76"><span class="st">    </span><span class="kw">group_by</span>(persnr, yearBrth, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-77" data-line-number="77"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-78" data-line-number="78"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb46-79" data-line-number="79">}</a>
<a class="sourceLine" id="cb46-80" data-line-number="80"></a>
<a class="sourceLine" id="cb46-81" data-line-number="81">gsoep_match &lt;-<span class="st"> </span><span class="kw">crossing</span>(</a>
<a class="sourceLine" id="cb46-82" data-line-number="82">  <span class="dt">p_year =</span> gsoep_waves<span class="op">$</span>Used, </a>
<a class="sourceLine" id="cb46-83" data-line-number="83">  <span class="dt">comp_rule =</span> <span class="kw">unique</span>(gsoep_match<span class="op">$</span>comp_rule)</a>
<a class="sourceLine" id="cb46-84" data-line-number="84">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-85" data-line-number="85"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(comp_rule, p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-86" data-line-number="86"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-87" data-line-number="87"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-88" data-line-number="88"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule, <span class="op">-</span>yearBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb46-89" data-line-number="89"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> name, <span class="dt">values_from =</span> value) </a></code></pre></div>
<pre><code>## # A tibble: 346,921 x 62
##     year   SID     A     C   DEP     E   LOC     N  `NA`     O    OP    PA    SE    SS   SWL
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  1994   201    NA    NA    NA    NA  2.62    NA    NA    NA    NA    NA    NA    NA     5
##  2  1994   203    NA    NA    NA    NA  3.25    NA    NA    NA    NA    NA    NA    NA     6
##  3  1994   204    NA    NA    NA    NA NA       NA    NA    NA    NA    NA    NA    NA    NA
##  4  1994   601    NA    NA    NA    NA  3.5     NA    NA    NA    NA    NA    NA    NA     9
##  5  1994   602    NA    NA    NA    NA  3       NA    NA    NA    NA    NA    NA    NA     4
##  6  1994   603    NA    NA    NA    NA NA       NA    NA    NA    NA    NA    NA    NA    NA
##  7  1994   604    NA    NA    NA    NA NA       NA    NA    NA    NA    NA    NA    NA    NA
##  8  1994   901    NA    NA    NA    NA  3.12    NA    NA    NA    NA    NA    NA    NA     6
##  9  1994  1101    NA    NA    NA    NA  2.25    NA    NA    NA    NA    NA    NA    NA    10
## 10  1994  1202    NA    NA    NA    NA  2.62    NA    NA    NA    NA    NA    NA    NA     9
## # … with 346,911 more rows, and 47 more variables: drVisits &lt;dbl&gt;, exercise &lt;dbl&gt;,
## #   grsWages &lt;dbl&gt;, satHealth &lt;dbl&gt;, satHH &lt;dbl&gt;, satIncome &lt;dbl&gt;, social &lt;dbl&gt;,
## #   SRhealth &lt;dbl&gt;, nbhdQual &lt;dbl&gt;, religiosity &lt;dbl&gt;, disability &lt;dbl&gt;, education &lt;dbl&gt;,
## #   HHsize &lt;dbl&gt;, hlthcare &lt;dbl&gt;, married &lt;dbl&gt;, numKids &lt;dbl&gt;, PhysFunc &lt;dbl&gt;,
## #   unempBen &lt;dbl&gt;, urban &lt;dbl&gt;, broPres &lt;dbl&gt;, dadPres &lt;dbl&gt;, momPres &lt;dbl&gt;,
## #   religion &lt;dbl&gt;, sisPres &lt;dbl&gt;, ageMarried &lt;dbl&gt;, gender &lt;dbl&gt;, age &lt;dbl&gt;,
## #   occPrestige &lt;dbl&gt;, height &lt;dbl&gt;, smokes &lt;dbl&gt;, weight &lt;dbl&gt;, welfare &lt;dbl&gt;,
## #   eatingHabits &lt;dbl&gt;, dadAlive &lt;dbl&gt;, momAlive &lt;dbl&gt;, alcohol &lt;dbl&gt;, satFam &lt;dbl&gt;,
## #   auntPres &lt;dbl&gt;, gmaPres &lt;dbl&gt;, gpaPres &lt;dbl&gt;, unclPres &lt;dbl&gt;, dadEdu &lt;dbl&gt;,
## #   dadOccPrstg &lt;dbl&gt;, momEdu &lt;dbl&gt;, momOccPrstg &lt;dbl&gt;, physhlthevnt &lt;dbl&gt;, BMI &lt;dbl&gt;</code></pre>
</div>
<div id="personality-variables-2" class="section level3">
<h3><span class="header-section-number">2.4.3</span> Personality Variables</h3>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" data-line-number="1"><span class="co"># keep correct personality waves</span></a>
<a class="sourceLine" id="cb48-2" data-line-number="2">gsoep_pers &lt;-<span class="st"> </span>gsoep_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb48-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;pers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-5" data-line-number="5"><span class="st">  </span><span class="kw">left_join</span>(gsoep_long) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-6" data-line-number="6"><span class="st">  </span><span class="kw">left_join</span>(p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;GSOEP&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">name =</span> p_item, Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span>Used) </a>
<a class="sourceLine" id="cb48-8" data-line-number="8"></a>
<a class="sourceLine" id="cb48-9" data-line-number="9">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb48-10" data-line-number="10">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb48-11" data-line-number="11">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb48-12" data-line-number="12">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb48-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb48-14" data-line-number="14"></a>
<a class="sourceLine" id="cb48-15" data-line-number="15"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb48-16" data-line-number="16">gsoep_pers &lt;-<span class="st"> </span>gsoep_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-17" data-line-number="17"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, reverse_code<span class="op">:</span>comp_rule, persnr, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-18" data-line-number="18"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-19" data-line-number="19"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-20" data-line-number="20"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-22" data-line-number="22"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb48-23" data-line-number="23"></a>
<a class="sourceLine" id="cb48-24" data-line-number="24"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb48-25" data-line-number="25"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb48-26" data-line-number="26">gsoep_pers &lt;-<span class="st"> </span>gsoep_pers <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-27" data-line-number="27"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb48-28" data-line-number="28"></a>
<a class="sourceLine" id="cb48-29" data-line-number="29"><span class="co"># alpha&#39;s</span></a>
<a class="sourceLine" id="cb48-30" data-line-number="30">gsoep_alpha &lt;-<span class="st"> </span>gsoep_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-31" data-line-number="31"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, persnr, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-32" data-line-number="32"><span class="st">  </span><span class="kw">group_by</span>(name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-33" data-line-number="33"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-34" data-line-number="34"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> itemname, <span class="dt">values_from =</span> value)),</a>
<a class="sourceLine" id="cb48-35" data-line-number="35">         <span class="dt">alpha =</span> <span class="kw">map</span>(data, <span class="kw">possibly</span>(<span class="op">~</span>psych<span class="op">::</span><span class="kw">alpha</span>((.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>persnr)), <span class="ot">NA_real_</span>)))</a>
<a class="sourceLine" id="cb48-36" data-line-number="36"></a>
<a class="sourceLine" id="cb48-37" data-line-number="37">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb48-38" data-line-number="38">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-39" data-line-number="39"><span class="st">    </span><span class="kw">group_by</span>(persnr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-40" data-line-number="40"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-41" data-line-number="41"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb48-42" data-line-number="42">}</a>
<a class="sourceLine" id="cb48-43" data-line-number="43"></a>
<a class="sourceLine" id="cb48-44" data-line-number="44"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb48-45" data-line-number="45">gsoep_pers &lt;-<span class="st"> </span>gsoep_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-46" data-line-number="46"><span class="st">  </span><span class="kw">group_by</span>(name, comp_rule, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-47" data-line-number="47"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-48" data-line-number="48"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-49" data-line-number="49"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-50" data-line-number="50"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb48-51" data-line-number="51"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb48-52" data-line-number="52"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value))</a></code></pre></div>
<pre><code>## # A tibble: 504,605 x 4
##    name   year   SID value
##    &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 A      2005   201  7   
##  2 A      2005   203  4.67
##  3 A      2005   602  4.33
##  4 A      2005   901  4.67
##  5 A      2005  1202  7   
##  6 A      2005  1501  4.67
##  7 A      2005  1601  4   
##  8 A      2005  1602  6.67
##  9 A      2005  1603  4.33
## 10 A      2005  1701  7   
## # … with 504,595 more rows</code></pre>
</div>
<div id="outcome-variables-3" class="section level3">
<h3><span class="header-section-number">2.4.4</span> Outcome Variables</h3>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" data-line-number="1">gsoep_pers_subs &lt;-<span class="st"> </span><span class="kw">unique</span>(gsoep_pers<span class="op">$</span>persnr)</a>
<a class="sourceLine" id="cb50-2" data-line-number="2">gsoep_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;GSOEP&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb50-3" data-line-number="3">exit &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/gsoep/ppfad.sav&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(persnr, todjahr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-5" data-line-number="5"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>persnr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-6" data-line-number="6"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">orig_itemname =</span> <span class="st">&quot;todjahr&quot;</span>, <span class="dt">p_year =</span> gsoep_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-7" data-line-number="7"><span class="st">  </span><span class="co"># filter(!value &lt; 0)</span></a>
<a class="sourceLine" id="cb50-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(value) <span class="op">|</span><span class="st"> </span>value <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="ot">NA</span>, value),</a>
<a class="sourceLine" id="cb50-9" data-line-number="9">         <span class="dt">value =</span> <span class="kw">ifelse</span>(year <span class="op">&lt;=</span><span class="st"> </span>p_year <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(year), <span class="dv">0</span>, <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>p_year, <span class="dv">1</span>, <span class="ot">NA</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-10" data-line-number="10"><span class="st">  </span><span class="kw">left_join</span>(gsoep_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(orig_itemname, name)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb50-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>year, <span class="op">-</span>orig_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-12" data-line-number="12"><span class="st">  </span><span class="kw">filter</span>(persnr <span class="op">%in%</span><span class="st"> </span>gsoep_pers_subs)</a>
<a class="sourceLine" id="cb50-13" data-line-number="13"></a>
<a class="sourceLine" id="cb50-14" data-line-number="14">gsoep_out &lt;-<span class="st"> </span>gsoep_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb50-15" data-line-number="15"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-16" data-line-number="16"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-17" data-line-number="17"><span class="st">  </span><span class="kw">left_join</span>(gsoep_long <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(persnr <span class="op">%in%</span><span class="st"> </span>gsoep_pers_subs)) </a>
<a class="sourceLine" id="cb50-18" data-line-number="18"></a>
<a class="sourceLine" id="cb50-19" data-line-number="19"><span class="co"># recode</span></a>
<a class="sourceLine" id="cb50-20" data-line-number="20">gsoep_out &lt;-<span class="st"> </span>gsoep_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-21" data-line-number="21"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, reverse_code<span class="op">:</span>comp_rule,  persnr, recode, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-22" data-line-number="22"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-23" data-line-number="23"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-24" data-line-number="24"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-25" data-line-number="25"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-26" data-line-number="26"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb50-27" data-line-number="27"></a>
<a class="sourceLine" id="cb50-28" data-line-number="28"><span class="co"># composite within years </span></a>
<a class="sourceLine" id="cb50-29" data-line-number="29"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb50-30" data-line-number="30">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb50-31" data-line-number="31">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-32" data-line-number="32"><span class="st">    </span><span class="kw">group_by</span>(persnr, name, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb50-33" data-line-number="33"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-34" data-line-number="34"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb50-35" data-line-number="35">}</a>
<a class="sourceLine" id="cb50-36" data-line-number="36"></a>
<a class="sourceLine" id="cb50-37" data-line-number="37"></a>
<a class="sourceLine" id="cb50-38" data-line-number="38">gsoep_out &lt;-<span class="st"> </span>gsoep_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-39" data-line-number="39"><span class="st">  </span><span class="co"># filter(year &lt;= max(gsoep_waves$Used)) %&gt;%</span></a>
<a class="sourceLine" id="cb50-40" data-line-number="40"><span class="st">  </span><span class="kw">group_by</span>(comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-41" data-line-number="41"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-42" data-line-number="42"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-43" data-line-number="43"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(comp_rule <span class="op">==</span><span class="st"> &quot;select&quot;</span>, <span class="st">&quot;skip&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb50-44" data-line-number="44">         <span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-45" data-line-number="45"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb50-46" data-line-number="46"></a>
<a class="sourceLine" id="cb50-47" data-line-number="47"><span class="co"># composite across years</span></a>
<a class="sourceLine" id="cb50-48" data-line-number="48">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(p_year){</a>
<a class="sourceLine" id="cb50-49" data-line-number="49">  gsoep_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-50" data-line-number="50"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>p_year, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;past&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-51" data-line-number="51"><span class="st">    </span><span class="kw">group_by</span>(persnr, name, group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-52" data-line-number="52"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-53" data-line-number="53"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-54" data-line-number="54"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-55" data-line-number="55"><span class="st">    </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> group, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-56" data-line-number="56"><span class="st">    </span><span class="kw">group_by</span>(persnr, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-57" data-line-number="57"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(past) <span class="op">|</span><span class="st"> </span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(future)), future,</a>
<a class="sourceLine" id="cb50-58" data-line-number="58">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(future), past, </a>
<a class="sourceLine" id="cb50-59" data-line-number="59">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)))) </a>
<a class="sourceLine" id="cb50-60" data-line-number="60">}</a>
<a class="sourceLine" id="cb50-61" data-line-number="61"></a>
<a class="sourceLine" id="cb50-62" data-line-number="62">gsoep_out &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">p_year =</span> gsoep_waves<span class="op">$</span>Used) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-63" data-line-number="63"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-64" data-line-number="64"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-65" data-line-number="65"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;mortality&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb50-66" data-line-number="66"><span class="st">  </span><span class="kw">full_join</span>(exit)</a></code></pre></div>
<pre><code>## # A tibble: 4,008,294 x 6
##    p_year   SID name         future  past value
##     &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1   2005   201 chldbrth          0     0     0
##  2   2005   201 chldmvout         0     0     0
##  3   2005   201 divorced          0     0     0
##  4   2005   201 edu              NA    NA    NA
##  5   2005   201 frstJob           0     0     0
##  6   2005   201 married           0     0     0
##  7   2005   201 mntlhlthevnt      0     0     0
##  8   2005   201 mvInPrtnr         0     0     0
##  9   2005   201 physhlthevnt      0     1    NA
## 10   2005   201 retired           1     1    NA
## # … with 4,008,284 more rows</code></pre>
</div>
<div id="covariates-2" class="section level3">
<h3><span class="header-section-number">2.4.5</span> Covariates</h3>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" data-line-number="1">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb52-2" data-line-number="2">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb52-3" data-line-number="3">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb52-4" data-line-number="4">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb52-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb52-6" data-line-number="6"></a>
<a class="sourceLine" id="cb52-7" data-line-number="7">old.names &lt;-<span class="st"> </span><span class="kw">unique</span>(gsoep_codebook<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb52-8" data-line-number="8">gsoep_bp &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/gsoep/bioparen.sav&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-9" data-line-number="9"><span class="st">  </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(<span class="kw">one_of</span>(old.names), <span class="op">-</span>hhnr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-11" data-line-number="11"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>persnr, <span class="op">-</span>fnr, <span class="op">-</span>mnr, <span class="dt">na.rm =</span> T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-12" data-line-number="12"><span class="st">  </span><span class="kw">left_join</span>(gsoep_codebook) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-13" data-line-number="13"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-14" data-line-number="14"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-15" data-line-number="15"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-17" data-line-number="17"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-18" data-line-number="18"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-19" data-line-number="19"><span class="st">  </span><span class="kw">group_by</span>(persnr, name, fnr, mnr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-20" data-line-number="20"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, comp_rule)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-21" data-line-number="21"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-22" data-line-number="22"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(fnr, mnr), <span class="op">~</span><span class="kw">ifelse</span>((.) <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-24" data-line-number="24"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">dadID =</span> fnr, <span class="dt">momID =</span> mnr)</a>
<a class="sourceLine" id="cb52-25" data-line-number="25"></a>
<a class="sourceLine" id="cb52-26" data-line-number="26"><span class="co"># parental divorce </span></a>
<a class="sourceLine" id="cb52-27" data-line-number="27">gsoep_match &lt;-<span class="st"> </span>gsoep_out <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-28" data-line-number="28"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;divorced&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-29" data-line-number="29"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">momID =</span> persnr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-30" data-line-number="30"><span class="st">  </span><span class="kw">right_join</span>(gsoep_bp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(momID, persnr)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-31" data-line-number="31"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(past)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-32" data-line-number="32"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">itemname =</span> <span class="st">&quot;momDivorced&quot;</span>, <span class="dt">name =</span> <span class="st">&quot;parDivorce&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-33" data-line-number="33"><span class="st">  </span><span class="kw">select</span>(p_year, persnr, name, <span class="dt">value =</span> past, itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-34" data-line-number="34"><span class="st">  </span><span class="kw">full_join</span>(</a>
<a class="sourceLine" id="cb52-35" data-line-number="35">gsoep_out <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-36" data-line-number="36"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;divorced&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-37" data-line-number="37"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">dadID =</span> persnr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-38" data-line-number="38"><span class="st">  </span><span class="kw">right_join</span>(gsoep_bp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(dadID, persnr)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-39" data-line-number="39"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(past)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-40" data-line-number="40"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">itemname =</span> <span class="st">&quot;dadDivorced&quot;</span>, <span class="dt">name =</span> <span class="st">&quot;parDivorce&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-41" data-line-number="41"><span class="st">  </span><span class="kw">select</span>(p_year, persnr, name, <span class="dt">value =</span> past, itemname)</a>
<a class="sourceLine" id="cb52-42" data-line-number="42">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-43" data-line-number="43"><span class="st">  </span><span class="kw">group_by</span>(p_year, persnr, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-44" data-line-number="44"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">parDivorce =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-45" data-line-number="45"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-46" data-line-number="46"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-47" data-line-number="47"><span class="st">  </span><span class="kw">right_join</span>(gsoep_match)</a>
<a class="sourceLine" id="cb52-48" data-line-number="48"></a>
<a class="sourceLine" id="cb52-49" data-line-number="49">gsoep_match &lt;-<span class="st"> </span>gsoep_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-50" data-line-number="50"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-51" data-line-number="51"><span class="st">  </span><span class="kw">full_join</span>(gsoep_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">year =</span> p_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-52" data-line-number="52"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-53" data-line-number="53"><span class="st">  </span><span class="kw">full_join</span>(gsoep_bp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>momID, <span class="op">-</span>dadID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-54" data-line-number="54"><span class="st">  </span><span class="co"># physical health event</span></a>
<a class="sourceLine" id="cb52-55" data-line-number="55"><span class="st">  </span><span class="kw">left_join</span>(gsoep_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;physhlthevnt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">year =</span> p_year, persnr, <span class="dt">physhlthevnt =</span> past) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(persnr, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">physhlthevnt =</span> <span class="kw">max</span>(physhlthevnt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-56" data-line-number="56"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb52-57" data-line-number="57"></a>
<a class="sourceLine" id="cb52-58" data-line-number="58">gsoep_out &lt;-<span class="st"> </span>gsoep_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-59" data-line-number="59"><span class="st">  </span><span class="kw">group_by</span>(persnr, p_year, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-60" data-line-number="60"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-61" data-line-number="61"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-62" data-line-number="62"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-63" data-line-number="63"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb52-64" data-line-number="64"></a>
<a class="sourceLine" id="cb52-65" data-line-number="65">gsoep_match &lt;-<span class="st"> </span>gsoep_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-66" data-line-number="66"><span class="st">  </span><span class="kw">group_by</span>(persnr, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-67" data-line-number="67"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">BMI =</span> <span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(weight) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(height), weight<span class="op">/</span>(height<span class="op">/</span><span class="dv">100</span>)<span class="op">^</span><span class="dv">2</span>, <span class="ot">NA</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-68" data-line-number="68"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb52-69" data-line-number="69"></a>
<a class="sourceLine" id="cb52-70" data-line-number="70">gsoep_SCA &lt;-<span class="st"> </span>gsoep_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-71" data-line-number="71"><span class="st">  </span><span class="kw">select</span>(persnr, <span class="dt">p_year =</span> year, <span class="kw">one_of</span>(<span class="kw">c</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name), <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;dadEdu&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-72" data-line-number="72"><span class="st">  </span><span class="kw">group_by</span>(persnr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-73" data-line-number="73"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb52-74" data-line-number="74">         <span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-75" data-line-number="75"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(parEdu, parOccPrstg), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb52-76" data-line-number="76"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-77" data-line-number="77"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu, <span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg)</a>
<a class="sourceLine" id="cb52-78" data-line-number="78"></a>
<a class="sourceLine" id="cb52-79" data-line-number="79"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(gsoep_match)]</a></code></pre></div>
<pre><code>## # A tibble: 346,921 x 18
##      SID p_year   age education gender grsWages physhlthevnt SRhealth smokes alcohol exercise
##    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
##  1   201   1994    58        NA      1    2979.            1      2.5     NA      NA     1   
##  2   203   1994    24         2     NA    5054.            1      4.5     NA      NA     4   
##  3   204   1994    NA        NA     NA    2599.            0     NA       NA      NA    NA   
##  4   601   1994    30        NA      0   31259.            1      4       NA      NA     3.86
##  5   602   1994    26         1      1   35436.            1      4       NA      NA     2.86
##  6   603   1994    43        NA     NA   66717.            0     NA       NA      NA    NA   
##  7   604   1994     1        NA     NA   69202.            0     NA       NA      NA    NA   
##  8   901   1994    33        NA      1   13774.            1      3.5     NA      NA     3.71
##  9  1101   1994    78        NA      1    1940.            1      3       NA      NA     1   
## 10  1202   1994    71        NA      1    2989.            1      3       NA      NA     1   
## # … with 346,911 more rows, and 7 more variables: BMI &lt;dbl&gt;, married &lt;dbl&gt;, numKids &lt;dbl&gt;,
## #   PhysFunc &lt;dbl&gt;, religion &lt;dbl&gt;, parEdu &lt;dbl&gt;, parOccPrstg &lt;dbl&gt;</code></pre>
</div>
<div id="imputation-2" class="section level3">
<h3><span class="header-section-number">2.4.6</span> Imputation</h3>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" data-line-number="1"><span class="co"># short helper functions to (1) identify and create factors, save col names of factors, remove columns with all missing values, and setup amelia</span></a>
<a class="sourceLine" id="cb54-2" data-line-number="2">factor_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){<span class="cf">if</span>(<span class="kw">is.numeric</span>(x)){<span class="kw">diff</span>(<span class="kw">range</span>(x, <span class="dt">na.rm =</span> T)) <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span>} <span class="cf">else</span>{F}}</a>
<a class="sourceLine" id="cb54-3" data-line-number="3">not_all_na &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">any</span>(<span class="op">!</span><span class="kw">is.na</span>(x))</a>
<a class="sourceLine" id="cb54-4" data-line-number="4">not_all_id &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="cf">if</span>(<span class="kw">is.numeric</span>(x)) <span class="kw">sd</span>(x, <span class="dt">na.rm =</span> T) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb54-5" data-line-number="5">mice_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb54-6" data-line-number="6">  <span class="kw">mice</span>(df, <span class="dt">m =</span> <span class="dv">5</span>, <span class="dt">maxit=</span><span class="dv">5</span>, <span class="dt">printFlag=</span><span class="ot">TRUE</span>, <span class="dt">method =</span> <span class="st">&quot;cart&quot;</span>)</a>
<a class="sourceLine" id="cb54-7" data-line-number="7">  }</a>
<a class="sourceLine" id="cb54-8" data-line-number="8">gsoep_match_imp &lt;-<span class="st"> </span>gsoep_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-9" data-line-number="9"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(year) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-10" data-line-number="10"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb54-12" data-line-number="12">         <span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(parEdu, parOccPrstg), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-14" data-line-number="14"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb54-15" data-line-number="15"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu, <span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-16" data-line-number="16"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb54-17" data-line-number="17"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-18" data-line-number="18"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-19" data-line-number="19"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_na) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_id)),</a>
<a class="sourceLine" id="cb54-20" data-line-number="20">         <span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(factor_fun, as.factor)),</a>
<a class="sourceLine" id="cb54-21" data-line-number="21">         <span class="dt">imp =</span> <span class="kw">map</span>(data, mice_fun))</a>
<a class="sourceLine" id="cb54-22" data-line-number="22">beepr<span class="op">::</span><span class="kw">beep</span>(<span class="dt">sound =</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb54-23" data-line-number="23"></a>
<a class="sourceLine" id="cb54-24" data-line-number="24">load_fun &lt;-<span class="st"> </span><span class="cf">function</span>(year){</a>
<a class="sourceLine" id="cb54-25" data-line-number="25">  <span class="kw">load</span>(<span class="kw">sprintf</span>(<span class="st">&quot;~/Downloads/GSOEP_%s.RData&quot;</span>, year))</a>
<a class="sourceLine" id="cb54-26" data-line-number="26">  m</a>
<a class="sourceLine" id="cb54-27" data-line-number="27">}</a>
<a class="sourceLine" id="cb54-28" data-line-number="28"></a>
<a class="sourceLine" id="cb54-29" data-line-number="29">gsoep_match_imp &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">year =</span> <span class="kw">c</span>(<span class="dv">1994</span>, <span class="dv">2002</span>, <span class="dv">2005</span>, <span class="dv">2006</span>, <span class="dv">2007</span>),</a>
<a class="sourceLine" id="cb54-30" data-line-number="30">                          <span class="dt">imp =</span> <span class="kw">map</span>(year, load_fun)) </a>
<a class="sourceLine" id="cb54-31" data-line-number="31"></a>
<a class="sourceLine" id="cb54-32" data-line-number="32">gsoep_match_imp &lt;-<span class="st"> </span>gsoep_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-33" data-line-number="33"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp, <span class="op">~</span>mice<span class="op">::</span><span class="kw">complete</span>(., <span class="st">&quot;long&quot;</span>)),</a>
<a class="sourceLine" id="cb54-34" data-line-number="34">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">nbhdQual =</span> <span class="kw">ifelse</span>(<span class="kw">is.factor</span>(nbhdQual), <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(nbhdQual)), nbhdQual))),</a>
<a class="sourceLine" id="cb54-35" data-line-number="35">         <span class="dt">imp_sca =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(.imp <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID,  <span class="kw">one_of</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name)))))</a>
<a class="sourceLine" id="cb54-36" data-line-number="36"></a>
<a class="sourceLine" id="cb54-37" data-line-number="37">gsoep_match_imp_long &lt;-<span class="st"> </span>gsoep_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-38" data-line-number="38"><span class="st">  </span><span class="kw">select</span>(year, imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-39" data-line-number="39"><span class="st">  </span><span class="kw">unnest</span>(imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-40" data-line-number="40"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">alcohol =</span> <span class="kw">factor</span>(<span class="kw">ifelse</span>(alcohol <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb54-41" data-line-number="41"></a>
<a class="sourceLine" id="cb54-42" data-line-number="42">gsoep_SCA_imp &lt;-<span class="st"> </span>gsoep_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-43" data-line-number="43"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-44" data-line-number="44"><span class="st">  </span><span class="kw">unnest</span>(imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-45" data-line-number="45"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">alcohol =</span> <span class="kw">ifelse</span>(alcohol <span class="op">&gt;</span><span class="st"> </span><span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-46" data-line-number="46"><span class="st">  </span><span class="kw">full_join</span>(gsoep_SCA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(p_year, SID, BMI))</a>
<a class="sourceLine" id="cb54-47" data-line-number="47"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(gsoep_SCA_imp)]</a>
<a class="sourceLine" id="cb54-48" data-line-number="48"></a>
<a class="sourceLine" id="cb54-49" data-line-number="49">gsoep_match_imp_long &lt;-<span class="st"> </span>gsoep_match_imp_long <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-50" data-line-number="50"><span class="st">  </span><span class="kw">select</span>(SID, age) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-51" data-line-number="51"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-52" data-line-number="52"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb54-53" data-line-number="53"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">age =</span> <span class="kw">Mode</span>(age))  <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb54-54" data-line-number="54"><span class="st">  </span><span class="kw">full_join</span>(gsoep_match_imp_long <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>age)) </a>
<a class="sourceLine" id="cb54-55" data-line-number="55"></a>
<a class="sourceLine" id="cb54-56" data-line-number="56">gsoep_SCA_imp &lt;-<span class="st"> </span>gsoep_SCA_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-57" data-line-number="57"><span class="st">  </span><span class="kw">select</span>(SID, smokes, alcohol, BMI) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-58" data-line-number="58"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(smokes), <span class="op">~</span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(.))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-59" data-line-number="59"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-60" data-line-number="60"><span class="st">  </span><span class="kw">gather</span>(item, value, <span class="op">-</span>SID, <span class="dt">na.rm =</span> T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-61" data-line-number="61"><span class="st">  </span><span class="kw">group_by</span>(SID, item) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-62" data-line-number="62"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-63" data-line-number="63"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-64" data-line-number="64"><span class="st">  </span><span class="kw">spread</span>(item, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-65" data-line-number="65"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(alcohol, smokes), factor) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-66" data-line-number="66"><span class="st">  </span><span class="kw">full_join</span>(gsoep_SCA_imp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>smokes, <span class="op">-</span>alcohol, <span class="op">-</span>BMI)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-67" data-line-number="67"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(age)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-68" data-line-number="68"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>age) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-69" data-line-number="69"><span class="st">  </span><span class="kw">full_join</span>(gsoep_match_imp_long <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID, <span class="dt">p_year =</span> year, age) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>())</a>
<a class="sourceLine" id="cb54-70" data-line-number="70"></a>
<a class="sourceLine" id="cb54-71" data-line-number="71">gsoep_match_imp_long &lt;-<span class="st"> </span>gsoep_match_imp_long <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">p_year =</span> year)</a></code></pre></div>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb55-1" data-line-number="1">gsoep_match &lt;-<span class="st"> </span>gsoep_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">SID =</span> persnr)</a>
<a class="sourceLine" id="cb55-2" data-line-number="2">gsoep_out &lt;-<span class="st"> </span>gsoep_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">SID =</span> persnr) </a>
<a class="sourceLine" id="cb55-3" data-line-number="3">gsoep_pers &lt;-<span class="st"> </span>gsoep_pers <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">SID =</span> persnr) </a>
<a class="sourceLine" id="cb55-4" data-line-number="4">gsoep_SCA &lt;-<span class="st"> </span>gsoep_SCA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">SID =</span> persnr) </a>
<a class="sourceLine" id="cb55-5" data-line-number="5"><span class="kw">save</span>(gsoep_SCA_imp, gsoep_match_imp_long,</a>
<a class="sourceLine" id="cb55-6" data-line-number="6">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/gsoep_imputed_small.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb55-7" data-line-number="7"><span class="kw">save</span>(gsoep_match_imp, </a>
<a class="sourceLine" id="cb55-8" data-line-number="8">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/gsoep_imputed.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb55-9" data-line-number="9"><span class="kw">save</span>(gsoep_alpha, gsoep_pers, gsoep_out, gsoep_match, gsoep_SCA,</a>
<a class="sourceLine" id="cb55-10" data-line-number="10">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/gsoep_cleaned.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb55-11" data-line-number="11"><span class="kw">save</span>(gsoep_long, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/gsoep_raw_long.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb55-12" data-line-number="12"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;gsoep&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" data-line-number="1"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;gsoep&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
</div>
</div>
<div id="hilda" class="section level2">
<h2><span class="header-section-number">2.5</span> HILDA</h2>
<p>The Household Income and Labour Dynamics in Australia (HILDA; Wilkins, Laß, Butterworth, &amp; Vera-Toscano, 2019) study is an ongoing longitudinal study of Australian households. These data are available through application from <a href="https://melbourneinstitute.unimelb.edu.au/hilda/for-data-users" class="uri">https://melbourneinstitute.unimelb.edu.au/hilda/for-data-users</a>.</p>
<p>Participants were recruited from more than 17,000 individuals. Data have been collected annually since 2001. The latest data release includes 17 waves of data from 2001 to 2017. More documentation can be found in the HILDA data dictionary at <a href="https://www.online.fbe.unimelb.edu.au/HILDAodd/srchSubjectAreas.aspx" class="uri">https://www.online.fbe.unimelb.edu.au/HILDAodd/srchSubjectAreas.aspx</a>.</p>
<p>Sample sizes vary by year, ranging from 12,408 (2004) to 17,693 (2016). This provides 99% power to detect a zero-order correlation effect size of ~.03, two tailed at alpha .05.</p>
<div id="load-data-4" class="section level3">
<h3><span class="header-section-number">2.5.1</span> Load Data</h3>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb57-1" data-line-number="1">hilda_read_fun &lt;-<span class="st"> </span><span class="cf">function</span>(Year, WL){</a>
<a class="sourceLine" id="cb57-2" data-line-number="2">  old.names &lt;-<span class="st"> </span>(hilda_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>Year <span class="op">|</span><span class="st"> </span>year <span class="op">==</span><span class="st"> </span><span class="dv">0</span>))<span class="op">$</span>orig_itemname</a>
<a class="sourceLine" id="cb57-3" data-line-number="3">  <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/hilda/Combined %s180c.sav&quot;</span>, wd, WL) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb57-4" data-line-number="4"><span class="st">    </span><span class="kw">select</span>(<span class="kw">one_of</span>(old.names)) </a>
<a class="sourceLine" id="cb57-5" data-line-number="5">}</a></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" data-line-number="1">hilda_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;HILDA&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb58-2" data-line-number="2">hilda_codebook</a></code></pre></div>
<pre><code>## # A tibble: 1,692 x 17
##    study dataset category name  itemname wave_letter  ...7  year new_itemname orig_itemname
##    &lt;chr&gt; &lt;lgl&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;        
##  1 hilda NA      match    alco… alcohol  &lt;NA&gt;           NA  2001 hilda__matc… alsdrink     
##  2 hilda NA      match    alco… alcohol  &lt;NA&gt;           NA  2002 hilda__matc… blsdrkf      
##  3 hilda NA      match    alco… alcohol  &lt;NA&gt;           NA  2003 hilda__matc… clsdrkf      
##  4 hilda NA      match    alco… alcohol  &lt;NA&gt;           NA  2004 hilda__matc… dlsdrkf      
##  5 hilda NA      match    alco… alcohol  &lt;NA&gt;           NA  2005 hilda__matc… elsdrkf      
##  6 hilda NA      match    alco… alcohol  &lt;NA&gt;           NA  2006 hilda__matc… flsdrkf      
##  7 hilda NA      match    alco… alcohol  &lt;NA&gt;           NA  2007 hilda__matc… glsdrkf      
##  8 hilda NA      match    alco… alcohol  &lt;NA&gt;           NA  2008 hilda__matc… hlsdrkf      
##  9 hilda NA      match    alco… alcohol  &lt;NA&gt;           NA  2009 hilda__matc… ilsdrkf      
## 10 hilda NA      match    alco… alcohol  &lt;NA&gt;           NA  2010 hilda__matc… jlsdrkf      
## # … with 1,682 more rows, and 7 more variables: description &lt;chr&gt;, scale &lt;chr&gt;,
## #   reverse_code &lt;chr&gt;, recode &lt;chr&gt;, mini &lt;dbl&gt;, maxi &lt;dbl&gt;, comp_rule &lt;chr&gt;</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb60-1" data-line-number="1">hilda &lt;-<span class="st"> </span>hilda_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb60-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(year, wave_letter) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb60-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(wave_letter)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb60-4" data-line-number="4"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb60-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2015</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb60-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(year, wave_letter, hilda_read_fun)) </a>
<a class="sourceLine" id="cb60-7" data-line-number="7"></a>
<a class="sourceLine" id="cb60-8" data-line-number="8"><span class="kw">save</span>(hilda, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/hilda_raw.RData&quot;</span>, wd))</a></code></pre></div>
</div>
<div id="matching-variables-3" class="section level3">
<h3><span class="header-section-number">2.5.2</span> Matching Variables</h3>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" data-line-number="1">rename_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, Year){</a>
<a class="sourceLine" id="cb61-2" data-line-number="2">  df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-3" data-line-number="3"><span class="st">    </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-4" data-line-number="4"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>xwaveid, <span class="dt">na.rm=</span>T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-5" data-line-number="5"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value=</span><span class="kw">as.numeric</span>(value))</a>
<a class="sourceLine" id="cb61-6" data-line-number="6">  hilda_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">==</span><span class="st"> </span>Year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-7" data-line-number="7"><span class="st">    </span><span class="kw">full_join</span>(df)</a>
<a class="sourceLine" id="cb61-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb61-9" data-line-number="9"></a>
<a class="sourceLine" id="cb61-10" data-line-number="10"><span class="co"># rename variables   </span></a>
<a class="sourceLine" id="cb61-11" data-line-number="11">hilda_match &lt;-<span class="st"> </span>hilda <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, year, rename_fun)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb61-13" data-line-number="13"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>year, <span class="op">-</span>wave_letter) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-14" data-line-number="14"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-15" data-line-number="15"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-16" data-line-number="16"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">SID =</span> xwaveid)</a>
<a class="sourceLine" id="cb61-17" data-line-number="17"></a>
<a class="sourceLine" id="cb61-18" data-line-number="18">yrBrth &lt;-<span class="st"> </span>hilda_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb61-19" data-line-number="19"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb61-20" data-line-number="20"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb61-21" data-line-number="21"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">yearBrth =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-22" data-line-number="22"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">yearBrth =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(yearBrth), <span class="ot">NA</span>, yearBrth))</a>
<a class="sourceLine" id="cb61-24" data-line-number="24"></a>
<a class="sourceLine" id="cb61-25" data-line-number="25"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb61-26" data-line-number="26">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, year){</a>
<a class="sourceLine" id="cb61-27" data-line-number="27">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb61-28" data-line-number="28">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb61-29" data-line-number="29">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb61-30" data-line-number="30">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb61-31" data-line-number="31">}</a>
<a class="sourceLine" id="cb61-32" data-line-number="32"></a>
<a class="sourceLine" id="cb61-33" data-line-number="33">hilda_match &lt;-<span class="st"> </span>hilda_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-34" data-line-number="34"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-35" data-line-number="35"><span class="st">  </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-36" data-line-number="36"><span class="st">  </span><span class="kw">group_by</span>(recode, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb61-37" data-line-number="37"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-38" data-line-number="38"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-39" data-line-number="39"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-40" data-line-number="40"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb61-41" data-line-number="41"></a>
<a class="sourceLine" id="cb61-42" data-line-number="42"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb61-43" data-line-number="43">hilda_match &lt;-<span class="st"> </span>hilda_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-44" data-line-number="44"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value,</a>
<a class="sourceLine" id="cb61-45" data-line-number="45">                        <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb61-46" data-line-number="46"></a>
<a class="sourceLine" id="cb61-47" data-line-number="47">fun_call &lt;-<span class="st"> </span><span class="cf">function</span>(x, rule){</a>
<a class="sourceLine" id="cb61-48" data-line-number="48">    <span class="cf">switch</span>(rule,</a>
<a class="sourceLine" id="cb61-49" data-line-number="49">           <span class="dt">average =</span> <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb61-50" data-line-number="50">           <span class="dt">mode =</span> <span class="kw">Mode</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb61-51" data-line-number="51">           <span class="dt">sum =</span> <span class="kw">sum</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb61-52" data-line-number="52">           <span class="dt">skip =</span> <span class="kw">unique</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb61-53" data-line-number="53">           <span class="dt">max =</span> <span class="kw">max</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb61-54" data-line-number="54">           <span class="dt">min =</span> <span class="kw">min</span>(x, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb61-55" data-line-number="55">  }</a>
<a class="sourceLine" id="cb61-56" data-line-number="56"></a>
<a class="sourceLine" id="cb61-57" data-line-number="57"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb61-58" data-line-number="58">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb61-59" data-line-number="59">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-60" data-line-number="60"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb61-61" data-line-number="61"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-62" data-line-number="62"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb61-63" data-line-number="63">}</a>
<a class="sourceLine" id="cb61-64" data-line-number="64"></a>
<a class="sourceLine" id="cb61-65" data-line-number="65">hilda_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;HILDA&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb61-66" data-line-number="66"></a>
<a class="sourceLine" id="cb61-67" data-line-number="67">hilda_match &lt;-<span class="st"> </span>hilda_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-68" data-line-number="68"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="kw">max</span>(hilda_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-69" data-line-number="69"><span class="st">  </span><span class="kw">group_by</span>(comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-70" data-line-number="70"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-71" data-line-number="71"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-72" data-line-number="72"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-73" data-line-number="73"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb61-74" data-line-number="74"></a>
<a class="sourceLine" id="cb61-75" data-line-number="75">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, p_year){</a>
<a class="sourceLine" id="cb61-76" data-line-number="76">  hilda_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-77" data-line-number="77"><span class="st">    </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span>p_year  <span class="op">&amp;</span><span class="st"> </span>comp_rule <span class="op">==</span><span class="st"> </span>rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-78" data-line-number="78"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-79" data-line-number="79"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-80" data-line-number="80"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb61-81" data-line-number="81">}</a>
<a class="sourceLine" id="cb61-82" data-line-number="82"></a>
<a class="sourceLine" id="cb61-83" data-line-number="83">hilda_match &lt;-<span class="st"> </span><span class="kw">crossing</span>(</a>
<a class="sourceLine" id="cb61-84" data-line-number="84">  <span class="dt">p_year =</span> hilda_waves<span class="op">$</span>Used, </a>
<a class="sourceLine" id="cb61-85" data-line-number="85">  <span class="dt">comp_rule =</span> <span class="kw">unique</span>(hilda_match<span class="op">$</span>comp_rule)</a>
<a class="sourceLine" id="cb61-86" data-line-number="86">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-87" data-line-number="87"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(comp_rule, p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-88" data-line-number="88"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-89" data-line-number="89"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-90" data-line-number="90"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb61-91" data-line-number="91"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> name, <span class="dt">values_from =</span> value, <span class="dt">names_repair =</span> <span class="st">&quot;unique&quot;</span>) </a></code></pre></div>
<pre><code>## # A tibble: 82,104 x 58
##    p_year    SID     A     C   DEP     E    IQ   LOC     N  `NA`     O    PA    SE    SS
##     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1   2003 100001    NA    NA     0    NA    NA  6       NA  1.33    NA   5      NA   4.3
##  2   2003 100002    NA    NA     1    NA    NA  2.71    NA  2       NA   4      NA   5  
##  3   2003 100003    NA    NA     0    NA    NA  5.71    NA  2       NA   4.5    NA   4.2
##  4   2003 100004    NA    NA     0    NA    NA  4.43    NA  2.67    NA   4.5    NA   5.3
##  5   2003 100005    NA    NA     0    NA    NA  7       NA  1       NA   5      NA   7  
##  6   2003 100006    NA    NA     1    NA    NA  5       NA  3       NA   5.5    NA   4.2
##  7   2003 100008    NA    NA    NA    NA    NA NA       NA NA       NA  NA      NA  NA  
##  8   2003 100009    NA    NA    NA    NA    NA NA       NA NA       NA  NA      NA  NA  
##  9   2003 100010    NA    NA     0    NA    NA  5.57    NA  1.33    NA   5      NA   5.9
## 10   2003 100011    NA    NA     1    NA    NA  6.14    NA  2.33    NA   4      NA   6.5
## # … with 82,094 more rows, and 44 more variables: SWL &lt;dbl&gt;, yearBrth &lt;dbl&gt;,
## #   compareHealth &lt;dbl&gt;, grsWages &lt;dbl&gt;, HHsize &lt;dbl&gt;, hlthDecline &lt;dbl&gt;, loneliness &lt;dbl&gt;,
## #   nbhdQual &lt;dbl&gt;, PhysFunc &lt;dbl&gt;, satFam &lt;dbl&gt;, satFinances &lt;dbl&gt;, satHH &lt;dbl&gt;,
## #   sickEasy &lt;dbl&gt;, SRhealth &lt;dbl&gt;, alcohol &lt;dbl&gt;, dadOccPrstg &lt;dbl&gt;, dadOcc &lt;dbl&gt;,
## #   education &lt;dbl&gt;, employed &lt;dbl&gt;, exercise &lt;dbl&gt;, married &lt;dbl&gt;, numKids &lt;dbl&gt;,
## #   urban &lt;dbl&gt;, welfare &lt;dbl&gt;, momOccPrstg &lt;dbl&gt;, momOcc &lt;dbl&gt;, disability &lt;dbl&gt;,
## #   ageMarried &lt;dbl&gt;, gender &lt;dbl&gt;, hospital &lt;dbl&gt;, visitDr &lt;dbl&gt;, weight &lt;dbl&gt;,
## #   height &lt;dbl&gt;, numSiblng &lt;dbl&gt;, dadAlive &lt;dbl&gt;, momAlive &lt;dbl&gt;, physhlthevnt &lt;dbl&gt;,
## #   age &lt;dbl&gt;, BMI &lt;dbl&gt;, dadEdu &lt;dbl&gt;, momEdu &lt;dbl&gt;, parDivorce &lt;dbl&gt;, religion &lt;dbl&gt;,
## #   smokes &lt;dbl&gt;</code></pre>
</div>
<div id="personality-variables-3" class="section level3">
<h3><span class="header-section-number">2.5.3</span> Personality Variables</h3>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb63-1" data-line-number="1">hilda &lt;-<span class="st"> </span><span class="kw">reduce</span>(hilda<span class="op">$</span>data, full_join) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.)</a>
<a class="sourceLine" id="cb63-2" data-line-number="2"></a>
<a class="sourceLine" id="cb63-3" data-line-number="3">hilda_long &lt;-<span class="st"> </span>hilda <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate_all</span>(as.numeric) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-5" data-line-number="5"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>xwaveid, <span class="dt">names_to =</span> <span class="st">&quot;orig_itemname&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;value&quot;</span>, <span class="dt">values_drop_na =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-6" data-line-number="6"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">SID =</span> xwaveid)</a>
<a class="sourceLine" id="cb63-7" data-line-number="7"></a>
<a class="sourceLine" id="cb63-8" data-line-number="8"><span class="co"># keep correct personality waves</span></a>
<a class="sourceLine" id="cb63-9" data-line-number="9">hilda_pers &lt;-<span class="st"> </span>hilda_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb63-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;pers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-12" data-line-number="12"><span class="st">  </span><span class="kw">left_join</span>(hilda_long) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-13" data-line-number="13"><span class="st">  </span><span class="kw">left_join</span>(p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;HILDA&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">name =</span> p_item, Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-14" data-line-number="14"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span>Used) </a>
<a class="sourceLine" id="cb63-15" data-line-number="15"></a>
<a class="sourceLine" id="cb63-16" data-line-number="16">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb63-17" data-line-number="17">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb63-18" data-line-number="18">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb63-19" data-line-number="19">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb63-20" data-line-number="20">}</a>
<a class="sourceLine" id="cb63-21" data-line-number="21"></a>
<a class="sourceLine" id="cb63-22" data-line-number="22"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb63-23" data-line-number="23">hilda_pers &lt;-<span class="st"> </span>hilda_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-24" data-line-number="24"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, reverse_code<span class="op">:</span>comp_rule, SID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-25" data-line-number="25"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-26" data-line-number="26"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-27" data-line-number="27"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-28" data-line-number="28"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-29" data-line-number="29"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb63-30" data-line-number="30"></a>
<a class="sourceLine" id="cb63-31" data-line-number="31"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb63-32" data-line-number="32">hilda_pers &lt;-<span class="st"> </span>hilda_pers <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-33" data-line-number="33"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb63-34" data-line-number="34"></a>
<a class="sourceLine" id="cb63-35" data-line-number="35"><span class="co"># alpha&#39;s</span></a>
<a class="sourceLine" id="cb63-36" data-line-number="36">hilda_alpha &lt;-<span class="st"> </span>hilda_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-37" data-line-number="37"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, SID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-38" data-line-number="38"><span class="st">  </span><span class="kw">group_by</span>(name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-39" data-line-number="39"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-40" data-line-number="40"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> itemname, <span class="dt">values_from =</span> value)),</a>
<a class="sourceLine" id="cb63-41" data-line-number="41">         <span class="dt">alpha =</span> <span class="kw">map</span>(data, <span class="kw">possibly</span>(<span class="op">~</span>psych<span class="op">::</span><span class="kw">alpha</span>((.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>SID)), <span class="ot">NA_real_</span>)))</a>
<a class="sourceLine" id="cb63-42" data-line-number="42"></a>
<a class="sourceLine" id="cb63-43" data-line-number="43">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb63-44" data-line-number="44">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-45" data-line-number="45"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-46" data-line-number="46"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-47" data-line-number="47"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb63-48" data-line-number="48">}</a>
<a class="sourceLine" id="cb63-49" data-line-number="49"></a>
<a class="sourceLine" id="cb63-50" data-line-number="50"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb63-51" data-line-number="51">hilda_pers &lt;-<span class="st"> </span>hilda_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-52" data-line-number="52"><span class="st">  </span><span class="kw">group_by</span>(name, comp_rule, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-53" data-line-number="53"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-54" data-line-number="54"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-55" data-line-number="55"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;average&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb63-56" data-line-number="56">         <span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-57" data-line-number="57"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb63-58" data-line-number="58"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))</a></code></pre></div>
</div>
<div id="outcome-variables-4" class="section level3">
<h3><span class="header-section-number">2.5.4</span> Outcome Variables</h3>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" data-line-number="1">hilda_out &lt;-<span class="st"> </span>hilda_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb64-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">!=</span><span class="st"> &quot;0&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-4" data-line-number="4"><span class="st">  </span><span class="kw">left_join</span>(hilda_long) </a>
<a class="sourceLine" id="cb64-5" data-line-number="5"></a>
<a class="sourceLine" id="cb64-6" data-line-number="6">old.names &lt;-<span class="st"> </span><span class="kw">unique</span>((hilda_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">==</span><span class="st"> &quot;0&quot;</span>))<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb64-7" data-line-number="7">hilda_out_stp &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/hilda/Master r180c.sav&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb64-8" data-line-number="8"><span class="st">  </span><span class="kw">read_sav</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-9" data-line-number="9"><span class="st">  </span><span class="kw">zap_labels</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(<span class="dt">SID =</span> xwaveid, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-11" data-line-number="11"><span class="st">  </span><span class="kw">gather</span>(orig_itemname, value, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-12" data-line-number="12"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">orig_itemname =</span> <span class="st">&quot;yodeath&quot;</span>, <span class="dt">year =</span> hilda_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-13" data-line-number="13"><span class="st">  </span><span class="kw">left_join</span>(hilda_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>new_itemname, <span class="op">-</span>year))</a>
<a class="sourceLine" id="cb64-14" data-line-number="14"></a>
<a class="sourceLine" id="cb64-15" data-line-number="15"><span class="co"># recode</span></a>
<a class="sourceLine" id="cb64-16" data-line-number="16">hilda_out &lt;-<span class="st"> </span>hilda_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-17" data-line-number="17"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, reverse_code<span class="op">:</span>comp_rule, SID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-18" data-line-number="18"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-19" data-line-number="19"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-20" data-line-number="20"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-22" data-line-number="22"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb64-23" data-line-number="23"></a>
<a class="sourceLine" id="cb64-24" data-line-number="24">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year){</a>
<a class="sourceLine" id="cb64-25" data-line-number="25">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb64-26" data-line-number="26">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb64-27" data-line-number="27">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb64-28" data-line-number="28">}</a>
<a class="sourceLine" id="cb64-29" data-line-number="29"></a>
<a class="sourceLine" id="cb64-30" data-line-number="30">hilda_out_stp &lt;-<span class="st"> </span>hilda_out_stp <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb64-31" data-line-number="31"><span class="st">  </span><span class="kw">group_by</span>(recode, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-32" data-line-number="32"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-33" data-line-number="33"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-34" data-line-number="34"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-35" data-line-number="35"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb64-36" data-line-number="36">  </a>
<a class="sourceLine" id="cb64-37" data-line-number="37"></a>
<a class="sourceLine" id="cb64-38" data-line-number="38"><span class="co"># composite within years </span></a>
<a class="sourceLine" id="cb64-39" data-line-number="39"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb64-40" data-line-number="40">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb64-41" data-line-number="41">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-42" data-line-number="42"><span class="st">    </span><span class="kw">group_by</span>(SID, name, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb64-43" data-line-number="43"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-44" data-line-number="44"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb64-45" data-line-number="45">}</a>
<a class="sourceLine" id="cb64-46" data-line-number="46"></a>
<a class="sourceLine" id="cb64-47" data-line-number="47">hilda_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;HILDA&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb64-48" data-line-number="48"></a>
<a class="sourceLine" id="cb64-49" data-line-number="49">hilda_out &lt;-<span class="st"> </span>hilda_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-50" data-line-number="50"><span class="st">  </span><span class="co"># filter(year &lt;= max(hilda_waves$Used)) %&gt;%</span></a>
<a class="sourceLine" id="cb64-51" data-line-number="51"><span class="st">  </span><span class="kw">group_by</span>(comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-52" data-line-number="52"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-53" data-line-number="53"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-54" data-line-number="54"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;max&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb64-55" data-line-number="55">         <span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-56" data-line-number="56"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-57" data-line-number="57"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb64-58" data-line-number="58"></a>
<a class="sourceLine" id="cb64-59" data-line-number="59"><span class="co"># composite across years</span></a>
<a class="sourceLine" id="cb64-60" data-line-number="60">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(p_year){</a>
<a class="sourceLine" id="cb64-61" data-line-number="61">  hilda_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-62" data-line-number="62"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>p_year, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;past&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-63" data-line-number="63"><span class="st">    </span><span class="kw">group_by</span>(SID, name, group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-64" data-line-number="64"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-65" data-line-number="65"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-66" data-line-number="66"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-67" data-line-number="67"><span class="st">    </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> group, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-68" data-line-number="68"><span class="st">    </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-69" data-line-number="69"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(past) <span class="op">|</span><span class="st"> </span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(future)), future,</a>
<a class="sourceLine" id="cb64-70" data-line-number="70">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(future), past, </a>
<a class="sourceLine" id="cb64-71" data-line-number="71">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)))) </a>
<a class="sourceLine" id="cb64-72" data-line-number="72">}</a>
<a class="sourceLine" id="cb64-73" data-line-number="73"></a>
<a class="sourceLine" id="cb64-74" data-line-number="74">hilda_out &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">p_year =</span> hilda_waves<span class="op">$</span>Used) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-75" data-line-number="75"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-76" data-line-number="76"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb64-77" data-line-number="77"><span class="st">  </span><span class="kw">full_join</span>(hilda_out_stp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, SID, name, value) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">SID =</span> <span class="kw">as.numeric</span>(SID)))</a></code></pre></div>
</div>
<div id="covariates-3" class="section level3">
<h3><span class="header-section-number">2.5.5</span> Covariates</h3>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" data-line-number="1">hilda_match &lt;-<span class="st"> </span>hilda_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-3" data-line-number="3"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-4" data-line-number="4"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">p_year =</span> year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-5" data-line-number="5"><span class="st">  </span><span class="kw">full_join</span>(hilda_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">SID =</span> <span class="kw">as.numeric</span>(SID))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-6" data-line-number="6"><span class="st">  </span><span class="co"># physical health event</span></a>
<a class="sourceLine" id="cb65-7" data-line-number="7"><span class="st">  </span><span class="kw">left_join</span>(hilda_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;physhlthevnt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(p_year, SID, <span class="dt">physhlthevnt =</span> past) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(SID, p_year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">physhlthevnt =</span> <span class="kw">max</span>(physhlthevnt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-8" data-line-number="8"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb65-9" data-line-number="9"></a>
<a class="sourceLine" id="cb65-10" data-line-number="10">hilda_match &lt;-<span class="st"> </span>hilda_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-11" data-line-number="11"><span class="st">  </span><span class="kw">group_by</span>(SID, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> p_year <span class="op">-</span><span class="st"> </span>yearBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-13" data-line-number="13"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-14" data-line-number="14"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">momOccPrstg =</span> momJobPrstg, <span class="dt">dadOccPrstg =</span> dadJobPrstg) </a>
<a class="sourceLine" id="cb65-15" data-line-number="15"></a>
<a class="sourceLine" id="cb65-16" data-line-number="16">hilda_dem &lt;-<span class="st"> </span>hilda_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-17" data-line-number="17"><span class="st">  </span><span class="kw">select</span>(SID, religion, smokes, parDivorce, BMI, momEdu, dadEdu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-18" data-line-number="18"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key=</span> item, <span class="dt">value =</span> value, <span class="op">-</span>SID, <span class="dt">na.rm =</span> T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-19" data-line-number="19"><span class="st">  </span><span class="kw">group_by</span>(SID, item) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-20" data-line-number="20"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-21" data-line-number="21"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-22" data-line-number="22"><span class="st">  </span><span class="kw">spread</span>(item, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parDivorce =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(parDivorce), <span class="dv">0</span>, parDivorce))</a>
<a class="sourceLine" id="cb65-24" data-line-number="24"></a>
<a class="sourceLine" id="cb65-25" data-line-number="25">hilda_match &lt;-<span class="st"> </span>hilda_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-26" data-line-number="26"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>religion, <span class="op">-</span>smokes, <span class="op">-</span>parDivorce, <span class="op">-</span>BMI, <span class="op">-</span>momEdu, <span class="op">-</span>dadEdu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-27" data-line-number="27"><span class="st">  </span><span class="kw">full_join</span>(hilda_dem)</a>
<a class="sourceLine" id="cb65-28" data-line-number="28">  </a>
<a class="sourceLine" id="cb65-29" data-line-number="29"></a>
<a class="sourceLine" id="cb65-30" data-line-number="30">hilda_out &lt;-<span class="st"> </span>hilda_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-31" data-line-number="31"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>past, <span class="op">-</span>future) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-32" data-line-number="32"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb65-33" data-line-number="33"></a>
<a class="sourceLine" id="cb65-34" data-line-number="34">hilda_SCA &lt;-<span class="st"> </span>hilda_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-35" data-line-number="35"><span class="st">  </span><span class="kw">select</span>(SID, p_year, <span class="kw">one_of</span>(<span class="kw">c</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name), <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;dadEdu&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-36" data-line-number="36"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-37" data-line-number="37"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb65-38" data-line-number="38">         <span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-39" data-line-number="39"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(parEdu, parOccPrstg), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb65-40" data-line-number="40"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb65-41" data-line-number="41"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu, <span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg)</a>
<a class="sourceLine" id="cb65-42" data-line-number="42"></a>
<a class="sourceLine" id="cb65-43" data-line-number="43"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(hilda_SCA_imp)]</a></code></pre></div>
</div>
<div id="imputation-3" class="section level3">
<h3><span class="header-section-number">2.5.6</span> Imputation</h3>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb66-1" data-line-number="1"><span class="co"># short helper functions to (1) identify and create factors, save col names of factors, remove columns with all missing values, and setup amelia</span></a>
<a class="sourceLine" id="cb66-2" data-line-number="2">factor_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){<span class="cf">if</span>(<span class="kw">is.numeric</span>(x)){<span class="kw">diff</span>(<span class="kw">range</span>(x, <span class="dt">na.rm =</span> T)) <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(x)) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">4</span>} <span class="cf">else</span>{F}}</a>
<a class="sourceLine" id="cb66-3" data-line-number="3">not_all_id &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="cf">if</span>(<span class="kw">is.numeric</span>(x)) <span class="kw">sd</span>(x, <span class="dt">na.rm =</span> T) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb66-4" data-line-number="4">mice_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb66-5" data-line-number="5">  <span class="kw">mice</span>(df, <span class="dt">m =</span> <span class="dv">5</span>, <span class="dt">maxit=</span><span class="dv">5</span>, <span class="dt">printFlag=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb66-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb66-7" data-line-number="7">hilda_match_imp &lt;-<span class="st"> </span>hilda_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-8" data-line-number="8"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">NegAff =</span> <span class="st">`</span><span class="dt">NA</span><span class="st">`</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-9" data-line-number="9"><span class="st">  </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-12" data-line-number="12"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate_all</span>(<span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-14" data-line-number="14"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(year) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-15" data-line-number="15"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-16" data-line-number="16"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-17" data-line-number="17"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-18" data-line-number="18"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_na) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_id)),</a>
<a class="sourceLine" id="cb66-19" data-line-number="19">         <span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(factor_fun, as.factor)),</a>
<a class="sourceLine" id="cb66-20" data-line-number="20">         <span class="dt">imp =</span> <span class="kw">map</span>(data, mice_fun))</a>
<a class="sourceLine" id="cb66-21" data-line-number="21">beepr<span class="op">::</span><span class="kw">beep</span>(<span class="dt">sound =</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb66-22" data-line-number="22"></a>
<a class="sourceLine" id="cb66-23" data-line-number="23">hilda_match_imp &lt;-<span class="st"> </span>hilda_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp, <span class="op">~</span>mice<span class="op">::</span><span class="kw">complete</span>(., <span class="st">&quot;long&quot;</span>)),</a>
<a class="sourceLine" id="cb66-25" data-line-number="25">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">PhysFunc =</span> <span class="kw">factor</span>(<span class="kw">ifelse</span>(PhysFunc <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)))),</a>
<a class="sourceLine" id="cb66-26" data-line-number="26">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb66-27" data-line-number="27"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-28" data-line-number="28"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-29" data-line-number="29"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-30" data-line-number="30"><span class="st">    </span><span class="kw">ungroup</span>()),</a>
<a class="sourceLine" id="cb66-31" data-line-number="31">         <span class="dt">imp_sca =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(.imp <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID,  <span class="kw">one_of</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name)))))</a>
<a class="sourceLine" id="cb66-32" data-line-number="32"></a>
<a class="sourceLine" id="cb66-33" data-line-number="33">hilda_match_imp_long &lt;-<span class="st"> </span>hilda_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-34" data-line-number="34"><span class="st">  </span><span class="kw">select</span>(p_year, imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-35" data-line-number="35"><span class="st">  </span><span class="kw">unnest</span>(imp_df)</a>
<a class="sourceLine" id="cb66-36" data-line-number="36"></a>
<a class="sourceLine" id="cb66-37" data-line-number="37">hilda_SCA_imp &lt;-<span class="st"> </span>hilda_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-38" data-line-number="38"><span class="st">  </span><span class="kw">select</span>(p_year, imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-39" data-line-number="39"><span class="st">  </span><span class="kw">unnest</span>(imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-40" data-line-number="40"><span class="st">  </span><span class="kw">left_join</span>(hilda_SCA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(p_year, SID,</a>
<a class="sourceLine" id="cb66-41" data-line-number="41">        <span class="kw">colnames</span>(hilda_SCA)[<span class="op">!</span><span class="kw">colnames</span>(hilda_SCA) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(.)])) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb66-42" data-line-number="42"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">race =</span> <span class="kw">factor</span>(<span class="dv">0</span>))</a>
<a class="sourceLine" id="cb66-43" data-line-number="43"></a>
<a class="sourceLine" id="cb66-44" data-line-number="44"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(hilda_SCA_imp)]</a></code></pre></div>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" data-line-number="1"><span class="kw">save</span>(hilda_match_imp_long, hilda_SCA_imp, </a>
<a class="sourceLine" id="cb67-2" data-line-number="2">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/hilda_imputed_small.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb67-3" data-line-number="3"><span class="kw">save</span>(hilda_match_imp, </a>
<a class="sourceLine" id="cb67-4" data-line-number="4">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/hilda_imputed.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb67-5" data-line-number="5"><span class="kw">save</span>(hilda_alpha, hilda_pers, hilda_out, hilda_match, hilda_SCA,</a>
<a class="sourceLine" id="cb67-6" data-line-number="6">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/hilda_cleaned.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb67-7" data-line-number="7"><span class="kw">save</span>(hilda_long, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/hilda_raw_long.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb67-8" data-line-number="8"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;hilda&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;hilda&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
</div>
</div>
<div id="hrs" class="section level2">
<h2><span class="header-section-number">2.6</span> HRS</h2>
<p>The Health and Retirement Study (HRS; Juster &amp; Suzman, 1995) is an ongoing longitudinal study of households in the United States. These data are available at <a href="https://hrs.isr.umich.edu" class="uri">https://hrs.isr.umich.edu</a> by creating a free account.</p>
<p>Participants were recruited from more than 35,000 individuals from the financial households of individuals born between 1931 and 1941 in the US. Data have been collected biannually since 1992. The latest data release includes data up to 2016. On average, 10,000 individuals are sampled each wave More information on the HRS can be found at <a href="https://hrs.isr.umich.edu/documentation/survey-design" class="uri">https://hrs.isr.umich.edu/documentation/survey-design</a>, but, in short, the HRS is a nationally representative sample of adults over 50 in the US. It is critical to note that the HRS samples households of the original cohort and follows individuals and their spouses or partners until their death.</p>
<p>Sample size varies by year, ranging from approximately 7,500 (2014) to 15,500 (1992). (<a href="https://hrs.isr.umich.edu/sites/default/files/biblio/ResponseRates_2017.pdf" class="uri">https://hrs.isr.umich.edu/sites/default/files/biblio/ResponseRates_2017.pdf</a>). This provides 99/% power to detect a zero-order correlation effect size of ~.04, two-tailed at alpha .05.</p>
<div id="load-data-5" class="section level3">
<h3><span class="header-section-number">2.6.1</span> Load Data</h3>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb69-1" data-line-number="1">hrs_read_fun &lt;-<span class="st"> </span><span class="cf">function</span>(year) {</a>
<a class="sourceLine" id="cb69-2" data-line-number="2">  read_da &lt;-<span class="st"> </span><span class="cf">function</span>(da, dct, Year){</a>
<a class="sourceLine" id="cb69-3" data-line-number="3">    <span class="kw">print</span>(<span class="kw">paste</span>(da, dct, year, <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>))</a>
<a class="sourceLine" id="cb69-4" data-line-number="4">    data.file &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/hrs/%s/%s&quot;</span>, wd, Year, da)</a>
<a class="sourceLine" id="cb69-5" data-line-number="5">    <span class="co"># Set path to the dictionary file &quot;*.DCT&quot;</span></a>
<a class="sourceLine" id="cb69-6" data-line-number="6">    dict.file &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/hrs/%s/%s&quot;</span>, wd, Year, dct)</a>
<a class="sourceLine" id="cb69-7" data-line-number="7">    <span class="co"># Read the dictionary file</span></a>
<a class="sourceLine" id="cb69-8" data-line-number="8">    df.dict &lt;-<span class="st"> </span><span class="kw">read.table</span>(dict.file, <span class="dt">skip =</span> <span class="dv">1</span>, <span class="dt">fill =</span> <span class="ot">TRUE</span>, <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb69-9" data-line-number="9">    <span class="co"># Set column names for dictionary dataframe</span></a>
<a class="sourceLine" id="cb69-10" data-line-number="10">    <span class="kw">colnames</span>(df.dict) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;col.num&quot;</span>,<span class="st">&quot;col.type&quot;</span>,<span class="st">&quot;col.name&quot;</span>,<span class="st">&quot;col.width&quot;</span>,<span class="st">&quot;col.lbl&quot;</span>)</a>
<a class="sourceLine" id="cb69-11" data-line-number="11">    <span class="co"># Remove last row which only contains a closing }</span></a>
<a class="sourceLine" id="cb69-12" data-line-number="12">    row &lt;-<span class="st"> </span><span class="kw">which</span>(df.dict<span class="op">$</span>col.name <span class="op">==</span><span class="st"> &quot;HHID&quot;</span>)</a>
<a class="sourceLine" id="cb69-13" data-line-number="13">    df.dict &lt;-<span class="st"> </span>df.dict[<span class="op">-</span><span class="kw">nrow</span>(df.dict),]</a>
<a class="sourceLine" id="cb69-14" data-line-number="14">    <span class="cf">if</span>(row <span class="op">==</span><span class="st"> </span><span class="dv">2</span>){df.dict &lt;-<span class="st"> </span>df.dict[<span class="op">-</span><span class="dv">1</span>,]}</a>
<a class="sourceLine" id="cb69-15" data-line-number="15">    <span class="co"># Extract numeric value from column width field</span></a>
<a class="sourceLine" id="cb69-16" data-line-number="16">    df.dict<span class="op">$</span>col.width &lt;-<span class="st"> </span><span class="kw">as.integer</span>(<span class="kw">sapply</span>(df.dict<span class="op">$</span>col.width, gsub, <span class="dt">pattern =</span> <span class="st">&quot;[^0-9</span><span class="ch">\\</span><span class="st">.]&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>))</a>
<a class="sourceLine" id="cb69-17" data-line-number="17">    <span class="co"># Convert column types to format to be used with read_fwf function</span></a>
<a class="sourceLine" id="cb69-18" data-line-number="18">    df.dict<span class="op">$</span>col.type &lt;-<span class="st"> </span><span class="kw">sapply</span>(df.dict<span class="op">$</span>col.type, <span class="cf">function</span>(x) <span class="kw">ifelse</span>(x <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;int&quot;</span>,<span class="st">&quot;byte&quot;</span>,<span class="st">&quot;long&quot;</span>), <span class="st">&quot;i&quot;</span>, <span class="kw">ifelse</span>(x <span class="op">==</span><span class="st"> &quot;float&quot;</span>, <span class="st">&quot;n&quot;</span>, <span class="kw">ifelse</span>(x <span class="op">==</span><span class="st"> &quot;double&quot;</span>, <span class="st">&quot;d&quot;</span>, <span class="st">&quot;c&quot;</span>))))</a>
<a class="sourceLine" id="cb69-19" data-line-number="19">    <span class="co"># Read the data file into a dataframe</span></a>
<a class="sourceLine" id="cb69-20" data-line-number="20">    df &lt;-<span class="st"> </span><span class="kw">read_fwf</span>(<span class="dt">file =</span> data.file, <span class="kw">fwf_widths</span>(<span class="dt">widths =</span> df.dict<span class="op">$</span>col.width, <span class="dt">col_names =</span> df.dict<span class="op">$</span>col.name), <span class="dt">col_types =</span> <span class="kw">paste</span>(df.dict<span class="op">$</span>col.type, <span class="dt">collapse =</span> <span class="st">&quot;&quot;</span>))</a>
<a class="sourceLine" id="cb69-21" data-line-number="21">    <span class="co"># Add column labels to headers</span></a>
<a class="sourceLine" id="cb69-22" data-line-number="22">    <span class="kw">attributes</span>(df)<span class="op">$</span>variable.labels &lt;-<span class="st"> </span>df.dict<span class="op">$</span>col.lbl</a>
<a class="sourceLine" id="cb69-23" data-line-number="23">    old.names &lt;-<span class="st"> </span>(hrs_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span>Year))<span class="op">$</span>orig_itemname</a>
<a class="sourceLine" id="cb69-24" data-line-number="24">    <span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">c</span>(<span class="st">&quot;PN&quot;</span>, <span class="st">&quot;HHID&quot;</span>) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(df)) <span class="op">&amp;</span><span class="st"> </span><span class="kw">any</span>(old.names <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(df))){</a>
<a class="sourceLine" id="cb69-25" data-line-number="25">    <span class="co"># if(any(c(&quot;PN&quot;, &quot;HHID&quot;) %in% colnames(df))){</span></a>
<a class="sourceLine" id="cb69-26" data-line-number="26">      df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-27" data-line-number="27"><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">hhidpn =</span> <span class="dv">1000</span><span class="op">*</span><span class="kw">as.numeric</span>(HHID) <span class="op">+</span><span class="st"> </span><span class="kw">as.numeric</span>(PN)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-28" data-line-number="28"><span class="st">      </span><span class="kw">select</span>(<span class="kw">one_of</span>(<span class="kw">c</span>(<span class="st">&quot;PN&quot;</span>, <span class="st">&quot;HHID&quot;</span>)), <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-29" data-line-number="29"><span class="st">        </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb69-30" data-line-number="30">      <span class="co"># gather(key = item, value = value, -hhidpn)</span></a>
<a class="sourceLine" id="cb69-31" data-line-number="31">    } <span class="cf">else</span> {df &lt;-<span class="st"> </span><span class="ot">NA</span>}</a>
<a class="sourceLine" id="cb69-32" data-line-number="32">    <span class="kw">return</span>(df)</a>
<a class="sourceLine" id="cb69-33" data-line-number="33">  }</a>
<a class="sourceLine" id="cb69-34" data-line-number="34">    <span class="co"># Set path to the data file &quot;*.DA&quot;</span></a>
<a class="sourceLine" id="cb69-35" data-line-number="35">  files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="kw">sprintf</span>(<span class="st">&quot;%s/data/hrs/%s&quot;</span>, wd, year))</a>
<a class="sourceLine" id="cb69-36" data-line-number="36">  df2 &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb69-37" data-line-number="37">    <span class="dt">da =</span> files[<span class="kw">grepl</span>(<span class="st">&quot;.da&quot;</span>,  files) <span class="op">|</span><span class="st"> </span><span class="kw">grepl</span>(<span class="st">&quot;.DA&quot;</span>, files)],</a>
<a class="sourceLine" id="cb69-38" data-line-number="38">    <span class="dt">dct =</span> files[<span class="kw">grepl</span>(<span class="st">&quot;.dct&quot;</span>, files) <span class="op">|</span><span class="st"> </span><span class="kw">grepl</span>(<span class="st">&quot;.DCT&quot;</span>, files)]</a>
<a class="sourceLine" id="cb69-39" data-line-number="39">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-40" data-line-number="40"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(da, dct, <span class="kw">possibly</span>(<span class="op">~</span><span class="kw">read_da</span>(.x, .y, year), <span class="ot">NA_real_</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-41" data-line-number="41"><span class="st">    </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(data)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb69-42" data-line-number="42"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>da, <span class="op">-</span>dct) </a>
<a class="sourceLine" id="cb69-43" data-line-number="43">  <span class="cf">if</span>(<span class="kw">nrow</span>(df2) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>){df2<span class="op">$</span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">reduce</span>(full_join) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()} <span class="cf">else</span> {<span class="ot">NA</span>}</a>
<a class="sourceLine" id="cb69-44" data-line-number="44">}</a></code></pre></div>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1">hrs_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;HRS&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]] <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb70-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">orig_itemname =</span> <span class="kw">str_to_upper</span>(orig_itemname)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb70-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(orig_itemname, name, itemname), <span class="op">~</span><span class="kw">str_remove_all</span>(., <span class="st">&quot;[[:space:]]&quot;</span>))</a>
<a class="sourceLine" id="cb70-4" data-line-number="4">hrs_codebook</a></code></pre></div>
<pre><code>## # A tibble: 2,293 x 19
##    study dataset category name  itemname  wave waveletter  year new_itemname orig_itemname
##    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;        
##  1 hrs   &lt;NA&gt;    match    ageM… yearMar…     1 a           1992 hrs__match_… V241         
##  2 hrs   &lt;NA&gt;    match    ageM… yearMar…     2 b           1993 hrs__match_… V156         
##  3 hrs   &lt;NA&gt;    match    ageM… yearMar…     3 c           1994 hrs__match_… A3-V1        
##  4 hrs   &lt;NA&gt;    match    ageM… yearMar…     4 d           1995 hrs__match_… D678         
##  5 hrs   &lt;NA&gt;    match    ageM… yearMar…     5 e           1996 hrs__match_… E678         
##  6 hrs   &lt;NA&gt;    match    ageM… yearMar…     6 f           1998 hrs__match_… F1073        
##  7 hrs   &lt;NA&gt;    match    ageM… yearMar…     7 g           2000 hrs__match_… GB066_1      
##  8 hrs   &lt;NA&gt;    match    ageM… yearMar…     8 h           2002 hrs__match_… HB066_1      
##  9 hrs   &lt;NA&gt;    match    ageM… yearMar…     9 i           2004 hrs__match_… IB066_1      
## 10 hrs   &lt;NA&gt;    match    ageM… yearMar…    10 j           2006 hrs__match_… JB066_1      
## # … with 2,283 more rows, and 9 more variables: description &lt;chr&gt;, scale &lt;chr&gt;,
## #   reverse_code &lt;chr&gt;, recode &lt;chr&gt;, mini &lt;dbl&gt;, maxi &lt;dbl&gt;, comp_rule &lt;chr&gt;, ...18 &lt;lgl&gt;,
## #   ...19 &lt;chr&gt;</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" data-line-number="1">old.names &lt;-<span class="st"> </span><span class="kw">unique</span>(hrs_codebook<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb72-2" data-line-number="2">hrs.paq &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">year =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/hrs&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">list.files</span>(., <span class="dt">pattern =</span> <span class="st">&quot;^[0-9]&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(year, hrs_read_fun),</a>
<a class="sourceLine" id="cb72-4" data-line-number="4">         <span class="dt">names =</span> <span class="kw">map</span>(data, colnames)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(data))</a>
<a class="sourceLine" id="cb72-6" data-line-number="6"></a>
<a class="sourceLine" id="cb72-7" data-line-number="7">old.names &lt;-<span class="st"> </span><span class="kw">unique</span>((hrs_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(dataset <span class="op">==</span><span class="st"> &quot;Rand&quot;</span>))<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb72-8" data-line-number="8">hrs.rand &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/hrs/randhrs1992_2016v1.sav&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb72-9" data-line-number="9"><span class="st">  </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-10" data-line-number="10"><span class="st">  </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="dt">SID =</span> HHIDPN, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-12" data-line-number="12"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>SID, <span class="dt">na.rm =</span> T)</a>
<a class="sourceLine" id="cb72-13" data-line-number="13"></a>
<a class="sourceLine" id="cb72-14" data-line-number="14"></a>
<a class="sourceLine" id="cb72-15" data-line-number="15">hrs_long &lt;-<span class="st"> </span>hrs.paq <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb72-17" data-line-number="17"><span class="st">      </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>HHID, <span class="op">-</span>PN))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-18" data-line-number="18"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>names, <span class="op">-</span>year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-19" data-line-number="19"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-20" data-line-number="20"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">SID =</span> <span class="dv">1000</span><span class="op">*</span><span class="kw">as.numeric</span>(HHID) <span class="op">+</span><span class="st"> </span><span class="kw">as.numeric</span>(PN)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-21" data-line-number="21"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>PN, <span class="op">-</span>HHID) </a>
<a class="sourceLine" id="cb72-22" data-line-number="22"></a>
<a class="sourceLine" id="cb72-23" data-line-number="23">hrs.subs &lt;-<span class="st"> </span><span class="kw">unique</span>(hrs_long<span class="op">$</span>SID)[<span class="kw">unique</span>(hrs_long<span class="op">$</span>SID) <span class="op">%in%</span><span class="st"> </span><span class="kw">unique</span>(hrs.rand<span class="op">$</span>SID)]</a>
<a class="sourceLine" id="cb72-24" data-line-number="24">hrs_long &lt;-<span class="st"> </span>hrs_long <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-25" data-line-number="25"><span class="st">  </span><span class="kw">bind_rows</span>(hrs.rand <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(orig_itemname, value, SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb72-26" data-line-number="26"><span class="st">  </span><span class="kw">filter</span>(SID <span class="op">%in%</span><span class="st"> </span>hrs.subs)</a>
<a class="sourceLine" id="cb72-27" data-line-number="27"></a>
<a class="sourceLine" id="cb72-28" data-line-number="28"><span class="kw">save</span>(hrs.rand, hrs.paq, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/hrs_raw.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb72-29" data-line-number="29"><span class="kw">rm</span>(<span class="dt">list =</span> <span class="kw">c</span>(<span class="st">&quot;hrs.paq&quot;</span>, <span class="st">&quot;hrs.rand&quot;</span>))</a></code></pre></div>
</div>
<div id="matching-variables-4" class="section level3">
<h3><span class="header-section-number">2.6.2</span> Matching Variables</h3>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1">hrs_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;HRS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb73-2" data-line-number="2"></a>
<a class="sourceLine" id="cb73-3" data-line-number="3"><span class="co"># rename variables   </span></a>
<a class="sourceLine" id="cb73-4" data-line-number="4">hrs_match &lt;-<span class="st"> </span>hrs_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="kw">max</span>(hrs_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;match&quot;</span>, category)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-7" data-line-number="7"><span class="st">  </span><span class="kw">select</span>(name, itemname, wave, year, orig_itemname, reverse_code<span class="op">:</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-8" data-line-number="8"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb73-9" data-line-number="9"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-10" data-line-number="10"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(hrs_long))) </a>
<a class="sourceLine" id="cb73-12" data-line-number="12"></a>
<a class="sourceLine" id="cb73-13" data-line-number="13">yrBrth &lt;-<span class="st"> </span>hrs_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-14" data-line-number="14"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-15" data-line-number="15"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">yearBrth =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-17" data-line-number="17"><span class="st">  </span><span class="kw">select</span>(SID, yearBrth)</a>
<a class="sourceLine" id="cb73-18" data-line-number="18"></a>
<a class="sourceLine" id="cb73-19" data-line-number="19"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb73-20" data-line-number="20">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, year){</a>
<a class="sourceLine" id="cb73-21" data-line-number="21">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb73-22" data-line-number="22">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb73-23" data-line-number="23">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb73-24" data-line-number="24">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb73-25" data-line-number="25">}</a>
<a class="sourceLine" id="cb73-26" data-line-number="26"></a>
<a class="sourceLine" id="cb73-27" data-line-number="27">hrs_match &lt;-<span class="st"> </span>hrs_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb73-28" data-line-number="28"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb73-29" data-line-number="29"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-30" data-line-number="30"><span class="st">    </span><span class="kw">group_by</span>(recode, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-31" data-line-number="31"><span class="st">    </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-32" data-line-number="32"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-33" data-line-number="33"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-34" data-line-number="34"><span class="st">    </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-35" data-line-number="35"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(value <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))))</a>
<a class="sourceLine" id="cb73-36" data-line-number="36"></a>
<a class="sourceLine" id="cb73-37" data-line-number="37"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb73-38" data-line-number="38">hrs_match &lt;-<span class="st"> </span>hrs_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-39" data-line-number="39"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-40" data-line-number="40"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, </a>
<a class="sourceLine" id="cb73-41" data-line-number="41">                        <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))))</a>
<a class="sourceLine" id="cb73-42" data-line-number="42"></a>
<a class="sourceLine" id="cb73-43" data-line-number="43">fun_call &lt;-<span class="st"> </span><span class="cf">function</span>(x, rule){</a>
<a class="sourceLine" id="cb73-44" data-line-number="44">    <span class="cf">switch</span>(rule,</a>
<a class="sourceLine" id="cb73-45" data-line-number="45">           <span class="dt">average =</span> <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb73-46" data-line-number="46">           <span class="dt">mode =</span> <span class="kw">Mode</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb73-47" data-line-number="47">           <span class="dt">sum =</span> <span class="kw">sum</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb73-48" data-line-number="48">           <span class="dt">skip =</span> <span class="kw">unique</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb73-49" data-line-number="49">           <span class="dt">max =</span> <span class="kw">max</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb73-50" data-line-number="50">           <span class="dt">min =</span> <span class="kw">min</span>(x, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb73-51" data-line-number="51">  }</a>
<a class="sourceLine" id="cb73-52" data-line-number="52"></a>
<a class="sourceLine" id="cb73-53" data-line-number="53"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb73-54" data-line-number="54">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb73-55" data-line-number="55">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-56" data-line-number="56"><span class="st">    </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb73-57" data-line-number="57"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb73-58" data-line-number="58"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-59" data-line-number="59"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb73-60" data-line-number="60"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb73-61" data-line-number="61">}</a>
<a class="sourceLine" id="cb73-62" data-line-number="62"></a>
<a class="sourceLine" id="cb73-63" data-line-number="63">hrs_match &lt;-<span class="st"> </span>hrs_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-64" data-line-number="64"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-65" data-line-number="65"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;skip&quot;</span>, comp_rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-66" data-line-number="66"><span class="st">  </span><span class="kw">group_by</span>(comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-67" data-line-number="67"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-68" data-line-number="68"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-69" data-line-number="69"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-70" data-line-number="70"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb73-71" data-line-number="71"></a>
<a class="sourceLine" id="cb73-72" data-line-number="72">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, p_year){</a>
<a class="sourceLine" id="cb73-73" data-line-number="73">  hrs_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-74" data-line-number="74"><span class="st">    </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span>p_year  <span class="op">&amp;</span><span class="st"> </span>comp_rule <span class="op">==</span><span class="st"> </span>rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-75" data-line-number="75"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-76" data-line-number="76"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-77" data-line-number="77"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-78" data-line-number="78"><span class="st">    </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb73-79" data-line-number="79">}</a>
<a class="sourceLine" id="cb73-80" data-line-number="80"></a>
<a class="sourceLine" id="cb73-81" data-line-number="81">hrs_match &lt;-<span class="st"> </span><span class="kw">crossing</span>(</a>
<a class="sourceLine" id="cb73-82" data-line-number="82">  <span class="dt">p_year =</span> hrs_waves<span class="op">$</span>Used, </a>
<a class="sourceLine" id="cb73-83" data-line-number="83">  <span class="dt">comp_rule =</span> <span class="kw">unique</span>(hrs_match<span class="op">$</span>comp_rule)</a>
<a class="sourceLine" id="cb73-84" data-line-number="84">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-85" data-line-number="85"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(comp_rule, p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-86" data-line-number="86"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb73-87" data-line-number="87"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-88" data-line-number="88"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-89" data-line-number="89"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-90" data-line-number="90"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb73-91" data-line-number="91"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(SID))</a></code></pre></div>
</div>
<div id="personality-variables-4" class="section level3">
<h3><span class="header-section-number">2.6.3</span> Personality Variables</h3>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1"><span class="co"># keep correct personality waves</span></a>
<a class="sourceLine" id="cb74-2" data-line-number="2">hrs_pers &lt;-<span class="st"> </span>hrs_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">reverse_code =</span> <span class="kw">tolower</span>(reverse_code)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-4" data-line-number="4"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;pers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-5" data-line-number="5"><span class="st">  </span><span class="kw">left_join</span>(hrs_long) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">mapvalues</span>(year, <span class="kw">seq</span>(<span class="dv">2006</span>, <span class="dv">2016</span>, <span class="dv">2</span>), <span class="kw">rep</span>(<span class="kw">c</span>(<span class="dv">2006</span>, <span class="dv">2010</span>, <span class="dv">2014</span>), <span class="dt">each =</span> <span class="dv">2</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-7" data-line-number="7"><span class="st">  </span><span class="kw">left_join</span>(p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;HRS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">name =</span> p_item, Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-8" data-line-number="8"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span>Used) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-9" data-line-number="9"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb74-10" data-line-number="10"></a>
<a class="sourceLine" id="cb74-11" data-line-number="11">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb74-12" data-line-number="12">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb74-13" data-line-number="13">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb74-14" data-line-number="14">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb74-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb74-16" data-line-number="16"></a>
<a class="sourceLine" id="cb74-17" data-line-number="17"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb74-18" data-line-number="18">hrs_pers &lt;-<span class="st"> </span>hrs_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-19" data-line-number="19"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, reverse_code<span class="op">:</span>comp_rule, SID, Used, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-20" data-line-number="20"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-21" data-line-number="21"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-22" data-line-number="22"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-24" data-line-number="24"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb74-25" data-line-number="25"></a>
<a class="sourceLine" id="cb74-26" data-line-number="26"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb74-27" data-line-number="27">hrs_pers &lt;-<span class="st"> </span>hrs_pers <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-28" data-line-number="28"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-29" data-line-number="29"><span class="st">  </span><span class="kw">group_by</span>(name, itemname, year, SID, comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-30" data-line-number="30"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb74-31" data-line-number="31"></a>
<a class="sourceLine" id="cb74-32" data-line-number="32"><span class="co"># alpha&#39;s</span></a>
<a class="sourceLine" id="cb74-33" data-line-number="33">hrs_alpha &lt;-<span class="st"> </span>hrs_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-34" data-line-number="34"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-35" data-line-number="35"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, SID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-36" data-line-number="36"><span class="st">  </span><span class="kw">group_by</span>(name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-37" data-line-number="37"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-38" data-line-number="38"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> itemname, <span class="dt">values_from =</span> value, <span class="dt">values_fn =</span> <span class="kw">list</span>(mean))),</a>
<a class="sourceLine" id="cb74-39" data-line-number="39">         <span class="dt">alpha =</span> <span class="kw">map</span>(data, <span class="kw">possibly</span>(<span class="op">~</span>psych<span class="op">::</span><span class="kw">alpha</span>((.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>SID)), <span class="ot">NA_real_</span>)))</a>
<a class="sourceLine" id="cb74-40" data-line-number="40"></a>
<a class="sourceLine" id="cb74-41" data-line-number="41">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb74-42" data-line-number="42">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-43" data-line-number="43"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-44" data-line-number="44"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-45" data-line-number="45"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-46" data-line-number="46"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb74-47" data-line-number="47">}</a>
<a class="sourceLine" id="cb74-48" data-line-number="48"></a>
<a class="sourceLine" id="cb74-49" data-line-number="49"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb74-50" data-line-number="50">hrs_pers &lt;-<span class="st"> </span>hrs_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-51" data-line-number="51"><span class="st">  </span><span class="kw">group_by</span>(name, comp_rule, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-52" data-line-number="52"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-53" data-line-number="53"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-54" data-line-number="54"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb74-55" data-line-number="55"><span class="st">  </span><span class="kw">unnest</span>()</a></code></pre></div>
<pre><code>## # A tibble: 314,336 x 5
##    name   year comp_rule      SID value
##    &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;
##  1 A      2006 average       3010   3  
##  2 A      2006 average       3020   3  
##  3 A      2006 average   10001010   4  
##  4 A      2006 average   10003030   3.4
##  5 A      2006 average   10004010   3.4
##  6 A      2006 average   10004040   3.6
##  7 A      2006 average   10013010   2  
##  8 A      2006 average   10013040   2.6
##  9 A      2006 average   10038010   3.4
## 10 A      2006 average   10038040   2.6
## # … with 314,326 more rows</code></pre>
</div>
<div id="outcome-variables-5" class="section level3">
<h3><span class="header-section-number">2.6.4</span> Outcome Variables</h3>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" data-line-number="1">hrs_out &lt;-<span class="st"> </span>hrs_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb76-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-4" data-line-number="4"><span class="st">  </span><span class="kw">left_join</span>(hrs_long) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-5" data-line-number="5"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-6" data-line-number="6"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> hrs_waves<span class="op">$</span>Used, <span class="dt">name =</span> <span class="kw">unique</span>((.)<span class="op">$</span>name)))</a>
<a class="sourceLine" id="cb76-7" data-line-number="7"></a>
<a class="sourceLine" id="cb76-8" data-line-number="8">hrs_out_stp &lt;-<span class="st"> </span>hrs_codebook <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb76-9" data-line-number="9"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>new_itemname, <span class="op">-</span>description, scale) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-10" data-line-number="10"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-11" data-line-number="11"><span class="st">  </span><span class="kw">left_join</span>(hrs_long) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-12" data-line-number="12"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">tibble</span>(<span class="dt">name =</span> <span class="st">&quot;mortality&quot;</span>, <span class="dt">SID =</span> <span class="kw">unique</span>(hrs_long<span class="op">$</span>SID),</a>
<a class="sourceLine" id="cb76-13" data-line-number="13">                   <span class="dt">recode =</span> <span class="kw">unique</span>(.<span class="op">$</span>recode))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-14" data-line-number="14"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> hrs_waves<span class="op">$</span>Used, <span class="dt">name =</span> <span class="kw">unique</span>((.)<span class="op">$</span>name)))</a>
<a class="sourceLine" id="cb76-15" data-line-number="15"></a>
<a class="sourceLine" id="cb76-16" data-line-number="16"><span class="co"># recode</span></a>
<a class="sourceLine" id="cb76-17" data-line-number="17">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year){</a>
<a class="sourceLine" id="cb76-18" data-line-number="18">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb76-19" data-line-number="19">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb76-20" data-line-number="20">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb76-21" data-line-number="21">}</a>
<a class="sourceLine" id="cb76-22" data-line-number="22"></a>
<a class="sourceLine" id="cb76-23" data-line-number="23">hrs_out &lt;-<span class="st"> </span>hrs_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-24" data-line-number="24"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, reverse_code<span class="op">:</span>comp_rule, value, SID, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-25" data-line-number="25"><span class="st">  </span><span class="kw">group_by</span>(recode, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-26" data-line-number="26"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-27" data-line-number="27"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-28" data-line-number="28"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-29" data-line-number="29"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb76-30" data-line-number="30"></a>
<a class="sourceLine" id="cb76-31" data-line-number="31">hrs_out_stp &lt;-<span class="st"> </span>hrs_out_stp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-32" data-line-number="32"><span class="st">  </span><span class="kw">select</span>(name, itemname, reverse_code<span class="op">:</span>comp_rule, value, SID, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-33" data-line-number="33"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(value <span class="op">&gt;</span><span class="st"> </span><span class="dv">2050</span> <span class="op">|</span><span class="st"> </span>value <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(value), <span class="dv">0</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-34" data-line-number="34"><span class="st">  </span><span class="kw">group_by</span>(recode, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-35" data-line-number="35"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-36" data-line-number="36"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-37" data-line-number="37"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-38" data-line-number="38"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb76-39" data-line-number="39"></a>
<a class="sourceLine" id="cb76-40" data-line-number="40"><span class="co"># composite within years </span></a>
<a class="sourceLine" id="cb76-41" data-line-number="41"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb76-42" data-line-number="42">hrs_out &lt;-<span class="st"> </span>hrs_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-43" data-line-number="43"><span class="st">  </span><span class="kw">group_by</span>(SID, name, year, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-44" data-line-number="44"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-45" data-line-number="45"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-46" data-line-number="46"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb76-47" data-line-number="47"></a>
<a class="sourceLine" id="cb76-48" data-line-number="48"><span class="co"># composite across years</span></a>
<a class="sourceLine" id="cb76-49" data-line-number="49">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(p_year){</a>
<a class="sourceLine" id="cb76-50" data-line-number="50">  hrs_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-51" data-line-number="51"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>p_year, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;past&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-52" data-line-number="52"><span class="st">    </span><span class="kw">group_by</span>(SID, name, group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-53" data-line-number="53"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-54" data-line-number="54"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-55" data-line-number="55"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-56" data-line-number="56"><span class="st">    </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> group, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-57" data-line-number="57"><span class="st">    </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-58" data-line-number="58"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(past) <span class="op">|</span><span class="st"> </span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(future)), future,</a>
<a class="sourceLine" id="cb76-59" data-line-number="59">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(future), past, </a>
<a class="sourceLine" id="cb76-60" data-line-number="60">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)))) </a>
<a class="sourceLine" id="cb76-61" data-line-number="61">}</a>
<a class="sourceLine" id="cb76-62" data-line-number="62"></a>
<a class="sourceLine" id="cb76-63" data-line-number="63">hrs_out &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">p_year =</span> hrs_waves<span class="op">$</span>Used) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-64" data-line-number="64"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-65" data-line-number="65"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-66" data-line-number="66"><span class="st">  </span><span class="kw">full_join</span>(hrs_out_stp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(name, p_year, value, SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb76-67" data-line-number="67"><span class="st">  </span><span class="kw">filter</span>((<span class="op">!</span>name <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;married&quot;</span>, <span class="st">&quot;edu&quot;</span>)) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(SID)) </a></code></pre></div>
<pre><code>## # A tibble: 774,366 x 6
##    p_year   SID name         future  past value
##     &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1   2006  1010 divorced          1     1    NA
##  2   2006  1010 mntlhlthevnt      1     1    NA
##  3   2006  1010 physhlthevnt      1     1    NA
##  4   2006  1010 retired          NA     0     0
##  5   2006  1010 unemployed       NA     0     0
##  6   2006  2010 divorced          0     0     0
##  7   2006  2010 mntlhlthevnt      1     1    NA
##  8   2006  2010 physhlthevnt      1     1    NA
##  9   2006  2010 retired           1     1    NA
## 10   2006  2010 unemployed        0     0     0
## # … with 774,356 more rows</code></pre>
</div>
<div id="covariates-4" class="section level3">
<h3><span class="header-section-number">2.6.5</span> Covariates</h3>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" data-line-number="1">hrs_match &lt;-<span class="st"> </span>hrs_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-3" data-line-number="3"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb78-4" data-line-number="4"><span class="st">  </span><span class="kw">full_join</span>(hrs_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">year =</span> p_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-5" data-line-number="5"><span class="st">  </span><span class="co"># left_join(gsoep_bp %&gt;% select(-momID, -dadID)) %&gt;%</span></a>
<a class="sourceLine" id="cb78-6" data-line-number="6"><span class="st">  </span><span class="co"># physical health event</span></a>
<a class="sourceLine" id="cb78-7" data-line-number="7"><span class="st">  </span><span class="kw">left_join</span>(hrs_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;physhlthevnt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">year =</span> p_year, SID, <span class="dt">physhlthevnt =</span> past) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">physhlthevnt =</span> <span class="kw">max</span>(physhlthevnt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-8" data-line-number="8"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb78-9" data-line-number="9"></a>
<a class="sourceLine" id="cb78-10" data-line-number="10">hrs_match &lt;-<span class="st"> </span>hrs_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-11" data-line-number="11"><span class="st">  </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> year <span class="op">-</span><span class="st"> </span>yearBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-13" data-line-number="13"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb78-14" data-line-number="14"></a>
<a class="sourceLine" id="cb78-15" data-line-number="15">npb_fun &lt;-<span class="st"> </span><span class="cf">function</span>(l, u){</a>
<a class="sourceLine" id="cb78-16" data-line-number="16">  lb &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">c</span>(l,u))[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb78-17" data-line-number="17">  ub &lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">c</span>(l,u))[<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb78-18" data-line-number="18">  <span class="kw">mean</span>((<span class="kw">tibble</span>(<span class="dt">occ00 =</span> <span class="kw">seq</span>(lb,ub),</a>
<a class="sourceLine" id="cb78-19" data-line-number="19">         <span class="dt">npb =</span> <span class="kw">mapvalues</span>(occ00, npb<span class="op">$</span>OCC00, npb<span class="op">$</span>NPB, <span class="dt">warn_missing =</span> F)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-20" data-line-number="20"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">npb =</span> <span class="kw">ifelse</span>(npb <span class="op">&gt;</span><span class="st"> </span><span class="dv">100</span>, <span class="ot">NA</span>, npb)))<span class="op">$</span>npb, <span class="dt">na.rm =</span> T)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb78-21" data-line-number="21">}</a>
<a class="sourceLine" id="cb78-22" data-line-number="22"></a>
<a class="sourceLine" id="cb78-23" data-line-number="23">hrs_npb_groups &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb78-24" data-line-number="24"><span class="st">  </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb78-25" data-line-number="25">    <span class="op">~</span>hrsCat, <span class="op">~</span>occ80l, <span class="op">~</span>occ80u, <span class="op">~</span>occ90l, <span class="op">~</span>occ90u,</a>
<a class="sourceLine" id="cb78-26" data-line-number="26">    <span class="dv">1</span>, <span class="dv">003</span>, <span class="dv">037</span>, <span class="dv">001</span>, <span class="dv">037</span>,</a>
<a class="sourceLine" id="cb78-27" data-line-number="27">    <span class="dv">2</span>, <span class="dv">043</span>, <span class="dv">235</span>, <span class="dv">043</span>, <span class="dv">235</span>,</a>
<a class="sourceLine" id="cb78-28" data-line-number="28">    <span class="dv">3</span>, <span class="dv">243</span>, <span class="dv">285</span>, <span class="dv">243</span>, <span class="dv">274</span>,</a>
<a class="sourceLine" id="cb78-29" data-line-number="29">    <span class="dv">4</span>, <span class="dv">303</span>, <span class="dv">389</span>, <span class="dv">303</span>, <span class="dv">389</span>,</a>
<a class="sourceLine" id="cb78-30" data-line-number="30">    <span class="dv">5</span>, <span class="dv">403</span>, <span class="dv">407</span>, <span class="dv">403</span>, <span class="dv">407</span>,</a>
<a class="sourceLine" id="cb78-31" data-line-number="31">    <span class="dv">6</span>, <span class="dv">413</span>, <span class="dv">427</span>, <span class="dv">417</span>, <span class="dv">427</span>,</a>
<a class="sourceLine" id="cb78-32" data-line-number="32">    <span class="dv">7</span>, <span class="dv">433</span>, <span class="dv">444</span>, <span class="dv">433</span>, <span class="dv">444</span>,</a>
<a class="sourceLine" id="cb78-33" data-line-number="33">    <span class="dv">8</span>, <span class="dv">445</span>, <span class="dv">447</span>, <span class="dv">445</span>, <span class="dv">447</span>,</a>
<a class="sourceLine" id="cb78-34" data-line-number="34">    <span class="dv">9</span>, <span class="dv">448</span>, <span class="dv">469</span>, <span class="dv">448</span>, <span class="dv">469</span>,</a>
<a class="sourceLine" id="cb78-35" data-line-number="35">    <span class="dv">10</span>, <span class="dv">473</span>, <span class="dv">499</span>, <span class="dv">473</span>, <span class="dv">498</span>,</a>
<a class="sourceLine" id="cb78-36" data-line-number="36">    <span class="dv">11</span>, <span class="dv">503</span>, <span class="dv">549</span>, <span class="dv">503</span>, <span class="dv">542</span>,</a>
<a class="sourceLine" id="cb78-37" data-line-number="37">    <span class="dv">12</span>, <span class="dv">553</span>, <span class="dv">617</span>, <span class="dv">553</span>, <span class="dv">617</span>,</a>
<a class="sourceLine" id="cb78-38" data-line-number="38">    <span class="dv">13</span>, <span class="dv">633</span>, <span class="dv">699</span>, <span class="dv">628</span>, <span class="dv">699</span>,</a>
<a class="sourceLine" id="cb78-39" data-line-number="39">    <span class="dv">14</span>, <span class="dv">703</span>, <span class="dv">799</span>, <span class="dv">703</span>, <span class="dv">799</span>,</a>
<a class="sourceLine" id="cb78-40" data-line-number="40">    <span class="dv">15</span>, <span class="dv">803</span>, <span class="dv">859</span>, <span class="dv">803</span>, <span class="dv">859</span>, </a>
<a class="sourceLine" id="cb78-41" data-line-number="41">    <span class="dv">16</span>, <span class="dv">863</span>, <span class="dv">889</span>, <span class="dv">863</span>, <span class="dv">889</span>, </a>
<a class="sourceLine" id="cb78-42" data-line-number="42">    <span class="dv">17</span>, <span class="dv">900</span>, <span class="dv">900</span>, <span class="dv">900</span>, <span class="dv">900</span></a>
<a class="sourceLine" id="cb78-43" data-line-number="43">    ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-44" data-line-number="44"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">occ00l =</span> <span class="kw">mapvalues</span>(occ90l, occ90to00<span class="op">$</span>OCC90, occ90to00<span class="op">$</span>OCC00),</a>
<a class="sourceLine" id="cb78-45" data-line-number="45">         <span class="dt">occ00u =</span> <span class="kw">mapvalues</span>(occ90u, occ90to00<span class="op">$</span>OCC90, occ90to00<span class="op">$</span>OCC00)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-46" data-line-number="46"><span class="st">  </span><span class="kw">group_by</span>(hrsCat) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-47" data-line-number="47"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">npb =</span> <span class="kw">npb_fun</span>(occ00l, occ00u))</a>
<a class="sourceLine" id="cb78-48" data-line-number="48"></a>
<a class="sourceLine" id="cb78-49" data-line-number="49">hrs_match &lt;-<span class="st"> </span>hrs_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb78-50" data-line-number="50"><span class="st">  </span><span class="kw">select</span>(SID, year, dadOcc) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb78-51" data-line-number="51"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(dadOcc)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-52" data-line-number="52"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">dadOccPrstg =</span> <span class="kw">ifelse</span>(dadOcc <span class="op">==</span><span class="st"> </span><span class="dv">98</span>, <span class="ot">NA</span>, dadOcc),</a>
<a class="sourceLine" id="cb78-53" data-line-number="53">         <span class="dt">dadOccPrstg =</span> <span class="kw">mapvalues</span>(dadOccPrstg, hrs_npb_groups<span class="op">$</span>hrsCat, hrs_npb_groups<span class="op">$</span>npb)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-54" data-line-number="54"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>dadOcc, <span class="op">-</span>year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-55" data-line-number="55"><span class="st">  </span><span class="kw">full_join</span>(hrs_match)</a>
<a class="sourceLine" id="cb78-56" data-line-number="56"></a>
<a class="sourceLine" id="cb78-57" data-line-number="57">hrs_out &lt;-<span class="st"> </span>hrs_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-58" data-line-number="58"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>past, <span class="op">-</span>future) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-59" data-line-number="59"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb78-60" data-line-number="60"></a>
<a class="sourceLine" id="cb78-61" data-line-number="61">hrs_SCA &lt;-<span class="st"> </span>hrs_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb78-62" data-line-number="62"><span class="st">  </span><span class="kw">select</span>(SID, <span class="dt">p_year =</span> year, <span class="kw">one_of</span>(<span class="kw">c</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name), <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;dadEdu&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-63" data-line-number="63"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-64" data-line-number="64"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-65" data-line-number="65"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(parEdu), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-66" data-line-number="66"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb78-67" data-line-number="67"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">parOccPrstg =</span> dadOccPrstg) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb78-68" data-line-number="68"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu)</a>
<a class="sourceLine" id="cb78-69" data-line-number="69"></a>
<a class="sourceLine" id="cb78-70" data-line-number="70"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(hrs_match2)]</a></code></pre></div>
<pre><code>## # A tibble: 128,334 x 20
##       SID p_year   age education gender grsWages  race physhlthevnt SRhealth smokes alcohol
##     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
##  1 1.01e7   1992    51         0      1   34932      2            1     2         1    NA  
##  2 1.01e7   1996    55         0      1   24137.     2            1     2         1     0  
##  3 1.01e7   2006    65         0      1   20276.     2            1     1.75      1     0  
##  4 1.03e7   1996    63         0      0   31800      0            1     4         0     2  
##  5 1.03e7   1992    59         0      0      NA      0            1    NA        NA    NA  
##  6 1.03e7   2006    73         0      0   70108.     0            1     3.8       0     1.8
##  7 1.04e7   1992    54         0      1  139700      0            1     5         1    NA  
##  8 1.04e7   1996    58         0      1  154033.     0            1     4.33      1     7  
##  9 1.04e7   2006    68         0      1  306668.     0            1     3.5       1     7  
## 10 1.04e7   1992    49         1      1  116000      0            1     4         1    NA  
## # … with 128,324 more rows, and 9 more variables: exercise &lt;dbl&gt;, BMI &lt;dbl&gt;, married &lt;dbl&gt;,
## #   numKids &lt;dbl&gt;, parDivorce &lt;dbl&gt;, PhysFunc &lt;dbl&gt;, religion &lt;dbl&gt;, parOccPrstg &lt;dbl&gt;,
## #   parEdu &lt;dbl&gt;</code></pre>
</div>
<div id="imputation-4" class="section level3">
<h3><span class="header-section-number">2.6.6</span> Imputation</h3>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1"><span class="co"># short helper functions to (1) identify and create factors, save col names of factors, remove columns with all missing values, and setup amelia</span></a>
<a class="sourceLine" id="cb80-2" data-line-number="2">factor_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){<span class="cf">if</span>(<span class="kw">is.numeric</span>(x)){<span class="kw">diff</span>(<span class="kw">range</span>(x, <span class="dt">na.rm =</span> T)) <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(x)) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">4</span>} <span class="cf">else</span>{F}}</a>
<a class="sourceLine" id="cb80-3" data-line-number="3">not_all_id &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="cf">if</span>(<span class="kw">is.numeric</span>(x)) <span class="kw">sd</span>(x, <span class="dt">na.rm =</span> T) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb80-4" data-line-number="4">sum_na &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">sum</span>(<span class="kw">is.na</span>(x))<span class="op">/</span><span class="kw">length</span>(x)<span class="op">*</span><span class="dv">100</span></a>
<a class="sourceLine" id="cb80-5" data-line-number="5">mice_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb80-6" data-line-number="6">  s &lt;-<span class="st"> </span><span class="kw">unique</span>(hrs_pers<span class="op">$</span>SID)</a>
<a class="sourceLine" id="cb80-7" data-line-number="7">  df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>ageMarried, <span class="op">-</span>CurMarYears, <span class="op">-</span>spouseEmployed, <span class="op">-</span>weight, <span class="op">-</span>numHospStays, <span class="op">-</span>SRhealthChng) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-8" data-line-number="8"><span class="st">    </span><span class="kw">filter</span>(SID <span class="op">%in%</span><span class="st"> </span>s)</a>
<a class="sourceLine" id="cb80-9" data-line-number="9">  pos &lt;-<span class="st"> </span><span class="kw">apply</span>(df, <span class="dv">1</span>, sum_na) <span class="op">&lt;</span><span class="st"> </span><span class="dv">60</span></a>
<a class="sourceLine" id="cb80-10" data-line-number="10">  df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(pos)</a>
<a class="sourceLine" id="cb80-11" data-line-number="11">  <span class="kw">mice</span>(df, <span class="dt">m =</span> <span class="dv">5</span>, <span class="dt">maxit=</span><span class="dv">5</span>, <span class="dt">printFlag=</span><span class="ot">TRUE</span>, <span class="dt">method =</span> <span class="st">&quot;cart&quot;</span>)</a>
<a class="sourceLine" id="cb80-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb80-13" data-line-number="13">hrs_match_imp &lt;-<span class="st"> </span>hrs_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-14" data-line-number="14"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">NegAff =</span> <span class="st">`</span><span class="dt">NA</span><span class="st">`</span>, <span class="dt">parOccPrstg =</span> dadOccPrstg) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-15" data-line-number="15"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(eduMom, eduDad), <span class="op">~</span><span class="kw">ifelse</span>(. <span class="op">&gt;=</span><span class="st"> </span><span class="dv">17</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(.), <span class="dv">2</span>, <span class="kw">ifelse</span>(. <span class="op">&gt;=</span><span class="st"> </span><span class="dv">15</span>, <span class="dv">1</span>, <span class="dv">0</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-16" data-line-number="16"><span class="st">  </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-17" data-line-number="17"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">momEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, eduMom), <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb80-18" data-line-number="18">         <span class="dt">dadEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(dadEdu, eduDad), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-19" data-line-number="19"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-20" data-line-number="20"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>eduMom, <span class="op">-</span>eduDad) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate_all</span>(<span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-22" data-line-number="22"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(year) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-23" data-line-number="23"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb80-24" data-line-number="24"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-25" data-line-number="25"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-26" data-line-number="26"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_na) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_id)),</a>
<a class="sourceLine" id="cb80-27" data-line-number="27">         <span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(factor_fun, as.factor)),</a>
<a class="sourceLine" id="cb80-28" data-line-number="28">         <span class="dt">imp =</span> <span class="kw">map</span>(data, mice_fun))</a>
<a class="sourceLine" id="cb80-29" data-line-number="29"></a>
<a class="sourceLine" id="cb80-30" data-line-number="30"></a>
<a class="sourceLine" id="cb80-31" data-line-number="31">hrs_match_imp &lt;-<span class="st"> </span>hrs_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-32" data-line-number="32"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp, <span class="op">~</span>mice<span class="op">::</span><span class="kw">complete</span>(., <span class="st">&quot;long&quot;</span>)),</a>
<a class="sourceLine" id="cb80-33" data-line-number="33">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb80-34" data-line-number="34"><span class="st">            </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(exercise, PhysFunc), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">as.numeric</span>(<span class="kw">as.character</span>(.)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-35" data-line-number="35"><span class="st">            </span><span class="kw">mutate</span>(<span class="dt">PhysFunc =</span> <span class="kw">factor</span>(PhysFunc), </a>
<a class="sourceLine" id="cb80-36" data-line-number="36">                   <span class="dt">satRetire =</span> <span class="kw">ifelse</span>(<span class="kw">is.factor</span>(satRetire), <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(satRetire)), satRetire))),</a>
<a class="sourceLine" id="cb80-37" data-line-number="37">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb80-38" data-line-number="38"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-39" data-line-number="39"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-40" data-line-number="40"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-41" data-line-number="41"><span class="st">    </span><span class="kw">ungroup</span>()),</a>
<a class="sourceLine" id="cb80-42" data-line-number="42">         <span class="dt">imp_sca =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(.imp <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID,  <span class="kw">one_of</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name)))))</a>
<a class="sourceLine" id="cb80-43" data-line-number="43"></a>
<a class="sourceLine" id="cb80-44" data-line-number="44">hrs_match_imp_long &lt;-<span class="st"> </span>hrs_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-45" data-line-number="45"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-46" data-line-number="46"><span class="st">  </span><span class="kw">unnest</span>(imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-47" data-line-number="47"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">alcohol =</span> <span class="kw">factor</span>(<span class="kw">ifelse</span>(alcohol <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)))</a>
<a class="sourceLine" id="cb80-48" data-line-number="48"></a>
<a class="sourceLine" id="cb80-49" data-line-number="49">hrs_SCA_imp &lt;-<span class="st"> </span>hrs_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-50" data-line-number="50"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-51" data-line-number="51"><span class="st">  </span><span class="kw">unnest</span>(imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-52" data-line-number="52"><span class="st">  </span><span class="kw">full_join</span>(hrs_SCA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, SID)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb80-53" data-line-number="53"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-54" data-line-number="54"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">alcohol =</span> <span class="kw">factor</span>(<span class="kw">ifelse</span>(alcohol <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)))</a>
<a class="sourceLine" id="cb80-55" data-line-number="55"></a>
<a class="sourceLine" id="cb80-56" data-line-number="56">hrs_SCA_imp  &lt;-<span class="st"> </span>hrs_SCA_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-57" data-line-number="57"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(alcohol)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-58" data-line-number="58"><span class="st">  </span><span class="kw">select</span>(SID, alcohol) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-59" data-line-number="59"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-60" data-line-number="60"><span class="st">  </span><span class="kw">full_join</span>(hrs_SCA_imp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>alcohol)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb80-61" data-line-number="61"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(age))</a>
<a class="sourceLine" id="cb80-62" data-line-number="62"></a>
<a class="sourceLine" id="cb80-63" data-line-number="63"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(hrs_SCA_imp)]</a></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" data-line-number="1"><span class="kw">save</span>(hrs_match_imp_long, hrs_SCA_imp, </a>
<a class="sourceLine" id="cb81-2" data-line-number="2">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/hrs_imputed_small.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb81-3" data-line-number="3"><span class="kw">save</span>(hrs_match_imp, </a>
<a class="sourceLine" id="cb81-4" data-line-number="4">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/hrs_imputed.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb81-5" data-line-number="5"><span class="kw">save</span>(hrs_alpha, hrs_pers, hrs_out, hrs_match, hrs_SCA,</a>
<a class="sourceLine" id="cb81-6" data-line-number="6">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/hrs_cleaned.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb81-7" data-line-number="7"><span class="kw">save</span>(hrs_long, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/hrs_raw_long.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb81-8" data-line-number="8"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;hrs&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;hrs&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
</div>
</div>
<div id="liss" class="section level2">
<h2><span class="header-section-number">2.7</span> LISS</h2>
<p>The Longitudinal Studies for the Social sciences (LISS; Scherpenzeel, Das, Ester, &amp; Kaczmirek, 2010) is an ongoing longitudinal study of households in the Netherlands. These data are online, through application, from <a href="https://statements.centerdata.nl/liss-panel-data-statement" class="uri">https://statements.centerdata.nl/liss-panel-data-statement</a>.</p>
<p>Participants were approximately 8,000 Dutch-speaking individuals permanently residing in the Netherlands from 5,000 households. Data have been collected annually since 2007. The latest data release includes 11 waves of data from 2008 to 2018. More documentation are available at <a href="https://www.dataarchive.lissdata.nl/study_units/view/1" class="uri">https://www.dataarchive.lissdata.nl/study_units/view/1</a>.</p>
<p>Sample sizes vary by year, ranging from 5,021 (2018) to 6808 (2008). This provides 99/% power to detect a correlation effect size of ~.04, two-tailed at alpha .05.</p>
<div id="load-data-6" class="section level3">
<h3><span class="header-section-number">2.7.1</span> Load Data</h3>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1">liss_read_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb83-2" data-line-number="2">  <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/liss/%s&quot;</span>, wd, x) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">one_of</span>(old.names))</a>
<a class="sourceLine" id="cb83-3" data-line-number="3">}</a></code></pre></div>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">liss_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;LISS&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb84-2" data-line-number="2">liss_codebook</a></code></pre></div>
<pre><code>## # A tibble: 3,688 x 18
##    study dataset category name  itemname  wave wave_letter  year new_itemname orig_itemname
##    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;        
##  1 liss  avars_… match    age   YOB1         1 a            2008 &lt;NA&gt;         gebjaar      
##  2 liss  avars_… match    age   YOB1         2 b            2009 &lt;NA&gt;         gebjaar      
##  3 liss  avars_… match    age   YOB1         3 c            2010 &lt;NA&gt;         gebjaar      
##  4 liss  avars_… match    age   YOB1         4 d            2011 &lt;NA&gt;         gebjaar      
##  5 liss  avars_… match    age   YOB1         5 e            2012 &lt;NA&gt;         gebjaar      
##  6 liss  avars_… match    age   YOB1         6 f            2013 &lt;NA&gt;         gebjaar      
##  7 liss  avars_… match    age   YOB1         7 g            2014 &lt;NA&gt;         gebjaar      
##  8 liss  avars_… match    age   YOB1         8 h            2015 &lt;NA&gt;         gebjaar      
##  9 liss  avars_… match    age   YOB1         9 i            2016 &lt;NA&gt;         gebjaar      
## 10 liss  avars_… match    age   YOB1        10 j            2017 &lt;NA&gt;         gebjaar      
## # … with 3,678 more rows, and 8 more variables: description &lt;chr&gt;, scale &lt;chr&gt;,
## #   reverse_code &lt;chr&gt;, recode &lt;chr&gt;, mini &lt;dbl&gt;, maxi &lt;dbl&gt;, comp_rule &lt;chr&gt;, LHQ &lt;chr&gt;</code></pre>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">old.names &lt;-<span class="st"> </span><span class="kw">unique</span>(liss_codebook<span class="op">$</span>orig_itemname) <span class="op">%&gt;%</span><span class="st"> </span>str_to_lower</a>
<a class="sourceLine" id="cb86-2" data-line-number="2">datasets &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/liss&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">list.files</span>()</a>
<a class="sourceLine" id="cb86-3" data-line-number="3">liss &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">datasets =</span> datasets) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(datasets, liss_read_fun)) </a>
<a class="sourceLine" id="cb86-5" data-line-number="5"></a>
<a class="sourceLine" id="cb86-6" data-line-number="6">liss &lt;-<span class="st"> </span><span class="kw">reduce</span>(liss<span class="op">$</span>data, full_join) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.)</a>
<a class="sourceLine" id="cb86-7" data-line-number="7"><span class="kw">save</span>(liss, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/liss_raw.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb86-8" data-line-number="8"></a>
<a class="sourceLine" id="cb86-9" data-line-number="9">avars &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">ds =</span> datasets[<span class="kw">grepl</span>(<span class="st">&quot;avar&quot;</span>, datasets)]) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(ds, <span class="op">~</span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/liss/%s&quot;</span>, wd, .) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-11" data-line-number="11"><span class="st">  </span><span class="kw">separate</span>(ds, <span class="kw">c</span>(<span class="st">&quot;ds&quot;</span>, <span class="st">&quot;year&quot;</span>, <span class="st">&quot;scrap1&quot;</span>, <span class="st">&quot;scrap2&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-12" data-line-number="12"><span class="st">  </span><span class="kw">separate</span>(year, <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;month&quot;</span>), <span class="dv">-2</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb86-13" data-line-number="13"><span class="st">  </span><span class="kw">select</span>(year, month, data) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb86-14" data-line-number="14"><span class="st">  </span><span class="kw">unnest</span>(data) </a></code></pre></div>
</div>
<div id="matching-variables-5" class="section level3">
<h3><span class="header-section-number">2.7.2</span> Matching Variables</h3>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" data-line-number="1">rename_fun &lt;-<span class="st"> </span><span class="cf">function</span>(cb, var){</a>
<a class="sourceLine" id="cb87-2" data-line-number="2">  old.names &lt;-<span class="st"> </span><span class="kw">unique</span>((liss_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> </span>var))<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb87-3" data-line-number="3">  df &lt;-<span class="st"> </span>liss <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-4" data-line-number="4"><span class="st">    </span><span class="kw">select</span>(<span class="dt">SID =</span> nomem_encr, <span class="dt">HHID =</span> nohouse_encr, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-5" data-line-number="5"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, </a>
<a class="sourceLine" id="cb87-6" data-line-number="6">           <span class="op">-</span>SID, <span class="op">-</span>HHID, <span class="dt">na.rm=</span>T)</a>
<a class="sourceLine" id="cb87-7" data-line-number="7">  <span class="cf">if</span>(<span class="kw">length</span>(old.names) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>){</a>
<a class="sourceLine" id="cb87-8" data-line-number="8">      df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(itemname, year, orig_itemname, reverse_code<span class="op">:</span>comp_rule))</a>
<a class="sourceLine" id="cb87-9" data-line-number="9">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb87-10" data-line-number="10">    df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>(itemname<span class="op">:</span>year),  <span class="op">-</span>new_itemname, <span class="op">-</span>dataset) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb87-11" data-line-number="11">  }</a>
<a class="sourceLine" id="cb87-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb87-13" data-line-number="13"></a>
<a class="sourceLine" id="cb87-14" data-line-number="14"><span class="co"># rename variables   </span></a>
<a class="sourceLine" id="cb87-15" data-line-number="15">liss_match &lt;-<span class="st"> </span>liss_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-16" data-line-number="16"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-17" data-line-number="17"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-18" data-line-number="18"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-19" data-line-number="19"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-20" data-line-number="20"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-21" data-line-number="21"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-22" data-line-number="22"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb87-23" data-line-number="23"></a>
<a class="sourceLine" id="cb87-24" data-line-number="24"><span class="co"># bring in year or birth for cleaning</span></a>
<a class="sourceLine" id="cb87-25" data-line-number="25">liss_match &lt;-<span class="st"> </span>liss_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-26" data-line-number="26"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;age&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-27" data-line-number="27"><span class="st">  </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb87-28" data-line-number="28">  liss_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;age&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-29" data-line-number="29"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">yearBrth =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-30" data-line-number="30"><span class="st">  </span><span class="kw">select</span>(SID, yearBrth)</a>
<a class="sourceLine" id="cb87-31" data-line-number="31">  ) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb87-32" data-line-number="32"></a>
<a class="sourceLine" id="cb87-33" data-line-number="33"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb87-34" data-line-number="34"></a>
<a class="sourceLine" id="cb87-35" data-line-number="35">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, year){</a>
<a class="sourceLine" id="cb87-36" data-line-number="36">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb87-37" data-line-number="37">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb87-38" data-line-number="38">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb87-39" data-line-number="39">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb87-40" data-line-number="40">}</a>
<a class="sourceLine" id="cb87-41" data-line-number="41"></a>
<a class="sourceLine" id="cb87-42" data-line-number="42">liss_match &lt;-<span class="st"> </span>liss_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-43" data-line-number="43"><span class="st">  </span><span class="kw">group_by</span>(recode, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-44" data-line-number="44"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-45" data-line-number="45"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-46" data-line-number="46"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-47" data-line-number="47"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb87-48" data-line-number="48"></a>
<a class="sourceLine" id="cb87-49" data-line-number="49"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb87-50" data-line-number="50">liss_match &lt;-<span class="st"> </span>liss_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-51" data-line-number="51"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">tolower</span>(reverse_code) <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, </a>
<a class="sourceLine" id="cb87-52" data-line-number="52">                        <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb87-53" data-line-number="53"></a>
<a class="sourceLine" id="cb87-54" data-line-number="54">fun_call &lt;-<span class="st"> </span><span class="cf">function</span>(x, rule){</a>
<a class="sourceLine" id="cb87-55" data-line-number="55">    <span class="cf">switch</span>(rule,</a>
<a class="sourceLine" id="cb87-56" data-line-number="56">           <span class="dt">average =</span> <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb87-57" data-line-number="57">           <span class="dt">mode =</span> <span class="kw">Mode</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb87-58" data-line-number="58">           <span class="dt">sum =</span> <span class="kw">sum</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb87-59" data-line-number="59">           <span class="dt">skip =</span> <span class="kw">unique</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb87-60" data-line-number="60">           <span class="dt">max =</span> <span class="kw">max</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb87-61" data-line-number="61">           <span class="dt">min =</span> <span class="kw">min</span>(x, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb87-62" data-line-number="62">  }</a>
<a class="sourceLine" id="cb87-63" data-line-number="63"></a>
<a class="sourceLine" id="cb87-64" data-line-number="64"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb87-65" data-line-number="65">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb87-66" data-line-number="66">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-67" data-line-number="67"><span class="st">    </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb87-68" data-line-number="68"><span class="st">    </span><span class="kw">group_by</span>(SID, HHID, yearBrth, name, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-69" data-line-number="69"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-70" data-line-number="70"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-71" data-line-number="71"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb87-72" data-line-number="72">}</a>
<a class="sourceLine" id="cb87-73" data-line-number="73"></a>
<a class="sourceLine" id="cb87-74" data-line-number="74">liss_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;LISS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb87-75" data-line-number="75"></a>
<a class="sourceLine" id="cb87-76" data-line-number="76">liss_match &lt;-<span class="st"> </span>liss_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-77" data-line-number="77"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="kw">max</span>(liss_waves<span class="op">$</span>Used) <span class="op">|</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-78" data-line-number="78"><span class="st">         </span>name <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;dadEdu&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-79" data-line-number="79"><span class="st">  </span><span class="kw">group_by</span>(comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-80" data-line-number="80"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-81" data-line-number="81"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-82" data-line-number="82"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-83" data-line-number="83"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb87-84" data-line-number="84"></a>
<a class="sourceLine" id="cb87-85" data-line-number="85">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, p_year){</a>
<a class="sourceLine" id="cb87-86" data-line-number="86">  liss_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-87" data-line-number="87"><span class="st">    </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span>p_year  <span class="op">&amp;</span><span class="st"> </span>comp_rule <span class="op">==</span><span class="st"> </span>rule <span class="op">|</span><span class="st"> </span></a>
<a class="sourceLine" id="cb87-88" data-line-number="88"><span class="st">           </span>name <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;dadEdu&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-89" data-line-number="89"><span class="st">    </span><span class="kw">group_by</span>(SID, HHID, yearBrth, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-90" data-line-number="90"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-91" data-line-number="91"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb87-92" data-line-number="92">}</a>
<a class="sourceLine" id="cb87-93" data-line-number="93"></a>
<a class="sourceLine" id="cb87-94" data-line-number="94">liss_match &lt;-<span class="st"> </span><span class="kw">crossing</span>(</a>
<a class="sourceLine" id="cb87-95" data-line-number="95">  <span class="dt">p_year =</span> liss_waves<span class="op">$</span>Used, </a>
<a class="sourceLine" id="cb87-96" data-line-number="96">  <span class="dt">comp_rule =</span> <span class="kw">unique</span>(liss_match<span class="op">$</span>comp_rule)</a>
<a class="sourceLine" id="cb87-97" data-line-number="97">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-98" data-line-number="98"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(comp_rule, p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-99" data-line-number="99"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-100" data-line-number="100"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-101" data-line-number="101"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb87-102" data-line-number="102"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> name, <span class="dt">values_from =</span> value, <span class="dt">values_fn =</span> <span class="kw">list</span>(<span class="dt">value =</span> max)) </a></code></pre></div>
<pre><code>## # A tibble: 27,382 x 62
##       SID   HHID  year     A     C   DEP     E    IQ     N  `NA`     O    PA    SE    SS
##     &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 800033 583404  2008  3     2    NA      2.2    NA   3.5   3.3  3.29   4.2  5.38  2   
##  2 800042 500277  2008  3.5   4     2.67   3.2    NA   3     2.1  3.43   5.7  4.88  2.08
##  3 800045 548654  2008 NA    NA     1     NA      NA  NA    NA   NA     NA   NA    NA   
##  4 800057 580532  2008  2.83  2.67  1      4.2    NA   4.5   1.4  4.57   4.5  6.75  2   
##  5 800076 578048  2008  3.17  3.5   2.33   3       4   3     2.5  3.14   5.6  4.5   1.3 
##  6 800119 537783  2008  2.83  3.33  1.33   3.4    NA   3    NA    3.14  NA    5.75 NA   
##  7 800125 582101  2008  4     4     4.33   2.4    NA   2     3.3  4.29   4.3  4.5   0   
##  8 800134 549826  2008  4.67  2.67  1.67   4.8    NA   4     1.8  3.43   5.4  5.62 NA   
##  9 800155 545016  2008 NA    NA    NA     NA      NA  NA    NA   NA     NA   NA     1.2 
## 10 800158 519049  2008  3.67  3.67  1      2.4    NA   4     1.3  3      3.2  5.5   2   
## # … with 27,372 more rows, and 48 more variables: SWL &lt;dbl&gt;, yearBrth &lt;dbl&gt;, HHsize &lt;dbl&gt;,
## #   dadEdu &lt;dbl&gt;, dadOccPrstg &lt;dbl&gt;, momEdu &lt;dbl&gt;, momOccPrstg &lt;dbl&gt;, eatingHabits &lt;dbl&gt;,
## #   loneliness &lt;dbl&gt;, physAct &lt;dbl&gt;, PhysFunc &lt;dbl&gt;, satFnc &lt;dbl&gt;, satLeisure &lt;dbl&gt;,
## #   satSchl &lt;dbl&gt;, satWgs &lt;dbl&gt;, SRhealth &lt;dbl&gt;, survAtt &lt;dbl&gt;, exercise &lt;dbl&gt;,
## #   satFam &lt;dbl&gt;, satHH &lt;dbl&gt;, alcohol &lt;dbl&gt;, alcoholType &lt;dbl&gt;, disability &lt;dbl&gt;,
## #   drugs &lt;dbl&gt;, drVisits &lt;dbl&gt;, employed &lt;dbl&gt;, ethnicity &lt;dbl&gt;, numSibling &lt;dbl&gt;,
## #   religion &lt;dbl&gt;, smokes &lt;dbl&gt;, unempBen &lt;dbl&gt;, welfare &lt;dbl&gt;, gender &lt;dbl&gt;, urban &lt;dbl&gt;,
## #   ageMarried &lt;dbl&gt;, married &lt;dbl&gt;, dadAlive &lt;dbl&gt;, diet &lt;dbl&gt;, height &lt;dbl&gt;,
## #   momAlive &lt;dbl&gt;, parDivorce &lt;dbl&gt;, weight &lt;dbl&gt;, grsWages &lt;dbl&gt;, numKids &lt;dbl&gt;,
## #   education &lt;dbl&gt;, physhlthevnt &lt;dbl&gt;, age &lt;dbl&gt;, BMI &lt;dbl&gt;</code></pre>
</div>
<div id="personality-variables-5" class="section level3">
<h3><span class="header-section-number">2.7.3</span> Personality Variables</h3>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" data-line-number="1">liss_pers &lt;-<span class="st"> </span>liss_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;pers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb89-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb89-7" data-line-number="7"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-8" data-line-number="8"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-9" data-line-number="9"><span class="st">  </span><span class="kw">left_join</span>(p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;LISS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">name =</span> p_item, Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-10" data-line-number="10"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span>Used) </a>
<a class="sourceLine" id="cb89-11" data-line-number="11"></a>
<a class="sourceLine" id="cb89-12" data-line-number="12">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb89-13" data-line-number="13">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb89-14" data-line-number="14">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb89-15" data-line-number="15">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb89-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb89-17" data-line-number="17"></a>
<a class="sourceLine" id="cb89-18" data-line-number="18"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb89-19" data-line-number="19">liss_pers &lt;-<span class="st"> </span>liss_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-20" data-line-number="20"><span class="st">  </span><span class="kw">select</span>(name<span class="op">:</span>HHID, itemname, year, reverse_code<span class="op">:</span>comp_rule, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-21" data-line-number="21"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-22" data-line-number="22"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-23" data-line-number="23"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-25" data-line-number="25"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb89-26" data-line-number="26"></a>
<a class="sourceLine" id="cb89-27" data-line-number="27"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb89-28" data-line-number="28">liss_pers &lt;-<span class="st"> </span>liss_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-29" data-line-number="29"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">tolower</span>(reverse_code) <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, </a>
<a class="sourceLine" id="cb89-30" data-line-number="30">                        <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb89-31" data-line-number="31"></a>
<a class="sourceLine" id="cb89-32" data-line-number="32"><span class="co"># alpha&#39;s</span></a>
<a class="sourceLine" id="cb89-33" data-line-number="33">liss_alpha &lt;-<span class="st"> </span>liss_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-34" data-line-number="34"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, SID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-35" data-line-number="35"><span class="st">  </span><span class="kw">group_by</span>(name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-36" data-line-number="36"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-37" data-line-number="37"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> itemname, <span class="dt">values_from =</span> value)),</a>
<a class="sourceLine" id="cb89-38" data-line-number="38">         <span class="dt">alpha =</span> <span class="kw">map</span>(data, <span class="kw">possibly</span>(<span class="op">~</span>psych<span class="op">::</span><span class="kw">alpha</span>((.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>SID)), <span class="ot">NA_real_</span>)))</a>
<a class="sourceLine" id="cb89-39" data-line-number="39"></a>
<a class="sourceLine" id="cb89-40" data-line-number="40"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb89-41" data-line-number="41">liss_pers &lt;-<span class="st"> </span>liss_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-42" data-line-number="42"><span class="st">  </span><span class="kw">group_by</span>(SID, HHID, name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb89-43" data-line-number="43"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T)) </a></code></pre></div>
</div>
<div id="outcome-variables-6" class="section level3">
<h3><span class="header-section-number">2.7.4</span> Outcome Variables</h3>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" data-line-number="1">rename_fun &lt;-<span class="st"> </span><span class="cf">function</span>(cb, var){</a>
<a class="sourceLine" id="cb90-2" data-line-number="2">  old.names &lt;-<span class="st"> </span><span class="kw">unique</span>((liss_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> </span>var))<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb90-3" data-line-number="3">  df &lt;-<span class="st"> </span>liss <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-4" data-line-number="4"><span class="st">    </span><span class="kw">select</span>(<span class="dt">SID =</span> nomem_encr, <span class="dt">HHID =</span> nohouse_encr, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-5" data-line-number="5"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, </a>
<a class="sourceLine" id="cb90-6" data-line-number="6">           <span class="op">-</span>SID, <span class="op">-</span>HHID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-7" data-line-number="7"><span class="st">    </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(itemname, year, orig_itemname, reverse_code<span class="op">:</span>comp_rule))</a>
<a class="sourceLine" id="cb90-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb90-9" data-line-number="9"></a>
<a class="sourceLine" id="cb90-10" data-line-number="10">liss_out &lt;-<span class="st"> </span>liss_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-12" data-line-number="12"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-13" data-line-number="13"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-14" data-line-number="14"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-15" data-line-number="15"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-16" data-line-number="16"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-17" data-line-number="17"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-18" data-line-number="18"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> liss_waves<span class="op">$</span>Used, <span class="dt">name =</span> <span class="kw">unique</span>((.)<span class="op">$</span>name)))</a>
<a class="sourceLine" id="cb90-19" data-line-number="19"></a>
<a class="sourceLine" id="cb90-20" data-line-number="20">liss_out &lt;-<span class="st"> </span>avars <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-21" data-line-number="21"><span class="st">  </span><span class="kw">select</span>(year, <span class="dt">itemname =</span> month, <span class="dt">SID =</span> nomem_encr, <span class="dt">divorced =</span> burgstat, <span class="dt">unemployed =</span> belbezig) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-22" data-line-number="22"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> name, <span class="dt">value =</span> value, divorced, unemployed) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-23" data-line-number="23"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">as.numeric</span>(year), <span class="dt">p_year =</span> <span class="dv">2008</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-25" data-line-number="25"><span class="st">  </span><span class="kw">left_join</span>(liss_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;divorced&quot;</span>, <span class="st">&quot;unemployed&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-26" data-line-number="26"><span class="st">              </span><span class="kw">select</span>(name, recode, reverse_code, mini, maxi) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-27" data-line-number="27"><span class="st">  </span><span class="kw">full_join</span>(liss_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="op">!</span>(orig_itemname <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;burgstat&quot;</span>, <span class="st">&quot;belbezig&quot;</span>))))</a>
<a class="sourceLine" id="cb90-28" data-line-number="28"></a>
<a class="sourceLine" id="cb90-29" data-line-number="29"><span class="co"># recode</span></a>
<a class="sourceLine" id="cb90-30" data-line-number="30">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year){</a>
<a class="sourceLine" id="cb90-31" data-line-number="31">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb90-32" data-line-number="32">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb90-33" data-line-number="33">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb90-34" data-line-number="34">}</a>
<a class="sourceLine" id="cb90-35" data-line-number="35"></a>
<a class="sourceLine" id="cb90-36" data-line-number="36">liss_out &lt;-<span class="st"> </span>liss_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-37" data-line-number="37"><span class="st">  </span><span class="kw">select</span>(year<span class="op">:</span>maxi, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-38" data-line-number="38"><span class="st">  </span><span class="co"># select(name:HHID, itemname, year, reverse_code:comp_rule, value, p_year) %&gt;%</span></a>
<a class="sourceLine" id="cb90-39" data-line-number="39"><span class="st">  </span><span class="co"># filter(name %in% c(&quot;married&quot;, &quot;mvInPrtnr&quot;)) %&gt;%</span></a>
<a class="sourceLine" id="cb90-40" data-line-number="40"><span class="st">  </span><span class="kw">group_by</span>(recode, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-41" data-line-number="41"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-42" data-line-number="42"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-43" data-line-number="43"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-44" data-line-number="44"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb90-45" data-line-number="45"></a>
<a class="sourceLine" id="cb90-46" data-line-number="46">liss_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;LISS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb90-47" data-line-number="47"></a>
<a class="sourceLine" id="cb90-48" data-line-number="48">liss_out &lt;-<span class="st"> </span>liss_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-49" data-line-number="49"><span class="st">  </span><span class="co"># filter(year &lt;= max(gsoep_waves$Used)) %&gt;%</span></a>
<a class="sourceLine" id="cb90-50" data-line-number="50"><span class="st">  </span><span class="kw">group_by</span>(SID, name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-51" data-line-number="51"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb90-52" data-line-number="52"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-53" data-line-number="53"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(value)<span class="op">|</span><span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb90-54" data-line-number="54"></a>
<a class="sourceLine" id="cb90-55" data-line-number="55"><span class="co"># composite across years</span></a>
<a class="sourceLine" id="cb90-56" data-line-number="56">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(p_year){</a>
<a class="sourceLine" id="cb90-57" data-line-number="57">  liss_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-58" data-line-number="58"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>p_year, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;past&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-59" data-line-number="59"><span class="st">    </span><span class="kw">group_by</span>(SID, name, group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-60" data-line-number="60"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-61" data-line-number="61"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-62" data-line-number="62"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-63" data-line-number="63"><span class="st">    </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> group, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-64" data-line-number="64"><span class="st">    </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-65" data-line-number="65"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(past) <span class="op">|</span><span class="st"> </span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(future)), future,</a>
<a class="sourceLine" id="cb90-66" data-line-number="66">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(future), past, </a>
<a class="sourceLine" id="cb90-67" data-line-number="67">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)))) </a>
<a class="sourceLine" id="cb90-68" data-line-number="68">}</a>
<a class="sourceLine" id="cb90-69" data-line-number="69"></a>
<a class="sourceLine" id="cb90-70" data-line-number="70">liss_out &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">p_year =</span> liss_waves<span class="op">$</span>Used) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-71" data-line-number="71"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb90-72" data-line-number="72"><span class="st">  </span><span class="kw">unnest</span>(data) </a></code></pre></div>
</div>
<div id="covariates-5" class="section level3">
<h3><span class="header-section-number">2.7.5</span> Covariates</h3>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1">liss_match &lt;-<span class="st"> </span>liss_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-2" data-line-number="2"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb91-3" data-line-number="3"><span class="st">  </span><span class="kw">full_join</span>(liss_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">year =</span> p_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-4" data-line-number="4"><span class="st">  </span><span class="co"># left_join(gsoep_bp %&gt;% select(-momID, -dadID)) %&gt;%</span></a>
<a class="sourceLine" id="cb91-5" data-line-number="5"><span class="st">  </span><span class="co"># physical health event</span></a>
<a class="sourceLine" id="cb91-6" data-line-number="6"><span class="st">  </span><span class="kw">left_join</span>(liss_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;physhlthevnt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">year =</span> p_year, SID, <span class="dt">physhlthevnt =</span> past) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">physhlthevnt =</span> <span class="kw">max</span>(physhlthevnt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-7" data-line-number="7"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-8" data-line-number="8"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb91-9" data-line-number="9"></a>
<a class="sourceLine" id="cb91-10" data-line-number="10">liss_match &lt;-<span class="st"> </span>liss_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-11" data-line-number="11"><span class="st">  </span><span class="kw">group_by</span>(SID, HHID, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> year <span class="op">-</span><span class="st"> </span>yearBrth,</a>
<a class="sourceLine" id="cb91-13" data-line-number="13">         <span class="dt">BMI =</span> weight <span class="op">/</span><span class="st"> </span>((height<span class="op">/</span><span class="dv">100</span>)<span class="op">^</span><span class="dv">2</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-14" data-line-number="14"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb91-15" data-line-number="15"></a>
<a class="sourceLine" id="cb91-16" data-line-number="16">liss_out &lt;-<span class="st"> </span>liss_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-17" data-line-number="17"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>past, <span class="op">-</span>future) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-18" data-line-number="18"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb91-19" data-line-number="19"></a>
<a class="sourceLine" id="cb91-20" data-line-number="20">liss_SCA &lt;-<span class="st"> </span>liss_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb91-21" data-line-number="21"><span class="st">  </span><span class="kw">select</span>(<span class="dt">SID =</span> SID, <span class="dt">p_year =</span> year, <span class="dt">race =</span> ethnicity, <span class="kw">one_of</span>(<span class="kw">c</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name), <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;dadEdu&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-22" data-line-number="22"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb91-24" data-line-number="24">         <span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-25" data-line-number="25"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(parEdu, parOccPrstg), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-26" data-line-number="26"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb91-27" data-line-number="27"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu, <span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg)</a>
<a class="sourceLine" id="cb91-28" data-line-number="28"></a>
<a class="sourceLine" id="cb91-29" data-line-number="29"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(liss_match2)]</a></code></pre></div>
</div>
<div id="imputation-5" class="section level3">
<h3><span class="header-section-number">2.7.6</span> Imputation</h3>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" data-line-number="1"><span class="co"># short helper functions to (1) identify and create factors, save col names of factors, remove columns with all missing values, and setup amelia</span></a>
<a class="sourceLine" id="cb92-2" data-line-number="2">factor_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){<span class="cf">if</span>(<span class="kw">is.numeric</span>(x)){<span class="kw">diff</span>(<span class="kw">range</span>(x, <span class="dt">na.rm =</span> T)) <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(x)) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">4</span>} <span class="cf">else</span>{F}}</a>
<a class="sourceLine" id="cb92-3" data-line-number="3">not_all_id &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="cf">if</span>(<span class="kw">is.numeric</span>(x)) <span class="kw">sd</span>(x, <span class="dt">na.rm =</span> T) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb92-4" data-line-number="4">mice_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb92-5" data-line-number="5">  <span class="kw">mice</span>(df, <span class="dt">m =</span> <span class="dv">5</span>, <span class="dt">maxit=</span><span class="dv">5</span>, <span class="dt">printFlag=</span><span class="ot">TRUE</span>, <span class="dt">method =</span> <span class="st">&quot;cart&quot;</span>)</a>
<a class="sourceLine" id="cb92-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb92-7" data-line-number="7"></a>
<a class="sourceLine" id="cb92-8" data-line-number="8">liss_match_imp &lt;-<span class="st"> </span>liss_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-9" data-line-number="9"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">NegAff =</span> <span class="st">`</span><span class="dt">NA</span><span class="st">`</span>, <span class="dt">race =</span> ethnicity) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-10" data-line-number="10"><span class="st">  </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-12" data-line-number="12"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg, <span class="op">-</span>HHID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-13" data-line-number="13"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-14" data-line-number="14"><span class="st">  </span><span class="kw">mutate_all</span>(<span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-15" data-line-number="15"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(year) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-16" data-line-number="16"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb92-17" data-line-number="17"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-18" data-line-number="18"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-19" data-line-number="19"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_na) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_id)),</a>
<a class="sourceLine" id="cb92-20" data-line-number="20">         <span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(factor_fun, as.factor)),</a>
<a class="sourceLine" id="cb92-21" data-line-number="21">         <span class="dt">imp =</span> <span class="kw">map</span>(data, mice_fun))</a>
<a class="sourceLine" id="cb92-22" data-line-number="22">beepr<span class="op">::</span><span class="kw">beep</span>(<span class="dt">sound =</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb92-23" data-line-number="23"></a>
<a class="sourceLine" id="cb92-24" data-line-number="24">liss_match_imp &lt;-<span class="st"> </span>liss_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-25" data-line-number="25"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp, <span class="op">~</span>mice<span class="op">::</span><span class="kw">complete</span>(., <span class="st">&quot;long&quot;</span>)),</a>
<a class="sourceLine" id="cb92-26" data-line-number="26">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">PhysFunc =</span> <span class="kw">factor</span>(<span class="kw">ceiling</span>(PhysFunc)))),</a>
<a class="sourceLine" id="cb92-27" data-line-number="27">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb92-28" data-line-number="28"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-29" data-line-number="29"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-30" data-line-number="30"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-31" data-line-number="31"><span class="st">    </span><span class="kw">ungroup</span>()),</a>
<a class="sourceLine" id="cb92-32" data-line-number="32">         <span class="dt">imp_sca =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(.imp <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID,  <span class="kw">one_of</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name)))))</a>
<a class="sourceLine" id="cb92-33" data-line-number="33"></a>
<a class="sourceLine" id="cb92-34" data-line-number="34">liss_match_imp_long &lt;-<span class="st"> </span>liss_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-35" data-line-number="35"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-36" data-line-number="36"><span class="st">  </span><span class="kw">unnest</span>(imp_df)</a>
<a class="sourceLine" id="cb92-37" data-line-number="37"></a>
<a class="sourceLine" id="cb92-38" data-line-number="38">liss_SCA_imp &lt;-<span class="st"> </span>liss_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-39" data-line-number="39"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-40" data-line-number="40"><span class="st">  </span><span class="kw">unnest</span>(imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-41" data-line-number="41"><span class="st">  </span><span class="kw">left_join</span>(liss_SCA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">p_year=</span>year, SID,</a>
<a class="sourceLine" id="cb92-42" data-line-number="42">        <span class="kw">colnames</span>(liss_SCA)[<span class="op">!</span><span class="kw">colnames</span>(liss_SCA) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(.)]))</a></code></pre></div>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" data-line-number="1"><span class="kw">save</span>(liss_match_imp_long, liss_SCA_imp, </a>
<a class="sourceLine" id="cb93-2" data-line-number="2">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/liss_imputed_small.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb93-3" data-line-number="3"><span class="kw">save</span>(liss_match_imp, </a>
<a class="sourceLine" id="cb93-4" data-line-number="4">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/liss_imputed.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb93-5" data-line-number="5"><span class="kw">save</span>(liss_alpha, liss_pers, liss_out, liss_match, avars, liss_SCA,</a>
<a class="sourceLine" id="cb93-6" data-line-number="6">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/liss_cleaned.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb93-7" data-line-number="7"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;liss&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" data-line-number="1"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;liss&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
</div>
</div>
<div id="midus" class="section level2">
<h2><span class="header-section-number">2.8</span> MIDUS</h2>
<p>The Midlife in the United States (MIDUS; Brim, Ryff, &amp; Kessler, 2004; Ryff et al., 2012, 2016) study is an ongoing longitudinal study of adults in the United States. These data are available at <a href="http://www.icpsr.umich.edu" class="uri">http://www.icpsr.umich.edu</a> by making a free account.</p>
<p>Participants included more than 10,000 individuals aged 25 or older from the United States. The present study uses data from MIDUS I, II, and III. MIDUS I was collected in 1995-1996. MIDUS II was the follow-up to MIDUS I and was collected from 2004-2006. MIDUS III was an additional follow-up conducted from 2013-2014. More information can be found at <a href="http://midus.wisc.edu/findings/Understanding_Data_Collection_in_MIDUS.pdf" class="uri">http://midus.wisc.edu/findings/Understanding_Data_Collection_in_MIDUS.pdf</a>.</p>
<p>Sample size varies by wave, with 7,108 (MIDUS I), 4,963 (MIDUS II), 3,294 (MIDUS III). This provides 99/% power to detect a zero-order correlation effect size of ~.06, two-tailed at alpha .05.</p>
<div id="load-data-7" class="section level3">
<h3><span class="header-section-number">2.8.1</span> Load Data</h3>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" data-line-number="1">loadRData &lt;-<span class="st"> </span><span class="cf">function</span>(fileName){</a>
<a class="sourceLine" id="cb95-2" data-line-number="2"><span class="co">#loads an RData file, and returns it</span></a>
<a class="sourceLine" id="cb95-3" data-line-number="3">    <span class="kw">load</span>(fileName)</a>
<a class="sourceLine" id="cb95-4" data-line-number="4">    <span class="kw">get</span>(<span class="kw">ls</span>()[<span class="kw">ls</span>() <span class="op">!=</span><span class="st"> &quot;fileName&quot;</span>])</a>
<a class="sourceLine" id="cb95-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb95-6" data-line-number="6"></a>
<a class="sourceLine" id="cb95-7" data-line-number="7">midus_read_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb95-8" data-line-number="8">  <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/midus/%s&quot;</span>, wd, x) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">loadRData</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb95-9" data-line-number="9"><span class="st">    </span><span class="kw">select</span>(<span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb95-10" data-line-number="10"><span class="st">    </span>tbl_df</a>
<a class="sourceLine" id="cb95-11" data-line-number="11">}</a></code></pre></div>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb96-1" data-line-number="1">midus_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;MIDUS&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb96-2" data-line-number="2">midus_codebook</a></code></pre></div>
<pre><code>## # A tibble: 1,051 x 16
##    study dataset category name  itemname wave   year new_itemname orig_itemname description
##    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;         &lt;chr&gt;      
##  1 midus M2P1    match    achv… hghStnd… M2P1   2004 midus__matc… B1SE7FF       Set very h…
##  2 midus M3P1    match    achv… hghStnd… M3P1   2013 midus__matc… C1SE7FF       Set very h…
##  3 midus M2P1    match    achv… keepWrk… M2P1   2004 midus__matc… B1SE7L        Keep worki…
##  4 midus M3P1    match    achv… keepWrk… M3P1   2013 midus__matc… C1SE7L        Keep worki…
##  5 midus M2P1    match    achv… likeDiff M2P1   2004 midus__matc… B1SE7O        I like to …
##  6 midus M3P1    match    achv… likeDiff M3P1   2013 midus__matc… C1SE7O        I like to …
##  7 midus M2P1    match    achv… likeWrk  M2P1   2004 midus__matc… B1SE7R        I like har…
##  8 midus M3P1    match    achv… likeWrk  M3P1   2013 midus__matc… C1SE7R        I like har…
##  9 midus M1P1    match    age   age      M1P1   1994 midus__matc… A1PAGE_M2     M1 age com…
## 10 midus M2P1    match    age   age      M2P1   2004 midus__matc… B1PAGE_M2     M1 age com…
## # … with 1,041 more rows, and 6 more variables: scale &lt;chr&gt;, reverse_code &lt;chr&gt;,
## #   recode &lt;chr&gt;, mini &lt;dbl&gt;, maxi &lt;dbl&gt;, comp_rule &lt;chr&gt;</code></pre>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb98-1" data-line-number="1">old.names &lt;-<span class="st"> </span><span class="kw">unique</span>(midus_codebook<span class="op">$</span>orig_itemname) <span class="op">%&gt;%</span><span class="st"> </span>str_to_upper</a>
<a class="sourceLine" id="cb98-2" data-line-number="2">datasets &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/midus&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">list.files</span>(., <span class="dt">pattern =</span> <span class="st">&quot;.rda&quot;</span>)</a>
<a class="sourceLine" id="cb98-3" data-line-number="3">midus &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">datasets =</span> datasets) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(datasets, midus_read_fun),</a>
<a class="sourceLine" id="cb98-5" data-line-number="5">         <span class="dt">ncol =</span> <span class="kw">map_dbl</span>(data, ncol)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(ncol <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb98-7" data-line-number="7"></a>
<a class="sourceLine" id="cb98-8" data-line-number="8">midus &lt;-<span class="st"> </span><span class="kw">reduce</span>(midus<span class="op">$</span>data, full_join) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.)</a>
<a class="sourceLine" id="cb98-9" data-line-number="9">midus &lt;-<span class="st"> </span>midus <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate_if</span>(is.factor, <span class="op">~</span><span class="kw">as.numeric</span>(<span class="kw">sub</span>(<span class="st">&quot;^</span><span class="ch">\\</span><span class="st">(0*([0-9]+)</span><span class="ch">\\</span><span class="st">).+$&quot;</span>, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>, .)))</a>
<a class="sourceLine" id="cb98-11" data-line-number="11"><span class="kw">save</span>(midus, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/midus_raw.RData&quot;</span>, wd))</a></code></pre></div>
</div>
<div id="matching-variables-6" class="section level3">
<h3><span class="header-section-number">2.8.2</span> Matching Variables</h3>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb99-1" data-line-number="1">rename_fun &lt;-<span class="st"> </span><span class="cf">function</span>(cb, var){</a>
<a class="sourceLine" id="cb99-2" data-line-number="2">  old.names &lt;-<span class="st"> </span><span class="kw">unique</span>((midus_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> </span>var))<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb99-3" data-line-number="3">  df &lt;-<span class="st"> </span>midus <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-4" data-line-number="4"><span class="st">    </span><span class="kw">select</span>(<span class="dt">SID =</span> M2ID, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-5" data-line-number="5"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-6" data-line-number="6"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">as.numeric</span>(value))</a>
<a class="sourceLine" id="cb99-7" data-line-number="7">  <span class="cf">if</span>(<span class="kw">length</span>(old.names) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>){</a>
<a class="sourceLine" id="cb99-8" data-line-number="8">      df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(itemname, year, orig_itemname, reverse_code<span class="op">:</span>comp_rule))</a>
<a class="sourceLine" id="cb99-9" data-line-number="9">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb99-10" data-line-number="10">    df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>(itemname<span class="op">:</span>year),  <span class="op">-</span>new_itemname, <span class="op">-</span>dataset) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb99-11" data-line-number="11">  }</a>
<a class="sourceLine" id="cb99-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb99-13" data-line-number="13"></a>
<a class="sourceLine" id="cb99-14" data-line-number="14"><span class="co"># rename variables   </span></a>
<a class="sourceLine" id="cb99-15" data-line-number="15">midus_match &lt;-<span class="st"> </span>midus_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-16" data-line-number="16"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-17" data-line-number="17"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-18" data-line-number="18"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-19" data-line-number="19"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-20" data-line-number="20"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-21" data-line-number="21"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-22" data-line-number="22"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb99-23" data-line-number="23"></a>
<a class="sourceLine" id="cb99-24" data-line-number="24"><span class="co"># bring in year or birth for cleaning</span></a>
<a class="sourceLine" id="cb99-25" data-line-number="25">yrBrth &lt;-<span class="st"> </span>midus_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-26" data-line-number="26"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;age&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-27" data-line-number="27"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">yearBrth =</span> year <span class="op">-</span><span class="st"> </span>value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-28" data-line-number="28"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-29" data-line-number="29"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">yearBrth =</span> <span class="kw">max</span>(yearBrth, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-30" data-line-number="30"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-31" data-line-number="31"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">yearBrth =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(yearBrth), <span class="ot">NA</span>, yearBrth))</a>
<a class="sourceLine" id="cb99-32" data-line-number="32"></a>
<a class="sourceLine" id="cb99-33" data-line-number="33"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb99-34" data-line-number="34"></a>
<a class="sourceLine" id="cb99-35" data-line-number="35">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, year){</a>
<a class="sourceLine" id="cb99-36" data-line-number="36">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb99-37" data-line-number="37">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb99-38" data-line-number="38">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb99-39" data-line-number="39">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb99-40" data-line-number="40">}</a>
<a class="sourceLine" id="cb99-41" data-line-number="41"></a>
<a class="sourceLine" id="cb99-42" data-line-number="42">midus_match &lt;-<span class="st"> </span>midus_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-43" data-line-number="43"><span class="st">  </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-44" data-line-number="44"><span class="st">  </span><span class="kw">group_by</span>(recode, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-45" data-line-number="45"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-46" data-line-number="46"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-47" data-line-number="47"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-48" data-line-number="48"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb99-49" data-line-number="49"></a>
<a class="sourceLine" id="cb99-50" data-line-number="50"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb99-51" data-line-number="51">midus_match &lt;-<span class="st"> </span>midus_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-52" data-line-number="52"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, </a>
<a class="sourceLine" id="cb99-53" data-line-number="53">                        <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb99-54" data-line-number="54"></a>
<a class="sourceLine" id="cb99-55" data-line-number="55">fun_call &lt;-<span class="st"> </span><span class="cf">function</span>(x, rule){</a>
<a class="sourceLine" id="cb99-56" data-line-number="56">    <span class="cf">switch</span>(rule,</a>
<a class="sourceLine" id="cb99-57" data-line-number="57">           <span class="dt">average =</span> <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb99-58" data-line-number="58">           <span class="dt">mode =</span> <span class="kw">Mode</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb99-59" data-line-number="59">           <span class="dt">sum =</span> <span class="kw">sum</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb99-60" data-line-number="60">           <span class="dt">skip =</span> <span class="kw">unique</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb99-61" data-line-number="61">           <span class="dt">max =</span> <span class="kw">max</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb99-62" data-line-number="62">           <span class="dt">min =</span> <span class="kw">min</span>(x, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb99-63" data-line-number="63">  }</a>
<a class="sourceLine" id="cb99-64" data-line-number="64"></a>
<a class="sourceLine" id="cb99-65" data-line-number="65"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb99-66" data-line-number="66">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb99-67" data-line-number="67">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-68" data-line-number="68"><span class="st">    </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb99-69" data-line-number="69"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-70" data-line-number="70"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-71" data-line-number="71"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb99-72" data-line-number="72"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb99-73" data-line-number="73">}</a>
<a class="sourceLine" id="cb99-74" data-line-number="74"></a>
<a class="sourceLine" id="cb99-75" data-line-number="75">midus_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;MIDUS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb99-76" data-line-number="76"></a>
<a class="sourceLine" id="cb99-77" data-line-number="77">midus_match &lt;-<span class="st"> </span>midus_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-78" data-line-number="78"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="kw">max</span>(midus_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-79" data-line-number="79"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule) <span class="op">|</span><span class="st"> </span>comp_rule <span class="op">==</span><span class="st"> &quot;none&quot;</span>, <span class="st">&quot;skip&quot;</span>, comp_rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-80" data-line-number="80"><span class="st">  </span><span class="kw">group_by</span>(comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-81" data-line-number="81"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-82" data-line-number="82"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-83" data-line-number="83"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-84" data-line-number="84"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb99-85" data-line-number="85"></a>
<a class="sourceLine" id="cb99-86" data-line-number="86">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, p_year){</a>
<a class="sourceLine" id="cb99-87" data-line-number="87">  midus_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-88" data-line-number="88"><span class="st">    </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span>p_year  <span class="op">&amp;</span><span class="st"> </span>comp_rule <span class="op">==</span><span class="st"> </span>rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-89" data-line-number="89"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-90" data-line-number="90"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-91" data-line-number="91"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb99-92" data-line-number="92">}</a>
<a class="sourceLine" id="cb99-93" data-line-number="93"></a>
<a class="sourceLine" id="cb99-94" data-line-number="94">midus_match &lt;-<span class="st"> </span><span class="kw">crossing</span>(</a>
<a class="sourceLine" id="cb99-95" data-line-number="95">  <span class="dt">p_year =</span> midus_waves<span class="op">$</span>Used, </a>
<a class="sourceLine" id="cb99-96" data-line-number="96">  <span class="dt">comp_rule =</span> <span class="kw">unique</span>(midus_match<span class="op">$</span>comp_rule)</a>
<a class="sourceLine" id="cb99-97" data-line-number="97">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-98" data-line-number="98"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(comp_rule, p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-99" data-line-number="99"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-100" data-line-number="100"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-101" data-line-number="101"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-102" data-line-number="102"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> name, <span class="dt">values_from =</span> value, <span class="dt">values_fn =</span> <span class="kw">list</span>(<span class="dt">value =</span> max)) </a></code></pre></div>
</div>
<div id="personality-variables-6" class="section level3">
<h3><span class="header-section-number">2.8.3</span> Personality Variables</h3>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb100-1" data-line-number="1">midus_pers &lt;-<span class="st"> </span>midus_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;pers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb100-7" data-line-number="7"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-8" data-line-number="8"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-9" data-line-number="9"><span class="st">  </span><span class="kw">left_join</span>(p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;MIDUS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">name =</span> p_item, Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-10" data-line-number="10"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span>Used <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(value)) </a>
<a class="sourceLine" id="cb100-11" data-line-number="11"></a>
<a class="sourceLine" id="cb100-12" data-line-number="12">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb100-13" data-line-number="13">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb100-14" data-line-number="14">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb100-15" data-line-number="15">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb100-16" data-line-number="16">}</a>
<a class="sourceLine" id="cb100-17" data-line-number="17"></a>
<a class="sourceLine" id="cb100-18" data-line-number="18"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb100-19" data-line-number="19">midus_pers &lt;-<span class="st"> </span>midus_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-20" data-line-number="20"><span class="st">  </span><span class="kw">select</span>(name, SID, itemname, year, reverse_code<span class="op">:</span>comp_rule, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-21" data-line-number="21"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-22" data-line-number="22"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-23" data-line-number="23"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-25" data-line-number="25"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb100-26" data-line-number="26"></a>
<a class="sourceLine" id="cb100-27" data-line-number="27"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb100-28" data-line-number="28">midus_pers &lt;-<span class="st"> </span>midus_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-29" data-line-number="29"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">tolower</span>(reverse_code) <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, </a>
<a class="sourceLine" id="cb100-30" data-line-number="30">                        <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb100-31" data-line-number="31"></a>
<a class="sourceLine" id="cb100-32" data-line-number="32"><span class="co"># alpha&#39;s</span></a>
<a class="sourceLine" id="cb100-33" data-line-number="33">midus_alpha &lt;-<span class="st"> </span>midus_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-34" data-line-number="34"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, SID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-35" data-line-number="35"><span class="st">  </span><span class="kw">group_by</span>(name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-36" data-line-number="36"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-37" data-line-number="37"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> itemname, <span class="dt">values_from =</span> value)),</a>
<a class="sourceLine" id="cb100-38" data-line-number="38">         <span class="dt">alpha =</span> <span class="kw">map</span>(data, <span class="kw">possibly</span>(<span class="op">~</span>psych<span class="op">::</span><span class="kw">alpha</span>((.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>SID)), <span class="ot">NA_real_</span>)))</a>
<a class="sourceLine" id="cb100-39" data-line-number="39"></a>
<a class="sourceLine" id="cb100-40" data-line-number="40"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb100-41" data-line-number="41">midus_pers &lt;-<span class="st"> </span>midus_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-42" data-line-number="42"><span class="st">  </span><span class="kw">group_by</span>(SID, name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-43" data-line-number="43"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T)) </a></code></pre></div>
<pre><code>## # A tibble: 118,712 x 4
## # Groups:   SID, name [78,545]
##      SID name   year value
##    &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 10001 A      1994  3   
##  2 10001 A      2004  2.6 
##  3 10001 C      1994  2.75
##  4 10001 C      2004  3.25
##  5 10001 E      1994  2.8 
##  6 10001 E      2004  2.8 
##  7 10001 LOC    1994  5.5 
##  8 10001 LOC    2004  4.75
##  9 10001 N      1994  2   
## 10 10001 N      2004  2.25
## # … with 118,702 more rows</code></pre>
</div>
<div id="outcome-variables-7" class="section level3">
<h3><span class="header-section-number">2.8.4</span> Outcome Variables</h3>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb102-1" data-line-number="1">rename_fun &lt;-<span class="st"> </span><span class="cf">function</span>(cb, var){</a>
<a class="sourceLine" id="cb102-2" data-line-number="2">  old.names &lt;-<span class="st"> </span><span class="kw">unique</span>((midus_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> </span>var))<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb102-3" data-line-number="3">  df &lt;-<span class="st"> </span>midus <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb102-4" data-line-number="4"><span class="st">    </span><span class="kw">select</span>(<span class="dt">SID =</span> M2ID, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-5" data-line-number="5"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-6" data-line-number="6"><span class="st">    </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(itemname, year, orig_itemname, reverse_code<span class="op">:</span>comp_rule))</a>
<a class="sourceLine" id="cb102-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb102-8" data-line-number="8"></a>
<a class="sourceLine" id="cb102-9" data-line-number="9">midus_out &lt;-<span class="st"> </span>midus_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-10" data-line-number="10"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-11" data-line-number="11"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb102-12" data-line-number="12"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-13" data-line-number="13"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-14" data-line-number="14"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb102-15" data-line-number="15"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-16" data-line-number="16"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-17" data-line-number="17"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> midus_waves<span class="op">$</span>Used, <span class="dt">name =</span> <span class="kw">unique</span>((.)<span class="op">$</span>name)))</a>
<a class="sourceLine" id="cb102-18" data-line-number="18"></a>
<a class="sourceLine" id="cb102-19" data-line-number="19"><span class="co"># recode</span></a>
<a class="sourceLine" id="cb102-20" data-line-number="20">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year, year){</a>
<a class="sourceLine" id="cb102-21" data-line-number="21">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb102-22" data-line-number="22">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb102-23" data-line-number="23">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb102-24" data-line-number="24">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb102-25" data-line-number="25">}</a>
<a class="sourceLine" id="cb102-26" data-line-number="26"></a>
<a class="sourceLine" id="cb102-27" data-line-number="27">midus_out &lt;-<span class="st"> </span>midus_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-28" data-line-number="28"><span class="st">  </span><span class="kw">select</span>(name, SID, value<span class="op">:</span>year, recode, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-29" data-line-number="29"><span class="st">  </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-30" data-line-number="30"><span class="st">  </span><span class="kw">group_by</span>(recode, p_year, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-31" data-line-number="31"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-32" data-line-number="32"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-33" data-line-number="33"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-34" data-line-number="34"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb102-35" data-line-number="35"></a>
<a class="sourceLine" id="cb102-36" data-line-number="36">midus_out &lt;-<span class="st"> </span>midus_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;mvInPrtnr&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-37" data-line-number="37"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-38" data-line-number="38"><span class="st">  </span><span class="kw">full_join</span>(</a>
<a class="sourceLine" id="cb102-39" data-line-number="39">    midus_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;mvInPrtnr&quot;</span>, <span class="st">&quot;married&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-40" data-line-number="40"><span class="st">      </span><span class="kw">group_by</span>(p_year, name, SID, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-41" data-line-number="41"><span class="st">      </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-42" data-line-number="42"><span class="st">      </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-43" data-line-number="43"><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(value)<span class="op">|</span><span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-44" data-line-number="44"><span class="st">      </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-45" data-line-number="45"><span class="st">      </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;mvInPrtnr&quot;</span>,</a>
<a class="sourceLine" id="cb102-46" data-line-number="46">             <span class="dt">value =</span> <span class="kw">ifelse</span>((married <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(married)) <span class="op">&amp;</span><span class="st"> </span>mvInPrtnr <span class="op">==</span><span class="st"> </span><span class="dv">1</span> </a>
<a class="sourceLine" id="cb102-47" data-line-number="47">                            <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(mvInPrtnr), <span class="dv">1</span>, <span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-48" data-line-number="48"><span class="st">      </span><span class="kw">select</span>(<span class="op">-</span>married, <span class="op">-</span>mvInPrtnr)</a>
<a class="sourceLine" id="cb102-49" data-line-number="49">  )</a>
<a class="sourceLine" id="cb102-50" data-line-number="50"></a>
<a class="sourceLine" id="cb102-51" data-line-number="51">midus_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;MIDUS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb102-52" data-line-number="52"></a>
<a class="sourceLine" id="cb102-53" data-line-number="53">midus_out &lt;-<span class="st"> </span>midus_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-54" data-line-number="54"><span class="st">  </span><span class="co"># filter(year &lt;= max(gsoep_waves$Used)) %&gt;%</span></a>
<a class="sourceLine" id="cb102-55" data-line-number="55"><span class="st">  </span><span class="kw">group_by</span>(SID, name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-56" data-line-number="56"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb102-57" data-line-number="57"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-58" data-line-number="58"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(value)<span class="op">|</span><span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb102-59" data-line-number="59"></a>
<a class="sourceLine" id="cb102-60" data-line-number="60"><span class="co"># composite across years</span></a>
<a class="sourceLine" id="cb102-61" data-line-number="61">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(p_year){</a>
<a class="sourceLine" id="cb102-62" data-line-number="62">  midus_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-63" data-line-number="63"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>p_year, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;past&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-64" data-line-number="64"><span class="st">    </span><span class="kw">group_by</span>(SID, name, group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-65" data-line-number="65"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-66" data-line-number="66"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-67" data-line-number="67"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-68" data-line-number="68"><span class="st">    </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> group, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-69" data-line-number="69"><span class="st">    </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-70" data-line-number="70"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(past) <span class="op">|</span><span class="st"> </span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(future)), future,</a>
<a class="sourceLine" id="cb102-71" data-line-number="71">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(future), past, </a>
<a class="sourceLine" id="cb102-72" data-line-number="72">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)))) </a>
<a class="sourceLine" id="cb102-73" data-line-number="73">}</a>
<a class="sourceLine" id="cb102-74" data-line-number="74"></a>
<a class="sourceLine" id="cb102-75" data-line-number="75">midus_out &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">p_year =</span> midus_waves<span class="op">$</span>Used) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-76" data-line-number="76"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-77" data-line-number="77"><span class="st">  </span><span class="kw">unnest</span>(data) </a></code></pre></div>
<pre><code>## # A tibble: 202,405 x 4
##    p_year   SID name         value
##     &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;
##  1   1994 10001 chldbrth        NA
##  2   1994 10001 crim             0
##  3   1994 10001 divorced        NA
##  4   1994 10001 edu             NA
##  5   1994 10001 frstjob         NA
##  6   1994 10001 married         NA
##  7   1994 10001 mntlhlthevnt    NA
##  8   1994 10001 mortality        0
##  9   1994 10001 mvInPrtnr        0
## 10   1994 10001 physhlthevnt     1
## # … with 202,395 more rows</code></pre>
</div>
<div id="covariates-6" class="section level3">
<h3><span class="header-section-number">2.8.5</span> Covariates</h3>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb104-1" data-line-number="1">midus_match &lt;-<span class="st"> </span>midus_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-2" data-line-number="2"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-3" data-line-number="3"><span class="st">  </span><span class="kw">full_join</span>(midus_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">year =</span> p_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-4" data-line-number="4"><span class="st">  </span><span class="co"># physical health event</span></a>
<a class="sourceLine" id="cb104-5" data-line-number="5"><span class="st">  </span><span class="kw">left_join</span>(midus_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;physhlthevnt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">year =</span> p_year, SID, <span class="dt">physhlthevnt =</span> past) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">physhlthevnt =</span> <span class="kw">max</span>(physhlthevnt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-6" data-line-number="6"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-7" data-line-number="7"><span class="st">  </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb104-8" data-line-number="8"></a>
<a class="sourceLine" id="cb104-9" data-line-number="9">midus_out &lt;-<span class="st"> </span>midus_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-10" data-line-number="10"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>past, <span class="op">-</span>future) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-11" data-line-number="11"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb104-12" data-line-number="12"></a>
<a class="sourceLine" id="cb104-13" data-line-number="13">midus_SCA &lt;-<span class="st"> </span>midus_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-14" data-line-number="14"><span class="st">  </span><span class="kw">select</span>(SID, <span class="dt">p_year =</span> year, <span class="kw">one_of</span>(<span class="kw">c</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name), <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;dadEdu&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-15" data-line-number="15"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-16" data-line-number="16"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb104-17" data-line-number="17">         <span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-18" data-line-number="18"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(parEdu, parOccPrstg), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb104-19" data-line-number="19"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb104-20" data-line-number="20"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu, <span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg)</a>
<a class="sourceLine" id="cb104-21" data-line-number="21"></a>
<a class="sourceLine" id="cb104-22" data-line-number="22"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(midus_match)]</a></code></pre></div>
<pre><code>## # A tibble: 15,184 x 20
##      SID p_year   age education gender grsWages  race physhlthevnt SRhealth smokes alcohol
##    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
##  1 10001   1994    53         1      0   300000     0            0      7        1       1
##  2 10001   2004    53         1      0   300000     0            1      7        1       1
##  3 10002   1994    60         2      0       NA    NA            0     NA       NA       1
##  4 10002   2004    60         2      0   235500    NA            1      8       NA       1
##  5 10004   1994    69         2      0    54000     0            0      7        1       0
##  6 10005   1994    70         0      1    27500     0            1      9        0       0
##  7 10005   2004    70         0      1    13750     0            1      8.5      0       0
##  8 10006   1994    51         1      1    34000     0            1      8        0       0
##  9 10006   2004    51         1      1    34000     0            1      8        1       0
## 10 10007   1994    35         0      1    46500     1            0      7        1       0
## # … with 15,174 more rows, and 9 more variables: exercise &lt;dbl&gt;, BMI &lt;dbl&gt;, married &lt;dbl&gt;,
## #   numKids &lt;dbl&gt;, parDivorce &lt;dbl&gt;, PhysFunc &lt;fct&gt;, religion &lt;dbl&gt;, parEdu &lt;dbl&gt;,
## #   parOccPrstg &lt;dbl&gt;</code></pre>
</div>
<div id="imputation-6" class="section level3">
<h3><span class="header-section-number">2.8.6</span> Imputation</h3>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb106-1" data-line-number="1"><span class="co"># short helper functions to (1) identify and create factors, save col names of factors, remove columns with all missing values, and setup amelia</span></a>
<a class="sourceLine" id="cb106-2" data-line-number="2">factor_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){<span class="cf">if</span>(<span class="kw">is.numeric</span>(x)){<span class="kw">diff</span>(<span class="kw">range</span>(x, <span class="dt">na.rm =</span> T)) <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(x)) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">4</span>} <span class="cf">else</span>{F}}</a>
<a class="sourceLine" id="cb106-3" data-line-number="3">not_all_id &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="cf">if</span>(<span class="kw">is.numeric</span>(x)) <span class="kw">sd</span>(x, <span class="dt">na.rm =</span> T) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb106-4" data-line-number="4">mice_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb106-5" data-line-number="5">  <span class="kw">mice</span>(df, <span class="dt">m =</span> <span class="dv">5</span>, <span class="dt">maxit=</span><span class="dv">5</span>, <span class="dt">printFlag=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb106-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb106-7" data-line-number="7">midus_match_imp &lt;-<span class="st"> </span>midus_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-8" data-line-number="8"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">NegAff =</span> <span class="st">`</span><span class="dt">NA</span><span class="st">`</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-9" data-line-number="9"><span class="st">  </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-12" data-line-number="12"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate_all</span>(<span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-14" data-line-number="14"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(year) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-15" data-line-number="15"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-16" data-line-number="16"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-17" data-line-number="17"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-18" data-line-number="18"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_na) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_id)),</a>
<a class="sourceLine" id="cb106-19" data-line-number="19">         <span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(factor_fun, as.factor)),</a>
<a class="sourceLine" id="cb106-20" data-line-number="20">         <span class="dt">imp =</span> <span class="kw">map</span>(data, mice_fun))</a>
<a class="sourceLine" id="cb106-21" data-line-number="21">beepr<span class="op">::</span><span class="kw">beep</span>(<span class="dt">sound =</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb106-22" data-line-number="22"></a>
<a class="sourceLine" id="cb106-23" data-line-number="23">midus_match_imp &lt;-<span class="st"> </span>midus_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp, <span class="op">~</span>mice<span class="op">::</span><span class="kw">complete</span>(., <span class="st">&quot;long&quot;</span>)),</a>
<a class="sourceLine" id="cb106-25" data-line-number="25">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">PhysFunc =</span> <span class="kw">factor</span>(<span class="kw">ifelse</span>(PhysFunc <span class="op">&lt;</span><span class="st"> </span><span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">0</span>)))),</a>
<a class="sourceLine" id="cb106-26" data-line-number="26">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb106-27" data-line-number="27"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-28" data-line-number="28"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-29" data-line-number="29"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-30" data-line-number="30"><span class="st">    </span><span class="kw">ungroup</span>()),</a>
<a class="sourceLine" id="cb106-31" data-line-number="31">         <span class="dt">imp_sca =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(.imp <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID,  <span class="kw">one_of</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name)))))</a>
<a class="sourceLine" id="cb106-32" data-line-number="32"></a>
<a class="sourceLine" id="cb106-33" data-line-number="33">midus_match_imp_long &lt;-<span class="st"> </span>midus_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-34" data-line-number="34"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-35" data-line-number="35"><span class="st">  </span><span class="kw">unnest</span>(imp_df)</a>
<a class="sourceLine" id="cb106-36" data-line-number="36"></a>
<a class="sourceLine" id="cb106-37" data-line-number="37">midus_SCA_imp &lt;-<span class="st"> </span>midus_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-38" data-line-number="38"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-39" data-line-number="39"><span class="st">  </span><span class="kw">unnest</span>(imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb106-40" data-line-number="40"><span class="st">  </span><span class="kw">left_join</span>(midus_SCA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(p_year, SID,</a>
<a class="sourceLine" id="cb106-41" data-line-number="41">        <span class="kw">colnames</span>(midus_SCA)[<span class="op">!</span><span class="kw">colnames</span>(midus_SCA) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(.)]))</a>
<a class="sourceLine" id="cb106-42" data-line-number="42"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(midus_SCA_imp)]</a></code></pre></div>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb107-1" data-line-number="1"><span class="kw">save</span>(midus_match_imp_long, midus_SCA_imp, </a>
<a class="sourceLine" id="cb107-2" data-line-number="2">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/midus_imputed_small.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb107-3" data-line-number="3"><span class="kw">save</span>(midus_match_imp, </a>
<a class="sourceLine" id="cb107-4" data-line-number="4">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/midus_imputed.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb107-5" data-line-number="5"><span class="kw">save</span>(midus_alpha, midus_pers, midus_out, midus_match, midus_SCA,</a>
<a class="sourceLine" id="cb107-6" data-line-number="6">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/midus_cleaned.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb107-7" data-line-number="7"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;midus&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb108-1" data-line-number="1"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;midus&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
</div>
</div>
<div id="nlsy" class="section level2">
<h2><span class="header-section-number">2.9</span> NLSY</h2>
<p>The Children to Young Adults Study (CNLSY; Bureau of Labor Statistics, 2017) is an offshoot study of the National Longitudinal Study of Youth (NLSY79), which is an ongoing longitudinal, nationally representative study in the United States. These data are available on the National Bureau of Labour Statistics website dedicated to the NLSY studies by creating a free account (<a href="https://www.nlsinfo.org/investigator/pages/login" class="uri">https://www.nlsinfo.org/investigator/pages/login</a>).</p>
<p>Participants included more than 12,500 individuals in the United States that began in 1979. The CNLSY includes the biological children of the NLSY79 participants and began in 1986. Children (10 years and older) completed separate inventories from children (or “young adults”) aged 15 and above. Mothers of children 10 and below also completed surveys on the children prior to age 10. All participants were interviewed in addition to surveys.</p>
<p>Sample sizes vary by year, ranging from approximately 1,331 (1979) to 11,530 (2016). This provides 99/% power to detect a zero-order correlation effect size of ~.05.</p>
<div id="load-data-8" class="section level3">
<h3><span class="header-section-number">2.9.1</span> Load Data</h3>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb109-1" data-line-number="1">(cnlsy_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;CNLSY&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]])</a></code></pre></div>
<pre><code>## # A tibble: 5,339 x 21
##    study dataset category name  itemname year  new_itemname orig_itemname QNAME description
##    &lt;chr&gt; &lt;lgl&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;        &lt;chr&gt;         &lt;chr&gt; &lt;chr&gt;      
##  1 nlsy  NA      match    acti… Activit… 2002  nlsy__match… Y1263100      Q4-3… DOES R BEL…
##  2 nlsy  NA      match    acti… Activit… 2004  nlsy__match… Y1496800      Q4-3… DOES R BEL…
##  3 nlsy  NA      match    acti… Activit… 2006  nlsy__match… Y1746700      Q4-3… DOES R BEL…
##  4 nlsy  NA      match    acti… Activit… 2008  nlsy__match… Y2027500      Q4-3… DOES R BEL…
##  5 nlsy  NA      match    acti… Activit… 2010  nlsy__match… Y2352600      Q4-3… DOES R BEL…
##  6 nlsy  NA      match    acti… Activit… 2012  nlsy__match… Y2682100      Q4-3… DOES R BEL…
##  7 nlsy  NA      match    acti… Activit… 2014  nlsy__match… Y3037500      Q4-3… DOES R BEL…
##  8 nlsy  NA      match    acti… Outside… 2002  nlsy__match… Y1263200      Q4-3… DOES R BEL…
##  9 nlsy  NA      match    acti… Outside… 2004  nlsy__match… Y1496900      Q4-3… DOES R BEL…
## 10 nlsy  NA      match    acti… Outside… 2006  nlsy__match… Y1746800      Q4-3… DOES R BEL…
## # … with 5,329 more rows, and 11 more variables: scale &lt;chr&gt;, reverse_code &lt;chr&gt;,
## #   recode &lt;chr&gt;, mini &lt;dbl&gt;, maxi &lt;dbl&gt;, comp_rule &lt;chr&gt;, item_rule &lt;chr&gt;, Include &lt;lgl&gt;,
## #   ...19 &lt;lgl&gt;, ...20 &lt;lgl&gt;, ...21 &lt;lgl&gt;</code></pre>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb111-1" data-line-number="1">(nlsy_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;NLSY&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]])</a></code></pre></div>
<pre><code>## # A tibble: 88 x 18
##    study dataset category name  itemname year  new_itemname orig_itemname QNAME description
##    &lt;chr&gt; &lt;lgl&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;        &lt;chr&gt;         &lt;chr&gt; &lt;chr&gt;      
##  1 nlsy  NA      match    momO… momOcc   1982  &lt;NA&gt;         R0828000      CPSO… OCCUPATION…
##  2 nlsy  NA      match    momO… momOcc   1983  &lt;NA&gt;         R0945300      CPSO… OCCUPATION…
##  3 nlsy  NA      match    momO… momOcc   1984  &lt;NA&gt;         R1255700      CPSO… OCCUPATION…
##  4 nlsy  NA      match    momO… momOcc   1985  &lt;NA&gt;         R1650500      CPSO… OCCUPATION…
##  5 nlsy  NA      match    momO… momOcc   1986  &lt;NA&gt;         R1923100      CPSO… OCCUPATION…
##  6 nlsy  NA      match    momO… momOcc   1987  &lt;NA&gt;         R2317900      CPSO… OCCUPATION…
##  7 nlsy  NA      match    momO… momOcc   1988  &lt;NA&gt;         R2525700      CPSO… OCCUPATION…
##  8 nlsy  NA      match    momO… momOcc   1989  &lt;NA&gt;         R2924700      CPSO… OCCUPATION…
##  9 nlsy  NA      match    momO… momOcc   1990  &lt;NA&gt;         R3127400      CPSO… OCCUPATION…
## 10 nlsy  NA      match    momO… momOcc   1991  &lt;NA&gt;         R3523100      CPSO… OCCUPATION…
## # … with 78 more rows, and 8 more variables: scale &lt;chr&gt;, reverse_code &lt;chr&gt;, recode &lt;chr&gt;,
## #   mini &lt;lgl&gt;, maxi &lt;lgl&gt;, comp_rule &lt;chr&gt;, item_rule &lt;chr&gt;, Include &lt;lgl&gt;</code></pre>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb113-1" data-line-number="1"><span class="co"># CNLSY codebook</span></a>
<a class="sourceLine" id="cb113-2" data-line-number="2">cnlsy_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(QNAME, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb113-3" data-line-number="3"><span class="st">  </span><span class="kw">write_delim</span>(<span class="dt">path =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/codebooks/meta.CHILDYA&quot;</span>, wd), <span class="dt">delim =</span> <span class="st">&quot;,&quot;</span>, <span class="dt">col_names =</span> F)</a>
<a class="sourceLine" id="cb113-4" data-line-number="4"></a>
<a class="sourceLine" id="cb113-5" data-line-number="5"><span class="co"># NLSY codebook</span></a>
<a class="sourceLine" id="cb113-6" data-line-number="6">nlsy_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(orig_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb113-7" data-line-number="7"><span class="st">  </span><span class="kw">write_delim</span>(<span class="dt">path =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/codebooks/meta.NLSY79&quot;</span>, wd), <span class="dt">delim =</span> <span class="st">&quot;,&quot;</span>, <span class="dt">col_names =</span> F)</a>
<a class="sourceLine" id="cb113-8" data-line-number="8"></a>
<a class="sourceLine" id="cb113-9" data-line-number="9">cnlsy_codebook &lt;-<span class="st"> </span>cnlsy_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">full_join</span>(nlsy_codebook)</a>
<a class="sourceLine" id="cb113-10" data-line-number="10"></a>
<a class="sourceLine" id="cb113-11" data-line-number="11">nlsy &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/nlsy/cnlsy.csv&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span>read_csv</a>
<a class="sourceLine" id="cb113-12" data-line-number="12">mnlsy &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/nlsy/nlsy79.csv&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span>read_csv</a>
<a class="sourceLine" id="cb113-13" data-line-number="13">nlsy &lt;-<span class="st"> </span>nlsy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(mnlsy <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">C0000200 =</span> R0000100))</a>
<a class="sourceLine" id="cb113-14" data-line-number="14"><span class="kw">rm</span>(mnlsy)</a></code></pre></div>
</div>
<div id="matching-variables-7" class="section level3">
<h3><span class="header-section-number">2.9.2</span> Matching Variables</h3>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb114-1" data-line-number="1">rename_fun &lt;-<span class="st"> </span><span class="cf">function</span>(cb, var){</a>
<a class="sourceLine" id="cb114-2" data-line-number="2">  old.names &lt;-<span class="st"> </span><span class="kw">unique</span>((cnlsy_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> </span>var))<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb114-3" data-line-number="3">  df &lt;-<span class="st"> </span>nlsy <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb114-4" data-line-number="4"><span class="st">    </span><span class="kw">select</span>(<span class="dt">SID =</span> C0000100, <span class="dt">yearBrth =</span> C0005700, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-5" data-line-number="5"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>yearBrth,</a>
<a class="sourceLine" id="cb114-6" data-line-number="6">           <span class="op">-</span>SID, <span class="dt">na.rm=</span>T)</a>
<a class="sourceLine" id="cb114-7" data-line-number="7">  <span class="cf">if</span>(<span class="kw">length</span>(old.names) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>){</a>
<a class="sourceLine" id="cb114-8" data-line-number="8">      df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(itemname, year, orig_itemname, reverse_code<span class="op">:</span>item_rule))</a>
<a class="sourceLine" id="cb114-9" data-line-number="9">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb114-10" data-line-number="10">    df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>(itemname<span class="op">:</span>year),  <span class="op">-</span>new_itemname, <span class="op">-</span>dataset) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="st">&quot;0&quot;</span>)</a>
<a class="sourceLine" id="cb114-11" data-line-number="11">  }</a>
<a class="sourceLine" id="cb114-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb114-13" data-line-number="13"></a>
<a class="sourceLine" id="cb114-14" data-line-number="14"><span class="co"># rename variables   </span></a>
<a class="sourceLine" id="cb114-15" data-line-number="15">nlsy_match &lt;-<span class="st"> </span>cnlsy_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-16" data-line-number="16"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">!=</span><span class="st"> &quot;XRND&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-17" data-line-number="17"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb114-18" data-line-number="18"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-19" data-line-number="19"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-20" data-line-number="20"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-22" data-line-number="22"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-23" data-line-number="23"><span class="st">  </span><span class="kw">distinct</span>() </a>
<a class="sourceLine" id="cb114-24" data-line-number="24"></a>
<a class="sourceLine" id="cb114-25" data-line-number="25"><span class="co"># single time point variables </span></a>
<a class="sourceLine" id="cb114-26" data-line-number="26">old.names &lt;-<span class="st"> </span>(cnlsy_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">==</span><span class="st"> &quot;XRND&quot;</span>))<span class="op">$</span>orig_itemname </a>
<a class="sourceLine" id="cb114-27" data-line-number="27">nlsy_match_stp &lt;-<span class="st"> </span>nlsy <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-28" data-line-number="28"><span class="st">  </span><span class="kw">select</span>(<span class="dt">SID =</span> C0000100, <span class="dt">yearBrth =</span> C0005700, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-29" data-line-number="29"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>SID, <span class="op">-</span>yearBrth, <span class="dt">na.rm=</span>T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-30" data-line-number="30"><span class="st">  </span><span class="kw">left_join</span>(cnlsy_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(name<span class="op">:</span>year, orig_itemname, recode, comp_rule, item_rule))</a>
<a class="sourceLine" id="cb114-31" data-line-number="31"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb114-32" data-line-number="32"></a>
<a class="sourceLine" id="cb114-33" data-line-number="33">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year){</a>
<a class="sourceLine" id="cb114-34" data-line-number="34">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb114-35" data-line-number="35">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb114-36" data-line-number="36">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb114-37" data-line-number="37">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb114-38" data-line-number="38">}</a>
<a class="sourceLine" id="cb114-39" data-line-number="39"></a>
<a class="sourceLine" id="cb114-40" data-line-number="40">nlsy_match &lt;-<span class="st"> </span>nlsy_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-41" data-line-number="41"><span class="st">  </span><span class="kw">group_by</span>(recode, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-42" data-line-number="42"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-43" data-line-number="43"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-44" data-line-number="44"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-45" data-line-number="45"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb114-46" data-line-number="46"></a>
<a class="sourceLine" id="cb114-47" data-line-number="47">nlsy_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;NLSY&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb114-48" data-line-number="48"></a>
<a class="sourceLine" id="cb114-49" data-line-number="49">nlsy_match_stp &lt;-<span class="st"> </span>nlsy_match_stp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-50" data-line-number="50"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> nlsy_waves<span class="op">$</span>Used, <span class="dt">year =</span> <span class="st">&quot;XRND&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-51" data-line-number="51"><span class="st">  </span><span class="kw">group_by</span>(recode, p_year, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-52" data-line-number="52"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb114-53" data-line-number="53"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-54" data-line-number="54"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-55" data-line-number="55"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb114-56" data-line-number="56"></a>
<a class="sourceLine" id="cb114-57" data-line-number="57"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb114-58" data-line-number="58">nlsy_match &lt;-<span class="st"> </span>nlsy_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-59" data-line-number="59"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, </a>
<a class="sourceLine" id="cb114-60" data-line-number="60">                        <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb114-61" data-line-number="61"></a>
<a class="sourceLine" id="cb114-62" data-line-number="62">occ_recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(year, df){</a>
<a class="sourceLine" id="cb114-63" data-line-number="63">  <span class="cf">if</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2000</span>){df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">mapvalues</span>(value, npb<span class="op">$</span>OCC00, npb<span class="op">$</span>NPB))}</a>
<a class="sourceLine" id="cb114-64" data-line-number="64">  <span class="cf">else</span> <span class="cf">if</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">1990</span>){</a>
<a class="sourceLine" id="cb114-65" data-line-number="65">    df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">mapvalues</span>(value, occ90to00<span class="op">$</span>OCC90, occ90to00<span class="op">$</span>OCC00), </a>
<a class="sourceLine" id="cb114-66" data-line-number="66">                  <span class="dt">value =</span> <span class="kw">mapvalues</span>(value, npb<span class="op">$</span>OCC00, npb<span class="op">$</span>NPB),</a>
<a class="sourceLine" id="cb114-67" data-line-number="67">                  <span class="dt">value =</span> <span class="kw">ifelse</span>(value <span class="op">&gt;</span><span class="st"> </span><span class="dv">100</span>, <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb114-68" data-line-number="68">  } <span class="cf">else</span>{</a>
<a class="sourceLine" id="cb114-69" data-line-number="69">    df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">mapvalues</span>(value, occ70to90<span class="op">$</span>OCC70, occ70to90<span class="op">$</span>OCC90),</a>
<a class="sourceLine" id="cb114-70" data-line-number="70">                  <span class="dt">value =</span> <span class="kw">mapvalues</span>(value, occ90to00<span class="op">$</span>OCC90, occ90to00<span class="op">$</span>OCC00), </a>
<a class="sourceLine" id="cb114-71" data-line-number="71">                  <span class="dt">value =</span> <span class="kw">mapvalues</span>(value, npb<span class="op">$</span>OCC00, npb<span class="op">$</span>NPB),</a>
<a class="sourceLine" id="cb114-72" data-line-number="72">                  <span class="dt">value =</span> <span class="kw">ifelse</span>(value <span class="op">&gt;</span><span class="st"> </span><span class="dv">100</span>, <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb114-73" data-line-number="73">  }</a>
<a class="sourceLine" id="cb114-74" data-line-number="74">}</a>
<a class="sourceLine" id="cb114-75" data-line-number="75"></a>
<a class="sourceLine" id="cb114-76" data-line-number="76">nlsy_match_occ &lt;-<span class="st"> </span>nlsy_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-77" data-line-number="77"><span class="st">  </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;Occ&quot;</span>, name)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-78" data-line-number="78"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value) <span class="op">&amp;</span><span class="st"> </span>year <span class="op">&gt;=</span><span class="st"> </span><span class="dv">1984</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb114-79" data-line-number="79"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&lt;</span><span class="st"> </span><span class="dv">2000</span>, <span class="dv">1970</span>, <span class="kw">ifelse</span>(year <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2002</span>, <span class="dv">2000</span>, <span class="dv">1990</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-80" data-line-number="80"><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-81" data-line-number="81"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-82" data-line-number="82"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-83" data-line-number="83"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(group, data, occ_recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-84" data-line-number="84"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-85" data-line-number="85"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="kw">paste</span>(name, <span class="st">&quot;Prstg&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-86" data-line-number="86"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>group)</a>
<a class="sourceLine" id="cb114-87" data-line-number="87"></a>
<a class="sourceLine" id="cb114-88" data-line-number="88">fun_call &lt;-<span class="st"> </span><span class="cf">function</span>(x, rule){</a>
<a class="sourceLine" id="cb114-89" data-line-number="89">    <span class="cf">switch</span>(rule,</a>
<a class="sourceLine" id="cb114-90" data-line-number="90">           <span class="dt">average =</span> <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb114-91" data-line-number="91">           <span class="dt">mode =</span> <span class="kw">Mode</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb114-92" data-line-number="92">           <span class="dt">sum =</span> <span class="kw">sum</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb114-93" data-line-number="93">           <span class="dt">skip =</span> <span class="kw">unique</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb114-94" data-line-number="94">           <span class="dt">max =</span> <span class="kw">max</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb114-95" data-line-number="95">           <span class="dt">min =</span> <span class="kw">min</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb114-96" data-line-number="96">           <span class="dt">multiply =</span> <span class="kw">prod</span>(x, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb114-97" data-line-number="97">  }</a>
<a class="sourceLine" id="cb114-98" data-line-number="98"></a>
<a class="sourceLine" id="cb114-99" data-line-number="99"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb114-100" data-line-number="100">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb114-101" data-line-number="101">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-102" data-line-number="102"><span class="st">    </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb114-103" data-line-number="103"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb114-104" data-line-number="104"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-105" data-line-number="105"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb114-106" data-line-number="106"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb114-107" data-line-number="107">}</a>
<a class="sourceLine" id="cb114-108" data-line-number="108"></a>
<a class="sourceLine" id="cb114-109" data-line-number="109">nlsy_match &lt;-<span class="st"> </span>nlsy_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-110" data-line-number="110"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="kw">max</span>(nlsy_waves<span class="op">$</span>Used) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">grepl</span>(<span class="st">&quot;Occ&quot;</span>, name)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-111" data-line-number="111"><span class="st">  </span><span class="kw">full_join</span>(nlsy_match_occ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-112" data-line-number="112"><span class="st">  </span><span class="kw">group_by</span>(comp_rule, item_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-113" data-line-number="113"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-114" data-line-number="114"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-115" data-line-number="115"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">item_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(item_rule), <span class="st">&quot;skip&quot;</span>, item_rule),</a>
<a class="sourceLine" id="cb114-116" data-line-number="116">         <span class="dt">data =</span> <span class="kw">map2</span>(data, item_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-117" data-line-number="117"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb114-118" data-line-number="118"></a>
<a class="sourceLine" id="cb114-119" data-line-number="119">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, p_year){</a>
<a class="sourceLine" id="cb114-120" data-line-number="120">  nlsy_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-121" data-line-number="121"><span class="st">    </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span>p_year  <span class="op">&amp;</span><span class="st"> </span>comp_rule <span class="op">==</span><span class="st"> </span>rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-122" data-line-number="122"><span class="st">    </span><span class="kw">full_join</span>(</a>
<a class="sourceLine" id="cb114-123" data-line-number="123">      nlsy_match_stp <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb114-124" data-line-number="124"><span class="st">        </span><span class="kw">select</span>(SID, yearBrth, p_year, name, value, comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-125" data-line-number="125"><span class="st">        </span><span class="kw">filter</span>(comp_rule <span class="op">==</span><span class="st"> </span>rule <span class="op">&amp;</span><span class="st"> </span>p_year <span class="op">==</span><span class="st"> </span>p_year)</a>
<a class="sourceLine" id="cb114-126" data-line-number="126">      ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-127" data-line-number="127"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-128" data-line-number="128"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-129" data-line-number="129"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb114-130" data-line-number="130">}</a>
<a class="sourceLine" id="cb114-131" data-line-number="131"></a>
<a class="sourceLine" id="cb114-132" data-line-number="132">nlsy_match &lt;-<span class="st"> </span><span class="kw">crossing</span>(</a>
<a class="sourceLine" id="cb114-133" data-line-number="133">  <span class="dt">p_year =</span> nlsy_waves<span class="op">$</span>Used, </a>
<a class="sourceLine" id="cb114-134" data-line-number="134">  <span class="dt">comp_rule =</span> <span class="kw">unique</span>(nlsy_match<span class="op">$</span>comp_rule)</a>
<a class="sourceLine" id="cb114-135" data-line-number="135">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-136" data-line-number="136"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;skip&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb114-137" data-line-number="137">         <span class="dt">data =</span> <span class="kw">map2</span>(comp_rule, p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-138" data-line-number="138"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-139" data-line-number="139"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-140" data-line-number="140"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb114-141" data-line-number="141"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> name, <span class="dt">values_from =</span> value, <span class="dt">values_fn =</span> <span class="kw">list</span>(<span class="dt">value =</span> max))</a></code></pre></div>
<pre><code>## # A tibble: 34,590 x 120
## # Groups:   SID [11,530]
##      SID dadEdu momEdu yearBrth  year     A     C    DEP     E    IQ   LOC     N     O    SE
##    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1   201     NA      1     1993  2000    NA  NA   NA      NA    17.6 NA     NA    NA    NA  
##  2   201     NA      1     1993  2006    NA  NA   NA      NA    NA   NA     NA    NA    NA  
##  3   201     NA      1     1993  2008    NA  NA   NA      NA    NA   NA     NA    NA    NA  
##  4   202     NA      1     1994  2000    NA  NA   NA      NA    16.3 NA     NA    NA    NA  
##  5   202     NA      1     1994  2006    NA  NA   NA      NA    NA   NA     NA    NA    NA  
##  6   202     NA      1     1994  2008    NA  NA   NA      NA    NA   NA     NA    NA    NA  
##  7   301     NA      1     1981  2008     2   3.5  0.571   2.5  NA    1.14   0.5   3.5   1.7
##  8   301     NA      1     1981  2000    NA  NA   NA      NA    NA   NA     NA    NA    NA  
##  9   301     NA      1     1981  2006    NA  NA   NA      NA    NA   NA     NA    NA    NA  
## 10   302     NA      1     1983  2000    NA  NA   NA      NA    NA   NA     NA    NA    NA  
## # … with 34,580 more rows, and 106 more variables: SS &lt;dbl&gt;, activity &lt;dbl&gt;,
## #   AgeBegDate &lt;dbl&gt;, batheSelf &lt;dbl&gt;, childhoodSS &lt;dbl&gt;, chores &lt;dbl&gt;, compliance &lt;dbl&gt;,
## #   difficulty &lt;dbl&gt;, discipline &lt;dbl&gt;, fearfulness &lt;dbl&gt;, foodChoice &lt;dbl&gt;, FreqSmk &lt;dbl&gt;,
## #   genRoles &lt;dbl&gt;, grsWages &lt;dbl&gt;, hsGrades &lt;dbl&gt;, Impls &lt;dbl&gt;, insecureAttach &lt;dbl&gt;,
## #   manageTIme &lt;dbl&gt;, nbhdQual &lt;dbl&gt;, parAffection &lt;dbl&gt;, parLimitations &lt;dbl&gt;,
## #   parTalkTV &lt;dbl&gt;, peerPressure &lt;dbl&gt;, positiveAffect &lt;dbl&gt;, praisedByPar &lt;dbl&gt;,
## #   reads &lt;dbl&gt;, relDad &lt;dbl&gt;, relMom &lt;dbl&gt;, RelProb &lt;dbl&gt;, relSat &lt;dbl&gt;, satJob &lt;dbl&gt;,
## #   satSchl &lt;dbl&gt;, SensSeek &lt;dbl&gt;, SRhealth &lt;dbl&gt;, timeHW &lt;dbl&gt;, timeWOthrs &lt;dbl&gt;,
## #   TVtime &lt;dbl&gt;, ADHD &lt;dbl&gt;, alcohol &lt;dbl&gt;, behProb &lt;dbl&gt;, BPI &lt;dbl&gt;, crprlPunish &lt;dbl&gt;,
## #   dadAlive &lt;dbl&gt;, dropOutSchl &lt;dbl&gt;, drugs &lt;dbl&gt;, dyslexia &lt;dbl&gt;, edu &lt;dbl&gt;,
## #   education &lt;dbl&gt;, employed &lt;dbl&gt;, familyProb &lt;dbl&gt;, height &lt;dbl&gt;, hlthcare &lt;dbl&gt;,
## #   hlthProbs &lt;dbl&gt;, Jail &lt;dbl&gt;, learnDis &lt;dbl&gt;, learningDis &lt;dbl&gt;, married &lt;dbl&gt;,
## #   momAge &lt;dbl&gt;, momAlcPreg &lt;dbl&gt;, momAlive &lt;dbl&gt;, momCocPreg &lt;dbl&gt;, momOccPrstg &lt;dbl&gt;,
## #   momRedAlcPreg &lt;dbl&gt;, momRedCalPreg &lt;dbl&gt;, momRedSaltPreg &lt;dbl&gt;, momRedSmkPreg &lt;dbl&gt;,
## #   momSmkPreg &lt;dbl&gt;, momVitPreg &lt;dbl&gt;, momWeedPreg &lt;dbl&gt;, musicInst &lt;dbl&gt;,
## #   nightmares &lt;dbl&gt;, numKids &lt;dbl&gt;, numSiblng &lt;dbl&gt;, parDivorce &lt;dbl&gt;, physAct &lt;dbl&gt;,
## #   probation &lt;dbl&gt;, race &lt;dbl&gt;, religion &lt;dbl&gt;, remedialClass &lt;dbl&gt;, seeDad &lt;dbl&gt;,
## #   shynessProb &lt;dbl&gt;, sleepProb &lt;dbl&gt;, smokes &lt;dbl&gt;, unempEen &lt;dbl&gt;, weight &lt;dbl&gt;,
## #   welfare &lt;dbl&gt;, dadOccPrstg &lt;dbl&gt;, HHsize &lt;dbl&gt;, liveDad &lt;dbl&gt;, ParEngmnt &lt;dbl&gt;,
## #   privateSchl &lt;dbl&gt;, urban &lt;dbl&gt;, readingMat &lt;dbl&gt;, tantrums &lt;dbl&gt;, ageMarried &lt;dbl&gt;,
## #   bornLate &lt;dbl&gt;, durBreastFed &lt;dbl&gt;, gender &lt;dbl&gt;, dscplnFreq &lt;dbl&gt;, eatingHabits &lt;dbl&gt;,
## #   …</code></pre>
</div>
<div id="personality-variables-7" class="section level3">
<h3><span class="header-section-number">2.9.3</span> Personality Variables</h3>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb116-1" data-line-number="1">nlsy_pers &lt;-<span class="st"> </span>cnlsy_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;pers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb116-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-8" data-line-number="8"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-9" data-line-number="9"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-10" data-line-number="10"><span class="st">  </span><span class="kw">left_join</span>(p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;NLSY&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">name =</span> p_item, Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span>Used) </a>
<a class="sourceLine" id="cb116-12" data-line-number="12"></a>
<a class="sourceLine" id="cb116-13" data-line-number="13">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb116-14" data-line-number="14">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb116-15" data-line-number="15">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb116-16" data-line-number="16">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb116-17" data-line-number="17">}</a>
<a class="sourceLine" id="cb116-18" data-line-number="18"></a>
<a class="sourceLine" id="cb116-19" data-line-number="19"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb116-20" data-line-number="20">nlsy_pers &lt;-<span class="st"> </span>nlsy_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-21" data-line-number="21"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>orig_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-22" data-line-number="22"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-23" data-line-number="23"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-24" data-line-number="24"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-25" data-line-number="25"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-26" data-line-number="26"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb116-27" data-line-number="27"></a>
<a class="sourceLine" id="cb116-28" data-line-number="28"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb116-29" data-line-number="29">nlsy_pers &lt;-<span class="st"> </span>nlsy_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-30" data-line-number="30"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">tolower</span>(reverse_code) <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), </a>
<a class="sourceLine" id="cb116-31" data-line-number="31">                        value, <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb116-32" data-line-number="32"></a>
<a class="sourceLine" id="cb116-33" data-line-number="33"><span class="co"># alpha&#39;s</span></a>
<a class="sourceLine" id="cb116-34" data-line-number="34">nlsy_alpha &lt;-<span class="st"> </span>nlsy_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-35" data-line-number="35"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, SID, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-36" data-line-number="36"><span class="st">  </span><span class="kw">group_by</span>(name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-37" data-line-number="37"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-38" data-line-number="38"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> itemname, <span class="dt">values_from =</span> value)),</a>
<a class="sourceLine" id="cb116-39" data-line-number="39">         <span class="dt">alpha =</span> <span class="kw">map</span>(data, <span class="kw">possibly</span>(<span class="op">~</span>psych<span class="op">::</span><span class="kw">alpha</span>((.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>SID)), <span class="ot">NA_real_</span>)))</a>
<a class="sourceLine" id="cb116-40" data-line-number="40"></a>
<a class="sourceLine" id="cb116-41" data-line-number="41"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb116-42" data-line-number="42">nlsy_pers &lt;-<span class="st"> </span>nlsy_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-43" data-line-number="43"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-44" data-line-number="44"><span class="st">  </span><span class="kw">group_by</span>(SID, yearBrth, name, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb116-45" data-line-number="45"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T)) </a></code></pre></div>
<pre><code>## # A tibble: 77,697 x 5
## # Groups:   SID, yearBrth, name [63,435]
##      SID yearBrth name  year   value
##    &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt;
##  1   201     1993 IQ    2000  17.6  
##  2   202     1994 IQ    2000  16.3  
##  3   301     1981 A     2008   2    
##  4   301     1981 C     2008   3.5  
##  5   301     1981 DEP   2008   0.571
##  6   301     1981 E     2008   2.5  
##  7   301     1981 LOC   2008   1.14 
##  8   301     1981 N     2008   0.5  
##  9   301     1981 O     2008   3.5  
## 10   301     1981 SE    2008   1.7  
## # … with 77,687 more rows</code></pre>
</div>
<div id="outcome-variables-8" class="section level3">
<h3><span class="header-section-number">2.9.4</span> Outcome Variables</h3>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb118-1" data-line-number="1">nlsy_out &lt;-<span class="st"> </span>cnlsy_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">!=</span><span class="st"> &quot;XRND&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb118-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-8" data-line-number="8"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-9" data-line-number="9"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-10" data-line-number="10"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> nlsy_waves<span class="op">$</span>Used, <span class="dt">name =</span> <span class="kw">unique</span>((.)<span class="op">$</span>name)))</a>
<a class="sourceLine" id="cb118-11" data-line-number="11"></a>
<a class="sourceLine" id="cb118-12" data-line-number="12">old.names &lt;-<span class="st"> </span>(cnlsy_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">==</span><span class="st"> &quot;XRND&quot;</span>))<span class="op">$</span>orig_itemname </a>
<a class="sourceLine" id="cb118-13" data-line-number="13">nlsy_out_stp &lt;-<span class="st"> </span>nlsy <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-14" data-line-number="14"><span class="st">  </span><span class="kw">select</span>(<span class="dt">SID =</span> C0000100, <span class="dt">yearBrth =</span> C0005700, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-15" data-line-number="15"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>SID, <span class="op">-</span>yearBrth, <span class="dt">na.rm=</span>T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-16" data-line-number="16"><span class="st">  </span><span class="kw">left_join</span>(cnlsy_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb118-17" data-line-number="17"><span class="st">              </span><span class="kw">select</span>(name<span class="op">:</span>year, orig_itemname, recode, comp_rule, item_rule))</a>
<a class="sourceLine" id="cb118-18" data-line-number="18"></a>
<a class="sourceLine" id="cb118-19" data-line-number="19"><span class="co"># recode</span></a>
<a class="sourceLine" id="cb118-20" data-line-number="20">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year){</a>
<a class="sourceLine" id="cb118-21" data-line-number="21">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb118-22" data-line-number="22">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb118-23" data-line-number="23">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb118-24" data-line-number="24">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb118-25" data-line-number="25">}</a>
<a class="sourceLine" id="cb118-26" data-line-number="26"></a>
<a class="sourceLine" id="cb118-27" data-line-number="27"><span class="co"># coding unemployment</span></a>
<a class="sourceLine" id="cb118-28" data-line-number="28">jobs &lt;-<span class="st"> </span>nlsy_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-29" data-line-number="29"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;unemployed&quot;</span> <span class="op">&amp;</span><span class="st"> </span>(<span class="kw">grepl</span>(<span class="st">&quot;start&quot;</span>, itemname) <span class="op">|</span><span class="st"> </span><span class="kw">grepl</span>(<span class="st">&quot;end&quot;</span>, itemname))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-30" data-line-number="30"><span class="st">  </span><span class="kw">select</span>(name, SID, value, itemname, year, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-31" data-line-number="31"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(value) <span class="op">|</span><span class="st"> </span>value <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="ot">NA</span>, value),</a>
<a class="sourceLine" id="cb118-32" data-line-number="32">         <span class="dt">timing =</span> <span class="kw">ifelse</span>(<span class="kw">grepl</span>(<span class="st">&quot;start&quot;</span>, itemname), <span class="st">&quot;start&quot;</span>, <span class="st">&quot;end&quot;</span>),</a>
<a class="sourceLine" id="cb118-33" data-line-number="33">         <span class="dt">itemname =</span> <span class="kw">str_remove</span>(itemname, <span class="st">&quot;start&quot;</span>), <span class="dt">itemname =</span> <span class="kw">str_remove</span>(itemname, <span class="st">&quot;end&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-34" data-line-number="34"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-35" data-line-number="35"><span class="st">  </span><span class="kw">separate</span>(itemname, <span class="kw">c</span>(<span class="st">&quot;time&quot;</span>, <span class="st">&quot;job&quot;</span>), <span class="dv">-1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-36" data-line-number="36"><span class="st">  </span><span class="kw">spread</span>(time, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-37" data-line-number="37"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">centMnth =</span> (Year <span class="op">-</span><span class="st"> </span><span class="dv">1950</span>)<span class="op">*</span><span class="dv">12</span> <span class="op">+</span><span class="st"> </span>Month) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-38" data-line-number="38"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>Year, <span class="op">-</span>Month) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-39" data-line-number="39"><span class="st">  </span><span class="kw">spread</span>(timing, centMnth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-40" data-line-number="40"><span class="st">  </span><span class="kw">group_by</span>(SID, year, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-41" data-line-number="41"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lead_end =</span> <span class="kw">lead</span>(end),</a>
<a class="sourceLine" id="cb118-42" data-line-number="42">         <span class="dt">gap =</span> start<span class="op">-</span>lead_end) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-43" data-line-number="43"><span class="st">  </span><span class="kw">group_by</span>(name, SID, year, p_year, job) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-44" data-line-number="44"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(gap <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-45" data-line-number="45"><span class="st">  </span><span class="kw">group_by</span>(name, SID, year, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-46" data-line-number="46"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb118-47" data-line-number="47"></a>
<a class="sourceLine" id="cb118-48" data-line-number="48">nlsy_out &lt;-<span class="st"> </span>nlsy_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-49" data-line-number="49"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>(name <span class="op">==</span><span class="st"> &quot;unemployed&quot;</span> <span class="op">&amp;</span><span class="st"> </span>(<span class="kw">grepl</span>(<span class="st">&quot;start&quot;</span>, itemname) <span class="op">|</span><span class="st"> </span><span class="kw">grepl</span>(<span class="st">&quot;end&quot;</span>, itemname)))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-50" data-line-number="50"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>orig_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-51" data-line-number="51"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-52" data-line-number="52"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-53" data-line-number="53"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-54" data-line-number="54"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-55" data-line-number="55"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-56" data-line-number="56"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb118-57" data-line-number="57"></a>
<a class="sourceLine" id="cb118-58" data-line-number="58">nlsy_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;NLSY&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb118-59" data-line-number="59"></a>
<a class="sourceLine" id="cb118-60" data-line-number="60">nlsy_out_stp &lt;-<span class="st"> </span>nlsy_out_stp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-61" data-line-number="61"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> nlsy_waves<span class="op">$</span>Used, <span class="dt">year =</span> <span class="st">&quot;XRND&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-62" data-line-number="62"><span class="st">  </span><span class="kw">group_by</span>(recode, p_year, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-63" data-line-number="63"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb118-64" data-line-number="64"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-65" data-line-number="65"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">recode =</span> <span class="kw">str_replace</span>(recode, <span class="st">&quot;if</span><span class="ch">\\</span><span class="st">(p_years&quot;</span>, <span class="st">&quot;ifelse</span><span class="ch">\\</span><span class="st">(p_year&quot;</span>),</a>
<a class="sourceLine" id="cb118-66" data-line-number="66">         <span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-67" data-line-number="67"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-68" data-line-number="68"><span class="st">  </span><span class="kw">select</span>(p_year, SID, name, value)</a>
<a class="sourceLine" id="cb118-69" data-line-number="69"></a>
<a class="sourceLine" id="cb118-70" data-line-number="70">nlsy_out_stp &lt;-<span class="st"> </span>nlsy_out_stp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-71" data-line-number="71"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;education&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-72" data-line-number="72"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">name =</span> <span class="st">&quot;edu&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-73" data-line-number="73"><span class="st">  </span><span class="kw">group_by</span>(name, p_year, SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-74" data-line-number="74"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T))<span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-75" data-line-number="75"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-76" data-line-number="76"><span class="st">  </span><span class="kw">full_join</span>(nlsy_out_stp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;education&quot;</span>))</a>
<a class="sourceLine" id="cb118-77" data-line-number="77"></a>
<a class="sourceLine" id="cb118-78" data-line-number="78"><span class="co"># composite within years</span></a>
<a class="sourceLine" id="cb118-79" data-line-number="79">nlsy_out &lt;-<span class="st"> </span>nlsy_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-80" data-line-number="80"><span class="st">  </span><span class="kw">select</span>(name<span class="op">:</span>year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-81" data-line-number="81"><span class="st">  </span><span class="co"># filter(year &lt;= max(gsoep_waves$Used)) %&gt;%</span></a>
<a class="sourceLine" id="cb118-82" data-line-number="82"><span class="st">  </span><span class="kw">group_by</span>(SID, name, year, yearBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-83" data-line-number="83"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb118-84" data-line-number="84"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-85" data-line-number="85"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(value)<span class="op">|</span><span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb118-86" data-line-number="86"></a>
<a class="sourceLine" id="cb118-87" data-line-number="87"><span class="co"># composite across years</span></a>
<a class="sourceLine" id="cb118-88" data-line-number="88">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(P_year){</a>
<a class="sourceLine" id="cb118-89" data-line-number="89">  nlsy_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-90" data-line-number="90"><span class="st">    </span><span class="kw">left_join</span>(jobs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(p_year <span class="op">==</span><span class="st"> </span>P_year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>p_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-91" data-line-number="91"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>P_year, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;past&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-92" data-line-number="92"><span class="st">    </span><span class="kw">group_by</span>(SID, name, group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-93" data-line-number="93"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-94" data-line-number="94"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-95" data-line-number="95"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-96" data-line-number="96"><span class="st">    </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> group, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-97" data-line-number="97"><span class="st">    </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-98" data-line-number="98"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(past) <span class="op">|</span><span class="st"> </span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(future)), future,</a>
<a class="sourceLine" id="cb118-99" data-line-number="99">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(future), past, </a>
<a class="sourceLine" id="cb118-100" data-line-number="100">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)))) </a>
<a class="sourceLine" id="cb118-101" data-line-number="101">}</a>
<a class="sourceLine" id="cb118-102" data-line-number="102"></a>
<a class="sourceLine" id="cb118-103" data-line-number="103">nlsy_out &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">p_year =</span> nlsy_waves<span class="op">$</span>Used) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-104" data-line-number="104"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-105" data-line-number="105"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb118-106" data-line-number="106"><span class="st">  </span><span class="kw">full_join</span>(nlsy_out_stp)</a></code></pre></div>
<pre><code>## # A tibble: 553,440 x 6
##    p_year   SID name         future  past value
##     &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1   2006   201 chldbrth         NA    NA    NA
##  2   2006   201 chldmvout        NA    NA    NA
##  3   2006   201 crim              0    NA     0
##  4   2006   201 divorced         NA    NA    NA
##  5   2006   201 frstjob          NA    NA    NA
##  6   2006   201 mntlhlthevnt     NA    NA    NA
##  7   2006   201 mortality         0     0     0
##  8   2006   201 physhlthevnt     NA    NA    NA
##  9   2006   201 separated        NA    NA    NA
## 10   2006   201 unemployed       NA    NA    NA
## # … with 553,430 more rows</code></pre>
</div>
<div id="covariates-7" class="section level3">
<h3><span class="header-section-number">2.9.5</span> Covariates</h3>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb120-1" data-line-number="1">nlsy_match &lt;-<span class="st"> </span>nlsy_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-2" data-line-number="2"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">as.numeric</span>(year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-4" data-line-number="4"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb120-5" data-line-number="5"><span class="st">  </span><span class="kw">full_join</span>(nlsy_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">year =</span> p_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-6" data-line-number="6"><span class="st">  </span><span class="co"># physical health event</span></a>
<a class="sourceLine" id="cb120-7" data-line-number="7"><span class="st">  </span><span class="kw">left_join</span>(nlsy_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;physhlthevnt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">year =</span> p_year, SID, <span class="dt">physhlthevnt =</span> past) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">physhlthevnt =</span> <span class="kw">max</span>(physhlthevnt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-8" data-line-number="8"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb120-9" data-line-number="9"></a>
<a class="sourceLine" id="cb120-10" data-line-number="10"><span class="co"># age</span></a>
<a class="sourceLine" id="cb120-11" data-line-number="11">nlsy_match &lt;-<span class="st"> </span>nlsy_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> year <span class="op">-</span><span class="st"> </span>yearBrth, </a>
<a class="sourceLine" id="cb120-13" data-line-number="13">         <span class="dt">BMI =</span> weight<span class="op">/</span><span class="st"> </span>(height<span class="op">/</span><span class="dv">100</span>)<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb120-14" data-line-number="14"></a>
<a class="sourceLine" id="cb120-15" data-line-number="15">nlsy_match &lt;-<span class="st"> </span>nlsy_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-16" data-line-number="16"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-17" data-line-number="17"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(education, numKids, married, smokes, alcohol), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(.) <span class="op">&amp;</span><span class="st"> </span>age <span class="op">&lt;</span><span class="st"> </span><span class="dv">19</span>, <span class="dv">0</span>, .)) </a>
<a class="sourceLine" id="cb120-18" data-line-number="18"></a>
<a class="sourceLine" id="cb120-19" data-line-number="19">nlsy_match &lt;-<span class="st"> </span>nlsy_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-20" data-line-number="20"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-21" data-line-number="21"><span class="st">  </span><span class="kw">select</span>(SID, dadEdu, momEdu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-22" data-line-number="22"><span class="st">  </span><span class="kw">distinct</span>()  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-23" data-line-number="23"><span class="st">  </span><span class="kw">gather</span>(item,value, <span class="dt">na.rm =</span> T, <span class="op">-</span>SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-24" data-line-number="24"><span class="st">  </span><span class="kw">group_by</span>(SID, item) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-25" data-line-number="25"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-26" data-line-number="26"><span class="st">  </span><span class="kw">spread</span>(item,value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-27" data-line-number="27"><span class="st">  </span><span class="kw">full_join</span>(nlsy_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu))</a>
<a class="sourceLine" id="cb120-28" data-line-number="28"></a>
<a class="sourceLine" id="cb120-29" data-line-number="29">nlsy_out &lt;-<span class="st"> </span>nlsy_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-30" data-line-number="30"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>past, <span class="op">-</span>future) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-31" data-line-number="31"><span class="st">  </span><span class="kw">distinct</span>() </a>
<a class="sourceLine" id="cb120-32" data-line-number="32"></a>
<a class="sourceLine" id="cb120-33" data-line-number="33">nlsy_SCA &lt;-<span class="st"> </span>nlsy_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">PhysFunc =</span> physAct) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-34" data-line-number="34"><span class="st">  </span><span class="kw">select</span>(SID, <span class="dt">p_year =</span> year, <span class="kw">one_of</span>(<span class="kw">c</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name), <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;dadEdu&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-35" data-line-number="35"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-36" data-line-number="36"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb120-37" data-line-number="37">         <span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-38" data-line-number="38"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(parEdu, parOccPrstg), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb120-39" data-line-number="39"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb120-40" data-line-number="40"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu, <span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg)</a>
<a class="sourceLine" id="cb120-41" data-line-number="41"></a>
<a class="sourceLine" id="cb120-42" data-line-number="42"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(nlsy_match)]</a></code></pre></div>
<pre><code>## # A tibble: 34,590 x 20
##      SID p_year   age education gender grsWages  race physhlthevnt SRhealth smokes alcohol
##    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
##  1   201   2000     7         0      1   32964.    NA           NA     1         0       0
##  2   201   2006    13         0      1   34682.    NA           NA     1         0       0
##  3   201   2008    15         0      1   32837.    NA           NA     1         0       0
##  4   202   2000     6         0      1   32964.    NA           NA     1         0       0
##  5   202   2006    12         0      1   34682.    NA           NA     1         0       0
##  6   202   2008    14         0      1   32837.    NA           NA     1         0       0
##  7   301   2008    27         0      1   29323.     2           NA     2         0      NA
##  8   301   2000    19         0      1   28167.     2           NA     1         0      NA
##  9   301   2006    25         0      1   27278.     2           NA     1.67      0      NA
## 10   302   2000    17         0      1   27311.     2           NA     2         1       1
## # … with 34,580 more rows, and 9 more variables: exercise &lt;dbl&gt;, BMI &lt;dbl&gt;, married &lt;dbl&gt;,
## #   numKids &lt;dbl&gt;, parDivorce &lt;dbl&gt;, PhysFunc &lt;dbl&gt;, religion &lt;dbl&gt;, parEdu &lt;dbl&gt;,
## #   parOccPrstg &lt;dbl&gt;</code></pre>
</div>
<div id="imputation-7" class="section level3">
<h3><span class="header-section-number">2.9.6</span> Imputation</h3>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb122-1" data-line-number="1"><span class="co"># short helper functions to (1) identify and create factors, save col names of factors, remove columns with all missing values, and setup amelia</span></a>
<a class="sourceLine" id="cb122-2" data-line-number="2">factor_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){<span class="cf">if</span>(<span class="kw">is.numeric</span>(x)){<span class="kw">diff</span>(<span class="kw">range</span>(x, <span class="dt">na.rm =</span> T)) <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(x)) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">4</span>} <span class="cf">else</span>{F}}</a>
<a class="sourceLine" id="cb122-3" data-line-number="3">not_all_na &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">any</span>(<span class="op">!</span><span class="kw">is.na</span>(x))</a>
<a class="sourceLine" id="cb122-4" data-line-number="4">not_all_id &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="cf">if</span>(<span class="kw">is.numeric</span>(x)) <span class="kw">sd</span>(x, <span class="dt">na.rm =</span> T) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb122-5" data-line-number="5">mice_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb122-6" data-line-number="6">  <span class="kw">mice</span>(df, <span class="dt">m =</span> <span class="dv">5</span>, <span class="dt">maxit=</span><span class="dv">5</span>, <span class="dt">printFlag=</span><span class="ot">TRUE</span>, <span class="dt">method =</span> <span class="st">&quot;cart&quot;</span>)</a>
<a class="sourceLine" id="cb122-7" data-line-number="7">  }</a>
<a class="sourceLine" id="cb122-8" data-line-number="8">nlsy_match_imp2 &lt;-<span class="st"> </span>nlsy_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-9" data-line-number="9"><span class="st">  </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-12" data-line-number="12"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate_all</span>(<span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-14" data-line-number="14"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(year) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-15" data-line-number="15"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb122-16" data-line-number="16"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-17" data-line-number="17"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-18" data-line-number="18"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_na) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_id)),</a>
<a class="sourceLine" id="cb122-19" data-line-number="19">         <span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(factor_fun, as.factor)),</a>
<a class="sourceLine" id="cb122-20" data-line-number="20">         <span class="dt">imp =</span> <span class="kw">map</span>(data, mice_fun))</a>
<a class="sourceLine" id="cb122-21" data-line-number="21">beepr<span class="op">::</span><span class="kw">beep</span>(<span class="dt">sound =</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb122-22" data-line-number="22"></a>
<a class="sourceLine" id="cb122-23" data-line-number="23">nlsy_match_imp &lt;-<span class="st"> </span>nlsy_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp, <span class="op">~</span>mice<span class="op">::</span><span class="kw">complete</span>(., <span class="st">&quot;long&quot;</span>)),</a>
<a class="sourceLine" id="cb122-25" data-line-number="25">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">PhysFunc =</span> physAct)),</a>
<a class="sourceLine" id="cb122-26" data-line-number="26">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb122-27" data-line-number="27"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-28" data-line-number="28"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-29" data-line-number="29"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-30" data-line-number="30"><span class="st">    </span><span class="kw">ungroup</span>()),</a>
<a class="sourceLine" id="cb122-31" data-line-number="31">         <span class="dt">imp_sca =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(.imp <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID,  <span class="kw">one_of</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name)), hlthProbs) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">physhlthevnt =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(physhlthevnt, hlthProbs))<span class="op">-</span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>hlthProbs)))</a>
<a class="sourceLine" id="cb122-32" data-line-number="32"></a>
<a class="sourceLine" id="cb122-33" data-line-number="33">nlsy_match_imp_long &lt;-<span class="st"> </span>nlsy_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-34" data-line-number="34"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(is.factor, <span class="op">~</span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(.))))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-35" data-line-number="35"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-36" data-line-number="36"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span><span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">colnames</span>(.) <span class="op">==</span><span class="st"> &quot;relSat&quot;</span>)){(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">relSat =</span> <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(relSat)))})) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-37" data-line-number="37"><span class="st">  </span><span class="kw">unnest</span>(imp_df)</a>
<a class="sourceLine" id="cb122-38" data-line-number="38"></a>
<a class="sourceLine" id="cb122-39" data-line-number="39">nlsy_SCA_imp &lt;-<span class="st"> </span>nlsy_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-40" data-line-number="40"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-41" data-line-number="41"><span class="st">  </span><span class="kw">unnest</span>(imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-42" data-line-number="42"><span class="st">  </span><span class="kw">left_join</span>(nlsy_SCA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(p_year, SID,</a>
<a class="sourceLine" id="cb122-43" data-line-number="43">        <span class="kw">colnames</span>(nlsy_SCA)[<span class="op">!</span><span class="kw">colnames</span>(nlsy_SCA) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(.)])) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-44" data-line-number="44"><span class="st">  </span><span class="kw">left_join</span>(nlsy_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID, <span class="dt">p_year =</span> year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb122-45" data-line-number="45"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">physhlthevnt =</span> <span class="kw">factor</span>(physhlthevnt))</a>
<a class="sourceLine" id="cb122-46" data-line-number="46"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(nlsy_SCA_imp)]</a></code></pre></div>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb123-1" data-line-number="1"><span class="kw">save</span>(nlsy_match_imp_long, nlsy_SCA_imp, </a>
<a class="sourceLine" id="cb123-2" data-line-number="2">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/nlsy_imputed_small.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb123-3" data-line-number="3"><span class="kw">save</span>(nlsy_match_imp, </a>
<a class="sourceLine" id="cb123-4" data-line-number="4">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/nlsy_imputed.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb123-5" data-line-number="5"><span class="kw">save</span>(nlsy_alpha, nlsy_pers, nlsy_out, nlsy_match, nlsy_SCA,</a>
<a class="sourceLine" id="cb123-6" data-line-number="6">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/nlsy_cleaned.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb123-7" data-line-number="7"><span class="kw">save</span>(nlsy, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/nlsy_raw.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb123-8" data-line-number="8"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;nlsy&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb124-1" data-line-number="1"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;nlsy&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
</div>
</div>
<div id="shp" class="section level2">
<h2><span class="header-section-number">2.10</span> SHP</h2>
<p>The Swiss Household Panel Study (SHP; Voorpostel et al., 2016) “Living in Switzerland” is an ongoing longitudinal study of households in Switzerland. These data are available online, through application from <a href="https://forsbase.unil.ch/project/study-public-overview/15632/0/" class="uri">https://forsbase.unil.ch/project/study-public-overview/15632/0/</a>.</p>
<p>Participants were recruited from more than 10,000 individuals from the households whose members represent the non-institutional resident population of Switzerland. Data have been collected annually since 1999. The latest data release includes data up to 2018. On average, about 5,000 individuals are sampled at each wave. More documentation can be found at LINK, but, in short, the SHP is a nationally representative sample of Swiss citizens.</p>
<p>Sample sizes vary by year, ranging from 5,220 (2003) to 13,295 (2013). This provides 99/% power to detect a zero-order correlation effect size of ~.06, two tailed at alpha .05.</p>
<div id="load-data-9" class="section level3">
<h3><span class="header-section-number">2.10.1</span> Load Data</h3>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb125-1" data-line-number="1">shp_read_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb125-2" data-line-number="2">  <span class="cf">if</span>(<span class="kw">grepl</span>(<span class="st">&quot;SHP0_BV&quot;</span>, x)){old.names &lt;-<span class="st"> </span><span class="kw">str_to_lower</span>(old.names)}</a>
<a class="sourceLine" id="cb125-3" data-line-number="3">  y &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/shp/%s&quot;</span>, wd, x) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb125-4" data-line-number="4"><span class="st">    </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">one_of</span>(old.names))</a>
<a class="sourceLine" id="cb125-5" data-line-number="5">  <span class="cf">if</span>(<span class="kw">grepl</span>(<span class="st">&quot;SHP0_BV&quot;</span>, x)){<span class="kw">colnames</span>(y) &lt;-<span class="st"> </span><span class="kw">str_to_upper</span>(<span class="kw">colnames</span>(y))}</a>
<a class="sourceLine" id="cb125-6" data-line-number="6">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb125-7" data-line-number="7">} </a></code></pre></div>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb126-1" data-line-number="1">shp_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;SHP&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb126-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="dv">2017</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(year) <span class="op">|</span><span class="st"> </span>year <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb126-3" data-line-number="3">shp_codebook</a></code></pre></div>
<pre><code>## # A tibble: 1,493 x 18
##    study dataset category name  itemname wave   year new_itemname orig_itemname stem 
##    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;         &lt;chr&gt;
##  1 shp   P       match    dadA… dadalive 15     2013 shp__match_… P13N82        N82  
##  2 shp   P       match    dadA… dadalive 18     2016 shp__match_… P16N82        N82  
##  3 shp   P       match    dadE… dadhigh… 0         0 shp__match_… P$$O17        O17  
##  4 shp   P       match    degP… hlthimp… 1      1999 shp__match_… P99C08        C08  
##  5 shp   P       match    degP… hlthimp… 2      2000 shp__match_… P00C08        C08  
##  6 shp   P       match    degP… hlthimp… 3      2001 shp__match_… P01C08        C08  
##  7 shp   P       match    degP… hlthimp… 4      2002 shp__match_… P02C08        C08  
##  8 shp   P       match    degP… hlthimp… 5      2003 shp__match_… P03C08        C08  
##  9 shp   P       match    degP… hlthimp… 6      2004 shp__match_… P04C08        C08  
## 10 shp   P       match    degP… hlthimp… 7      2005 shp__match_… P05C08        C08  
## # … with 1,483 more rows, and 8 more variables: description &lt;chr&gt;, scale &lt;chr&gt;,
## #   reverse_code &lt;chr&gt;, recode &lt;chr&gt;, mini &lt;dbl&gt;, maxi &lt;dbl&gt;, comp_rule &lt;chr&gt;, ...18 &lt;lgl&gt;</code></pre>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb128-1" data-line-number="1">old.names &lt;-<span class="st"> </span><span class="kw">unique</span>(shp_codebook<span class="op">$</span>orig_itemname) <span class="op">%&gt;%</span><span class="st"> </span>str_to_upper</a>
<a class="sourceLine" id="cb128-2" data-line-number="2">datasets &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/shp&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">list.files</span>()</a>
<a class="sourceLine" id="cb128-3" data-line-number="3">shp &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">datasets =</span> datasets) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(datasets, shp_read_fun),</a>
<a class="sourceLine" id="cb128-5" data-line-number="5">         <span class="dt">ncol =</span> <span class="kw">map</span>(data, ncol)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb128-6" data-line-number="6"><span class="st">  </span><span class="kw">unnest</span>(ncol) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb128-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(ncol <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb128-8" data-line-number="8"></a>
<a class="sourceLine" id="cb128-9" data-line-number="9">shp_grid &lt;-<span class="st"> </span>shp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(datasets <span class="op">==</span><span class="st"> &quot;SHP_MH.sav&quot;</span>)</a>
<a class="sourceLine" id="cb128-10" data-line-number="10">shp &lt;-<span class="st"> </span>shp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(datasets <span class="op">!=</span><span class="st"> &quot;SHP_MH.sav&quot;</span>)</a>
<a class="sourceLine" id="cb128-11" data-line-number="11"></a>
<a class="sourceLine" id="cb128-12" data-line-number="12">shp &lt;-<span class="st"> </span><span class="kw">reduce</span>(shp<span class="op">$</span>data, full_join) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.)</a>
<a class="sourceLine" id="cb128-13" data-line-number="13"><span class="kw">save</span>(shp, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/shp_raw.RData&quot;</span>, wd))</a></code></pre></div>
</div>
<div id="matching-variables-8" class="section level3">
<h3><span class="header-section-number">2.10.2</span> Matching Variables</h3>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb129-1" data-line-number="1">rename_fun &lt;-<span class="st"> </span><span class="cf">function</span>(cb, var){</a>
<a class="sourceLine" id="cb129-2" data-line-number="2">  <span class="kw">print</span>(var)</a>
<a class="sourceLine" id="cb129-3" data-line-number="3">  old.names &lt;-<span class="st"> </span><span class="kw">unique</span>((shp_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> </span>var))<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb129-4" data-line-number="4">  df &lt;-<span class="st"> </span>shp <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb129-5" data-line-number="5"><span class="st">    </span><span class="kw">select</span>(<span class="dt">SID =</span> IDPERS, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-6" data-line-number="6"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>SID, <span class="dt">na.rm=</span>T)</a>
<a class="sourceLine" id="cb129-7" data-line-number="7">  <span class="cf">if</span>(<span class="kw">length</span>(old.names) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>){</a>
<a class="sourceLine" id="cb129-8" data-line-number="8">      df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(itemname, year, orig_itemname, reverse_code<span class="op">:</span>comp_rule))</a>
<a class="sourceLine" id="cb129-9" data-line-number="9">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb129-10" data-line-number="10">    df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>(itemname<span class="op">:</span>year),  <span class="op">-</span>new_itemname, <span class="op">-</span>dataset) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="st">&quot;0&quot;</span>)</a>
<a class="sourceLine" id="cb129-11" data-line-number="11">  }</a>
<a class="sourceLine" id="cb129-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb129-13" data-line-number="13"></a>
<a class="sourceLine" id="cb129-14" data-line-number="14"><span class="co"># rename variables   </span></a>
<a class="sourceLine" id="cb129-15" data-line-number="15">shp_match &lt;-<span class="st"> </span>shp_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-16" data-line-number="16"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-17" data-line-number="17"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb129-18" data-line-number="18"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-19" data-line-number="19"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-20" data-line-number="20"><span class="st">  </span><span class="co"># filter(name != &quot;yearBrth&quot;) %&gt;%</span></a>
<a class="sourceLine" id="cb129-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-22" data-line-number="22"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-23" data-line-number="23"><span class="st">  </span><span class="kw">distinct</span>() </a>
<a class="sourceLine" id="cb129-24" data-line-number="24"></a>
<a class="sourceLine" id="cb129-25" data-line-number="25"><span class="co"># single time point variables </span></a>
<a class="sourceLine" id="cb129-26" data-line-number="26">old.names &lt;-<span class="st"> </span>(shp_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">==</span><span class="st"> &quot;0&quot;</span>))<span class="op">$</span>orig_itemname </a>
<a class="sourceLine" id="cb129-27" data-line-number="27">shp_match_stp &lt;-<span class="st"> </span>shp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-28" data-line-number="28"><span class="st">  </span><span class="kw">select</span>(<span class="dt">SID =</span> IDPERS, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-29" data-line-number="29"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-30" data-line-number="30"><span class="st">  </span><span class="kw">left_join</span>(shp_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(name<span class="op">:</span>year, orig_itemname, recode, comp_rule)) </a>
<a class="sourceLine" id="cb129-31" data-line-number="31"></a>
<a class="sourceLine" id="cb129-32" data-line-number="32"><span class="co"># recoding</span></a>
<a class="sourceLine" id="cb129-33" data-line-number="33">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year){</a>
<a class="sourceLine" id="cb129-34" data-line-number="34">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb129-35" data-line-number="35">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb129-36" data-line-number="36">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb129-37" data-line-number="37">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb129-38" data-line-number="38">}</a>
<a class="sourceLine" id="cb129-39" data-line-number="39"></a>
<a class="sourceLine" id="cb129-40" data-line-number="40">yrBrth &lt;-<span class="st"> </span>shp_match_stp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-41" data-line-number="41"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">yearBrth =</span> <span class="kw">ifelse</span>(value <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-42" data-line-number="42"><span class="st">  </span><span class="kw">select</span>(SID, yearBrth) </a>
<a class="sourceLine" id="cb129-43" data-line-number="43"></a>
<a class="sourceLine" id="cb129-44" data-line-number="44">shp_match &lt;-<span class="st"> </span>shp_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-45" data-line-number="45"><span class="st">  </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-46" data-line-number="46"><span class="st">  </span><span class="kw">group_by</span>(recode, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-47" data-line-number="47"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-48" data-line-number="48"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-49" data-line-number="49"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">recode =</span> <span class="kw">mapvalues</span>(recode, <span class="st">&quot;ifelse(is.na(x) | x &lt; 0), NA, ifelse(x &gt; 0, 1, 0))&quot;</span>, <span class="st">&quot;ifelse(is.na(x) | x &lt; 0, NA, ifelse(x &gt; 0, 1, 0))&quot;</span>),</a>
<a class="sourceLine" id="cb129-50" data-line-number="50">         <span class="dt">recode =</span> <span class="kw">mapvalues</span>(recode, <span class="st">&quot;ifelse(is.na(x) | x &lt; 0, ifelse(x %in% 7:14, 0, 1))&quot;</span>, <span class="st">&quot;ifelse(is.na(x) | x &lt; 0, NA, ifelse(x %in% 7:14, 0, 1))&quot;</span>),</a>
<a class="sourceLine" id="cb129-51" data-line-number="51">         <span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-52" data-line-number="52"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb129-53" data-line-number="53"></a>
<a class="sourceLine" id="cb129-54" data-line-number="54">shp_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;SHP&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb129-55" data-line-number="55"></a>
<a class="sourceLine" id="cb129-56" data-line-number="56">shp_match_stp &lt;-<span class="st"> </span>shp_match_stp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-57" data-line-number="57"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> shp_waves<span class="op">$</span>Used, <span class="dt">year =</span> <span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-58" data-line-number="58"><span class="st">  </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-59" data-line-number="59"><span class="st">  </span><span class="kw">group_by</span>(recode, p_year, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-60" data-line-number="60"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb129-61" data-line-number="61"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-62" data-line-number="62"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-63" data-line-number="63"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb129-64" data-line-number="64"></a>
<a class="sourceLine" id="cb129-65" data-line-number="65"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb129-66" data-line-number="66">shp_match &lt;-<span class="st"> </span>shp_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-67" data-line-number="67"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, </a>
<a class="sourceLine" id="cb129-68" data-line-number="68">                        <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb129-69" data-line-number="69"></a>
<a class="sourceLine" id="cb129-70" data-line-number="70">fun_call &lt;-<span class="st"> </span><span class="cf">function</span>(x, rule){</a>
<a class="sourceLine" id="cb129-71" data-line-number="71">    <span class="cf">switch</span>(rule,</a>
<a class="sourceLine" id="cb129-72" data-line-number="72">           <span class="dt">average =</span> <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb129-73" data-line-number="73">           <span class="dt">mode =</span> <span class="kw">Mode</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb129-74" data-line-number="74">           <span class="dt">sum =</span> <span class="kw">sum</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb129-75" data-line-number="75">           <span class="dt">skip =</span> <span class="kw">unique</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb129-76" data-line-number="76">           <span class="dt">max =</span> <span class="kw">max</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb129-77" data-line-number="77">           <span class="dt">min =</span> <span class="kw">min</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb129-78" data-line-number="78">           <span class="dt">multiply =</span> <span class="kw">prod</span>(x, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb129-79" data-line-number="79">  }</a>
<a class="sourceLine" id="cb129-80" data-line-number="80"></a>
<a class="sourceLine" id="cb129-81" data-line-number="81"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb129-82" data-line-number="82">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb129-83" data-line-number="83">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-84" data-line-number="84"><span class="st">    </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb129-85" data-line-number="85"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb129-86" data-line-number="86"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-87" data-line-number="87"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb129-88" data-line-number="88"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb129-89" data-line-number="89">}</a>
<a class="sourceLine" id="cb129-90" data-line-number="90"></a>
<a class="sourceLine" id="cb129-91" data-line-number="91">shp_match &lt;-<span class="st"> </span>shp_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-92" data-line-number="92"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="kw">max</span>(shp_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-93" data-line-number="93"><span class="st">  </span><span class="kw">group_by</span>(comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-94" data-line-number="94"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-95" data-line-number="95"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-96" data-line-number="96"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;skip&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb129-97" data-line-number="97">         <span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-98" data-line-number="98"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb129-99" data-line-number="99"></a>
<a class="sourceLine" id="cb129-100" data-line-number="100">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, p_year){</a>
<a class="sourceLine" id="cb129-101" data-line-number="101">  shp_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-102" data-line-number="102"><span class="st">    </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span>p_year  <span class="op">&amp;</span><span class="st"> </span>comp_rule <span class="op">==</span><span class="st"> </span>rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-103" data-line-number="103"><span class="st">    </span><span class="kw">left_join</span>(</a>
<a class="sourceLine" id="cb129-104" data-line-number="104">      shp_match_stp <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb129-105" data-line-number="105"><span class="st">        </span><span class="kw">select</span>(SID, yearBrth, p_year, name, value, comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-106" data-line-number="106"><span class="st">        </span><span class="kw">filter</span>(comp_rule <span class="op">==</span><span class="st"> </span>rule <span class="op">&amp;</span><span class="st"> </span>p_year <span class="op">==</span><span class="st"> </span>p_year)</a>
<a class="sourceLine" id="cb129-107" data-line-number="107">      ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-108" data-line-number="108"><span class="st">    </span><span class="kw">group_by</span>(SID, yearBrth, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-109" data-line-number="109"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-110" data-line-number="110"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb129-111" data-line-number="111">}</a>
<a class="sourceLine" id="cb129-112" data-line-number="112"></a>
<a class="sourceLine" id="cb129-113" data-line-number="113">shp_match &lt;-<span class="st"> </span><span class="kw">crossing</span>(</a>
<a class="sourceLine" id="cb129-114" data-line-number="114">  <span class="dt">p_year =</span> shp_waves<span class="op">$</span>Used, </a>
<a class="sourceLine" id="cb129-115" data-line-number="115">  <span class="dt">comp_rule =</span> <span class="kw">unique</span>(shp_match<span class="op">$</span>comp_rule)</a>
<a class="sourceLine" id="cb129-116" data-line-number="116">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-117" data-line-number="117"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;skip&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb129-118" data-line-number="118">         <span class="dt">data =</span> <span class="kw">map2</span>(comp_rule, p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-119" data-line-number="119"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-120" data-line-number="120"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-121" data-line-number="121"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-122" data-line-number="122"><span class="st">  </span><span class="kw">full_join</span>(shp_match_stp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID, yearBrth, name, value, p_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-123" data-line-number="123"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-124" data-line-number="124"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb129-125" data-line-number="125"><span class="st">  </span><span class="kw">spread</span>(name,value)</a></code></pre></div>
<pre><code>## # A tibble: 139,867 x 56
##     year   SID     A     C   DEP     E   LOC     N  `NA`     O    OP    PA    SE    SS   SWL
##    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  2000  4101    NA    NA     0    NA    NA    NA    NA    NA     9    NA    NA  9       10
##  2  2000  4102    NA    NA     5    NA    NA    NA    NA    NA     7    NA    NA 10       10
##  3  2000  5101    NA    NA     1    NA    NA    NA    NA    NA    10    NA    NA  6.5      8
##  4  2000  6101    NA    NA     8    NA    NA    NA    NA    NA     0    NA    NA  4.75     5
##  5  2000 13102    NA    NA     3    NA    NA    NA    NA    NA     7    NA    NA  8.7      9
##  6  2000 14101    NA    NA     0    NA    NA    NA    NA    NA     8    NA    NA  5.88     8
##  7  2000 26101    NA    NA     2    NA    NA    NA    NA    NA     0    NA    NA  8.12     5
##  8  2000 26102    NA    NA     0    NA    NA    NA    NA    NA     9    NA    NA  7.5     10
##  9  2000 27101    NA    NA     0    NA    NA    NA    NA    NA     9    NA    NA  7.5      8
## 10  2000 27102    NA    NA     1    NA    NA    NA    NA    NA     0    NA    NA  7        8
## # … with 139,857 more rows, and 41 more variables: ageMarried &lt;dbl&gt;, dadEdu &lt;dbl&gt;,
## #   dadOccPrstg &lt;dbl&gt;, degPhysFunc &lt;dbl&gt;, disability &lt;dbl&gt;, drVisits &lt;dbl&gt;, education &lt;dbl&gt;,
## #   employed &lt;dbl&gt;, exercise &lt;dbl&gt;, gender &lt;dbl&gt;, grsWages &lt;dbl&gt;, height &lt;dbl&gt;, HHID &lt;dbl&gt;,
## #   HHsize &lt;dbl&gt;, hlthcare &lt;dbl&gt;, imprvHealth &lt;dbl&gt;, loneliness &lt;dbl&gt;, married &lt;dbl&gt;,
## #   meaning &lt;dbl&gt;, momEdu &lt;dbl&gt;, momOccPrstg &lt;dbl&gt;, numKids &lt;dbl&gt;, parDivorce &lt;dbl&gt;,
## #   physAct &lt;dbl&gt;, PhysFunc &lt;dbl&gt;, race &lt;dbl&gt;, religion &lt;dbl&gt;, religiosity &lt;dbl&gt;,
## #   satFinances &lt;dbl&gt;, satFncChng &lt;dbl&gt;, satHealth &lt;dbl&gt;, satHH &lt;dbl&gt;, satSchl &lt;dbl&gt;,
## #   SRhealth &lt;dbl&gt;, unemployBen &lt;dbl&gt;, weight &lt;dbl&gt;, welfare &lt;dbl&gt;, yearBrth &lt;dbl&gt;,
## #   physhlthevnt &lt;dbl&gt;, age &lt;dbl&gt;, BMI &lt;dbl&gt;</code></pre>
</div>
<div id="personality-variables-8" class="section level3">
<h3><span class="header-section-number">2.10.3</span> Personality Variables</h3>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb131-1" data-line-number="1">shp_pers &lt;-<span class="st"> </span>shp_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;pers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb131-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-8" data-line-number="8"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-9" data-line-number="9"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-10" data-line-number="10"><span class="st">  </span><span class="kw">left_join</span>(p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;SHP&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">name =</span> p_item, Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-11" data-line-number="11"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span>Used)</a>
<a class="sourceLine" id="cb131-12" data-line-number="12"></a>
<a class="sourceLine" id="cb131-13" data-line-number="13">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb131-14" data-line-number="14">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb131-15" data-line-number="15">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb131-16" data-line-number="16">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb131-17" data-line-number="17">}</a>
<a class="sourceLine" id="cb131-18" data-line-number="18"></a>
<a class="sourceLine" id="cb131-19" data-line-number="19"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb131-20" data-line-number="20">shp_pers &lt;-<span class="st"> </span>shp_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-21" data-line-number="21"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>orig_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-22" data-line-number="22"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-23" data-line-number="23"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-24" data-line-number="24"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-25" data-line-number="25"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-26" data-line-number="26"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb131-27" data-line-number="27"></a>
<a class="sourceLine" id="cb131-28" data-line-number="28"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb131-29" data-line-number="29">shp_pers &lt;-<span class="st"> </span>shp_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-30" data-line-number="30"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">tolower</span>(reverse_code) <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), </a>
<a class="sourceLine" id="cb131-31" data-line-number="31">                        value, <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb131-32" data-line-number="32"></a>
<a class="sourceLine" id="cb131-33" data-line-number="33"><span class="co"># alpha&#39;s</span></a>
<a class="sourceLine" id="cb131-34" data-line-number="34">shp_alpha &lt;-<span class="st"> </span>shp_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-35" data-line-number="35"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, SID, value, comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-36" data-line-number="36"><span class="st">  </span><span class="kw">group_by</span>(name, year, SID, comp_rule, itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-37" data-line-number="37"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-38" data-line-number="38"><span class="st">  </span><span class="kw">group_by</span>(name, year, comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-39" data-line-number="39"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-40" data-line-number="40"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> itemname, <span class="dt">values_from =</span> value, <span class="dt">values_fn =</span> <span class="kw">list</span>(<span class="dt">value =</span> mean))),</a>
<a class="sourceLine" id="cb131-41" data-line-number="41">         <span class="dt">alpha =</span> <span class="kw">map</span>(data, <span class="kw">possibly</span>(<span class="op">~</span>psych<span class="op">::</span><span class="kw">alpha</span>((.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>SID)), <span class="ot">NA_real_</span>)))</a>
<a class="sourceLine" id="cb131-42" data-line-number="42"></a>
<a class="sourceLine" id="cb131-43" data-line-number="43"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb131-44" data-line-number="44">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb131-45" data-line-number="45">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-46" data-line-number="46"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-47" data-line-number="47"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-48" data-line-number="48"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb131-49" data-line-number="49">}</a>
<a class="sourceLine" id="cb131-50" data-line-number="50"></a>
<a class="sourceLine" id="cb131-51" data-line-number="51"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb131-52" data-line-number="52">shp_pers &lt;-<span class="st"> </span>shp_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-53" data-line-number="53"><span class="st">  </span><span class="kw">group_by</span>(name, comp_rule, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-54" data-line-number="54"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-55" data-line-number="55"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-56" data-line-number="56"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;average&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb131-57" data-line-number="57">         <span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb131-58" data-line-number="58"><span class="st">  </span><span class="kw">unnest</span>()</a></code></pre></div>
<pre><code>## # A tibble: 187,730 x 5
##    name   year comp_rule   SID value
##    &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;
##  1 A      2009 average    4101   7  
##  2 A      2009 average    4102   5  
##  3 A      2009 average    4103   1.5
##  4 A      2009 average    4104   5  
##  5 A      2009 average    5101   5.5
##  6 A      2009 average    5104   5  
##  7 A      2009 average   21101   7.5
##  8 A      2009 average   26101  10  
##  9 A      2009 average   27101   6  
## 10 A      2009 average   27102   5.5
## # … with 187,720 more rows</code></pre>
</div>
<div id="outcome-variables-9" class="section level3">
<h3><span class="header-section-number">2.10.4</span> Outcome Variables</h3>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb133-1" data-line-number="1">shp_out &lt;-<span class="st"> </span>shp_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">!=</span><span class="st"> &quot;0&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb133-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-7" data-line-number="7"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-8" data-line-number="8"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-9" data-line-number="9"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> shp_waves<span class="op">$</span>Used, <span class="dt">name =</span> <span class="kw">unique</span>((.)<span class="op">$</span>name))) </a>
<a class="sourceLine" id="cb133-10" data-line-number="10"></a>
<a class="sourceLine" id="cb133-11" data-line-number="11">old.names &lt;-<span class="st"> </span>(shp_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">==</span><span class="st"> &quot;0&quot;</span>))<span class="op">$</span>orig_itemname </a>
<a class="sourceLine" id="cb133-12" data-line-number="12">shp_out_stp &lt;-<span class="st"> </span>shp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-13" data-line-number="13"><span class="st">  </span><span class="kw">select</span>(<span class="dt">SID =</span> IDPERS, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-14" data-line-number="14"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-15" data-line-number="15"><span class="st">  </span><span class="kw">left_join</span>(shp_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(name<span class="op">:</span>year, orig_itemname, recode, comp_rule))</a>
<a class="sourceLine" id="cb133-16" data-line-number="16"></a>
<a class="sourceLine" id="cb133-17" data-line-number="17"><span class="co"># recode</span></a>
<a class="sourceLine" id="cb133-18" data-line-number="18">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year, year){</a>
<a class="sourceLine" id="cb133-19" data-line-number="19">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb133-20" data-line-number="20">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb133-21" data-line-number="21">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb133-22" data-line-number="22">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb133-23" data-line-number="23">}</a>
<a class="sourceLine" id="cb133-24" data-line-number="24"></a>
<a class="sourceLine" id="cb133-25" data-line-number="25">shp_out &lt;-<span class="st"> </span>shp_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-26" data-line-number="26"><span class="st">  </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-27" data-line-number="27"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>orig_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-28" data-line-number="28"><span class="st">  </span><span class="kw">group_by</span>(recode, year, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-29" data-line-number="29"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-30" data-line-number="30"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-31" data-line-number="31"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">as.numeric</span>(year),</a>
<a class="sourceLine" id="cb133-32" data-line-number="32">         <span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-33" data-line-number="33"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-34" data-line-number="34"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb133-35" data-line-number="35"></a>
<a class="sourceLine" id="cb133-36" data-line-number="36">shp_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;SHP&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb133-37" data-line-number="37"></a>
<a class="sourceLine" id="cb133-38" data-line-number="38">shp_out_stp &lt;-<span class="st"> </span>shp_out_stp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-39" data-line-number="39"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> shp_waves<span class="op">$</span>Used, <span class="dt">year =</span> <span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-40" data-line-number="40"><span class="st">  </span><span class="kw">group_by</span>(recode, p_year, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-41" data-line-number="41"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb133-42" data-line-number="42"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-43" data-line-number="43"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-44" data-line-number="44"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-45" data-line-number="45"><span class="st">  </span><span class="kw">left_join</span>(yrBrth)</a>
<a class="sourceLine" id="cb133-46" data-line-number="46"></a>
<a class="sourceLine" id="cb133-47" data-line-number="47"><span class="co"># composite within years</span></a>
<a class="sourceLine" id="cb133-48" data-line-number="48">shp_out &lt;-<span class="st"> </span>shp_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-49" data-line-number="49"><span class="st">  </span><span class="kw">select</span>(year, p_year<span class="op">:</span>itemname, yearBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-50" data-line-number="50"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-51" data-line-number="51"><span class="st">  </span><span class="co"># filter(year &lt;= max(gsoep_waves$Used)) %&gt;%</span></a>
<a class="sourceLine" id="cb133-52" data-line-number="52"><span class="st">  </span><span class="kw">group_by</span>(SID, name, year, yearBrth, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-53" data-line-number="53"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb133-54" data-line-number="54"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-55" data-line-number="55"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(value)<span class="op">|</span><span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb133-56" data-line-number="56"></a>
<a class="sourceLine" id="cb133-57" data-line-number="57">shp_out &lt;-<span class="st"> </span>shp_out <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb133-58" data-line-number="58"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;chldmvout&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-59" data-line-number="59"><span class="st">  </span><span class="kw">group_by</span>(SID, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-60" data-line-number="60"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">max =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-61" data-line-number="61"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-62" data-line-number="62"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(value <span class="op">&lt;</span><span class="st"> </span>max, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-63" data-line-number="63"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>max) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-64" data-line-number="64"><span class="st">  </span><span class="kw">full_join</span>(shp_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;chldmvout&quot;</span>))</a>
<a class="sourceLine" id="cb133-65" data-line-number="65"></a>
<a class="sourceLine" id="cb133-66" data-line-number="66"><span class="co"># composite across years</span></a>
<a class="sourceLine" id="cb133-67" data-line-number="67">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(P_year){</a>
<a class="sourceLine" id="cb133-68" data-line-number="68">  shp_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-69" data-line-number="69"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>P_year, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;past&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-70" data-line-number="70"><span class="st">    </span><span class="kw">group_by</span>(SID, name, group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-71" data-line-number="71"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-72" data-line-number="72"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-73" data-line-number="73"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-74" data-line-number="74"><span class="st">    </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> group, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-75" data-line-number="75"><span class="st">    </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-76" data-line-number="76"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(past) <span class="op">|</span><span class="st"> </span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(future)), future,</a>
<a class="sourceLine" id="cb133-77" data-line-number="77">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(future), past, </a>
<a class="sourceLine" id="cb133-78" data-line-number="78">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)))) </a>
<a class="sourceLine" id="cb133-79" data-line-number="79">}</a>
<a class="sourceLine" id="cb133-80" data-line-number="80"></a>
<a class="sourceLine" id="cb133-81" data-line-number="81">shp_out &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">p_year =</span> shp_waves<span class="op">$</span>Used) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-82" data-line-number="82"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-83" data-line-number="83"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-84" data-line-number="84"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-85" data-line-number="85"><span class="st">  </span><span class="kw">full_join</span>(shp_out_stp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(p_year, name, SID, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb133-86" data-line-number="86"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st">  </span><span class="kw">left_join</span>(yrBrth)</a></code></pre></div>
<pre><code>## # A tibble: 1,323,120 x 7
##    p_year   SID name         future  past value yearBrth
##     &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
##  1   2009  4101 chldbrth          1     1    NA     1965
##  2   2009  4101 chldmvout         1     1    NA     1965
##  3   2009  4101 divorced          0     0     0     1965
##  4   2009  4101 edu               1     0     1     1965
##  5   2009  4101 frstjob           0     0     0     1965
##  6   2009  4101 married           0     0     0     1965
##  7   2009  4101 mortality         0     0     0     1965
##  8   2009  4101 mvInPrtnr         1     1    NA     1965
##  9   2009  4101 physhlthevnt      0     0     0     1965
## 10   2009  4101 vlntred           0     1    NA     1965
## # … with 1,323,110 more rows</code></pre>
</div>
<div id="covariates-8" class="section level3">
<h3><span class="header-section-number">2.10.5</span> Covariates</h3>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb135-1" data-line-number="1">shp_match &lt;-<span class="st"> </span>shp_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-3" data-line-number="3"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb135-4" data-line-number="4"><span class="st">  </span><span class="kw">full_join</span>(shp_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">year =</span> p_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-5" data-line-number="5"><span class="st">  </span><span class="co"># physical health event</span></a>
<a class="sourceLine" id="cb135-6" data-line-number="6"><span class="st">  </span><span class="kw">left_join</span>(shp_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;physhlthevnt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">year =</span> p_year, SID, <span class="dt">physhlthevnt =</span> past) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">physhlthevnt =</span> <span class="kw">max</span>(physhlthevnt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-7" data-line-number="7"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb135-8" data-line-number="8"></a>
<a class="sourceLine" id="cb135-9" data-line-number="9"><span class="co"># age</span></a>
<a class="sourceLine" id="cb135-10" data-line-number="10">shp_match &lt;-<span class="st"> </span>shp_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-11" data-line-number="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> year <span class="op">-</span><span class="st"> </span>yearBrth,</a>
<a class="sourceLine" id="cb135-12" data-line-number="12">         <span class="dt">BMI =</span> weight <span class="op">/</span><span class="st"> </span>(height<span class="op">/</span><span class="dv">100</span>)<span class="op">^</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb135-13" data-line-number="13">         <span class="dt">parDivorce =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(parDivorce), <span class="dv">0</span>, parDivorce))</a>
<a class="sourceLine" id="cb135-14" data-line-number="14"></a>
<a class="sourceLine" id="cb135-15" data-line-number="15">shp_out &lt;-<span class="st"> </span>shp_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-16" data-line-number="16"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>past, <span class="op">-</span>future) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-17" data-line-number="17"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb135-18" data-line-number="18"></a>
<a class="sourceLine" id="cb135-19" data-line-number="19">shp_SCA &lt;-<span class="st"> </span>shp_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb135-20" data-line-number="20"><span class="st">  </span><span class="kw">select</span>(SID, <span class="dt">p_year =</span> year, <span class="kw">one_of</span>(<span class="kw">c</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name), <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;dadEdu&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-21" data-line-number="21"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-22" data-line-number="22"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb135-23" data-line-number="23">         <span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(parEdu, parOccPrstg), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb135-25" data-line-number="25"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb135-26" data-line-number="26"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu, <span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg)</a>
<a class="sourceLine" id="cb135-27" data-line-number="27"></a>
<a class="sourceLine" id="cb135-28" data-line-number="28"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(shp_match2)]</a></code></pre></div>
<pre><code>## # A tibble: 139,867 x 18
##      SID p_year   age education gender grsWages  race physhlthevnt SRhealth exercise   BMI
##    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
##  1  4101   2000    35         0      0    57750     0            0      1          1    NA
##  2  4102   2000    32         0      1    57750     0            1      3          2    NA
##  3  5101   2000    39         1      0    86700     0            1      2          2    NA
##  4  6101   2000    36         0      1    49400     0            0      3.5        0    NA
##  5 13102   2000    27         0      1    34270     0            0      2          2    NA
##  6 14101   2000    66         0      0    72130     0            0      2          2    NA
##  7 26101   2000    78         0      1    57400     0            0      3          4    NA
##  8 26102   2000    75         0      0    57400     0            0      2          7    NA
##  9 27101   2000    32         0      1    37050     0            0      3          7    NA
## 10 27102   2000    32         0      0    37050     0            1      1          3    NA
## # … with 139,857 more rows, and 7 more variables: married &lt;dbl&gt;, numKids &lt;dbl&gt;,
## #   parDivorce &lt;dbl&gt;, PhysFunc &lt;dbl&gt;, religion &lt;dbl&gt;, parEdu &lt;dbl&gt;, parOccPrstg &lt;dbl&gt;</code></pre>
</div>
<div id="imputation-8" class="section level3">
<h3><span class="header-section-number">2.10.6</span> Imputation</h3>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb137-1" data-line-number="1"><span class="co"># short helper functions to (1) identify and create factors, save col names of factors, remove columns with all missing values, and setup amelia</span></a>
<a class="sourceLine" id="cb137-2" data-line-number="2">factor_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){<span class="cf">if</span>(<span class="kw">is.numeric</span>(x)){<span class="kw">diff</span>(<span class="kw">range</span>(x, <span class="dt">na.rm =</span> T)) <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(x)) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">4</span>} <span class="cf">else</span>{F}}</a>
<a class="sourceLine" id="cb137-3" data-line-number="3">not_all_id &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="cf">if</span>(<span class="kw">is.numeric</span>(x)) <span class="kw">sd</span>(x, <span class="dt">na.rm =</span> T) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb137-4" data-line-number="4">mice_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb137-5" data-line-number="5">  <span class="kw">mice</span>(df, <span class="dt">m =</span> <span class="dv">5</span>, <span class="dt">maxit=</span><span class="dv">5</span>, <span class="dt">method =</span> <span class="st">&quot;cart&quot;</span>, <span class="dt">printFlag=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb137-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb137-7" data-line-number="7">shp_match_imp &lt;-<span class="st"> </span>shp_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-8" data-line-number="8"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">NegAff =</span> <span class="st">`</span><span class="dt">NA</span><span class="st">`</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-9" data-line-number="9"><span class="st">  </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-12" data-line-number="12"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate_all</span>(<span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-14" data-line-number="14"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(year) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-15" data-line-number="15"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb137-16" data-line-number="16"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-17" data-line-number="17"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-18" data-line-number="18"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_na) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_id)),</a>
<a class="sourceLine" id="cb137-19" data-line-number="19">         <span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(factor_fun, as.factor)),</a>
<a class="sourceLine" id="cb137-20" data-line-number="20">         <span class="dt">imp =</span> <span class="kw">map</span>(data, mice_fun))</a>
<a class="sourceLine" id="cb137-21" data-line-number="21">beepr<span class="op">::</span><span class="kw">beep</span>(<span class="dt">sound =</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb137-22" data-line-number="22"></a>
<a class="sourceLine" id="cb137-23" data-line-number="23">shp_match_imp &lt;-<span class="st"> </span>shp_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp, <span class="op">~</span>mice<span class="op">::</span><span class="kw">complete</span>(., <span class="st">&quot;long&quot;</span>)),</a>
<a class="sourceLine" id="cb137-25" data-line-number="25">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb137-26" data-line-number="26"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-27" data-line-number="27"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-28" data-line-number="28"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-29" data-line-number="29"><span class="st">    </span><span class="kw">ungroup</span>()),</a>
<a class="sourceLine" id="cb137-30" data-line-number="30">         <span class="dt">imp_sca =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(.imp <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID,  <span class="kw">one_of</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name)))))</a>
<a class="sourceLine" id="cb137-31" data-line-number="31"></a>
<a class="sourceLine" id="cb137-32" data-line-number="32">shp_match_imp_long &lt;-<span class="st"> </span>shp_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-33" data-line-number="33"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(is.factor, <span class="op">~</span><span class="kw">as.numeric</span>(<span class="kw">as.factor</span>(.))))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-34" data-line-number="34"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-35" data-line-number="35"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span><span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">colnames</span>(.) <span class="op">==</span><span class="st"> &quot;relSat&quot;</span>)){(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">relSat =</span> <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(relSat))); (.)}<span class="cf">else</span>{(.)})) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-36" data-line-number="36"><span class="st">  </span><span class="kw">unnest</span>(imp_df)</a>
<a class="sourceLine" id="cb137-37" data-line-number="37"></a>
<a class="sourceLine" id="cb137-38" data-line-number="38">shp_SCA_imp &lt;-<span class="st"> </span>shp_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-39" data-line-number="39"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-40" data-line-number="40"><span class="st">  </span><span class="kw">unnest</span>(imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-41" data-line-number="41"><span class="st">  </span><span class="kw">left_join</span>(shp_SCA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">p_year=</span>year, SID,</a>
<a class="sourceLine" id="cb137-42" data-line-number="42">        <span class="kw">colnames</span>(shp_SCA)[<span class="op">!</span><span class="kw">colnames</span>(shp_SCA) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(.)])) </a>
<a class="sourceLine" id="cb137-43" data-line-number="43">shp_SCA_imp &lt;-<span class="st"> </span>shp_SCA_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-44" data-line-number="44"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>BMI) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-45" data-line-number="45"><span class="st">  </span><span class="kw">left_join</span>(shp_SCA_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-46" data-line-number="46"><span class="st">    </span><span class="kw">select</span>(SID, BMI) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-47" data-line-number="47"><span class="st">    </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-48" data-line-number="48"><span class="st">    </span><span class="kw">gather</span>(item, value, <span class="op">-</span>SID, <span class="dt">na.rm =</span>  T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-49" data-line-number="49"><span class="st">    </span><span class="kw">group_by</span>(SID,item) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-50" data-line-number="50"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb137-51" data-line-number="51"><span class="st">    </span><span class="kw">spread</span>(item,value))</a>
<a class="sourceLine" id="cb137-52" data-line-number="52"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(shp_SCA_imp)]</a></code></pre></div>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb138-1" data-line-number="1"><span class="kw">save</span>(shp_match_imp_long, shp_SCA_imp, </a>
<a class="sourceLine" id="cb138-2" data-line-number="2">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/shp_imputed_small.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb138-3" data-line-number="3"><span class="kw">save</span>(shp_match_imp, </a>
<a class="sourceLine" id="cb138-4" data-line-number="4">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/shp_imputed.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb138-5" data-line-number="5"><span class="kw">save</span>(shp_alpha, shp_pers, shp_out, shp_match, shp_SCA,</a>
<a class="sourceLine" id="cb138-6" data-line-number="6">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/shp_cleaned.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb138-7" data-line-number="7"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;shp&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb139-1" data-line-number="1"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;shp&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
</div>
</div>
<div id="wls" class="section level2">
<h2><span class="header-section-number">2.11</span> WLS</h2>
<p>The Wisconsin Longitudinal Study (WLS) is an ongoing longitudinal study of individuals who graduated from Wisconsin high schools in 1957 and were born between 1937 and 1940 as well as their siblings.</p>
<p>Graduates were randomly recruited from Wisconsin high schools in 1957 and born between 1937 and 1940. In 1977, at least one sibling of the original graduates from 2,100 families were also invited to participate in the study. As such, the study is representative of older, white Americans who have at least a high school education. Graduate data have been collected in in 1957, 1964, 1975, 1992, 2004, and 2011, and sibling data have been collected in 1977, 1994, 2005, and 2011. Personality data were initially collected in 1992 for graduates and 1994 for siblings. More documentation can be found at <a href="https://www.ssc.wisc.edu/wlsresearch/" class="uri">https://www.ssc.wisc.edu/wlsresearch/</a>.</p>
<p>Sample sizes vary by wave, from 9,681 (2011) to 10,317 (1957). This provides 99/% power to detect zero-order correlation effect sizes of ~.06, two-tailed at alpha .05.</p>
<div id="load-data-10" class="section level3">
<h3><span class="header-section-number">2.11.1</span> Load Data</h3>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb140-1" data-line-number="1">wls_codebook &lt;-<span class="st"> </span>(codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(study <span class="op">==</span><span class="st"> &quot;WLSS&quot;</span>))<span class="op">$</span>codebook[[<span class="dv">1</span>]] <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb140-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">orig_itemname =</span> <span class="kw">str_to_lower</span>(orig_itemname),</a>
<a class="sourceLine" id="cb140-3" data-line-number="3">         <span class="dt">sib =</span> <span class="kw">ifelse</span>(<span class="kw">grepl</span>(<span class="st">&quot;rad&quot;</span>, dataset), <span class="st">&quot;grad&quot;</span>, <span class="kw">ifelse</span>(<span class="kw">grepl</span>(<span class="st">&quot;ibl&quot;</span>, dataset), <span class="st">&quot;sib&quot;</span>, <span class="ot">NA</span>)))</a>
<a class="sourceLine" id="cb140-4" data-line-number="4">wls_codebook</a></code></pre></div>
<pre><code>## # A tibble: 834 x 19
##    study dataset category name  itemname year  new_itemname orig_itemname description scale
##    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;        &lt;chr&gt;         &lt;chr&gt;       &lt;chr&gt;
##  1 wlss  1992 -… match    ageF… ageFrst… 1992  wlss__match… ru020re       What age w… &quot;.\t…
##  2 wlss  1993 -… match    ageF… ageFrst… 1993  wlss__match… su020re       What age w… &quot;.\t…
##  3 wlss  1992 -… match    alco… alcohol  1992  wlss__match… ru026re       During the…  &lt;NA&gt;
##  4 wlss  1993 -… match    alco… alcohol  1993  wlss__match… su026re       During the…  &lt;NA&gt;
##  5 wlss  1992 -… match    anem… anemia   1992  wlss__match… mx083rer      Has a medi… &quot;.\t…
##  6 wlss  1993 -… match    anem… anemia   1992  wlss__match… nx103rer      Has a medi… &quot;\&quot;.…
##  7 wlss  1992 -… match    appr… apprncR… 1992  wlss__match… mx004rer      Compared w… &quot;.\t…
##  8 wlss  1993 -… match    appr… apprncR… 1993  wlss__match… nx004rer      Compared w… &quot;.\t…
##  9 wlss  1992-1… match    auth… afraidV… 1992  wlss__match… mn007rer      “I am not … &quot;1 a…
## 10 wlss  1992-1… match    auth… afraidV… 1992  wlss__match… np007rer      “I am not … &quot;1 a…
## # … with 824 more rows, and 9 more variables: reverse_code &lt;chr&gt;, recode &lt;chr&gt;, mini &lt;dbl&gt;,
## #   maxi &lt;dbl&gt;, comp_rule &lt;chr&gt;, ...16 &lt;chr&gt;, ...17 &lt;chr&gt;, ...18 &lt;chr&gt;, sib &lt;chr&gt;</code></pre>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb142-1" data-line-number="1">old.names &lt;-<span class="st"> </span>wls_codebook<span class="op">$</span>orig_itemname</a>
<a class="sourceLine" id="cb142-2" data-line-number="2"></a>
<a class="sourceLine" id="cb142-3" data-line-number="3">wls &lt;-<span class="st"> </span><span class="kw">sprintf</span>(<span class="st">&quot;%s/data/wls/wls_b_13_07.sav&quot;</span>, wd) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb142-4" data-line-number="4"><span class="st">  </span>haven<span class="op">::</span><span class="kw">read_sav</span>(.) <span class="op">%&gt;%</span><span class="st"> </span>haven<span class="op">::</span><span class="kw">zap_labels</span>(.) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb142-5" data-line-number="5"><span class="st">  </span><span class="kw">select</span>(<span class="kw">one_of</span>(old.names))</a>
<a class="sourceLine" id="cb142-6" data-line-number="6"><span class="kw">save</span>(wls, <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/wls_raw.RData&quot;</span>, wd))</a></code></pre></div>
</div>
<div id="matching-variables-9" class="section level3">
<h3><span class="header-section-number">2.11.2</span> Matching Variables</h3>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb143-1" data-line-number="1">rename_fun &lt;-<span class="st"> </span><span class="cf">function</span>(cb, var){</a>
<a class="sourceLine" id="cb143-2" data-line-number="2">  old.names &lt;-<span class="st"> </span><span class="kw">unique</span>((wls_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> </span>var))<span class="op">$</span>orig_itemname)</a>
<a class="sourceLine" id="cb143-3" data-line-number="3">  df &lt;-<span class="st"> </span>wls <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb143-4" data-line-number="4"><span class="st">    </span><span class="kw">select</span>(<span class="dt">SID =</span> idpub, <span class="dt">HHID =</span> familypub, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-5" data-line-number="5"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>SID, <span class="op">-</span>HHID, <span class="dt">na.rm=</span>T)</a>
<a class="sourceLine" id="cb143-6" data-line-number="6">  <span class="cf">if</span>(<span class="kw">length</span>(old.names) <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>){</a>
<a class="sourceLine" id="cb143-7" data-line-number="7">      df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(itemname, year, orig_itemname, reverse_code<span class="op">:</span>comp_rule, sib))</a>
<a class="sourceLine" id="cb143-8" data-line-number="8">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb143-9" data-line-number="9">    df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cb <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>(itemname<span class="op">:</span>year),  <span class="op">-</span>new_itemname, <span class="op">-</span>dataset) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="st">&quot;0&quot;</span>)</a>
<a class="sourceLine" id="cb143-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb143-11" data-line-number="11">}</a>
<a class="sourceLine" id="cb143-12" data-line-number="12"></a>
<a class="sourceLine" id="cb143-13" data-line-number="13"><span class="co"># rename variables   </span></a>
<a class="sourceLine" id="cb143-14" data-line-number="14">wls_match &lt;-<span class="st"> </span>wls_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-15" data-line-number="15"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-16" data-line-number="16"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb143-17" data-line-number="17"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-18" data-line-number="18"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-19" data-line-number="19"><span class="st">  </span><span class="co"># filter(name != &quot;yearBrth&quot;) %&gt;%</span></a>
<a class="sourceLine" id="cb143-20" data-line-number="20"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-21" data-line-number="21"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-22" data-line-number="22"><span class="st">  </span><span class="kw">distinct</span>() </a>
<a class="sourceLine" id="cb143-23" data-line-number="23"></a>
<a class="sourceLine" id="cb143-24" data-line-number="24"><span class="co"># single time point variables </span></a>
<a class="sourceLine" id="cb143-25" data-line-number="25">old.names &lt;-<span class="st"> </span>(wls_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;match&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">==</span><span class="st"> &quot;0&quot;</span>))<span class="op">$</span>orig_itemname </a>
<a class="sourceLine" id="cb143-26" data-line-number="26">wls_match_stp &lt;-<span class="st"> </span>wls <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-27" data-line-number="27"><span class="st">  </span><span class="kw">select</span>(<span class="dt">SID =</span> idpub, <span class="dt">HHID =</span> familypub, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-28" data-line-number="28"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>SID, <span class="op">-</span>HHID, <span class="dt">na.rm=</span>T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-29" data-line-number="29"><span class="st">  </span><span class="kw">left_join</span>(wls_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(name<span class="op">:</span>year, orig_itemname, recode, comp_rule, sib)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-30" data-line-number="30"><span class="st">  </span><span class="kw">unite</span>(SID, SID, sib, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb143-31" data-line-number="31"></a>
<a class="sourceLine" id="cb143-32" data-line-number="32"><span class="co"># recoding</span></a>
<a class="sourceLine" id="cb143-33" data-line-number="33">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year){</a>
<a class="sourceLine" id="cb143-34" data-line-number="34">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb143-35" data-line-number="35">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb143-36" data-line-number="36">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb143-37" data-line-number="37">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb143-38" data-line-number="38">}</a>
<a class="sourceLine" id="cb143-39" data-line-number="39"></a>
<a class="sourceLine" id="cb143-40" data-line-number="40">yrBrth &lt;-<span class="st"> </span>wls_match_stp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-41" data-line-number="41"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">yearBrth =</span> <span class="kw">ifelse</span>(value <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="ot">NA</span>, value <span class="op">+</span><span class="dv">1900</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-42" data-line-number="42"><span class="st">  </span><span class="kw">select</span>(SID, HHID, yearBrth) </a>
<a class="sourceLine" id="cb143-43" data-line-number="43"></a>
<a class="sourceLine" id="cb143-44" data-line-number="44">wls_match &lt;-<span class="st"> </span>wls_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-45" data-line-number="45"><span class="st">  </span><span class="kw">unite</span>(SID, SID, sib, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-46" data-line-number="46"><span class="st">  </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-47" data-line-number="47"><span class="st">  </span><span class="kw">group_by</span>(recode, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-48" data-line-number="48"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-49" data-line-number="49"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-50" data-line-number="50"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-51" data-line-number="51"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb143-52" data-line-number="52"></a>
<a class="sourceLine" id="cb143-53" data-line-number="53">wls_match_par &lt;-<span class="st"> </span>wls_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(<span class="kw">grepl</span>(<span class="st">&quot;mom&quot;</span>, name) <span class="op">|</span><span class="st"> </span></a>
<a class="sourceLine" id="cb143-54" data-line-number="54"><span class="st">        </span><span class="kw">grepl</span>(<span class="st">&quot;dad&quot;</span>, name) <span class="op">|</span><span class="st"> </span>name <span class="op">==</span><span class="st"> &quot;parGrsWages&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-55" data-line-number="55"><span class="st">  </span><span class="kw">group_by</span>(year, HHID, name, comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-56" data-line-number="56"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-57" data-line-number="57"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-58" data-line-number="58"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value),</a>
<a class="sourceLine" id="cb143-59" data-line-number="59">         <span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;skip&quot;</span>, comp_rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-60" data-line-number="60"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-61" data-line-number="61"><span class="st">  </span><span class="kw">group_by</span>(HHID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-62" data-line-number="62"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, comp_rule[<span class="dv">1</span>])) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-63" data-line-number="63"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-64" data-line-number="64"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-65" data-line-number="65"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parGrsWages =</span> parGrsWages<span class="op">*</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb143-66" data-line-number="66"></a>
<a class="sourceLine" id="cb143-67" data-line-number="67">wls_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;WLS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb143-68" data-line-number="68"></a>
<a class="sourceLine" id="cb143-69" data-line-number="69">wls_match_stp &lt;-<span class="st"> </span>wls_match_stp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-70" data-line-number="70"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> wls_waves<span class="op">$</span>Used, <span class="dt">year =</span> <span class="st">&quot;0&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-71" data-line-number="71"><span class="st">  </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-72" data-line-number="72"><span class="st">  </span><span class="kw">group_by</span>(recode, p_year, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-73" data-line-number="73"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb143-74" data-line-number="74"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-75" data-line-number="75"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-76" data-line-number="76"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-77" data-line-number="77"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-78" data-line-number="78"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;skip&quot;</span>, comp_rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-79" data-line-number="79"><span class="st">  </span><span class="kw">group_by</span>(p_year, SID, HHID, name, yearBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-80" data-line-number="80"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, comp_rule[<span class="dv">1</span>])) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-81" data-line-number="81"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-82" data-line-number="82"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(value <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>, <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-83" data-line-number="83"><span class="st">  </span><span class="kw">spread</span>(name, value)</a>
<a class="sourceLine" id="cb143-84" data-line-number="84"></a>
<a class="sourceLine" id="cb143-85" data-line-number="85"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb143-86" data-line-number="86">wls_match &lt;-<span class="st"> </span>wls_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-87" data-line-number="87"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(reverse_code <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), value, </a>
<a class="sourceLine" id="cb143-88" data-line-number="88">                        <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb143-89" data-line-number="89"></a>
<a class="sourceLine" id="cb143-90" data-line-number="90">fun_call &lt;-<span class="st"> </span><span class="cf">function</span>(x, rule){</a>
<a class="sourceLine" id="cb143-91" data-line-number="91">    <span class="cf">switch</span>(rule,</a>
<a class="sourceLine" id="cb143-92" data-line-number="92">           <span class="dt">average =</span> <span class="kw">mean</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb143-93" data-line-number="93">           <span class="dt">mode =</span> <span class="kw">Mode</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb143-94" data-line-number="94">           <span class="dt">sum =</span> <span class="kw">sum</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb143-95" data-line-number="95">           <span class="dt">skip =</span> <span class="kw">unique</span>(x)[<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb143-96" data-line-number="96">           <span class="dt">max =</span> <span class="kw">max</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb143-97" data-line-number="97">           <span class="dt">min =</span> <span class="kw">min</span>(x, <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb143-98" data-line-number="98">           <span class="dt">multiply =</span> <span class="kw">prod</span>(x, <span class="dt">na.rm =</span> T))</a>
<a class="sourceLine" id="cb143-99" data-line-number="99">  }</a>
<a class="sourceLine" id="cb143-100" data-line-number="100"></a>
<a class="sourceLine" id="cb143-101" data-line-number="101"><span class="co"># compositing within years</span></a>
<a class="sourceLine" id="cb143-102" data-line-number="102">year_comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb143-103" data-line-number="103">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-104" data-line-number="104"><span class="st">    </span><span class="co"># group by person and item (collapse across age)</span></a>
<a class="sourceLine" id="cb143-105" data-line-number="105"><span class="st">    </span><span class="kw">group_by</span>(SID, HHID, yearBrth, name, year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb143-106" data-line-number="106"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-107" data-line-number="107"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb143-108" data-line-number="108"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb143-109" data-line-number="109">}</a>
<a class="sourceLine" id="cb143-110" data-line-number="110"></a>
<a class="sourceLine" id="cb143-111" data-line-number="111">wls_match &lt;-<span class="st"> </span>wls_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-112" data-line-number="112"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>(<span class="kw">grepl</span>(<span class="st">&quot;mom&quot;</span>, name) <span class="op">|</span><span class="st"> </span><span class="kw">grepl</span>(<span class="st">&quot;dad&quot;</span>, name) <span class="op">|</span><span class="st"> </span>name <span class="op">==</span><span class="st"> &quot;parGrsWages&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-113" data-line-number="113"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span><span class="kw">max</span>(wls_waves<span class="op">$</span>Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-114" data-line-number="114"><span class="st">  </span><span class="kw">group_by</span>(comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-115" data-line-number="115"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-116" data-line-number="116"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-117" data-line-number="117"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;skip&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb143-118" data-line-number="118">         <span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, year_comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-119" data-line-number="119"><span class="st">  </span><span class="kw">unnest</span>(data)</a>
<a class="sourceLine" id="cb143-120" data-line-number="120"></a>
<a class="sourceLine" id="cb143-121" data-line-number="121">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, p_year){</a>
<a class="sourceLine" id="cb143-122" data-line-number="122">  wls_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-123" data-line-number="123"><span class="st">    </span><span class="kw">filter</span>(year <span class="op">&lt;=</span><span class="st"> </span>p_year  <span class="op">&amp;</span><span class="st"> </span>comp_rule <span class="op">==</span><span class="st"> </span>rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-124" data-line-number="124"><span class="st">    </span><span class="kw">group_by</span>(SID, HHID, yearBrth, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-125" data-line-number="125"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-126" data-line-number="126"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb143-127" data-line-number="127">}</a>
<a class="sourceLine" id="cb143-128" data-line-number="128"></a>
<a class="sourceLine" id="cb143-129" data-line-number="129">wls_match &lt;-<span class="st"> </span><span class="kw">crossing</span>(</a>
<a class="sourceLine" id="cb143-130" data-line-number="130">  <span class="dt">p_year =</span> wls_waves<span class="op">$</span>Used, </a>
<a class="sourceLine" id="cb143-131" data-line-number="131">  <span class="dt">comp_rule =</span> <span class="kw">unique</span>(wls_match<span class="op">$</span>comp_rule)</a>
<a class="sourceLine" id="cb143-132" data-line-number="132">  ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-133" data-line-number="133"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;skip&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb143-134" data-line-number="134">         <span class="dt">data =</span> <span class="kw">map2</span>(comp_rule, p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-135" data-line-number="135"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-136" data-line-number="136"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-137" data-line-number="137"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-138" data-line-number="138"><span class="st">  </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> name, <span class="dt">values_from =</span> value, <span class="dt">values_fn =</span> <span class="kw">list</span>(<span class="dt">value =</span> max)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">full_join</span>(wls_match_par) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb143-139" data-line-number="139"><span class="st">  </span><span class="kw">full_join</span>(wls_match_stp)</a></code></pre></div>
<pre><code>## # A tibble: 44,342 x 69
##     year SID       A     C   DEP     E    IQ    LOC     N   `NA`     O    OP    PA     SE
##    &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
##  1  1992 9000…  4.2    5    1     4.20    NA   5.33  4.36  1.33    4.6    NA NA      4.67
##  2  1992 9000…  6.4    6.4  0.55  6.8     NA   5.67  1.72  0       5.2    NA NA      5.44
##  3  1992 9000…  6.2    4.8  0.7   3.8     NA   6     2.2   0.375   2.4    NA  6.75   3.86
##  4  1992 9000… NA     NA   NA    NA       NA NaN    NA    NA      NA      NA NA    NaN   
##  5  1992 9000…  4.4    5.8  0.25  4.6     NA   5.67  1.96  0       3.2    NA NA      6.09
##  6  1992 9000… NA     NA   NA    NA        9  NA    NA    NA      NA      NA NA      5.5 
##  7  1992 9000… NA     NA   NA    NA       NA   1    NA    NA      NA      NA NA      4.55
##  8  1992 9000…  5.4    6    1.05  4        4   3.5   2.92  0       4.4    NA  7      4.33
##  9  1992 9000…  5.40   6.4  0.6   5.2     NA   5     3.16  0       5.2    NA NA      5.78
## 10  1992 9000…  5.2    6.8  0.6   5.4     NA   6.33  3.4   0.333   5.8    NA NA      6.22
## # … with 44,332 more rows, and 55 more variables: HHID &lt;dbl&gt;, yearBrth &lt;dbl&gt;,
## #   authonomy &lt;dbl&gt;, EnvMastery &lt;dbl&gt;, exercise &lt;dbl&gt;, grsWages &lt;dbl&gt;, hospitalized &lt;dbl&gt;,
## #   PersGrowth &lt;dbl&gt;, Purpose &lt;dbl&gt;, hlthcare &lt;dbl&gt;, PhysFunc &lt;dbl&gt;, welfare &lt;dbl&gt;,
## #   ageMarried &lt;dbl&gt;, disability &lt;dbl&gt;, urban &lt;dbl&gt;, ageFrstDep &lt;dbl&gt;, alcohol &lt;dbl&gt;,
## #   anemia &lt;dbl&gt;, apprncRel10yrs &lt;dbl&gt;, backPain &lt;dbl&gt;, BMI &lt;dbl&gt;, depIntUnit &lt;dbl&gt;,
## #   depLngthUnit &lt;dbl&gt;, dizziness &lt;dbl&gt;, education &lt;dbl&gt;, employed &lt;dbl&gt;, everSmoked &lt;dbl&gt;,
## #   fatigue &lt;dbl&gt;, headaches &lt;dbl&gt;, height &lt;dbl&gt;, HHsize &lt;dbl&gt;, hlthRel10yrs &lt;dbl&gt;,
## #   hlthRelOthrs &lt;dbl&gt;, married &lt;dbl&gt;, numKids &lt;dbl&gt;, parDivorce &lt;dbl&gt;, religion &lt;dbl&gt;,
## #   satFam &lt;dbl&gt;, satJob &lt;dbl&gt;, sleepProb &lt;dbl&gt;, smokePacks &lt;dbl&gt;, smokes &lt;dbl&gt;,
## #   smokeYears &lt;dbl&gt;, SRhealth &lt;dbl&gt;, weight &lt;dbl&gt;, dadAlive &lt;dbl&gt;, dadEdu &lt;dbl&gt;,
## #   dadJob &lt;dbl&gt;, dadOccPrstg &lt;dbl&gt;, momAlive &lt;dbl&gt;, momEdu &lt;dbl&gt;, momOccPrstg &lt;dbl&gt;,
## #   parGrsWages &lt;dbl&gt;, gender &lt;dbl&gt;, physhlthevnt &lt;dbl&gt;</code></pre>
</div>
<div id="personality-variables-9" class="section level3">
<h3><span class="header-section-number">2.11.3</span> Personality Variables</h3>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb145-1" data-line-number="1">wls_pers &lt;-<span class="st"> </span>wls_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;pers&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb145-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;yearBrth&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-7" data-line-number="7"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-8" data-line-number="8"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-9" data-line-number="9"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">ifelse</span>(sib <span class="op">==</span><span class="st"> &quot;sib&quot;</span>, <span class="kw">as.numeric</span>(year) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>, year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-11" data-line-number="11"><span class="st">  </span><span class="kw">left_join</span>(p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;WLS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">name =</span> p_item, Used)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-12" data-line-number="12"><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span>Used) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-13" data-line-number="13"><span class="st">  </span><span class="kw">unite</span>(SID, SID, sib, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb145-14" data-line-number="14"></a>
<a class="sourceLine" id="cb145-15" data-line-number="15">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y){</a>
<a class="sourceLine" id="cb145-16" data-line-number="16">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb145-17" data-line-number="17">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb145-18" data-line-number="18">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb145-19" data-line-number="19">}</a>
<a class="sourceLine" id="cb145-20" data-line-number="20"></a>
<a class="sourceLine" id="cb145-21" data-line-number="21"><span class="co"># recode </span></a>
<a class="sourceLine" id="cb145-22" data-line-number="22">wls_pers &lt;-<span class="st"> </span>wls_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-23" data-line-number="23"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>orig_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-24" data-line-number="24"><span class="st">  </span><span class="kw">group_by</span>(recode) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-25" data-line-number="25"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-26" data-line-number="26"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-27" data-line-number="27"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(recode, data, recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-28" data-line-number="28"><span class="st">  </span><span class="kw">unnest</span>(data) </a>
<a class="sourceLine" id="cb145-29" data-line-number="29"></a>
<a class="sourceLine" id="cb145-30" data-line-number="30"><span class="co"># reverse code </span></a>
<a class="sourceLine" id="cb145-31" data-line-number="31">wls_pers &lt;-<span class="st"> </span>wls_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-32" data-line-number="32"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">tolower</span>(reverse_code) <span class="op">==</span><span class="st"> &quot;no&quot;</span> <span class="op">|</span><span class="st"> </span><span class="kw">is.na</span>(reverse_code), </a>
<a class="sourceLine" id="cb145-33" data-line-number="33">                        value, <span class="kw">reverse.code</span>(<span class="op">-</span><span class="dv">1</span>, value, <span class="dt">mini =</span> mini, <span class="dt">maxi =</span> maxi)))</a>
<a class="sourceLine" id="cb145-34" data-line-number="34"></a>
<a class="sourceLine" id="cb145-35" data-line-number="35"><span class="co"># alpha&#39;s</span></a>
<a class="sourceLine" id="cb145-36" data-line-number="36">wls_alpha &lt;-<span class="st"> </span>wls_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-37" data-line-number="37"><span class="st">  </span><span class="kw">select</span>(name, itemname, year, SID, value, comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-38" data-line-number="38"><span class="st">  </span><span class="kw">group_by</span>(name, year, SID, comp_rule, itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-39" data-line-number="39"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">mean</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-40" data-line-number="40"><span class="st">  </span><span class="kw">group_by</span>(name, year, comp_rule) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-41" data-line-number="41"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-42" data-line-number="42"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> itemname, <span class="dt">values_from =</span> value, <span class="dt">values_fn =</span> <span class="kw">list</span>(<span class="dt">value =</span> mean))),</a>
<a class="sourceLine" id="cb145-43" data-line-number="43">         <span class="dt">alpha =</span> <span class="kw">map</span>(data, <span class="kw">possibly</span>(<span class="op">~</span>psych<span class="op">::</span><span class="kw">alpha</span>((.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>SID)), <span class="ot">NA_real_</span>)))</a>
<a class="sourceLine" id="cb145-44" data-line-number="44"></a>
<a class="sourceLine" id="cb145-45" data-line-number="45"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb145-46" data-line-number="46">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df, rule){</a>
<a class="sourceLine" id="cb145-47" data-line-number="47">  df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-48" data-line-number="48"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-49" data-line-number="49"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">fun_call</span>(value, rule)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-50" data-line-number="50"><span class="st">    </span><span class="kw">ungroup</span>()</a>
<a class="sourceLine" id="cb145-51" data-line-number="51">}</a>
<a class="sourceLine" id="cb145-52" data-line-number="52"></a>
<a class="sourceLine" id="cb145-53" data-line-number="53"><span class="co"># create composites</span></a>
<a class="sourceLine" id="cb145-54" data-line-number="54">wls_pers &lt;-<span class="st"> </span>wls_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-55" data-line-number="55"><span class="st">  </span><span class="kw">group_by</span>(name, comp_rule, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-56" data-line-number="56"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-57" data-line-number="57"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-58" data-line-number="58"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">comp_rule =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(comp_rule), <span class="st">&quot;average&quot;</span>, comp_rule),</a>
<a class="sourceLine" id="cb145-59" data-line-number="59">         <span class="dt">data =</span> <span class="kw">map2</span>(data, comp_rule, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb145-60" data-line-number="60"><span class="st">  </span><span class="kw">unnest</span>()</a></code></pre></div>
<pre><code>## # A tibble: 243,434 x 5
##    name  year  comp_rule SID        value
##    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;      &lt;dbl&gt;
##  1 A     1992  average   900021grad  4.2 
##  2 A     1992  average   900026grad  6.4 
##  3 A     1992  average   900026sib   6.2 
##  4 A     1992  average   900042grad  4.4 
##  5 A     1992  average   900043sib   5.4 
##  6 A     1992  average   900054grad  5.40
##  7 A     1992  average   900069grad  5.2 
##  8 A     1992  average   900074sib   6.8 
##  9 A     1992  average   900075grad  5.4 
## 10 A     1992  average   900078grad  6.6 
## # … with 243,424 more rows</code></pre>
</div>
<div id="outcome-variables-10" class="section level3">
<h3><span class="header-section-number">2.11.4</span> Outcome Variables</h3>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb147-1" data-line-number="1">wls_out &lt;-<span class="st"> </span>wls_codebook <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-2" data-line-number="2"><span class="st">  </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">!=</span><span class="st"> &quot;0&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(name) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb147-4" data-line-number="4"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-5" data-line-number="5"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map2</span>(data, name, rename_fun))  <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-7" data-line-number="7"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-8" data-line-number="8"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-9" data-line-number="9"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> wls_waves<span class="op">$</span>Used, <span class="dt">name =</span> <span class="kw">unique</span>((.)<span class="op">$</span>name))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-10" data-line-number="10"><span class="st">  </span><span class="kw">unite</span>(SID, SID, sib, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb147-11" data-line-number="11"></a>
<a class="sourceLine" id="cb147-12" data-line-number="12">old.names &lt;-<span class="st"> </span>(wls_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(category <span class="op">==</span><span class="st"> &quot;out&quot;</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">==</span><span class="st"> &quot;0&quot;</span>))<span class="op">$</span>orig_itemname </a>
<a class="sourceLine" id="cb147-13" data-line-number="13">wls_out_stp &lt;-<span class="st"> </span>wls <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-14" data-line-number="14"><span class="st">  </span><span class="kw">select</span>(<span class="dt">SID =</span> idpub, <span class="dt">HHID =</span> familypub, <span class="kw">one_of</span>(old.names)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-15" data-line-number="15"><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key =</span> orig_itemname, <span class="dt">value =</span> value, <span class="op">-</span>SID, <span class="op">-</span>HHID, <span class="dt">na.rm=</span>T) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-16" data-line-number="16"><span class="st">  </span><span class="kw">left_join</span>(wls_codebook <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(name<span class="op">:</span>year, orig_itemname, recode, comp_rule, sib)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-17" data-line-number="17"><span class="st">  </span><span class="kw">unite</span>(SID, SID, sib, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb147-18" data-line-number="18"></a>
<a class="sourceLine" id="cb147-19" data-line-number="19"><span class="co"># recode</span></a>
<a class="sourceLine" id="cb147-20" data-line-number="20">recode_fun &lt;-<span class="st"> </span><span class="cf">function</span>(rule, y, p_year, year){</a>
<a class="sourceLine" id="cb147-21" data-line-number="21">  yearBrth &lt;-<span class="st"> </span>y<span class="op">$</span>yearBrth</a>
<a class="sourceLine" id="cb147-22" data-line-number="22">  x &lt;-<span class="st"> </span>y<span class="op">$</span>value</a>
<a class="sourceLine" id="cb147-23" data-line-number="23">  <span class="cf">if</span>(<span class="op">!</span><span class="kw">is.na</span>(rule)){y<span class="op">$</span>value &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> rule))}</a>
<a class="sourceLine" id="cb147-24" data-line-number="24">  <span class="kw">return</span>(y)</a>
<a class="sourceLine" id="cb147-25" data-line-number="25">}</a>
<a class="sourceLine" id="cb147-26" data-line-number="26"></a>
<a class="sourceLine" id="cb147-27" data-line-number="27">wls_out &lt;-<span class="st"> </span>wls_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-28" data-line-number="28"><span class="st">  </span><span class="kw">left_join</span>(yrBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-29" data-line-number="29"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>orig_itemname) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-30" data-line-number="30"><span class="st">  </span><span class="kw">group_by</span>(recode, year, p_year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-31" data-line-number="31"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-32" data-line-number="32"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-33" data-line-number="33"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">recode =</span> <span class="kw">str_replace_all</span>(recode, <span class="st">&quot;ifesle&quot;</span>, <span class="st">&quot;ifelse&quot;</span>),</a>
<a class="sourceLine" id="cb147-34" data-line-number="34">         <span class="dt">year =</span> <span class="kw">as.numeric</span>(year),</a>
<a class="sourceLine" id="cb147-35" data-line-number="35">         <span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year, year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-36" data-line-number="36"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-37" data-line-number="37"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb147-38" data-line-number="38"></a>
<a class="sourceLine" id="cb147-39" data-line-number="39">wls_waves &lt;-<span class="st"> </span>p_waves <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(Study <span class="op">==</span><span class="st"> &quot;WLS&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Used) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb147-40" data-line-number="40"></a>
<a class="sourceLine" id="cb147-41" data-line-number="41">wls_out_stp &lt;-<span class="st"> </span>wls_out_stp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-42" data-line-number="42"><span class="st">  </span><span class="kw">full_join</span>(<span class="kw">crossing</span>(<span class="dt">p_year =</span> wls_waves<span class="op">$</span>Used, <span class="dt">year =</span> <span class="st">&quot;0&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-43" data-line-number="43"><span class="st">  </span><span class="kw">group_by</span>(recode, p_year, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-44" data-line-number="44"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb147-45" data-line-number="45"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-46" data-line-number="46"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">pmap</span>(<span class="kw">list</span>(recode, data, p_year), recode_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-47" data-line-number="47"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-48" data-line-number="48"><span class="st">  </span><span class="kw">left_join</span>(yrBrth)</a>
<a class="sourceLine" id="cb147-49" data-line-number="49"></a>
<a class="sourceLine" id="cb147-50" data-line-number="50"><span class="co"># composite within years</span></a>
<a class="sourceLine" id="cb147-51" data-line-number="51">wls_out &lt;-<span class="st"> </span>wls_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-52" data-line-number="52"><span class="st">  </span><span class="kw">select</span>(year, p_year<span class="op">:</span>itemname, yearBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-53" data-line-number="53"><span class="st">  </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-54" data-line-number="54"><span class="st">  </span><span class="co"># filter(year &lt;= max(gsoep_waves$Used)) %&gt;%</span></a>
<a class="sourceLine" id="cb147-55" data-line-number="55"><span class="st">  </span><span class="kw">group_by</span>(SID, name, HHID, year, yearBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-56" data-line-number="56"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb147-57" data-line-number="57"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-58" data-line-number="58"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.nan</span>(value)<span class="op">|</span><span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value))</a>
<a class="sourceLine" id="cb147-59" data-line-number="59"></a>
<a class="sourceLine" id="cb147-60" data-line-number="60"><span class="co"># composite across years</span></a>
<a class="sourceLine" id="cb147-61" data-line-number="61">comp_fun &lt;-<span class="st"> </span><span class="cf">function</span>(P_year){</a>
<a class="sourceLine" id="cb147-62" data-line-number="62">  wls_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-63" data-line-number="63"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">ifelse</span>(year <span class="op">&gt;</span><span class="st"> </span>P_year, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;past&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-64" data-line-number="64"><span class="st">    </span><span class="kw">group_by</span>(SID, HHID, name, group) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-65" data-line-number="65"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">value =</span> <span class="kw">max</span>(value, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-66" data-line-number="66"><span class="st">    </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-67" data-line-number="67"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(value), <span class="ot">NA</span>, value)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-68" data-line-number="68"><span class="st">    </span><span class="kw">pivot_wider</span>(<span class="dt">names_from =</span> group, <span class="dt">values_from =</span> value) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-69" data-line-number="69"><span class="st">    </span><span class="kw">group_by</span>(SID, name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-70" data-line-number="70"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">value =</span> <span class="kw">ifelse</span>(<span class="kw">is.na</span>(past) <span class="op">|</span><span class="st"> </span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(future)), future,</a>
<a class="sourceLine" id="cb147-71" data-line-number="71">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">is.na</span>(future), past, </a>
<a class="sourceLine" id="cb147-72" data-line-number="72">                   <span class="kw">ifelse</span>(past <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, <span class="ot">NA</span>, <span class="ot">NA</span>)))) </a>
<a class="sourceLine" id="cb147-73" data-line-number="73">}</a>
<a class="sourceLine" id="cb147-74" data-line-number="74"></a>
<a class="sourceLine" id="cb147-75" data-line-number="75">wls_out &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">p_year =</span> wls_waves<span class="op">$</span>Used) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-76" data-line-number="76"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(p_year, comp_fun)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-77" data-line-number="77"><span class="st">  </span><span class="kw">unnest</span>(data) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-78" data-line-number="78"><span class="st">  </span><span class="kw">full_join</span>(wls_out_stp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(p_year,name, SID, HHID, value, yearBrth)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb147-79" data-line-number="79"><span class="st">  </span><span class="kw">filter</span>(name <span class="op">!=</span><span class="st"> &quot;chldbrth&quot;</span>)</a></code></pre></div>
<pre><code>## # A tibble: 347,140 x 8
##    p_year SID           HHID name        past future value yearBrth
##     &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
##  1   1992 900018grad 1201627 divorced       0     NA     0       NA
##  2   1992 900018grad 1201627 married       NA     NA    NA       NA
##  3   1992 900018grad 1201627 unemployed    NA     NA    NA       NA
##  4   1992 900018grad 1201627 vlntred       NA     NA    NA       NA
##  5   1992 900018sib  1201627 divorced       0     NA     0       NA
##  6   1992 900018sib  1201627 married       NA     NA    NA       NA
##  7   1992 900018sib  1201627 unemployed    NA     NA    NA       NA
##  8   1992 900018sib  1201627 vlntred       NA     NA    NA       NA
##  9   1992 900021grad 1205260 crim          NA      0     0       NA
## 10   1992 900021grad 1205260 divorced       0      1     1       NA
## # … with 347,130 more rows</code></pre>
</div>
<div id="covariates-9" class="section level3">
<h3><span class="header-section-number">2.11.5</span> Covariates</h3>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb149-1" data-line-number="1">wls_match &lt;-<span class="st"> </span>wls_pers <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-2" data-line-number="2"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>comp_rule)  <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb149-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">year =</span> <span class="kw">as.numeric</span>(year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-4" data-line-number="4"><span class="st">  </span><span class="kw">spread</span>(name, value) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb149-5" data-line-number="5"><span class="st">  </span><span class="kw">full_join</span>(wls_match <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename</span>(<span class="dt">year =</span> p_year)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-6" data-line-number="6"><span class="st">  </span><span class="co"># physical health event</span></a>
<a class="sourceLine" id="cb149-7" data-line-number="7"><span class="st">  </span><span class="kw">full_join</span>(wls_out <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(name <span class="op">==</span><span class="st"> &quot;physhlthevnt&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">year =</span> p_year, SID, <span class="dt">physhlthevnt =</span> past) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">distinct</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">physhlthevnt =</span> <span class="kw">max</span>(physhlthevnt)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-8" data-line-number="8"><span class="st">  </span><span class="kw">distinct</span>()</a>
<a class="sourceLine" id="cb149-9" data-line-number="9"></a>
<a class="sourceLine" id="cb149-10" data-line-number="10"><span class="co"># age</span></a>
<a class="sourceLine" id="cb149-11" data-line-number="11">wls_match &lt;-<span class="st"> </span>wls_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age =</span> year <span class="op">-</span><span class="st"> </span>yearBrth)</a>
<a class="sourceLine" id="cb149-13" data-line-number="13"></a>
<a class="sourceLine" id="cb149-14" data-line-number="14">wls_out &lt;-<span class="st"> </span>wls_out <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-15" data-line-number="15"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>past, <span class="op">-</span>future, <span class="op">-</span>yearBrth) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-16" data-line-number="16"><span class="st">  </span><span class="kw">distinct</span>() </a>
<a class="sourceLine" id="cb149-17" data-line-number="17"></a>
<a class="sourceLine" id="cb149-18" data-line-number="18">wls_SCA &lt;-<span class="st"> </span>wls_match <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb149-19" data-line-number="19"><span class="st">  </span><span class="kw">select</span>(SID, <span class="dt">p_year =</span> year, <span class="kw">one_of</span>(<span class="kw">c</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name), <span class="st">&quot;momOccPrstg&quot;</span>, <span class="st">&quot;dadOccPrstg&quot;</span>, <span class="st">&quot;momEdu&quot;</span>, <span class="st">&quot;dadEdu&quot;</span>))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-20" data-line-number="20"><span class="st">  </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-21" data-line-number="21"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T),</a>
<a class="sourceLine" id="cb149-22" data-line-number="22">         <span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(parEdu, parOccPrstg), <span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb149-24" data-line-number="24"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb149-25" data-line-number="25"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu, <span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg)</a>
<a class="sourceLine" id="cb149-26" data-line-number="26"></a>
<a class="sourceLine" id="cb149-27" data-line-number="27"><span class="kw">unique</span>(specifications<span class="op">$</span>name)[<span class="op">!</span><span class="kw">unique</span>(specifications<span class="op">$</span>name) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(wls_match2)]</a></code></pre></div>
<pre><code>## # A tibble: 44,342 x 19
##    SID   p_year   age education gender grsWages physhlthevnt SRhealth smokes alcohol exercise
##    &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt; &lt;fct&gt;      &lt;dbl&gt;
##  1 9000…   1992    54         2      0   66000             1        4     NA 1            1.5
##  2 9000…   1992    53         2      0   38500             0        5     NA 1            3.5
##  3 9000…   1992    59        NA      0      NA            NA       NA     NA &lt;NA&gt;         2.5
##  4 9000…   1992    54        NA      0   12500            NA       NA     NA &lt;NA&gt;        NA  
##  5 9000…   1992    53        NA      0   48800             0        5      0 0            2.5
##  6 9000…   1992    48        NA      0      NA            NA       NA     NA &lt;NA&gt;        NA  
##  7 9000…   1992    54        NA      0   19451.           NA       NA     NA 1           NA  
##  8 9000…   1992    51        NA      0      NA            NA       NA     NA &lt;NA&gt;         4  
##  9 9000…   1992    53        NA      0   65350             0        5      0 1            3  
## 10 9000…   1992    53         2      0   44250             0        5      0 1            3  
## # … with 44,332 more rows, and 8 more variables: BMI &lt;dbl&gt;, married &lt;dbl&gt;, numKids &lt;dbl&gt;,
## #   parDivorce &lt;dbl&gt;, PhysFunc &lt;fct&gt;, religion &lt;dbl&gt;, parEdu &lt;dbl&gt;, parOccPrstg &lt;dbl&gt;</code></pre>
</div>
<div id="imputation-9" class="section level3">
<h3><span class="header-section-number">2.11.6</span> Imputation</h3>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb151-1" data-line-number="1"><span class="co"># short helper functions to (1) identify and create factors, save col names of factors, remove columns with all missing values, and setup amelia</span></a>
<a class="sourceLine" id="cb151-2" data-line-number="2">factor_fun &lt;-<span class="st"> </span><span class="cf">function</span>(x){<span class="cf">if</span>(<span class="kw">is.numeric</span>(x)){<span class="kw">diff</span>(<span class="kw">range</span>(x, <span class="dt">na.rm =</span> T)) <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(x)) <span class="op">&lt;=</span><span class="st"> </span><span class="dv">4</span>} <span class="cf">else</span>{F}}</a>
<a class="sourceLine" id="cb151-3" data-line-number="3">not_all_id &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="cf">if</span>(<span class="kw">is.numeric</span>(x)) <span class="kw">sd</span>(x, <span class="dt">na.rm =</span> T) <span class="op">!=</span><span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb151-4" data-line-number="4">mice_fun &lt;-<span class="st"> </span><span class="cf">function</span>(df){</a>
<a class="sourceLine" id="cb151-5" data-line-number="5">  <span class="kw">mice</span>(df, <span class="dt">m =</span> <span class="dv">5</span>, <span class="dt">maxit=</span><span class="dv">5</span>,  <span class="dt">printFlag=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb151-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb151-7" data-line-number="7">wls_match_imp &lt;-<span class="st"> </span>wls_match <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-8" data-line-number="8"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">NegAff =</span> <span class="st">`</span><span class="dt">NA</span><span class="st">`</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-9" data-line-number="9"><span class="st">  </span><span class="kw">group_by</span>(SID, year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parOccPrstg =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momOccPrstg, dadOccPrstg), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>momOccPrstg, <span class="op">-</span>dadOccPrstg, <span class="op">-</span>HHID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-12" data-line-number="12"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate_all</span>(<span class="op">~</span><span class="kw">ifelse</span>(<span class="kw">is.infinite</span>(.) <span class="op">|</span><span class="st"> </span><span class="kw">is.nan</span>(.), <span class="ot">NA</span>, .)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-14" data-line-number="14"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">is.na</span>(year) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span><span class="kw">is.na</span>(SID)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-15" data-line-number="15"><span class="st">  </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb151-16" data-line-number="16"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-17" data-line-number="17"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-18" data-line-number="18"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select_if</span>(not_all_na)),</a>
<a class="sourceLine" id="cb151-19" data-line-number="19">         <span class="dt">data =</span> <span class="kw">map</span>(data, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(factor_fun, as.factor)),</a>
<a class="sourceLine" id="cb151-20" data-line-number="20">         <span class="dt">imp =</span> <span class="kw">map</span>(data, mice_fun))</a>
<a class="sourceLine" id="cb151-21" data-line-number="21">beepr<span class="op">::</span><span class="kw">beep</span>(<span class="dt">sound =</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb151-22" data-line-number="22"></a>
<a class="sourceLine" id="cb151-23" data-line-number="23">wls_match_imp &lt;-<span class="st"> </span>wls_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp, <span class="op">~</span>mice<span class="op">::</span><span class="kw">complete</span>(., <span class="st">&quot;long&quot;</span>)),</a>
<a class="sourceLine" id="cb151-25" data-line-number="25">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb151-26" data-line-number="26"><span class="st">    </span><span class="kw">group_by</span>(SID) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-27" data-line-number="27"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">parEdu =</span> <span class="kw">max</span>(<span class="kw">cbind</span>(momEdu, dadEdu), <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-28" data-line-number="28"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>momEdu, <span class="op">-</span>dadEdu) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-29" data-line-number="29"><span class="st">    </span><span class="kw">ungroup</span>()),</a>
<a class="sourceLine" id="cb151-30" data-line-number="30">         <span class="dt">imp_sca =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(.imp <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(SID,  <span class="kw">one_of</span>(<span class="kw">unique</span>(specifications<span class="op">$</span>name)))))</a>
<a class="sourceLine" id="cb151-31" data-line-number="31"></a>
<a class="sourceLine" id="cb151-32" data-line-number="32">wls_match_imp_long &lt;-<span class="st"> </span>wls_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-33" data-line-number="33"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_df) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-34" data-line-number="34"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="op">~</span>(.) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate_if</span>(is.factor, <span class="op">~</span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(.)))),</a>
<a class="sourceLine" id="cb151-35" data-line-number="35">         <span class="dt">imp_df =</span> <span class="kw">map</span>(imp_df, <span class="cf">function</span>(x){<span class="cf">if</span>(<span class="kw">any</span>(<span class="kw">colnames</span>(x) <span class="op">==</span><span class="st"> &quot;relSat&quot;</span>)){(x) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">relSat =</span> <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(relSat)))} <span class="cf">else</span>{x}})) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-36" data-line-number="36"><span class="st">  </span><span class="kw">unnest</span>(imp_df)</a>
<a class="sourceLine" id="cb151-37" data-line-number="37"></a>
<a class="sourceLine" id="cb151-38" data-line-number="38">wls_SCA_imp &lt;-<span class="st"> </span>wls_match_imp <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-39" data-line-number="39"><span class="st">  </span><span class="kw">select</span>(<span class="dt">p_year =</span> year, imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-40" data-line-number="40"><span class="st">  </span><span class="kw">unnest</span>(imp_sca) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-41" data-line-number="41"><span class="st">  </span><span class="kw">left_join</span>(wls_SCA <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dt">p_year=</span>year, SID,</a>
<a class="sourceLine" id="cb151-42" data-line-number="42">        <span class="kw">colnames</span>(wls_SCA)[<span class="op">!</span><span class="kw">colnames</span>(wls_SCA) <span class="op">%in%</span><span class="st"> </span><span class="kw">colnames</span>(.)])) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-43" data-line-number="43"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">race =</span> <span class="kw">factor</span>(<span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb151-44" data-line-number="44"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(alcohol, PhysFunc), <span class="op">~</span><span class="kw">factor</span>(<span class="kw">ifelse</span>(. <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, .)))</a></code></pre></div>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb152-1" data-line-number="1"><span class="kw">save</span>(wls_match_imp_long, wls_SCA_imp, </a>
<a class="sourceLine" id="cb152-2" data-line-number="2">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/wls_imputed_small.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb152-3" data-line-number="3"><span class="kw">save</span>(wls_match_imp, </a>
<a class="sourceLine" id="cb152-4" data-line-number="4">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/imputed/wls_imputed.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb152-5" data-line-number="5"><span class="kw">save</span>(wls_alpha, wls_pers, wls_out, wls_match, wls_SCA,</a>
<a class="sourceLine" id="cb152-6" data-line-number="6">     <span class="dt">file =</span> <span class="kw">sprintf</span>(<span class="st">&quot;%s/data/clean/wls_cleaned.RData&quot;</span>, wd))</a>
<a class="sourceLine" id="cb152-7" data-line-number="7"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;wls&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb153-1" data-line-number="1"><span class="kw">rm</span>(<span class="dt">list =</span><span class="kw">ls</span>()[<span class="kw">grepl</span>(<span class="st">&quot;wls&quot;</span>, <span class="kw">ls</span>())])</a></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="propensity-score-matching-psm.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/01-dataCleaning.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bookdown-demo.pdf", "bookdown-demo.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
